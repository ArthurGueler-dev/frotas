<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Diagn√≥stico - Filtro de √Årea</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1a1a1a;
            color: #00ff00;
        }
        .result {
            background: #000;
            padding: 15px;
            margin: 10px 0;
            border: 1px solid #00ff00;
            border-radius: 5px;
        }
        .error {
            color: #ff0000;
        }
        .warning {
            color: #ffaa00;
        }
    </style>
</head>
<body>
    <h1>üîç Diagn√≥stico - Filtro de √Årea Ativo</h1>
    <div id="results"></div>

    <script>
        async function diagnosticar() {
            const results = document.getElementById('results');
            let html = '';

            // 1. Verificar select de √°rea no dashboard
            html += '<div class="result">';
            html += '<h3>1. Verificando select de √°rea (areaFilterSelect):</h3>';
            const areaSelect = document.getElementById('areaFilterSelect');
            if (areaSelect) {
                html += `<p>‚úÖ Select encontrado!</p>`;
                html += `<p>Valor atual: <strong>${areaSelect.value || '(vazio)'}</strong></p>`;
                html += `<p>Texto selecionado: <strong>${areaSelect.options[areaSelect.selectedIndex]?.text || 'N/A'}</strong></p>`;
                html += `<p>Total de op√ß√µes: ${areaSelect.options.length}</p>`;

                // Listar todas as op√ß√µes
                html += '<p>Op√ß√µes dispon√≠veis:</p><ul>';
                for (let i = 0; i < areaSelect.options.length; i++) {
                    const opt = areaSelect.options[i];
                    html += `<li>${opt.value || '(vazio)'} - ${opt.text}${i === areaSelect.selectedIndex ? ' <strong>(SELECIONADO)</strong>' : ''}</li>`;
                }
                html += '</ul>';
            } else {
                html += '<p class="warning">‚ö†Ô∏è Select "areaFilterSelect" N√ÉO encontrado!</p>';
            }
            html += '</div>';

            // 2. Verificar baseSelect
            html += '<div class="result">';
            html += '<h3>2. Verificando baseSelect:</h3>';
            const baseSelect = document.getElementById('baseSelect');
            if (baseSelect) {
                html += `<p>‚úÖ Select encontrado!</p>`;
                html += `<p>Valor atual: <strong>${baseSelect.value || '(vazio)'}</strong></p>`;
                html += `<p>Texto selecionado: <strong>${baseSelect.options[baseSelect.selectedIndex]?.text || 'N/A'}</strong></p>`;
            } else {
                html += '<p class="warning">‚ö†Ô∏è Select "baseSelect" N√ÉO encontrado!</p>`;
            }
            html += '</div>';

            // 3. Buscar API para comparar totais
            html += '<div class="result">';
            html += '<h3>3. Comparando dados da API:</h3>';
            try {
                const today = new Date().toISOString().split('T')[0];

                // Total SEM filtro
                const urlSemFiltro = `https://floripa.in9automacao.com.br/daily-mileage-api.php?date_from=${today}&date_to=${today}&limit=1000`;
                const resSemFiltro = await fetch(urlSemFiltro);
                const dataSemFiltro = await resSemFiltro.json();

                const totalSemFiltro = dataSemFiltro.success && dataSemFiltro.records
                    ? dataSemFiltro.records.reduce((sum, r) => sum + (parseFloat(r.km_driven) || 0), 0)
                    : 0;

                html += `<p>üìä Total SEM filtro de √°rea: <strong>${totalSemFiltro.toFixed(2)} km</strong> (${dataSemFiltro.records?.length || 0} ve√≠culos)</p>`;

                // Se h√° um filtro de √°rea ativo, buscar com filtro
                if (areaSelect && areaSelect.value && areaSelect.value !== '') {
                    const area_id = areaSelect.value;
                    const urlComFiltro = `https://floripa.in9automacao.com.br/daily-mileage-api.php?date_from=${today}&date_to=${today}&area_id=${area_id}&limit=1000`;
                    const resComFiltro = await fetch(urlComFiltro);
                    const dataComFiltro = await resComFiltro.json();

                    const totalComFiltro = dataComFiltro.success && dataComFiltro.records
                        ? dataComFiltro.records.reduce((sum, r) => sum + (parseFloat(r.km_driven) || 0), 0)
                        : 0;

                    html += `<p>üîç Total COM filtro de √°rea ${area_id}: <strong>${totalComFiltro.toFixed(2)} km</strong> (${dataComFiltro.records?.length || 0} ve√≠culos)</p>`;
                    html += `<p class="warning">‚ö†Ô∏è DIFEREN√áA: ${(totalSemFiltro - totalComFiltro).toFixed(2)} km</p>`;

                    if (Math.abs(totalComFiltro - 2127) < 10) {
                        html += '<p class="error">üéØ BINGO! O filtro de √°rea est√° causando a diferen√ßa nos cards!</p>';
                    }
                } else {
                    html += '<p>‚úÖ Nenhum filtro de √°rea ativo no momento</p>';
                }
            } catch (error) {
                html += `<p class="error">‚ùå Erro ao buscar API: ${error.message}</p>`;
            }
            html += '</div>';

            // 4. Verificar valor exibido no card
            html += '<div class="result">';
            html += '<h3>4. Verificando card de KM Hoje:</h3>';
            const cardKmToday = document.getElementById('stat-km-today');
            if (cardKmToday) {
                html += `<p>Valor exibido: <strong>${cardKmToday.textContent}</strong></p>`;

                const kmNumerico = parseFloat(cardKmToday.textContent.replace(/[^\d,.-]/g, '').replace(',', '.'));
                html += `<p>Valor num√©rico: ${kmNumerico.toFixed(2)} km</p>`;

                if (Math.abs(kmNumerico - 2127) < 10) {
                    html += '<p class="error">üéØ Card mostrando valor FILTRADO (~2,127 km)</p>';
                } else if (Math.abs(kmNumerico - 2935) < 10) {
                    html += '<p>‚úÖ Card mostrando valor TOTAL (~2,935 km)</p>';
                }
            } else {
                html += '<p class="warning">‚ö†Ô∏è Card "stat-km-today" N√ÉO encontrado!</p>';
            }
            html += '</div>';

            results.innerHTML = html;
        }

        diagnosticar();
    </script>
</body>
</html>
