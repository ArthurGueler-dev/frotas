<!DOCTYPE html>
<html class="light" lang="en"><head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Gerenciamento de Manuten√ß√£o</title>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&amp;display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
<script src="ituran-service.js"></script>
<script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#1E3A8A",
                        "background-light": "#F3F4F6",
                        "background-dark": "#1F2937",
                        "text-light": "#1F2937",
                        "text-dark": "#F3F4F6",
                        "success": "#10B981",
                        "warning": "#F59E0B",
                        "danger": "#EF4444",
                        "info": "#3B82F6",
                    },
                    fontFamily: {
                        "display": ["Inter", "sans-serif"]
                    },
                    borderRadius: {
                        "DEFAULT": "0.5rem",
                        "lg": "0.75rem",
                        "xl": "1rem",
                        "full": "9999px"
                    },
                },
            },
        }
    </script>
<style>
        .material-symbols-outlined {
            font-variation-settings:
            'FILL' 0,
            'wght' 400,
            'GRAD' 0,
            'opsz' 24
        }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark font-display text-[#333333] dark:text-white">
<div class="relative flex h-auto min-h-screen w-full flex-col">
<div class="flex h-full grow flex-row">
<!-- Sidebar Container -->
<div id="sidebar-container" data-page="manutencao"></div>
<main class="flex-1 p-6 lg:p-8 bg-background-light dark:bg-gray-900">
<div class="flex flex-col gap-8">
<div class="flex flex-wrap justify-between items-center gap-4">
<h1 class="text-gray-900 dark:text-white text-4xl font-black leading-tight tracking-[-0.033em]">Gest√£o de Manuten√ß√£o</h1>
<a href="lancar-os.html" class="flex items-center justify-center gap-2 min-w-[84px] max-w-[480px] cursor-pointer rounded-lg h-12 px-5 bg-primary text-white text-base font-bold leading-normal tracking-[0.015em] hover:bg-primary/90">
<span class="material-symbols-outlined">add</span>
<span class="truncate">Lan√ßar Nova OS</span>
</a>
</div>
<div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
<div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-6">
<h2 class="text-xl font-bold text-gray-900 dark:text-white">Ordens de Servi√ßo</h2>
<div class="flex items-center gap-4">
<div class="relative">
<span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">search</span>
<input id="search-input" class="form-input w-full md:w-64 pl-10 pr-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-800 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary/50" placeholder="Buscar OS..." type="text"/>
</div>
<button id="toggle-filters-btn" class="flex items-center gap-2 px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 text-gray-800 dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700">
<span class="material-symbols-outlined">filter_list</span>
                                Filtros
                            </button>
</div>
</div>

<!-- Painel de Filtros Avan√ßados -->
<div id="filters-panel" class="hidden mb-6 bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6">
    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Filtros Avan√ßados</h3>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
        <!-- Filtro: N√∫mero da OS -->
        <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                N√∫mero da OS
            </label>
            <input id="filter-os-number" type="text" placeholder="Ex: OS-2024-00123"
                   class="form-input w-full bg-gray-50 dark:bg-gray-900 border-gray-300 dark:border-gray-600 rounded h-10 text-sm"/>
        </div>

        <!-- Filtro: Placa -->
        <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                Placa do Ve√≠culo
            </label>
            <input id="filter-plate" type="text" placeholder="Ex: ABC1234"
                   class="form-input w-full bg-gray-50 dark:bg-gray-900 border-gray-300 dark:border-gray-600 rounded h-10 text-sm"/>
        </div>

        <!-- Filtro: Status -->
        <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                Status
            </label>
            <select id="filter-status" class="form-select w-full bg-gray-50 dark:bg-gray-900 border-gray-300 dark:border-gray-600 rounded h-10 text-sm">
                <option value="">Todos</option>
                <option value="Diagn√≥stico">Diagn√≥stico</option>
                <option value="Or√ßamento">Or√ßamento</option>
                <option value="Execu√ß√£o">Execu√ß√£o</option>
                <option value="Finalizada">Finalizada</option>
            </select>
        </div>

        <!-- Filtro: Respons√°vel -->
        <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                Respons√°vel
            </label>
            <select id="filter-responsavel" class="form-select w-full bg-gray-50 dark:bg-gray-900 border-gray-300 dark:border-gray-600 rounded h-10 text-sm">
                <option value="">Todos</option>
                <option value="Jo√£o Silva">Jo√£o Silva</option>
                <option value="Maria Oliveira">Maria Oliveira</option>
            </select>
        </div>

        <!-- Filtro: Data Inicial -->
        <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                Data Inicial
            </label>
            <input id="filter-date-start" type="date"
                   class="form-input w-full bg-gray-50 dark:bg-gray-900 border-gray-300 dark:border-gray-600 rounded h-10 text-sm"/>
        </div>

        <!-- Filtro: Data Final -->
        <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                Data Final
            </label>
            <input id="filter-date-end" type="date"
                   class="form-input w-full bg-gray-50 dark:bg-gray-900 border-gray-300 dark:border-gray-600 rounded h-10 text-sm"/>
        </div>

        <!-- Filtro: Tipo de Item -->
        <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                Tipo de Item/Servi√ßo
            </label>
            <select id="filter-item-type" class="form-select w-full bg-gray-50 dark:bg-gray-900 border-gray-300 dark:border-gray-600 rounded h-10 text-sm">
                <option value="">Todos</option>
                <option value="Servi√ßo">Servi√ßo</option>
                <option value="Produto">Produto</option>
            </select>
        </div>

        <!-- Filtro: Categoria -->
        <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                Categoria
            </label>
            <select id="filter-category" class="form-select w-full bg-gray-50 dark:bg-gray-900 border-gray-300 dark:border-gray-600 rounded h-10 text-sm">
                <option value="">Todas</option>
                <option value="pneus">Pneus</option>
                <option value="munck">Munck</option>
                <option value="carroceria">Carroceria</option>
                <option value="motor">Motor</option>
                <option value="caixa">Caixa</option>
                <option value="limpeza">Limpeza</option>
                <option value="cambio">C√¢mbio</option>
                <option value="suspensao">Suspens√£o</option>
                <option value="eletrica">El√©trica</option>
                <option value="freio">Freio</option>
            </select>
        </div>

        <!-- Filtro: Ocorr√™ncia -->
        <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                Ocorr√™ncia
            </label>
            <select id="filter-occurrence" class="form-select w-full bg-gray-50 dark:bg-gray-900 border-gray-300 dark:border-gray-600 rounded h-10 text-sm">
                <option value="">Todas</option>
                <option value="preventivo">Preventivo</option>
                <option value="corretivo">Corretivo</option>
            </select>
        </div>

        <!-- Filtro: Valor M√≠nimo -->
        <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                Valor M√≠nimo (R$)
            </label>
            <input id="filter-value-min" type="number" step="0.01" placeholder="0,00"
                   class="form-input w-full bg-gray-50 dark:bg-gray-900 border-gray-300 dark:border-gray-600 rounded h-10 text-sm"/>
        </div>

        <!-- Filtro: Valor M√°ximo -->
        <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                Valor M√°ximo (R$)
            </label>
            <input id="filter-value-max" type="number" step="0.01" placeholder="999999,99"
                   class="form-input w-full bg-gray-50 dark:bg-gray-900 border-gray-300 dark:border-gray-600 rounded h-10 text-sm"/>
        </div>

        <!-- Filtro: Ano/M√™s -->
        <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                Ano/M√™s
            </label>
            <input id="filter-ano-mes" type="month"
                   class="form-input w-full bg-gray-50 dark:bg-gray-900 border-gray-300 dark:border-gray-600 rounded h-10 text-sm"/>
        </div>
    </div>

    <div class="flex justify-end gap-3">
        <button id="clear-filters-btn" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-lg text-sm font-medium hover:bg-gray-300 dark:hover:bg-gray-600">
            Limpar Filtros
        </button>
        <button id="apply-filters-btn" class="px-4 py-2 bg-primary text-white rounded-lg text-sm font-medium hover:bg-primary/90">
            Aplicar Filtros
        </button>
    </div>
</div>
<div class="overflow-x-auto">
<table class="w-full text-left text-sm text-gray-500 dark:text-gray-400">
<thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
<tr>
<th class="px-6 py-3" scope="col">N¬∫ OS</th>
<th class="px-6 py-3" scope="col">Data</th>
<th class="px-6 py-3" scope="col">Placa</th>
<th class="px-6 py-3" scope="col">Respons√°vel</th>
<th class="px-6 py-3" scope="col">Status</th>
<th class="px-6 py-3" scope="col">Valor Total</th>
<th class="px-6 py-3" scope="col">A√ß√µes</th>
</tr>
</thead>
<tbody class="text-gray-800 dark:text-white" id="orders-tbody">
<tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">
<td colspan="7" class="px-6 py-8 text-center text-gray-500 dark:text-gray-400">
<span class="material-symbols-outlined text-4xl mb-2">inventory_2</span>
<p>Nenhuma ordem de servi√ßo cadastrada</p>
<p class="text-xs mt-2">Clique em "Lan√ßar Nova OS" para criar a primeira</p>
</td>
</tr>
</tbody>
</table>
</div>
<div class="flex justify-between items-center pt-4">
<span class="text-sm text-gray-700 dark:text-gray-400">
                            Mostrando <span class="font-semibold text-gray-900 dark:text-white">1</span> a <span class="font-semibold text-gray-900 dark:text-white">4</span> de <span class="font-semibold text-gray-900 dark:text-white">100</span>
</span>
<div class="inline-flex items-center -space-x-px">
<a class="py-2 px-3 ml-0 leading-tight text-gray-500 bg-white rounded-l-lg border border-gray-300 hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white" href="#">Anterior</a>
<a class="py-2 px-3 leading-tight text-gray-500 bg-white rounded-r-lg border border-gray-300 hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white" href="#">Pr√≥ximo</a>
</div>
</div>
</div>
</div>
</main>
</div>

<!-- Modal de Edi√ß√£o de OS -->
<div id="edit-os-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 overflow-y-auto">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-6xl w-full max-h-[90vh] overflow-y-auto" style="position: relative;">
            <div class="p-6 border-b border-gray-200 dark:border-gray-700 sticky top-0 bg-white dark:bg-gray-800 z-10">
                <div class="flex items-center justify-between">
                    <h3 class="text-xl font-semibold text-gray-900 dark:text-white">
                        Editar Ordem de Servi√ßo - <span id="edit-os-number"></span>
                    </h3>
                    <button onclick="closeEditModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                        <span class="material-symbols-outlined text-2xl">close</span>
                    </button>
                </div>
                <div id="readonly-warning" class="hidden mt-3 p-3 bg-yellow-100 dark:bg-yellow-900/30 border border-yellow-300 dark:border-yellow-700 rounded-lg">
                    <p class="text-sm text-yellow-800 dark:text-yellow-300">
                        <span class="material-symbols-outlined text-sm align-middle">lock</span>
                        Esta OS est√° finalizada e n√£o pode ser editada.
                    </p>
                </div>
            </div>

            <form id="edit-os-form" class="p-6">
                <!-- Dados B√°sicos -->
                <div class="mb-6">
                    <h4 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Dados B√°sicos</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Data e Hora</label>
                            <input id="edit-datetime" type="datetime-local" class="form-input w-full bg-gray-50 dark:bg-gray-900 border-gray-300 dark:border-gray-600 rounded h-10 text-sm"/>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Respons√°vel</label>
                            <select id="edit-responsavel" class="form-select w-full bg-gray-50 dark:bg-gray-900 border-gray-300 dark:border-gray-600 rounded h-10 text-sm">
                                <option>Jo√£o Silva</option>
                                <option>Maria Oliveira</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Status</label>
                            <select id="edit-status" class="form-select w-full bg-gray-50 dark:bg-gray-900 border-gray-300 dark:border-gray-600 rounded h-10 text-sm">
                                <option>Diagn√≥stico</option>
                                <option>Or√ßamento</option>
                                <option>Execu√ß√£o</option>
                                <option>Finalizada</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Placa do Ve√≠culo</label>
                            <input id="edit-plate" type="text" readonly class="form-input w-full bg-gray-100 dark:bg-gray-700 border-gray-300 dark:border-gray-600 rounded h-10 text-sm" style="cursor: not-allowed;"/>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Quilometragem (KM)</label>
                            <input id="edit-km" type="number" class="form-input w-full bg-gray-50 dark:bg-gray-900 border-gray-300 dark:border-gray-600 rounded h-10 text-sm"/>
                        </div>
                    </div>
                </div>

                <!-- Datas de Acompanhamento -->
                <div class="mb-6">
                    <h4 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Datas de Acompanhamento</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Data Diagn√≥stico</label>
                            <input id="edit-date-diagnostico" type="datetime-local" class="form-input w-full bg-gray-50 dark:bg-gray-900 border-gray-300 dark:border-gray-600 rounded h-10 text-sm"/>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Data Or√ßamento</label>
                            <input id="edit-date-orcamento" type="datetime-local" class="form-input w-full bg-gray-50 dark:bg-gray-900 border-gray-300 dark:border-gray-600 rounded h-10 text-sm"/>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Data Execu√ß√£o</label>
                            <input id="edit-date-execucao" type="datetime-local" class="form-input w-full bg-gray-50 dark:bg-gray-900 border-gray-300 dark:border-gray-600 rounded h-10 text-sm"/>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Data Finaliza√ß√£o</label>
                            <input id="edit-date-finalizacao" type="datetime-local" class="form-input w-full bg-gray-50 dark:bg-gray-900 border-gray-300 dark:border-gray-600 rounded h-10 text-sm"/>
                        </div>
                    </div>
                </div>

                <!-- Observa√ß√µes -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Observa√ß√µes</label>
                    <textarea id="edit-observacoes" rows="4" class="form-textarea w-full bg-gray-50 dark:bg-gray-900 border-gray-300 dark:border-gray-600 rounded text-sm p-3"></textarea>
                </div>

                <!-- Itens da OS -->
                <div class="mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h4 class="text-lg font-semibold text-gray-900 dark:text-white">Itens, Produtos e Servi√ßos</h4>
                        <button type="button" id="add-service-btn" class="flex items-center gap-2 px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm font-medium">
                            <span class="material-symbols-outlined text-base">add</span>
                            Adicionar Servi√ßo
                        </button>
                    </div>
                    <div class="w-full" style="overflow: visible;">
                        <table class="w-full text-sm">
                            <thead class="text-xs uppercase bg-gray-50 dark:bg-gray-700">
                                <tr>
                                    <th class="px-3 py-2 text-left">Tipo</th>
                                    <th class="px-3 py-2 text-left">Descri√ß√£o</th>
                                    <th class="px-3 py-2 text-left">Categoria</th>
                                    <th class="px-3 py-2 text-center">Qtd.</th>
                                    <th class="px-3 py-2 text-right">Valor Unit.</th>
                                    <th class="px-3 py-2 text-right">Total</th>
                                    <th class="px-3 py-2 text-left">Ocorr√™ncia</th>
                                    <th class="px-3 py-2 text-center">A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="edit-items-tbody" class="divide-y divide-gray-200 dark:divide-gray-700">
                                <!-- Itens ser√£o preenchidos via JS -->
                            </tbody>
                            <tfoot>
                                <tr class="font-semibold bg-gray-50 dark:bg-gray-700">
                                    <td colspan="5" class="px-3 py-3 text-right">Total Geral:</td>
                                    <td id="edit-total-geral" class="px-3 py-3 text-right">R$ 0,00</td>
                                    <td colspan="2"></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>

                <!-- Bot√µes -->
                <div class="flex justify-end gap-3 pt-4 border-t border-gray-200 dark:border-gray-700">
                    <button type="button" onclick="closeEditModal()" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-lg text-sm font-medium hover:bg-gray-300 dark:hover:bg-gray-600">
                        Cancelar
                    </button>
                    <button type="submit" id="save-edit-btn" class="px-4 py-2 bg-primary text-white rounded-lg text-sm font-medium hover:bg-primary/90">
                        Salvar Altera√ß√µes
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Inicializa√ß√£o
document.addEventListener('DOMContentLoaded', async () => {
    console.log('üöÄ Inicializando p√°gina de gest√£o de manuten√ß√£o...');

    // Inicializar servi√ßo Ituran para obter modelos
    const ituranService = new IturanService();
    await ituranService.loadVehicleModels();

    // Configurar busca
    setupSearch();

    // Configurar filtros avan√ßados
    setupAdvancedFilters();

    // Carregar ordens de servi√ßo usando os filtros (isso garantir√° que os bot√µes de editar/excluir funcionem)
    applyAllFilters();
});

function loadServiceOrders(ituranService) {
    try {
        console.log('üìã Carregando ordens de servi√ßo...');

        // Carregar do localStorage
        const orders = JSON.parse(localStorage.getItem('serviceOrders') || '[]');

        if (orders.length === 0) {
            console.log('‚ÑπÔ∏è Nenhuma ordem de servi√ßo encontrada');
            return;
        }

        console.log(`‚úÖ ${orders.length} ordens de servi√ßo carregadas`);

        // Ordenar por data (mais recentes primeiro)
        orders.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

        // Renderizar tabela
        const tbody = document.querySelector('#orders-tbody');
        tbody.innerHTML = orders.map(os => {
            // Determinar status badge
            let statusBadge = '';
            switch(os.status) {
                case 'Conclu√≠da':
                case 'Finalizada':
                    statusBadge = '<span class="inline-flex items-center gap-2 px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300">Conclu√≠da</span>';
                    break;
                case 'Execu√ß√£o':
                case 'Em Andamento':
                    statusBadge = '<span class="inline-flex items-center gap-2 px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300">Em Andamento</span>';
                    break;
                case 'Or√ßamento':
                case 'Diagn√≥stico':
                case 'Pendente':
                    statusBadge = '<span class="inline-flex items-center gap-2 px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300">Pendente</span>';
                    break;
                default:
                    statusBadge = `<span class="inline-flex items-center gap-2 px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-300">${os.status}</span>`;
            }

            // Formatar data
            const dataFormatada = new Date(os.dateTime).toLocaleDateString('pt-BR');

            return `
            <tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 cursor-pointer" onclick="viewOrderDetails('${os.osNumber}')">
                <td class="px-6 py-4 font-medium text-primary">${os.osNumber}</td>
                <td class="px-6 py-4">${dataFormatada}</td>
                <td class="px-6 py-4 font-medium">${os.plate}</td>
                <td class="px-6 py-4">${os.responsavel || 'N/A'}</td>
                <td class="px-6 py-4">${statusBadge}</td>
                <td class="px-6 py-4 font-semibold text-green-600 dark:text-green-400">R$ ${os.totalGeral.toFixed(2).replace('.', ',')}</td>
                <td class="px-6 py-4">
                    <button class="text-gray-500 dark:text-gray-400 hover:text-primary dark:hover:text-white" onclick="event.stopPropagation(); viewOrderDetails('${os.osNumber}')">
                        <span class="material-symbols-outlined">visibility</span>
                    </button>
                </td>
            </tr>
            `;
        }).join('');

        // Atualizar contador
        updatePagination(orders.length);

    } catch (error) {
        console.error('‚ùå Erro ao carregar ordens de servi√ßo:', error);
    }
}

function viewOrderDetails(osNumber) {
    try {
        const orders = JSON.parse(localStorage.getItem('serviceOrders') || '[]');
        const order = orders.find(o => o.osNumber === osNumber);

        if (!order) {
            alert('Ordem de servi√ßo n√£o encontrada!');
            return;
        }

        // Criar modal de detalhes
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
        modal.onclick = (e) => {
            if (e.target === modal) modal.remove();
        };

        const itemsHtml = order.items.map((item, idx) => `
            <tr class="border-b dark:border-gray-700">
                <td class="px-4 py-3">${idx + 1}</td>
                <td class="px-4 py-3">${item.description}</td>
                <td class="px-4 py-3">${item.type}</td>
                <td class="px-4 py-3 text-center">${item.qty}</td>
                <td class="px-4 py-3 text-right">R$ ${item.value.toFixed(2).replace('.', ',')}</td>
                <td class="px-4 py-3 text-right font-medium">R$ ${(item.qty * item.value).toFixed(2).replace('.', ',')}</td>
                <td class="px-4 py-3">${item.occurrence || '-'}</td>
            </tr>
        `).join('');

        modal.innerHTML = `
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                <div class="p-6 border-b dark:border-gray-700 flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-gray-900 dark:text-white">Detalhes da OS: ${order.osNumber}</h2>
                    <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-white">
                        <span class="material-symbols-outlined text-3xl">close</span>
                    </button>
                </div>

                <div class="p-6 space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <p class="text-sm text-gray-500 dark:text-gray-400">Respons√°vel</p>
                            <p class="font-medium text-gray-900 dark:text-white">${order.responsavel}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500 dark:text-gray-400">Status</p>
                            <p class="font-medium text-gray-900 dark:text-white">${order.status}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500 dark:text-gray-400">Data</p>
                            <p class="font-medium text-gray-900 dark:text-white">${new Date(order.dateTime).toLocaleString('pt-BR')}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500 dark:text-gray-400">Placa</p>
                            <p class="font-medium text-gray-900 dark:text-white">${order.plate}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500 dark:text-gray-400">Quilometragem</p>
                            <p class="font-medium text-gray-900 dark:text-white">${order.km ? order.km.toLocaleString('pt-BR') : 'N/A'} km</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500 dark:text-gray-400">Valor Total</p>
                            <p class="font-medium text-green-600 dark:text-green-400 text-lg">R$ ${order.totalGeral.toFixed(2).replace('.', ',')}</p>
                        </div>
                    </div>

                    ${order.observacoes ? `
                        <div>
                            <p class="text-sm text-gray-500 dark:text-gray-400 mb-2">Observa√ß√µes</p>
                            <p class="text-gray-900 dark:text-white bg-gray-50 dark:bg-gray-900 p-3 rounded-lg">${order.observacoes}</p>
                        </div>
                    ` : ''}

                    <div>
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Itens, Produtos e Servi√ßos</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead class="bg-gray-50 dark:bg-gray-900">
                                    <tr>
                                        <th class="px-4 py-3 text-left">#</th>
                                        <th class="px-4 py-3 text-left">Descri√ß√£o</th>
                                        <th class="px-4 py-3 text-left">Tipo</th>
                                        <th class="px-4 py-3 text-center">Qtd.</th>
                                        <th class="px-4 py-3 text-right">Valor Unit.</th>
                                        <th class="px-4 py-3 text-right">Valor Total</th>
                                        <th class="px-4 py-3 text-left">Ocorr√™ncia</th>
                                    </tr>
                                </thead>
                                <tbody class="text-gray-900 dark:text-white">
                                    ${itemsHtml}
                                </tbody>
                                <tfoot class="font-semibold bg-gray-50 dark:bg-gray-900">
                                    <tr>
                                        <td colspan="5" class="px-4 py-3 text-right">Total Geral:</td>
                                        <td class="px-4 py-3 text-right text-green-600 dark:text-green-400">R$ ${order.totalGeral.toFixed(2).replace('.', ',')}</td>
                                        <td></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="p-6 border-t dark:border-gray-700 flex justify-end gap-3">
                    <button onclick="this.closest('.fixed').remove()" class="px-6 py-2.5 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-lg font-medium hover:bg-gray-300 dark:hover:bg-gray-600">
                        Fechar
                    </button>
                </div>
            </div>
        `;

        document.body.appendChild(modal);

    } catch (error) {
        console.error('‚ùå Erro ao visualizar detalhes:', error);
        alert('Erro ao carregar detalhes da ordem de servi√ßo.');
    }
}

function updatePagination(total) {
    const paginationText = document.querySelector('.text-sm.text-gray-700');
    if (paginationText) {
        paginationText.innerHTML = `
            Mostrando <span class="font-semibold text-gray-900 dark:text-white">1</span> a <span class="font-semibold text-gray-900 dark:text-white">${Math.min(total, 100)}</span> de <span class="font-semibold text-gray-900 dark:text-white">${total}</span>
        `;
    }
}

function setupSearch() {
    const searchInput = document.getElementById('search-input');
    if (searchInput) {
        searchInput.addEventListener('input', (e) => {
            applyAllFilters();
        });
    }
}

function setupAdvancedFilters() {
    // Toggle do painel de filtros
    const toggleBtn = document.getElementById('toggle-filters-btn');
    const filtersPanel = document.getElementById('filters-panel');

    if (toggleBtn && filtersPanel) {
        toggleBtn.addEventListener('click', () => {
            filtersPanel.classList.toggle('hidden');
        });
    }

    // Bot√£o aplicar filtros
    const applyBtn = document.getElementById('apply-filters-btn');
    if (applyBtn) {
        applyBtn.addEventListener('click', () => {
            applyAllFilters();
        });
    }

    // Bot√£o limpar filtros
    const clearBtn = document.getElementById('clear-filters-btn');
    if (clearBtn) {
        clearBtn.addEventListener('click', () => {
            clearAllFilters();
        });
    }

    // Aplicar filtros automaticamente ao mudar qualquer campo
    const filterInputs = [
        'filter-os-number', 'filter-plate', 'filter-status', 'filter-responsavel',
        'filter-date-start', 'filter-date-end', 'filter-item-type', 'filter-category',
        'filter-occurrence', 'filter-value-min', 'filter-value-max', 'filter-ano-mes'
    ];

    filterInputs.forEach(id => {
        const input = document.getElementById(id);
        if (input) {
            input.addEventListener('change', () => {
                applyAllFilters();
            });
        }
    });
}

async function applyAllFilters() {
    // Carregar da API e do localStorage
    let serviceOrders = [];

    try {
        // Tentar carregar da API primeiro
        const response = await fetch('/api/ordens-servico');
        console.log('üì° Response status:', response.status, response.ok);

        if (response.ok) {
            const apiOrders = await response.json();
            console.log('üì¶ Dados da API:', apiOrders);

            // Mapear campos da API para o formato esperado
            serviceOrders = apiOrders.map(os => ({
                osNumber: os.ordem_numero,
                dateTime: os.data_abertura,
                plate: os.placa,
                responsavel: os.responsavel,
                status: os.status,
                totalGeral: parseFloat(os.custo_total) || 0,
                items: [],
                kmVeiculo: os.km_veiculo,
                observacoes: os.observacoes,
                tipoServico: os.tipo_servico
            }));
            console.log(`‚úÖ ${serviceOrders.length} OS carregadas da API`);
        } else {
            const errorText = await response.text();
            console.error('‚ùå Erro na resposta:', errorText);
        }
    } catch (error) {
        console.error('‚ùå Erro ao carregar da API:', error);
    }

    // Mesclar com localStorage (caso tenha OS locais)
    const localOrders = JSON.parse(localStorage.getItem('serviceOrders') || '[]');
    if (localOrders.length > 0) {
        // Adicionar apenas OS locais que n√£o existem na API
        const apiOsNumbers = new Set(serviceOrders.map(os => os.osNumber));
        const uniqueLocalOrders = localOrders.filter(os => !apiOsNumbers.has(os.osNumber));
        serviceOrders = [...serviceOrders, ...uniqueLocalOrders];
    }

    // Obter valores dos filtros
    const searchTerm = document.getElementById('search-input')?.value.toLowerCase() || '';
    const filterOsNumber = document.getElementById('filter-os-number')?.value.toLowerCase() || '';
    const filterPlate = document.getElementById('filter-plate')?.value.toUpperCase() || '';
    const filterStatus = document.getElementById('filter-status')?.value || '';
    const filterResponsavel = document.getElementById('filter-responsavel')?.value || '';
    const filterDateStart = document.getElementById('filter-date-start')?.value || '';
    const filterDateEnd = document.getElementById('filter-date-end')?.value || '';
    const filterItemType = document.getElementById('filter-item-type')?.value || '';
    const filterCategory = document.getElementById('filter-category')?.value || '';
    const filterOccurrence = document.getElementById('filter-occurrence')?.value || '';
    const filterValueMin = parseFloat(document.getElementById('filter-value-min')?.value) || 0;
    const filterValueMax = parseFloat(document.getElementById('filter-value-max')?.value) || Infinity;
    const filterAnoMes = document.getElementById('filter-ano-mes')?.value || '';

    // Filtrar ordens de servi√ßo
    const filteredOrders = serviceOrders.filter(order => {
        // Filtro de busca geral
        if (searchTerm) {
            const orderText = `${order.osNumber} ${order.plate} ${order.responsavel} ${order.status}`.toLowerCase();
            if (!orderText.includes(searchTerm)) return false;
        }

        // Filtro: N√∫mero da OS
        if (filterOsNumber && !order.osNumber.toLowerCase().includes(filterOsNumber)) {
            return false;
        }

        // Filtro: Placa
        if (filterPlate && order.plate !== filterPlate) {
            return false;
        }

        // Filtro: Status
        if (filterStatus && order.status !== filterStatus) {
            return false;
        }

        // Filtro: Respons√°vel
        if (filterResponsavel && order.responsavel !== filterResponsavel) {
            return false;
        }

        // Filtro: Data Inicial
        if (filterDateStart) {
            const orderDate = new Date(order.dateTime).toISOString().split('T')[0];
            if (orderDate < filterDateStart) return false;
        }

        // Filtro: Data Final
        if (filterDateEnd) {
            const orderDate = new Date(order.dateTime).toISOString().split('T')[0];
            if (orderDate > filterDateEnd) return false;
        }

        // Filtro: Valor M√≠nimo/M√°ximo
        if (order.totalGeral < filterValueMin || order.totalGeral > filterValueMax) {
            return false;
        }

        // Filtro: Ano/M√™s
        if (filterAnoMes) {
            const anoMesFormatted = filterAnoMes.replace('-', '/');
            if (order.anoMes !== anoMesFormatted) return false;
        }

        // Filtros baseados em itens (tipo, categoria, ocorr√™ncia)
        if (filterItemType || filterCategory || filterOccurrence) {
            if (!order.items || order.items.length === 0) return false;

            const hasMatchingItem = order.items.some(item => {
                if (filterItemType && item.type !== filterItemType) return false;
                if (filterCategory && item.category !== filterCategory) return false;
                if (filterOccurrence && item.occurrence !== filterOccurrence) return false;
                return true;
            });

            if (!hasMatchingItem) return false;
        }

        return true;
    });

    // Renderizar resultados filtrados
    renderFilteredOrders(filteredOrders);

    console.log(`üîç Filtros aplicados: ${filteredOrders.length} de ${serviceOrders.length} OS encontradas`);
}

function renderFilteredOrders(orders) {
    const tbody = document.getElementById('orders-tbody');
    if (!tbody) return;

    if (orders.length === 0) {
        tbody.innerHTML = `
            <tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700">
                <td colspan="7" class="px-6 py-8 text-center text-gray-500 dark:text-gray-400">
                    <span class="material-symbols-outlined text-4xl mb-2">search_off</span>
                    <p class="text-lg font-medium">Nenhuma ordem de servi√ßo encontrada</p>
                    <p class="text-sm mt-2">Tente ajustar os filtros de pesquisa</p>
                </td>
            </tr>
        `;
        return;
    }

    tbody.innerHTML = orders.map(order => {
        const date = new Date(order.dateTime);
        const formattedDate = date.toLocaleDateString('pt-BR');

        const statusColors = {
            'Diagn√≥stico': 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300',
            'Or√ßamento': 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300',
            'Execu√ß√£o': 'bg-orange-100 text-orange-800 dark:bg-orange-900 dark:text-orange-300',
            'Finalizada': 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300'
        };

        const statusClass = statusColors[order.status] || 'bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-300';

        return `
            <tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">
                <td class="px-6 py-4 font-medium">${order.osNumber}</td>
                <td class="px-6 py-4">${formattedDate}</td>
                <td class="px-6 py-4 font-mono">${order.plate}</td>
                <td class="px-6 py-4">${order.responsavel}</td>
                <td class="px-6 py-4">
                    <span class="px-2 py-1 rounded text-xs font-medium ${statusClass}">
                        ${order.status}
                    </span>
                </td>
                <td class="px-6 py-4 font-medium">R$ ${order.totalGeral.toFixed(2).replace('.', ',')}</td>
                <td class="px-6 py-4">
                    <div class="flex items-center gap-2">
                        <button class="text-blue-600 hover:text-blue-800 dark:text-blue-400" title="Visualizar" onclick="viewOS('${order.osNumber}')">
                            <span class="material-symbols-outlined">visibility</span>
                        </button>
                        <button class="text-green-600 hover:text-green-800 dark:text-green-400" title="Editar" onclick="editOS('${order.osNumber}')">
                            <span class="material-symbols-outlined">edit</span>
                        </button>
                        <button class="text-red-600 hover:text-red-800 dark:text-red-400" title="Excluir" onclick="deleteOS('${order.osNumber}')">
                            <span class="material-symbols-outlined">delete</span>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
}

function clearAllFilters() {
    // Limpar todos os inputs de filtro
    document.getElementById('search-input').value = '';
    document.getElementById('filter-os-number').value = '';
    document.getElementById('filter-plate').value = '';
    document.getElementById('filter-status').value = '';
    document.getElementById('filter-responsavel').value = '';
    document.getElementById('filter-date-start').value = '';
    document.getElementById('filter-date-end').value = '';
    document.getElementById('filter-item-type').value = '';
    document.getElementById('filter-category').value = '';
    document.getElementById('filter-occurrence').value = '';
    document.getElementById('filter-value-min').value = '';
    document.getElementById('filter-value-max').value = '';
    document.getElementById('filter-ano-mes').value = '';

    // Reaplicar filtros (que agora est√£o vazios)
    applyAllFilters();

    console.log('üßπ Filtros limpos');
}

// Vari√°vel global para armazenar a OS sendo editada
let currentEditingOS = null;

async function editOS(osNumber) {
    // Primeiro tentar buscar da API
    let order = null;

    try {
        const response = await fetch('/api/ordens-servico');
        if (response.ok) {
            const apiOrders = await response.json();
            const apiOrder = apiOrders.find(o => o.ordem_numero === osNumber);

            if (apiOrder) {
                // Buscar detalhes completos da OS (incluindo itens)
                try {
                    const detailsResponse = await fetch(`/api/ordens-servico/${apiOrder.id}`);
                    if (detailsResponse.ok) {
                        const details = await detailsResponse.json();

                        // Mapear campos da API para o formato esperado
                        order = {
                            id: details.id,
                            osNumber: details.ordem_numero,
                            dateTime: details.data_abertura,
                            plate: details.placa_veiculo,
                            responsavel: details.responsavel,
                            status: details.status,
                            totalGeral: parseFloat(details.custo_total) || 0,
                            km: details.km_veiculo,
                            observacoes: details.observacoes,
                            tipoServico: details.tipo_servico || details.ocorrencia,
                            items: [],
                            dates: {
                                diagnostico: details.data_diagnostico,
                                orcamento: details.data_orcamento,
                                execucao: details.data_execucao,
                                finalizacao: details.data_finalizacao
                            }
                        };

                        // Mapear itens se existirem
                        if (details.itens && Array.isArray(details.itens)) {
                            order.items = details.itens.map(item => ({
                                type: item.tipo || 'Servi√ßo',
                                description: item.descricao,
                                category: item.categoria || '',
                                qty: item.quantidade || 1,
                                value: parseFloat(item.valor_unitario) || 0,
                                total: parseFloat(item.valor_total) || (item.quantidade * parseFloat(item.valor_unitario)) || 0,
                                occurrence: item.ocorrencia || 'corretivo'
                            }));
                        }

                        console.log('‚úÖ OS carregada da API com itens:', order);
                    }
                } catch (e) {
                    console.error('Erro ao buscar detalhes da OS:', e);

                    // Fallback: usar dados b√°sicos
                    order = {
                        id: apiOrder.id,
                        osNumber: apiOrder.ordem_numero,
                        dateTime: apiOrder.data_abertura,
                        plate: apiOrder.placa,
                        responsavel: apiOrder.responsavel,
                        status: apiOrder.status,
                        totalGeral: parseFloat(apiOrder.custo_total) || 0,
                        km: apiOrder.km_veiculo,
                        observacoes: apiOrder.observacoes,
                        tipoServico: apiOrder.tipo_servico,
                        items: [],
                        dates: {
                            diagnostico: null,
                            orcamento: null,
                            execucao: null,
                            finalizacao: null
                        }
                    };
                }
            }
        }
    } catch (error) {
        console.error('Erro ao buscar OS da API:', error);
    }

    // Se n√£o encontrou na API, tentar no localStorage
    if (!order) {
        const serviceOrders = JSON.parse(localStorage.getItem('serviceOrders') || '[]');
        order = serviceOrders.find(o => o.osNumber === osNumber);
    }

    if (!order) {
        alert('Ordem de servi√ßo n√£o encontrada!');
        return;
    }

    currentEditingOS = order;

    // Verificar se est√° finalizada
    const isFinalized = order.status === 'Finalizada';
    const readonlyWarning = document.getElementById('readonly-warning');
    const saveBtn = document.getElementById('save-edit-btn');
    const form = document.getElementById('edit-os-form');

    if (isFinalized) {
        readonlyWarning.classList.remove('hidden');
        saveBtn.disabled = true;
        saveBtn.classList.add('opacity-50', 'cursor-not-allowed');

        // Desabilitar todos os campos do formul√°rio
        form.querySelectorAll('input, select, textarea').forEach(field => {
            field.disabled = true;
        });
    } else {
        readonlyWarning.classList.add('hidden');
        saveBtn.disabled = false;
        saveBtn.classList.remove('opacity-50', 'cursor-not-allowed');

        // Habilitar campos (exceto placa)
        form.querySelectorAll('input:not(#edit-plate), select, textarea').forEach(field => {
            field.disabled = false;
        });
    }

    // Preencher dados do modal
    document.getElementById('edit-os-number').textContent = order.osNumber;
    document.getElementById('edit-datetime').value = order.dateTime ? new Date(order.dateTime).toISOString().slice(0, 16) : '';
    document.getElementById('edit-responsavel').value = order.responsavel || '';
    document.getElementById('edit-status').value = order.status || '';
    document.getElementById('edit-plate').value = order.plate || '';
    document.getElementById('edit-km').value = order.km || '';
    document.getElementById('edit-observacoes').value = order.observacoes || '';

    // Preencher datas de acompanhamento
    if (order.dates) {
        document.getElementById('edit-date-diagnostico').value = order.dates.diagnostico ? new Date(order.dates.diagnostico).toISOString().slice(0, 16) : '';
        document.getElementById('edit-date-orcamento').value = order.dates.orcamento ? new Date(order.dates.orcamento).toISOString().slice(0, 16) : '';
        document.getElementById('edit-date-execucao').value = order.dates.execucao ? new Date(order.dates.execucao).toISOString().slice(0, 16) : '';
        document.getElementById('edit-date-finalizacao').value = order.dates.finalizacao ? new Date(order.dates.finalizacao).toISOString().slice(0, 16) : '';
    }

    // Preencher itens
    const itemsTbody = document.getElementById('edit-items-tbody');
    itemsTbody.innerHTML = order.items.map((item, index) => `
        <tr class="bg-white dark:bg-gray-800" data-item-index="${index}">
            <td class="px-3 py-2">${item.type}</td>
            <td class="px-3 py-2">${item.description}</td>
            <td class="px-3 py-2">${item.category || '-'}</td>
            <td class="px-3 py-2 text-center">${item.qty}</td>
            <td class="px-3 py-2 text-right">R$ ${item.value.toFixed(2).replace('.', ',')}</td>
            <td class="px-3 py-2 text-right">R$ ${item.total.toFixed(2).replace('.', ',')}</td>
            <td class="px-3 py-2">${item.occurrence || '-'}</td>
            <td class="px-3 py-2 text-center">
                ${!isFinalized ? `
                    <button type="button" onclick="removeItemFromOS(${index})" class="text-red-600 hover:text-red-800 dark:text-red-400" title="Remover">
                        <span class="material-symbols-outlined text-base">delete</span>
                    </button>
                ` : ''}
            </td>
        </tr>
    `).join('');

    document.getElementById('edit-total-geral').textContent = `R$ ${order.totalGeral.toFixed(2).replace('.', ',')}`;

    // Configurar bot√£o "Adicionar Servi√ßo"
    const addServiceBtn = document.getElementById('add-service-btn');
    if (addServiceBtn) {
        addServiceBtn.onclick = () => addNewServiceToOS();
        addServiceBtn.disabled = isFinalized;
        if (isFinalized) {
            addServiceBtn.classList.add('opacity-50', 'cursor-not-allowed');
        } else {
            addServiceBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        }
    }

    // DEBUG: Log observa√ß√µes
    console.log('üìù Observa√ß√µes carregadas:', order.observacoes);
    console.log('üìù Campo textarea preenchido:', document.getElementById('edit-observacoes').value);

    // Mostrar modal
    document.getElementById('edit-os-modal').classList.remove('hidden');
}

function closeEditModal() {
    document.getElementById('edit-os-modal').classList.add('hidden');
    currentEditingOS = null;

    // Remover dropdown fixo se existir
    const dropdown = document.getElementById('new-service-dropdown-fixed');
    if (dropdown) {
        dropdown.remove();
    }

    // Mostrar bot√£o salvar novamente (caso tenha sido ocultado no modo visualiza√ß√£o)
    document.getElementById('save-edit-btn').classList.remove('hidden');
}

async function viewOS(osNumber) {
    await editOS(osNumber);
    // Desabilitar todos os campos para visualiza√ß√£o
    const form = document.getElementById('edit-os-form');
    form.querySelectorAll('input, select, textarea').forEach(field => {
        field.disabled = true;
    });
    document.getElementById('save-edit-btn').classList.add('hidden');
}

async function deleteOS(osNumber) {
    if (!confirm(`Tem certeza que deseja excluir a OS ${osNumber}?`)) {
        return;
    }

    try {
        // Excluir da API
        const response = await fetch(`/api/ordens-servico?ordem_numero=${encodeURIComponent(osNumber)}`, {
            method: 'DELETE'
        });

        if (response.ok) {
            console.log(`üóëÔ∏è OS ${osNumber} exclu√≠da da API`);
        } else {
            console.error('Erro ao excluir da API:', await response.text());
        }
    } catch (error) {
        console.error('Erro ao excluir da API:', error);
    }

    // Tamb√©m excluir do localStorage (backup)
    const serviceOrders = JSON.parse(localStorage.getItem('serviceOrders') || '[]');
    const filteredOrders = serviceOrders.filter(o => o.osNumber !== osNumber);
    localStorage.setItem('serviceOrders', JSON.stringify(filteredOrders));

    console.log(`üóëÔ∏è OS ${osNumber} exclu√≠da`);

    // Recarregar a lista
    applyAllFilters();
}

// Event listener para o formul√°rio de edi√ß√£o
document.addEventListener('DOMContentLoaded', () => {
    const editForm = document.getElementById('edit-os-form');
    if (editForm) {
        editForm.addEventListener('submit', (e) => {
            e.preventDefault();
            saveEditedOS();
        });
    }
});

async function saveEditedOS() {
    if (!currentEditingOS) return;

    if (currentEditingOS.status === 'Finalizada') {
        alert('N√£o √© poss√≠vel editar uma OS finalizada!');
        return;
    }

    // DEBUG: Verificar observa√ß√µes antes de salvar
    const observacoesField = document.getElementById('edit-observacoes');
    console.log('üíæ Salvando OS...');
    console.log('   Campo observacoes existe?', !!observacoesField);
    console.log('   Valor do campo:', observacoesField?.value);
    console.log('   Disabled?', observacoesField?.disabled);

    // Coletar dados do formul√°rio
    const observacoesValue = observacoesField ? observacoesField.value : '';

    const updatedData = {
        ...currentEditingOS,
        dateTime: document.getElementById('edit-datetime').value ? new Date(document.getElementById('edit-datetime').value).toISOString() : currentEditingOS.dateTime,
        responsavel: document.getElementById('edit-responsavel').value,
        status: document.getElementById('edit-status').value,
        km: parseInt(document.getElementById('edit-km').value),
        observacoes: observacoesValue,
        dates: {
            diagnostico: document.getElementById('edit-date-diagnostico').value ? new Date(document.getElementById('edit-date-diagnostico').value).toISOString() : null,
            orcamento: document.getElementById('edit-date-orcamento').value ? new Date(document.getElementById('edit-date-orcamento').value).toISOString() : null,
            execucao: document.getElementById('edit-date-execucao').value ? new Date(document.getElementById('edit-date-execucao').value).toISOString() : null,
            finalizacao: document.getElementById('edit-date-finalizacao').value ? new Date(document.getElementById('edit-date-finalizacao').value).toISOString() : null
        },
        updatedAt: new Date().toISOString()
    };

    console.log('   Observa√ß√µes que ser√£o salvas:', updatedData.observacoes);

    // Verificar mudan√ßa de status
    const statusChanged = currentEditingOS.status !== updatedData.status;
    const wasFinalized = updatedData.status === 'Finalizada';

    // Salvar na API
    try {
        const osId = currentEditingOS.id || currentEditingOS.osNumber;
        const response = await fetch(`/api/ordens-servico/${osId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                placa_veiculo: currentEditingOS.plate,
                km_veiculo: updatedData.km,
                responsavel: updatedData.responsavel,
                status: updatedData.status,
                observacoes: updatedData.observacoes,
                ocorrencia: currentEditingOS.tipoServico || 'Corretiva'
            })
        });

        if (response.ok) {
            console.log('‚úÖ OS atualizada na API');
        } else {
            console.error('Erro ao atualizar na API:', await response.text());
        }
    } catch (error) {
        console.error('Erro ao atualizar na API:', error);
    }

    // Tamb√©m atualizar no localStorage (backup)
    const serviceOrders = JSON.parse(localStorage.getItem('serviceOrders') || '[]');
    const index = serviceOrders.findIndex(o => o.osNumber === currentEditingOS.osNumber);

    if (index !== -1) {
        serviceOrders[index] = updatedData;
        localStorage.setItem('serviceOrders', JSON.stringify(serviceOrders));
    }

    console.log('‚úÖ OS atualizada:', updatedData);

    // Logs de manuten√ß√£o
    if (statusChanged) {
        if (wasFinalized) {
            console.log(`‚úÖ Ve√≠culo ${updatedData.plate} SAIU da manuten√ß√£o (OS finalizada)`);
            alert(`Ordem de servi√ßo finalizada!\nVe√≠culo ${updatedData.plate} n√£o est√° mais em manuten√ß√£o.`);
        } else {
            console.log(`üîß Status da OS alterado para: ${updatedData.status}`);
            alert('Ordem de servi√ßo atualizada com sucesso!');
        }
    } else {
        alert('Ordem de servi√ßo atualizada com sucesso!');
    }

    closeEditModal();

    // Recarregar a lista
    applyAllFilters();
}

// Vari√°vel para armazenar dados de servi√ßos e produtos
let servicesDataForEdit = null;

// Carregar dados de servi√ßos e produtos
async function loadServicesDataForEdit() {
    if (servicesDataForEdit) return servicesDataForEdit;

    try {
        const response = await fetch('services-data.json');
        servicesDataForEdit = await response.json();

        // Carregar itens customizados do localStorage
        const storageKey = 'fleetflow_custom_items';
        const customItems = JSON.parse(localStorage.getItem(storageKey) || '{"services": [], "products": []}');

        if (customItems.services && customItems.services.length > 0) {
            servicesDataForEdit.services = [...servicesDataForEdit.services, ...customItems.services];
        }

        if (customItems.products && customItems.products.length > 0) {
            servicesDataForEdit.products = [...servicesDataForEdit.products, ...customItems.products];
        }

        console.log('‚úÖ Dados de servi√ßos carregados para edi√ß√£o');
        return servicesDataForEdit;
    } catch (error) {
        console.error('‚ùå Erro ao carregar dados:', error);
        return null;
    }
}

// Adicionar novo servi√ßo √† OS
async function addNewServiceToOS() {
    if (!currentEditingOS) return;

    // Carregar dados se ainda n√£o foram carregados
    await loadServicesDataForEdit();

    // Criar linha edit√°vel
    const itemsTbody = document.getElementById('edit-items-tbody');
    const newRow = document.createElement('tr');
    newRow.className = 'bg-white dark:bg-gray-800 border-2 border-green-500 new-service-row';
    newRow.innerHTML = `
        <td class="px-3 py-2">
            <select class="form-select w-full bg-gray-50 dark:bg-gray-900 border-gray-300 dark:border-gray-600 rounded h-9 text-sm new-item-type" onchange="onNewServiceTypeChange(this)">
                <option value="">Selecione...</option>
                <option value="service">Servi√ßo</option>
                <option value="product">Produto</option>
            </select>
        </td>
        <td class="px-3 py-2">
            <div class="relative new-service-dropdown-container">
                <input type="text"
                       class="form-input w-full bg-gray-50 dark:bg-gray-900 border-gray-300 dark:border-gray-600 rounded h-9 text-sm new-item-description"
                       placeholder="Selecione o tipo primeiro..."
                       disabled
                       autocomplete="off"
                       style="padding-right: 40px;"/>
                <button type="button" class="absolute right-2 top-1/2 -translate-y-1/2 text-primary new-item-dropdown-btn" style="pointer-events: auto;">
                    <span class="material-symbols-outlined text-xl">arrow_drop_down</span>
                </button>
            </div>
        </td>
        <td class="px-3 py-2">
            <select class="form-select w-full bg-gray-50 dark:bg-gray-900 border-gray-300 dark:border-gray-600 rounded h-9 text-sm new-item-category" disabled>
                <option value="">Aguardando...</option>
            </select>
        </td>
        <td class="px-3 py-2">
            <input type="number" min="1" value="1" class="form-input w-20 text-center bg-gray-50 dark:bg-gray-900 border-gray-300 dark:border-gray-600 rounded h-9 text-sm new-item-qty" onchange="updateNewItemTotal(this)"/>
        </td>
        <td class="px-3 py-2">
            <input type="number" step="0.01" min="0" class="form-input w-28 text-right bg-gray-50 dark:bg-gray-900 border-gray-300 dark:border-gray-600 rounded h-9 text-sm new-item-value" placeholder="0,00" onchange="updateNewItemTotal(this)"/>
        </td>
        <td class="px-3 py-2 text-right font-medium new-item-total">R$ 0,00</td>
        <td class="px-3 py-2">
            <select class="form-select w-full bg-gray-50 dark:bg-gray-900 border-gray-300 dark:border-gray-600 rounded h-9 text-sm new-item-occurrence">
                <option value="preventivo">Preventivo</option>
                <option value="corretivo">Corretivo</option>
            </select>
        </td>
        <td class="px-3 py-2 text-center">
            <button type="button" onclick="confirmNewService(this)" class="text-green-600 hover:text-green-800 dark:text-green-400 mr-2" title="Confirmar">
                <span class="material-symbols-outlined text-base">check</span>
            </button>
            <button type="button" onclick="cancelNewService(this)" class="text-red-600 hover:text-red-800 dark:text-red-400" title="Cancelar">
                <span class="material-symbols-outlined text-base">close</span>
            </button>
        </td>
    `;

    itemsTbody.appendChild(newRow);

    // Focar no campo de tipo
    newRow.querySelector('.new-item-type').focus();
}

// Quando muda o tipo (Servi√ßo/Produto)
function onNewServiceTypeChange(selectElement) {
    const row = selectElement.closest('tr');
    const type = selectElement.value;
    const descriptionInput = row.querySelector('.new-item-description');
    const categorySelect = row.querySelector('.new-item-category');
    const dropdown = row.querySelector('.new-item-dropdown');

    if (!type) {
        descriptionInput.disabled = true;
        descriptionInput.placeholder = 'Selecione o tipo primeiro...';
        categorySelect.disabled = true;
        categorySelect.innerHTML = '<option value="">Aguardando...</option>';
        return;
    }

    // Habilita campo de descri√ß√£o
    descriptionInput.disabled = false;
    descriptionInput.placeholder = `Digite para buscar ${type === 'service' ? 'servi√ßo' : 'produto'}...`;
    descriptionInput.value = '';

    // Habilita campo de categoria
    categorySelect.disabled = false;
    populateCategoriesForNewService(categorySelect);

    // Configura autocomplete
    setupAutocompleteForNewService(row, type);
}

// Preencher categorias
function populateCategoriesForNewService(selectElement) {
    if (!servicesDataForEdit) return;

    selectElement.innerHTML = '<option value="">Todos</option>';
    servicesDataForEdit.categories.forEach(cat => {
        const option = document.createElement('option');
        option.value = cat;
        option.textContent = formatCategoryNameForEdit(cat);
        selectElement.appendChild(option);
    });
}

// Formatar nome da categoria
function formatCategoryNameForEdit(category) {
    const names = {
        'pneus': 'Pneus',
        'munck': 'Munck',
        'carroceria': 'Carroceria',
        'motor': 'Motor',
        'caixa': 'Caixa',
        'limpeza': 'Limpeza',
        'cambio': 'C√¢mbio',
        'suspensao': 'Suspens√£o',
        'eletrica': 'El√©trica',
        'freio': 'Freio'
    };
    return names[category] || category;
}

// Configurar autocomplete para novo servi√ßo
function setupAutocompleteForNewService(row, type) {
    const input = row.querySelector('.new-item-description');
    const categorySelect = row.querySelector('.new-item-category');
    const dropdownBtn = row.querySelector('.new-item-dropdown-btn');
    let currentDropdown = null;

    // Evento de digita√ß√£o
    input.addEventListener('input', () => {
        const searchTerm = input.value.trim().toLowerCase();
        const selectedCategory = categorySelect.value;

        let items = type === 'service' ? servicesDataForEdit.services : servicesDataForEdit.products;

        // Filtrar por categoria
        if (selectedCategory) {
            items = items.filter(item => item.category === selectedCategory);
        }

        // Filtrar por termo de busca
        if (searchTerm) {
            items = items.filter(item => item.name.toLowerCase().includes(searchTerm));
        }

        currentDropdown = renderDropdownForNewService(null, items, input, row, type);
    });

    // Evento de clique no bot√£o
    if (dropdownBtn) {
        dropdownBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();

            // Se j√° existe dropdown, remove
            const existingDropdown = document.getElementById('new-service-dropdown-fixed');
            if (existingDropdown) {
                existingDropdown.remove();
                currentDropdown = null;
                return;
            }

            const selectedCategory = categorySelect.value;
            let items = type === 'service' ? servicesDataForEdit.services : servicesDataForEdit.products;

            if (selectedCategory) {
                items = items.filter(item => item.category === selectedCategory);
            }

            currentDropdown = renderDropdownForNewService(null, items, input, row, type);
        });
    }

    // Fechar ao clicar fora
    setTimeout(() => {
        document.addEventListener('click', (e) => {
            const dropdown = document.getElementById('new-service-dropdown-fixed');
            if (dropdown && !row.contains(e.target) && !dropdown.contains(e.target)) {
                dropdown.remove();
                currentDropdown = null;
            }
        });
    }, 100);

    // Evento de mudan√ßa de categoria
    categorySelect.addEventListener('change', () => {
        if (input.value) {
            input.dispatchEvent(new Event('input'));
        }
    });
}

// Renderizar dropdown com position fixed
function renderDropdownForNewService(dropdownPlaceholder, items, input, row, type) {
    // Remover dropdown existente se houver
    const existingDropdown = document.getElementById('new-service-dropdown-fixed');
    if (existingDropdown) {
        existingDropdown.remove();
    }

    // Criar novo dropdown com position fixed
    const dropdown = document.createElement('div');
    dropdown.id = 'new-service-dropdown-fixed';
    dropdown.className = 'bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg shadow-xl max-h-60 overflow-y-auto';
    dropdown.style.position = 'fixed';
    dropdown.style.zIndex = '10000';
    dropdown.style.minWidth = '300px';

    // Calcular posi√ß√£o
    const inputRect = input.getBoundingClientRect();
    dropdown.style.top = `${inputRect.bottom + 4}px`;
    dropdown.style.left = `${inputRect.left}px`;
    dropdown.style.width = `${inputRect.width}px`;

    if (items.length === 0) {
        dropdown.innerHTML = `
            <div class="p-4 text-center">
                <p class="text-sm text-gray-500 dark:text-gray-400 mb-3">Nenhum item encontrado</p>
                <button type="button" class="px-4 py-2 bg-primary text-white rounded-lg text-sm hover:bg-primary/90" onclick="showAddNewModalForEdit('${type}')">
                    + Cadastrar novo item
                </button>
            </div>
        `;
    } else {
        dropdown.innerHTML = items.map(item => `
            <div class="item-option px-4 py-3 hover:bg-blue-50 dark:hover:bg-blue-900/20 cursor-pointer border-b border-gray-100 dark:border-gray-700 last:border-b-0"
                 data-name="${item.name}"
                 data-price="${item.defaultPrice}"
                 data-category="${item.category}">
                <div class="font-semibold text-primary dark:text-blue-400">${item.name}</div>
                <div class="text-sm text-gray-600 dark:text-gray-400 mt-1">
                    ${formatCategoryNameForEdit(item.category)} ‚Ä¢ R$ ${item.defaultPrice.toFixed(2).replace('.', ',')}
                </div>
            </div>
        `).join('') + `
            <div class="border-t border-gray-200 dark:border-gray-700 p-3 bg-gray-50 dark:bg-gray-800/50">
                <button type="button" class="text-primary hover:text-primary/80 text-sm font-medium w-full text-center" onclick="showAddNewModalForEdit('${type}')">
                    + Cadastrar novo item
                </button>
            </div>
        `;

        // Adicionar event listeners
        dropdown.querySelectorAll('.item-option').forEach(option => {
            option.addEventListener('click', () => {
                const name = option.dataset.name;
                const price = parseFloat(option.dataset.price);
                const category = option.dataset.category;

                input.value = name;
                row.querySelector('.new-item-value').value = price.toFixed(2);
                row.querySelector('.new-item-category').value = category;
                updateNewItemTotal(row.querySelector('.new-item-value'));

                dropdown.remove();
            });
        });
    }

    // Adicionar ao body
    document.body.appendChild(dropdown);

    // Atualizar posi√ß√£o ao fazer scroll do modal
    const modal = document.getElementById('edit-os-modal');
    const modalContent = modal?.querySelector('.max-h-\\[90vh\\]');

    if (modalContent) {
        modalContent.addEventListener('scroll', () => {
            const newRect = input.getBoundingClientRect();
            dropdown.style.top = `${newRect.bottom + 4}px`;
            dropdown.style.left = `${newRect.left}px`;
        });
    }

    // Retornar refer√™ncia ao dropdown
    return dropdown;
}

// Mostrar modal para cadastrar novo item
function showAddNewModalForEdit(type) {
    // Fechar todos os dropdowns
    document.querySelectorAll('.new-item-dropdown').forEach(d => d.classList.add('hidden'));

    // Usar o modal existente
    const modal = document.getElementById('new-item-modal');
    if (!modal) {
        // Criar modal se n√£o existir
        const modalHTML = `
            <div id="new-item-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[10000] flex items-center justify-center">
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-md w-full mx-4">
                    <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                        <div class="flex items-center justify-between">
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
                                Cadastrar Novo <span id="modal-type-label">Item</span>
                            </h3>
                            <button onclick="closeNewItemModalForEdit()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                                <span class="material-symbols-outlined">close</span>
                            </button>
                        </div>
                    </div>

                    <form id="new-item-form-edit" class="p-6 space-y-4" onsubmit="saveNewItemForEdit(event)">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Nome <span class="text-red-500">*</span>
                            </label>
                            <input type="text" id="modal-item-name-edit" required
                                   class="form-input w-full bg-gray-50 dark:bg-gray-800 border-gray-300 dark:border-gray-600 rounded h-10 text-sm"
                                   placeholder="Ex: Troca de √≥leo, Filtro de ar..."/>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Categoria <span class="text-red-500">*</span>
                            </label>
                            <select id="modal-item-category-edit" required
                                    class="form-select w-full bg-gray-50 dark:bg-gray-800 border-gray-300 dark:border-gray-600 rounded h-10 text-sm">
                                <option value="">Selecione...</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Pre√ßo Padr√£o <span class="text-red-500">*</span>
                            </label>
                            <input type="text" id="modal-item-price-edit" required
                                   class="form-input w-full bg-gray-50 dark:bg-gray-800 border-gray-300 dark:border-gray-600 rounded h-10 text-sm"
                                   placeholder="Ex: 150,00"/>
                        </div>

                        <div class="flex justify-end gap-3 pt-4">
                            <button type="button" onclick="closeNewItemModalForEdit()"
                                    class="px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-lg text-sm font-medium hover:bg-gray-300 dark:hover:bg-gray-600">
                                Cancelar
                            </button>
                            <button type="submit"
                                    class="px-4 py-2 bg-primary text-white rounded-lg text-sm font-medium hover:bg-primary/90">
                                Cadastrar
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHTML);
    }

    const modalEl = document.getElementById('new-item-modal');
    const typeLabel = document.getElementById('modal-type-label');
    const categorySelect = document.getElementById('modal-item-category-edit');

    // Definir tipo do item
    const typeName = type === 'service' ? 'Servi√ßo' : 'Produto';
    typeLabel.textContent = typeName;
    modalEl.dataset.itemType = type;

    // Preencher categorias
    categorySelect.innerHTML = '<option value="">Selecione...</option>';
    servicesDataForEdit.categories.forEach(cat => {
        const option = document.createElement('option');
        option.value = cat;
        option.textContent = formatCategoryNameForEdit(cat);
        categorySelect.appendChild(option);
    });

    // Limpar campos
    document.getElementById('modal-item-name-edit').value = '';
    document.getElementById('modal-item-category-edit').value = '';
    document.getElementById('modal-item-price-edit').value = '';

    // Mostrar modal
    modalEl.classList.remove('hidden');
}

// Fechar modal
function closeNewItemModalForEdit() {
    const modal = document.getElementById('new-item-modal');
    if (modal) {
        modal.classList.add('hidden');
    }
}

// Salvar novo item
function saveNewItemForEdit(event) {
    event.preventDefault();

    const modal = document.getElementById('new-item-modal');
    const type = modal.dataset.itemType;
    const name = document.getElementById('modal-item-name-edit').value.trim();
    const category = document.getElementById('modal-item-category-edit').value;
    const priceStr = document.getElementById('modal-item-price-edit').value.trim();

    // Valida√ß√µes
    if (!name || !category || !priceStr) {
        alert('Por favor, preencha todos os campos!');
        return;
    }

    // Converter pre√ßo
    const price = parseFloat(priceStr.replace(',', '.'));
    if (isNaN(price) || price <= 0) {
        alert('Por favor, informe um pre√ßo v√°lido!');
        return;
    }

    // Criar novo item
    const newItem = {
        id: `${type === 'service' ? 'srv' : 'prd'}${Date.now()}`,
        name,
        category,
        defaultPrice: price
    };

    // Adicionar ao array
    if (type === 'service') {
        servicesDataForEdit.services.push(newItem);
    } else {
        servicesDataForEdit.products.push(newItem);
    }

    // Salvar no localStorage
    const storageKey = 'fleetflow_custom_items';
    const customItems = JSON.parse(localStorage.getItem(storageKey) || '{"services": [], "products": []}');

    if (type === 'service') {
        customItems.services.push(newItem);
    } else {
        customItems.products.push(newItem);
    }

    localStorage.setItem(storageKey, JSON.stringify(customItems));

    console.log('‚úÖ Novo item cadastrado:', newItem);

    // Fechar modal
    closeNewItemModalForEdit();

    // Auto-selecionar o item na linha
    const newServiceRow = document.querySelector('.new-service-row');
    if (newServiceRow) {
        const descriptionInput = newServiceRow.querySelector('.new-item-description');
        const valueInput = newServiceRow.querySelector('.new-item-value');
        const categorySelect = newServiceRow.querySelector('.new-item-category');

        descriptionInput.value = name;
        valueInput.value = price.toFixed(2);
        categorySelect.value = category;
        updateNewItemTotal(valueInput);
    }

    alert(`${type === 'service' ? 'Servi√ßo' : 'Produto'} "${name}" cadastrado com sucesso!`);
}

// Atualizar total do novo item
function updateNewItemTotal(input) {
    const row = input.closest('tr');
    const qtyInput = row.querySelector('.new-item-qty');
    const valueInput = row.querySelector('.new-item-value');
    const totalCell = row.querySelector('.new-item-total');

    const qty = parseFloat(qtyInput.value) || 0;
    const value = parseFloat(valueInput.value) || 0;
    const total = qty * value;

    totalCell.textContent = `R$ ${total.toFixed(2).replace('.', ',')}`;
}

// Confirmar novo servi√ßo
function confirmNewService(btn) {
    const row = btn.closest('tr');

    // Coletar dados
    const typeValue = row.querySelector('.new-item-type').value;
    const type = typeValue === 'service' ? 'Servi√ßo' : 'Produto';
    const description = row.querySelector('.new-item-description').value.trim();
    const category = row.querySelector('.new-item-category').value;
    const qty = parseFloat(row.querySelector('.new-item-qty').value) || 1;
    const valueStr = row.querySelector('.new-item-value').value;
    const value = parseFloat(valueStr.toString().replace(',', '.')) || 0;
    const occurrence = row.querySelector('.new-item-occurrence').value;

    // Valida√ß√µes
    if (!typeValue) {
        alert('Por favor, selecione o tipo (Servi√ßo ou Produto)!');
        row.querySelector('.new-item-type').focus();
        return;
    }

    if (!description) {
        alert('Por favor, informe a descri√ß√£o do servi√ßo!');
        row.querySelector('.new-item-description').focus();
        return;
    }

    if (value <= 0) {
        alert('Por favor, informe um valor v√°lido!');
        row.querySelector('.new-item-value').focus();
        return;
    }

    // Criar objeto do item
    const newItem = {
        type,
        description,
        category,
        qty,
        value,
        total: qty * value,
        occurrence
    };

    // Adicionar ao array de itens da OS atual
    currentEditingOS.items.push(newItem);

    // Recalcular total
    currentEditingOS.totalGeral = currentEditingOS.items.reduce((sum, item) => sum + item.total, 0);

    // Remover linha de edi√ß√£o e recarregar itens
    row.remove();

    // Remover dropdown fixo se existir
    const dropdown = document.getElementById('new-service-dropdown-fixed');
    if (dropdown) {
        dropdown.remove();
    }

    // Atualizar visualiza√ß√£o
    const itemsTbody = document.getElementById('edit-items-tbody');
    const isFinalized = currentEditingOS.status === 'Finalizada';

    itemsTbody.innerHTML = currentEditingOS.items.map((item, index) => `
        <tr class="bg-white dark:bg-gray-800" data-item-index="${index}">
            <td class="px-3 py-2">${item.type}</td>
            <td class="px-3 py-2">${item.description}</td>
            <td class="px-3 py-2">${item.category || '-'}</td>
            <td class="px-3 py-2 text-center">${item.qty}</td>
            <td class="px-3 py-2 text-right">R$ ${item.value.toFixed(2).replace('.', ',')}</td>
            <td class="px-3 py-2 text-right">R$ ${item.total.toFixed(2).replace('.', ',')}</td>
            <td class="px-3 py-2">${item.occurrence || '-'}</td>
            <td class="px-3 py-2 text-center">
                ${!isFinalized ? `
                    <button type="button" onclick="removeItemFromOS(${index})" class="text-red-600 hover:text-red-800 dark:text-red-400" title="Remover">
                        <span class="material-symbols-outlined text-base">delete</span>
                    </button>
                ` : ''}
            </td>
        </tr>
    `).join('');

    document.getElementById('edit-total-geral').textContent = `R$ ${currentEditingOS.totalGeral.toFixed(2).replace('.', ',')}`;

    console.log('‚úÖ Novo servi√ßo adicionado:', newItem);
}

// Cancelar novo servi√ßo
function cancelNewService(btn) {
    btn.closest('tr').remove();

    // Remover dropdown fixo se existir
    const dropdown = document.getElementById('new-service-dropdown-fixed');
    if (dropdown) {
        dropdown.remove();
    }
}

// Remover item da OS
function removeItemFromOS(itemIndex) {
    if (!confirm('Deseja realmente remover este item?')) return;

    // Remover do array
    currentEditingOS.items.splice(itemIndex, 1);

    // Recalcular total
    currentEditingOS.totalGeral = currentEditingOS.items.reduce((sum, item) => sum + item.total, 0);

    // Atualizar visualiza√ß√£o
    const itemsTbody = document.getElementById('edit-items-tbody');
    const isFinalized = currentEditingOS.status === 'Finalizada';

    itemsTbody.innerHTML = currentEditingOS.items.map((item, index) => `
        <tr class="bg-white dark:bg-gray-800" data-item-index="${index}">
            <td class="px-3 py-2">${item.type}</td>
            <td class="px-3 py-2">${item.description}</td>
            <td class="px-3 py-2">${item.category || '-'}</td>
            <td class="px-3 py-2 text-center">${item.qty}</td>
            <td class="px-3 py-2 text-right">R$ ${item.value.toFixed(2).replace('.', ',')}</td>
            <td class="px-3 py-2 text-right">R$ ${item.total.toFixed(2).replace('.', ',')}</td>
            <td class="px-3 py-2">${item.occurrence || '-'}</td>
            <td class="px-3 py-2 text-center">
                ${!isFinalized ? `
                    <button type="button" onclick="removeItemFromOS(${index})" class="text-red-600 hover:text-red-800 dark:text-red-400" title="Remover">
                        <span class="material-symbols-outlined text-base">delete</span>
                    </button>
                ` : ''}
            </td>
        </tr>
    `).join('');

    document.getElementById('edit-total-geral').textContent = `R$ ${currentEditingOS.totalGeral.toFixed(2).replace('.', ',')}`;

    console.log('üóëÔ∏è Item removido, total atualizado:', currentEditingOS.totalGeral);
}
</script>

<!-- Carregar Sidebar Unificado -->
<script src="sidebar.js"></script>

</body></html>