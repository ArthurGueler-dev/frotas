<?php
/**
 * Script para importar serviços do CSV para o banco de dados
 * Importa apenas serviços que não existem no sistema
 */

header('Content-Type: application/json; charset=utf-8');
header('Access-Control-Allow-Origin: *');

require_once 'db-config.php';

// Aumentar limites para processamento
set_time_limit(300);
ini_set('memory_limit', '256M');

try {
    $pdo = getDBConnection();

    // Lista de serviços para importar (extraída do CSV)
    $servicos = array(
        "ABRAÇADEIRA EM AÇO",
        "AFERIÇÃO DE TACÓGRAFO",
        "AJUSTE BARRA DE DIREÇÃO",
        "ALINHAMENTO DE DIREÇÃO",
        "ALINHAMENTO E BALANCEAMENTO CAMINHAO 3/4",
        "ALINHAMENTO SUV/CAMINHONETE",
        "BALANCEAMENTO DE RODAS",
        "BALANCEAMENTO SUV/CAMINHONETE",
        "BEGUINHA TORNEIRO (PASSE 2 TAMBOR FREIO)",
        "CALIBRAÇÃO DE TACÓGRAFO",
        "CAMBAGEM",
        "CAMBAGEM LD",
        "CAMBAGEM LE",
        "CAPOTA MARITIMA",
        "CARGA DE GÁS - AR COND.",
        "CARGA DE OLEO - AR COND.",
        "CHECK UP FUNCIONAMENTO",
        "CONSERTO DE PNEU",
        "CORREÇÃO SISTEMA ELÉTRICO",
        "DESCARBONIZAR TBI",
        "DESEMPENO HASTE EXTENSÃO DA PATOLA",
        "DESM.E MONTAGEM CILINDRO EXTENSAO PATOLA DIANT DIR",
        "DESM.E MONTAGEM CILINDRO EXTENSAO PATOLA DIANT ESQ",
        "DIAGNOSTICO ELETRICO",
        "DIAGNÓSTICO ELÉTRICO",
        "DIAGNÓSTICO ELETRÔNICO",
        "DIAGNÓSTICO MECÂNICO",
        "EMBUCHAMENTO MANGAS DE EIXO DIANT - CAMINHÃO",
        "FACEAMENTO DO VOLANTE - CAMINHAO",
        "FORNECIMENTO DE PEÇAS",
        "GUINCHO",
        "HIGIENIZAÇÃO AR CONDICIONADO",
        "HIGIENIZAÇÃO CAIXA EVAPORADORA",
        "INSPEÇÃO DE SEGURANÇA VEICULAR",
        "INSPEÇÃO DO SISTEMA DE SUSPENSÃO",
        "INSPEÇÃO SISTEMA DE FREIOS",
        "INSPEÇÃO SUSPENSÃO",
        "INST PNEUMATICA BUZINA E DO SOPRADOR DE AR",
        "INSTALAÇÃO",
        "INSTALAÇÃO CAMERA DE RÉ",
        "ISOLAMENTO DE AR QUENTE",
        "LAVAGEM COMPLETA CAMINHAO",
        "LAVAGEM COMPLETA E DETALHADA",
        "LAVAGEM DE MOTOR COMPLETA",
        "LAVAGEM DE VEICULO",
        "LIMPEZA COMPLETA",
        "LIMPEZA COMPLETA E LUBRIFICAÇÃO CAMINHÃO",
        "LIMPEZA COMPLETA E LUBRIFICAÇÃO CAMINHÃO 3/4",
        "LIMPEZA COMPLETA E LUBRIFICAÇÃO CAMINHÃO TRUCK",
        "LIMPEZA DE BICO",
        "LIMPEZA DE EVAPORADOR",
        "LIMPEZA DO SISTEMA DE ARREFECIMENTO",
        "LIMPEZA PARTE SUPERIOR DO MOTOR",
        "LIMPEZA SIMPLES",
        "LIMPEZA SISTEMA DE FREIO + SANGRIA",
        "LIMPEZA SUPERIOR MOTOR",
        "LIMPEZA TBI",
        "LUBRIFICAÇÃO DE COMPONENTES MÓVEIS",
        "MANUTENÇÃO DE MOLAS PNEUMÁTICAS",
        "MANUTENÇÃO MAQUINA DE VIDRO",
        "MANUTENÇÃO MOTOR DE ARRANQUE",
        "MÃO DE OBRA FREIOS",
        "MAO DE OBRA SERVIÇO HIDRAÚLICO CAMINHÃO",
        "MOLA USADA - STRADA",
        "MONTAGEM MOTOR",
        "MONTAGEM PNEU",
        "MONTAGEM PNEU SUV/CAMINHONETE",
        "PASSAR APARELHO SIST INJEÇÃO",
        "PINTURA COMPLETA OU PARCIAL",
        "PLOTAGEM - VEICULO ADESIVO",
        "RECARREGAMENTO DE GÁS REFRIGERANTE",
        "RECUPERAR BALANCA (TORNEIRO) STRADA",
        "RECUPERAR ROSCA BUJAO CARTER",
        "REFORMA PNEU 235/75 R17",
        "REGULAGEM DE PORTA TRASEIRA - DOBRO",
        "REGULAGEM DO FREIO DE MAO",
        "REGULAGEM E LUBRIFICAÇÃO DE FREIO TRASEIRO",
        "REMOCAO E INST DO RADIADOR E INTERCOOLER CAMINHAO",
        "REMOCAO E INST DO SETOR DE DIRECAO",
        "REMOVER E INSTALAÇÃO/DESMONTAR E MONTAR CAIXA DE MARCHA",
        "REPARO / SUBST DE LANTERNAS OU FAROIS",
        "REPARO / SUBST EM LATARIA E PARACHOQUES",
        "REPARO BOMBA DAGUA",
        "REPARO DE CARROCERIA",
        "REPARO DE CHICOTE ELÉTRICO",
        "REPARO EM CABEÇOTE",
        "REPARO EM EIXOS TRASS",
        "REPARO EM MÓDULOS ELETRÔNICOS",
        "REPARO EM TERMINAIS DE DIREÇÃO",
        "REPARO NO CONDENSADOR",
        "REPARO NO DIFERENCIAL",
        "REPARO NO SISTEMA DE EXAUSTÃO",
        "REPARO NO SISTEMA DE FREIO A AR",
        "REPARO OU SUBST DE EMBREAGEM E COMPONENTES",
        "REPARO OU SUBST DE JUNTAS HOMOCINÉTICAS",
        "REPARO OU SUBST DO ALTERNADOR",
        "REPARO OU SUBST DO MOTOR DE PARTIDA",
        "REPARO/SUBST DE COMPONENTES DA IGNIÇÃO",
        "REPARO/SUBST DE COMPONETES DA INJEÇÃO ELETRONICA",
        "REPARO/SUBST DE COMPONETES DA PORTA",
        "REPARO/SUBST EM RETROVISORES",
        "RETIFICA DE MOTOR",
        "RETIRADA ADESIVO",
        "RETIRAR TRIZETAS",
        "REVISAO CAIXA DE MARCHA VEICULO LEVE",
        "REVISÃO DE QUILOMETRAGEM (10K, 20K, ETC.)",
        "REVISAO SETOR DIRECAO C/ TROCA DO REPARO",
        "REVISÃO SISTEMA DE FREIO DIANT E TRAS",
        "REVISAR CAIXA DE MARCHA - CAMINHAO",
        "RODIZIO DE PNEUS",
        "SENSOR ABS",
        "SERV LIMP, HIG , TESTE RADIADOR E TC CX SUP RADIADOR - CAMINHAO",
        "SERVIÇO AR CONDICIONADO",
        "SERVICO CAPOTA DE FIBRA",
        "SERVICO CHAVEIRO",
        "SERVIÇO DE CROMAGEM DO EIXO PTIMAN",
        "SERVIÇO DE CROMAGEM DO EIXO SEM FIM",
        "SERVICO DE ESCAPAMENTO",
        "SERVIÇO DE RETIFICA CABEÇOTE",
        "SERVIÇO DE TACÓGRAFO",
        "SERVIÇO DE TROCA DE VÁLVULA",
        "SERVIÇO DESPACHANTE",
        "SERVICO HOMOCINETICA",
        "SERVICO LANTERNAGEM",
        "SERVICO NO CABO DO BANCO",
        "SERVIÇOS ELETRICOS",
        "SOLDA DIFERENCIAL TRAS",
        "SUBS CILINDRO FREIO TRASEIRO",
        "SUBS DE BATENTE TRASEIRO",
        "SUBST ADITIVO DE RADIADOR",
        "SUBST AMORTEC DIANT 1 LADO",
        "SUBST BUCHAS ESTAB. DIANT - CAMINHÃO",
        "SUBST CUBO + ROLAMENTOS DIANT",
        "SUBST DE ALTERNADOR",
        "SUBST DE AMORTEC DIANT",
        "SUBST DE AMORTEC TRAS",
        "SUBST DE BARRA ESTABILIZADORA",
        "SUBST DE BATERIA",
        "SUBST DE BIELETAS",
        "SUBST DE BOMBA D'ÁGUA",
        "SUBST DE BOMBA D'ÁGUA, VÁLVULA TERMOSTÁTICA, KIT TRANSMISSÃO",
        "SUBST DE BOMBA DE COMBUSTÍVEL",
        "SUBST DE BUCHAS DA BALANÇA",
        "SUBST DE BUCHAS DA BARRA ESTABILIZADORA",
        "SUBST DE CABO SELETOR DE MARCHA - GM CELTA/CLASSIC",
        "SUBST DE CARDAN E JUNTAS UNIVERSAIS",
        "SUBST DE COMPONENTES DA SUSPENSÃO",
        "SUBST DE COMPONENTES ELETRICOS (FUSIVEIS, LAMPADAS)",
        "SUBST DE COMPRESSOR",
        "SUBST DE CORREIAS (DENTADA, ALTERNADOR)",
        "SUBST DE DISCOS DE FREIO",
        "SUBST DE EVAPORADOR (DESMONT. E MONT. PAINEL)",
        "SUBST DE FAROL",
        "SUBST DE FILTRO DE AR",
        "SUBST DE FILTRO DE COMBUSTÍVEL",
        "SUBST DE FLUIDO DE DIREÇÃO HIDRÁULICA",
        "SUBST DE FLUIDO DE FREIO",
        "SUBST DE JUNTA DA TAMPA DE VÁLVULAS",
        "SUBST DE JUNTA DO ESCAPE",
        "SUBST DE KIT EMBREAGEM",
        "SUBST DE LÂMPADA FAROL/FORNECIMENTO",
        "SUBST DE LONA E TAMBOR DIANT LD LE",
        "SUBST DE LONA E TAMBOR TRAS LD LE",
        "SUBST DE LONAS DE FREIO",
        "SUBST DE MANGUEIRAS DO AR-CONDICIONADO",
        "SUBST DE MORCEGUINHOS",
        "SUBST DE OLEO DA TRANSMISSÃO",
        "SUBST DE OLEO DO DIFERENCIAL",
        "SUBST DE OLEO DO MOTOR",
        "SUBST DE OLEO E FILTROS",
        "SUBST DE OLEO, FILTRO DE OLEO E FILTRO COMBUSTÍVEL",
        "SUBST DE PALHETAS PARA BRISA",
        "SUBST DE PARA-BRISAS",
        "SUBST DE PASTILHAS DE FREIO",
        "SUBST DE PASTILHAS E DISCOS DE FREIO",
        "SUBST DE PEÇA DIREÇÃO",
        "SUBST DE PIVÔS DE SUSPENSÃO",
        "SUBST DE RADIADOR",
        "SUBST DE RETROVISOR OU SUPORTE",
        "SUBST DE ROLAMENTO TRAS",
        "SUBST DE SAPATA DE FREIO",
        "SUBST DE SENSORES",
        "SUBST DE SONDA LAMBDA, JG VELAS E CABOS DE VELAS",
        "SUBST DE TAMBOR E SAPATAS DE FREIO",
        "SUBST DE TRANCA TRASEIRA",
        "SUBST DE VÁLVULA TERMOSTÁTICA",
        "SUBST ELETROVENTILADOR",
        "SUBST ESTOJO DE RODA",
        "SUBST JOGO DE VELA",
        "SUBST JUNTA COLETOR/JUNTA FLEXIVEL/FLEXIVEL",
        "SUBST JUNTA HOMOCINÉTICA",
        "SUBST LONAS DE FREIO E TAMBORES TRAS - CAMINHÃO",
        "SUBST PALHETA LIMPADOR",
        "SUBST REPARO BOMBA HIDRÁULICA",
        "SUBST REPARO DA CAIXA DE DIREÇÃO HIDRÁULICA",
        "SUBST SANGRIA E TROCA DO FLUIDO DE FREIO",
        "SUBST VELAS DE IGNIÇÃO",
        "SUBT CILINDRO MESTRE",
        "TROCA BATENTE TRASEIRO",
        "TROCA DA CORREIA MOTOR - CAMINHAO",
        "TROCA DE BARRA AXIAL ESQUERDO",
        "TROCA DE FILTRO HIDRAÚLICO E LIMPEZA DO SISTEMA HIDRAÚLICO",
        "TROCA SOQUETE H4",
        "VERIFICAÇÃO DE MANGUEIRAS DO RADIADOR",
        "VERIFICAÇÃO DE PINO DE FECHO DE MOLA TRASEIRO",
        "VERIFICAÇÃO DE VELAS DE IGNIÇÃO",
        "VERIFICAÇÃO E AJUSTE DO SISTEMA DE ILUMINAÇÃO",
        "VIRADA PNEU",
        "VISTORIA VEICULAR",
        "SUBST ROLAMENTOALTERNADO, KIT CORREIA DENTADA, OLEO DE CAIXA",
        "SUBST RESERVATORIO AGUA, ADITIVOS, AGUA DESMINERALIZADA",
        "VULCANIZAÇÃO",
        "ALINHAMENTO CARGA",
        "REPPARO / LANTERNAGEM E PINTURA",
        "SUBST DO PAINEL, RESET NA INJEÇÃO",
        "SUBT ESPELHO RETROVISOR",
        "SUBST CORREIA DO ALTERNADOR",
        "SERVIÇO - RECUPERAR ALOJAMENTO BUJÃO CARTER E CONF. BUJÃO",
        "SERVIÇO - BANDEJA COMPLETA E TOP KIT DIATEIROS",
        "SERVIÇO - SIRENE DE RÉ",
        "SUBST COXIM DO CAMBIO",
        "SERVIÇO - SOLDA E REPARO NA ALAVANCA",
        "SUBST CILINDRO DO PEDAL DE EMBREAGEM",
        "SERVIÇO - SUBST DE ALAVANCA",
        "SUBST CONJUNTO DE EMBREAGEM",
        "SERVIÇO DE TORNO",
        "RETIFICA DE SEDE",
        "SUSBT MANCAL DE SUSPENSÃO",
        "TROCA DE GUIA",
        "SERVIÇO - RETIFICA FACEAR",
        "SUPERFICIE",
        "LIMPEZA QUIMICA",
        "DESEMPENO DE RODA",
        "ESMERILHAR, MONTAR E REGULAR",
        "SELO",
        "REMOÇÃO DO PAINEL E LIMPEZA DO SISTEMA",
        "RETIFICA DE VALVULA",
        "SUBST KIT CORREIA DENTADA",
        "SUBST DO KIT CORREIA DENTADA E JOGO PASTILHAS DE FREIO",
        "SERVIÇO - REMOVER E INSTALAR BOMBA DE ALTA PRESSÃO",
        "DESMONT/MONTAGEM - PNEU PASSEIO",
        "SUBST DE OLEO, FILTRO DE OLEO E FILTRO DE AR",
        "CONDICIONAMENTO DE CX EMBREAGEM",
        "SERVIÇO - SUBST LAMPADA DO VEÍCULO",
        "SERVIÇO - REPARO DO MÓDULO DE INJEÇÃO ELETRÔNICA",
        "SERVIÇO - AJUSTE DO VOLANTE DE VEÍCULO",
        "SERVIÇO - REPARO ODOMETRO PAINEL",
        "SUBST CORREIA DENTADA",
        "MÃO DE OBRA E AQUIAMENTO 2 FEIXE DT ACCELO",
        "SERVIÇO - ESTABILIZADOR",
        "SANGRIA DO FREIO",
        "DESMONTAGEM / MONTAGEM CARGA",
        "SERVIÇO - PINTURA VEÍCULO",
        "MÃO OBRA DESM/MONT. SETOR CATAL.",
        "SERVIÇO - CATALIZADOR",
        "USINAGEM E MONTAGEM PARCIAL MOTOR FIRE 1.4 EVO",
        "SERVIÇO TROCA DE LAMPADA FAROL E SETA",
        "MÃO DE OBRA CALÇOS",
        "MÃO DE OBRA SUSPENSÃO",
        "CORRIGIR MARCHAS OXCILANDO",
        "LANTERNAGEM E PINTURA (CAPO, PARACHOQUE DIANT, PAINEL DIANT)",
        "TROCA DO CHICOTE COMPLETO DO BAÚ",
        "SERVIÇO - SUBST ANTICHAMAS",
        "SERVIÇO - REMOVER E INTALAR CX DE MARCHAS",
        "SERVIÇO DE TERCEIROS (CAPOTARIA)",
        "DESMONTAGEM E REPARO DO CAMOBIO DE MARCHAS",
        "SERVIÇO MECÂNICO",
        "SERVIÇO - SUBST DE AMORT DIANT/ BIELETA",
        "SUBS KIT DE ELEMENTO FILTRANTE",
        "REAPERTO E VERIFICAÇÃO GERAL DO EQUIPAMENTO",
        "REVISAR CUBOS TRASEIROS",
        "SUBS MANOMETRO DE SATURAÇÃO - FILTRO",
        "LUBRIFICAÇÃO GERAL",
        "SUBST DE COMUTADOR E EXCÊNTRICO",
        "CONFECÇÃO E SUBSTITUIÇÃO MANGUEIRA",
        "SUBS E CONFEC. (MANGUEIRA COMANDO E MANGUEIRA EXTENSÃO)",
        "SERVIÇO FREIO",
        "LIMPEZA DE ARREFECIMENTO",
        "SERVIÇO - RETÍFICA CABEÇOTE",
        "REMOÇÃO E INSTALAÇÃO DE EMBREAGEM",
        "MÃO DE OBRA - REMOÇÃO E INSTALAÇÃO COXINS DO MOTOR",
        "SUBSTITUIR TRANSDUTOR DE PRESSÃO",
        "SERVIÇO ELETRICO",
        "TROCA MOTOR DE PARTIDA/CARGA DE BATERIA",
        "MONTAGEM DE MOTOR/LIMPEZA DE BICOS INJETORES",
        "MÃO DE OBRA - SUSPENSÃO",
        "SERVIÇO - TROCA DE PEÇAS E REGULAGEM",
        "SERVIÇO - INSTALAÇÃO DE ESCAPAMENTO",
        "SERVIÇO - PARAMETRIZAR INJETOR",
        "SERVIÇO - REMOÇÃO E INSTALAÇÃO CX DE EMBREAGEM",
        "LIMPEZA DO RADIADOR E TROCA DO RESEVATÓRIO",
        "LIMPEZA SISTEMA DE FREIO",
        "MÃO DE OBRA - BARRA AXIAL",
        "MÃO DE OBRA - BUCHA BALANÇA",
        "SUBST RETENTOR BOMBA DE ÓLEO",
        "SERVIÇO - TROCA RETENTOR DO COMANDO",
        "SERVIÇO - INSTALAÇÃO PARACHOQUE",
        "SERVIÇO - PINTURA RESERVATORIO DANIFICADO",
        "SUBS VEDAÇÃO DO SUPORTE DO FILTRO",
        "SERVIÇO - SUBST LAMINAR DO SUPORTE DO PARACHOQUE",
        "SERVIÇO DE LIMPEZA - DESCARBONIZAÇÃO",
        "POLIMENTO CABINE",
        "SERVIÇO - SUBST BICO DE AR, CORREÇÃO VAZAMENTO DE AR",
        "LIMPEZA DE TBI E BICOS INJETORES",
        "SERVIÇO - CORRIGIR VIDRO",
        "DIAGNOSTICO - LUZ ABS",
        "SUBST SENSOR ABS - RODA TRASEIRA",
        "SERVIÇO - CALÇOS, BUCHAS, BATENTE E CANELETA",
        "SUBS DOS REPAROS DO COMANDO HIDRAULICO",
        "SERVIÇO - REVISÃO MAQUINA VIDRO PORTA LD C/ TROCA MOTOR",
        "SUBST CARCOS TRASEIROS PINOS E BUCHAS",
        "SUBST CANALETA PORTA DIREITA",
        "SERVIÇO - SCANNER",
        "REVISÃO MAQUINA VIDRO PORTA DIREITA C TROCA MOTOR",
        "SERVIÇO - AMORTECEDOR TRASEIRO E BATENTE",
        "REAPERTO EM CARROCERIA E TROCA DE PORCA",
        "SERVIÇO - CAIXA DE MARCHAS - SUBTS. DE PEÇAS",
        "MÃO DE OBRA CAIXA DE MARCHA",
        "MÃO DE OBRA ALTERNADOR",
        "SERVIÇO - BOMBA COMBUSTIVEL",
        "MÃO DE OBRA CAMBIO",
        "SUBST ROLAMENTOS",
        "ALINHAMENTO TRASEIRO",
        "SERVIÇO - ADESIVAGEM",
        "SERVIÇO - IMÃ PARA VEÍCULO CESAN",
        "SERVIÇO - ETIQUETA ADESIVA",
        "SERVIÇO - PERSONALIZAÇÃO FROTA",
        "SERVIÇO - SUBST CABO DESTRAVA CABINE",
        "CORRIGIR TRAVA LIMITADOR CABINE",
        "SERVIÇO - DESATIVAÇÃO DE ALARME",
        "SERVIÇO - LAMPADA FAROL DIREITO",
        "SERVIÇO - LANTERNAS E FAROL",
        "INSTALAÇÃO ALMA AÇO TRASEIRA",
        "LIMPEZA DO PAINEL E CAIXA, MONT. E DESM.",
        "SERVIÇO - CHICOTE MOTOR, SENSOR VELOCIDADE E CHICOTE PAINEL",
        "TESTE COMPUTADORIZADO",
        "SERVIÇO - REMOÇÃO E INSTALAÇÃO DE BOBINA",
        "SERVIÇO - MÓDULO DE INJEÇÃO E DRIVE",
        "SUBST PINO",
        "SERVIÇO - ACERTAR O BERCO DO GANCHO",
        "CARGA DE GÁS",
        "CARGA DE OLEO",
        "SERVIÇO - AR CONDICIONADO",
        "SUBST MANGUEIRA DA EXTENSÃO SAPATA",
        "SERVIÇO - CORRIGIR ARLA",
        "SERVIÇO - REVISAR CHICOTE SISTEMA DO ARLA",
        "SUBST ANEL ORING DA VALVULA TELESCOPIA",
        "SERVIÇO - CHICOTE DO TACOGRAFO",
        "SERVIÇO - AFERIÇÃO DE TACOGRAFO",
        "SERVIÇO - LANTERNAGEM, RECUPERAÇÃO, PINTURA E ALINHAMENTO",
        "SERVIÇO - CORREIA DENTADA/TENSOR/TAMPA DE VAL.",
        "SERVIÇO - ALINHAMENTO 3D/BALANCEAMENTO/MONTAGEM",
        "SERVIÇO - INSTALAÇÃO CALÇO DO MOTOR",
        "SERVIÇO - TRANSMISSÃO DO VEÍCULO",
        "SUBST ROLAMENTO DE RODA DIANTERIO",
        "SUBST CILINDRO MESTRE E HIDROVACUO",
        "MÃO DE OBRA COM DIAGNOSTICO",
        "SERVIÇO - SAPATAS DO FREIO",
        "SERVIÇO - EMBREAGEM",
        "SUBST MANGUEIRA RESPIRO GARGALO",
        "ALINHAMENTO 3D / BALANCEAMENTO"
    );

    // Buscar serviços existentes
    $stmt = $pdo->query("SELECT UPPER(nome) as nome FROM servicos WHERE tipo = 'Serviço'");
    $existentes = array();
    while ($row = $stmt->fetch(PDO::FETCH_ASSOC)) {
        $existentes[] = $row['nome'];
    }

    // Contador
    $inseridos = 0;
    $ja_existem = 0;
    $erros = array();

    // Inserir serviços que não existem
    $sqlInsert = "INSERT INTO servicos (codigo, nome, tipo, valor_padrao, ocorrencia_padrao, ativo)
                  VALUES (:codigo, :nome, 'Serviço', 0.00, 'Corretiva', 1)";
    $stmtInsert = $pdo->prepare($sqlInsert);

    foreach ($servicos as $index => $nome) {
        $nomeUpper = mb_strtoupper($nome, 'UTF-8');

        // Verificar se já existe
        if (in_array($nomeUpper, $existentes)) {
            $ja_existem++;
            continue;
        }

        // Gerar código único
        $codigo = 'SRV' . str_pad($index + 100, 4, '0', STR_PAD_LEFT);

        try {
            $stmtInsert->execute(array(
                ':codigo' => $codigo,
                ':nome' => $nome
            ));
            $inseridos++;
            $existentes[] = $nomeUpper; // Evitar duplicatas no mesmo batch
        } catch (Exception $e) {
            $erros[] = array('nome' => $nome, 'erro' => $e->getMessage());
        }
    }

    echo json_encode(array(
        'success' => true,
        'message' => "Importação concluída",
        'total_na_lista' => count($servicos),
        'inseridos' => $inseridos,
        'ja_existiam' => $ja_existem,
        'erros' => count($erros),
        'detalhes_erros' => array_slice($erros, 0, 10)
    ), JSON_UNESCAPED_UNICODE | JSON_PRETTY_PRINT);

} catch (Exception $e) {
    echo json_encode(array(
        'success' => false,
        'error' => $e->getMessage()
    ), JSON_UNESCAPED_UNICODE);
}
?>
