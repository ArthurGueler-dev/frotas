<!DOCTYPE html>
<html lang="pt-br"><head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Planos de Manuten√ß√£o</title>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&amp;display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
<script>
    tailwind.config = {
        darkMode: "class",
        theme: {
            extend: {
                colors: {
                    "primary": "#1173d4",
                    "background-light": "#f6f7f8",
                    "background-dark": "#101922",
                },
                fontFamily: {
                    "display": ["Inter"]
                },
                borderRadius: {
                    "DEFAULT": "0.25rem",
                    "lg": "0.5rem",
                    "xl": "0.75rem",
                    "full": "9999px"
                },
            },
        },
    }
    </script>
<style>
    .material-symbols-outlined {
        font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
    }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark font-display text-[#333333] dark:text-white">
<div class="relative flex h-auto min-h-screen w-full flex-col">
<div class="flex h-full grow flex-row">
<!-- Sidebar Container -->
<div id="sidebar-container" data-page="planos"></div>
<main class="flex-1 p-6 lg:p-8 overflow-y-auto bg-background-light dark:bg-gray-900">
<div class="max-w-[1400px] mx-auto">
<div class="flex flex-wrap justify-between gap-4 p-4 items-center">
<div class="flex min-w-72 flex-col gap-2">
<h1 class="text-[#18181B] dark:text-white text-4xl font-black leading-tight tracking-[-0.033em]">Planos de Manuten√ß√£o</h1>
</div>
</div>
<!-- Cabe√ßalho do plano com informa√ß√µes do modelo -->
<div id="cabecalho-plano" class="p-4">
<div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm p-6 border dark:border-slate-700">
<div class="flex flex-wrap gap-4 items-center justify-between">
<div class="flex-grow">
<h2 id="titulo-plano" class="text-xl font-bold text-gray-900 dark:text-white">Carregando plano...</h2>
<p id="info-plano" class="text-sm text-gray-600 dark:text-gray-400 mt-1"></p>
</div>
<div class="flex items-center gap-2">
<a href="modelos.html" class="flex items-center gap-2 text-sm text-primary hover:underline">
<span class="material-symbols-outlined text-base">arrow_back</span>
Voltar para Modelos
</a>
</div>
</div>
</div>
</div>
<!-- Container din√¢mico para os itens do plano -->
<div id="container-itens-plano" class="p-4">
<!-- Os itens ser√£o renderizados aqui via JavaScript -->
</div>
</div>
</div>
</div>

<!-- Modal de Gerenciamento de Pe√ßas -->
<div id="modalPecas" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 dark:bg-opacity-70">
<div class="bg-white dark:bg-slate-800 rounded-xl shadow-xl w-full max-w-4xl max-h-[90vh] flex flex-col m-4">
<div class="flex justify-between items-center p-6 border-b dark:border-slate-700">
<h3 id="modalPecasTitulo" class="text-2xl font-bold text-gray-900 dark:text-white">Gerenciar Pe√ßas do Item</h3>
<button id="btnFecharModalPecas" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200"><span class="material-symbols-outlined">close</span></button>
</div>
<div class="p-6 overflow-y-auto flex-grow">
<input type="hidden" id="pecas-item-id" />

<!-- Se√ß√£o para adicionar pe√ßas -->
<div class="mb-6">
<h4 class="text-lg font-semibold text-gray-800 dark:text-white mb-3">Adicionar Pe√ßa</h4>
<div class="grid grid-cols-1 md:grid-cols-4 gap-4">
<div class="md:col-span-2">
<label class="block mb-1 text-sm font-medium text-gray-700 dark:text-gray-300">Buscar Pe√ßa</label>
<select id="select-peca" class="w-full h-10 px-3 text-sm bg-white dark:bg-slate-700 border border-gray-300 dark:border-slate-600 rounded-lg focus:outline-0 focus:ring-2 focus:ring-primary">
<option value="">Selecione uma pe√ßa...</option>
</select>
</div>
<div>
<label class="block mb-1 text-sm font-medium text-gray-700 dark:text-gray-300">Quantidade</label>
<input id="input-quantidade-peca" type="number" min="1" value="1" class="w-full h-10 px-3 text-sm bg-white dark:bg-slate-700 border border-gray-300 dark:border-slate-600 rounded-lg focus:outline-0 focus:ring-2 focus:ring-primary" />
</div>
<div class="flex items-end">
<button id="btnAdicionarPeca" class="w-full h-10 px-4 bg-primary text-white text-sm font-bold rounded-lg hover:bg-primary/90 flex items-center justify-center gap-2">
<span class="material-symbols-outlined text-base">add</span>
Adicionar
</button>
</div>
</div>
</div>

<!-- Lista de pe√ßas do item -->
<div>
<h4 class="text-lg font-semibold text-gray-800 dark:text-white mb-3">Pe√ßas Cadastradas</h4>
<div id="lista-pecas-item" class="border rounded-lg dark:border-slate-700 overflow-hidden">
<table class="w-full text-sm text-left">
<thead class="text-xs text-gray-700 dark:text-gray-300 uppercase bg-gray-100 dark:bg-slate-700">
<tr>
<th class="px-4 py-3">C√≥digo</th>
<th class="px-4 py-3">Nome da Pe√ßa</th>
<th class="px-4 py-3 text-center">Qtd.</th>
<th class="px-4 py-3">Unidade</th>
<th class="px-4 py-3 text-right">Custo Unit.</th>
<th class="px-4 py-3 text-right">Total</th>
<th class="px-4 py-3 text-center">A√ß√µes</th>
</tr>
</thead>
<tbody id="tbody-pecas-item">
<tr><td colspan="7" class="px-4 py-8 text-center text-gray-500">Carregando...</td></tr>
</tbody>
<tfoot class="font-semibold text-gray-800 dark:text-white bg-gray-50 dark:bg-slate-800/50">
<tr>
<td colspan="5" class="px-4 py-3 text-right">Total em Pe√ßas:</td>
<td id="total-pecas-item" class="px-4 py-3 text-right text-primary">R$ 0,00</td>
<td></td>
</tr>
</tfoot>
</table>
</div>
</div>
</div>
<div class="flex justify-end items-center p-6 bg-gray-50 dark:bg-slate-800/50 border-t dark:border-slate-700 rounded-b-xl gap-4">
<button id="btnFecharModalPecas2" class="flex min-w-[84px] cursor-pointer items-center justify-center rounded-lg h-10 px-4 bg-gray-200 dark:bg-slate-700 text-gray-800 dark:text-gray-200 text-sm font-bold hover:bg-gray-300 dark:hover:bg-slate-600">Fechar</button>
</div>
</div>
</div>

<!-- Modal de Edi√ß√£o de Item -->
<div id="modalEditarItem" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 dark:bg-opacity-70">
<div class="bg-white dark:bg-slate-800 rounded-xl shadow-xl w-full max-w-4xl max-h-[90vh] flex flex-col m-4">
<div class="flex justify-between items-center p-6 border-b dark:border-slate-700">
<h3 id="modalEditarTitulo" class="text-2xl font-bold text-gray-900 dark:text-white">Editar Item do Plano</h3>
<button id="btnFecharModalEditar" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200"><span class="material-symbols-outlined">close</span></button>
</div>
<form id="formEditarItem" class="p-6 overflow-y-auto space-y-4">
<input type="hidden" id="edit-item-id" />
<div>
<label class="block mb-1 text-sm font-medium text-gray-700 dark:text-gray-300">Nome/T√≠tulo *</label>
<input id="edit-nome" class="w-full h-10 px-3 text-sm bg-white dark:bg-slate-700 border border-gray-300 dark:border-slate-600 rounded-lg focus:outline-0 focus:ring-2 focus:ring-primary" type="text" required />
</div>
<div>
<label class="block mb-1 text-sm font-medium text-gray-700 dark:text-gray-300">Descri√ß√£o</label>
<textarea id="edit-descricao" class="w-full px-3 py-2 text-sm bg-white dark:bg-slate-700 border border-gray-300 dark:border-slate-600 rounded-lg focus:outline-0 focus:ring-2 focus:ring-primary" rows="3"></textarea>
</div>
<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
<div>
<label class="block mb-1 text-sm font-medium text-gray-700 dark:text-gray-300">Intervalo por KM</label>
<input id="edit-intervalo-km" class="w-full h-10 px-3 text-sm bg-white dark:bg-slate-700 border border-gray-300 dark:border-slate-600 rounded-lg focus:outline-0 focus:ring-2 focus:ring-primary" type="number" />
</div>
<div>
<label class="block mb-1 text-sm font-medium text-gray-700 dark:text-gray-300">Intervalo por Tempo (meses)</label>
<input id="edit-intervalo-meses" class="w-full h-10 px-3 text-sm bg-white dark:bg-slate-700 border border-gray-300 dark:border-slate-600 rounded-lg focus:outline-0 focus:ring-2 focus:ring-primary" type="number" />
</div>
</div>
<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
<div>
<label class="block mb-1 text-sm font-medium text-gray-700 dark:text-gray-300">Custo Estimado (R$) *</label>
<input id="edit-custo" class="w-full h-10 px-3 text-sm bg-white dark:bg-slate-700 border border-gray-300 dark:border-slate-600 rounded-lg focus:outline-0 focus:ring-2 focus:ring-primary" type="number" step="0.01" required />
</div>
<div>
<label class="block mb-1 text-sm font-medium text-gray-700 dark:text-gray-300">Criticidade *</label>
<select id="edit-criticidade" class="w-full h-10 px-3 text-sm bg-white dark:bg-slate-700 border border-gray-300 dark:border-slate-600 rounded-lg focus:outline-0 focus:ring-2 focus:ring-primary" required>
<option value="baixa">Baixa</option>
<option value="media">M√©dia</option>
<option value="alta">Alta</option>
</select>
</div>
</div>

<!-- Se√ß√£o de Pe√ßas -->
<div class="border-t dark:border-slate-700 pt-4 mt-4">
<h4 class="text-lg font-semibold text-gray-800 dark:text-white mb-3 flex items-center gap-2">
<span class="material-symbols-outlined">build</span>
Pe√ßas do Item
</h4>

<!-- Adicionar pe√ßa -->
<div class="grid grid-cols-1 md:grid-cols-12 gap-3 mb-4">
<div class="md:col-span-6">
<select id="edit-select-peca" class="w-full h-10 px-3 text-sm bg-white dark:bg-slate-700 border border-gray-300 dark:border-slate-600 rounded-lg focus:outline-0 focus:ring-2 focus:ring-primary">
<option value="">Selecione uma pe√ßa para adicionar...</option>
</select>
</div>
<div class="md:col-span-3">
<input id="edit-quantidade-peca" type="number" min="1" value="1" placeholder="Qtd" class="w-full h-10 px-3 text-sm bg-white dark:bg-slate-700 border border-gray-300 dark:border-slate-600 rounded-lg focus:outline-0 focus:ring-2 focus:ring-primary" />
</div>
<div class="md:col-span-3">
<button type="button" id="btnAdicionarPecaEdicao" class="w-full h-10 px-4 bg-green-600 text-white text-sm font-bold rounded-lg hover:bg-green-700 flex items-center justify-center gap-1">
<span class="material-symbols-outlined text-base">add</span>
Adicionar
</button>
</div>
</div>

<!-- Lista de pe√ßas -->
<div id="edit-lista-pecas" class="border rounded-lg dark:border-slate-700 overflow-hidden max-h-48 overflow-y-auto">
<table class="w-full text-sm text-left">
<thead class="text-xs text-gray-700 dark:text-gray-300 uppercase bg-gray-100 dark:bg-slate-700 sticky top-0">
<tr>
<th class="px-3 py-2">Pe√ßa</th>
<th class="px-3 py-2 text-center">Qtd</th>
<th class="px-3 py-2 text-right">Custo</th>
<th class="px-3 py-2 text-center w-10"></th>
</tr>
</thead>
<tbody id="edit-tbody-pecas">
<tr><td colspan="4" class="px-3 py-4 text-center text-gray-500 italic text-xs">Nenhuma pe√ßa adicionada</td></tr>
</tbody>
</table>
</div>
<div class="flex justify-between items-center mt-2 text-sm">
<span class="text-gray-500 dark:text-gray-400">Total em pe√ßas:</span>
<span id="edit-total-pecas" class="font-bold text-primary">R$ 0,00</span>
</div>
</div>
</form>
<div class="flex justify-end items-center p-6 bg-gray-50 dark:bg-slate-800/50 border-t dark:border-slate-700 rounded-b-xl gap-4">
<button id="btnCancelarModalEditar" class="flex min-w-[84px] cursor-pointer items-center justify-center rounded-lg h-10 px-4 bg-gray-200 dark:bg-slate-700 text-gray-800 dark:text-gray-200 text-sm font-bold hover:bg-gray-300 dark:hover:bg-slate-600">Cancelar</button>
<button id="btnSalvarItemEditar" class="flex min-w-[84px] cursor-pointer items-center justify-center rounded-lg h-10 px-4 bg-primary text-white text-sm font-bold hover:bg-primary/90">Salvar Altera√ß√µes</button>
</div>
</div>
</div>

</div>
</main>
</div>
</div>

<script>
// Vari√°veis globais
let planosCarregados = [];
let modeloAtual = null;

// Verificar par√¢metro modeloId na URL
document.addEventListener('DOMContentLoaded', async () => {
    const urlParams = new URLSearchParams(window.location.search);
    const modeloId = urlParams.get('modeloId');

    if (modeloId) {
        console.log('üìã Carregando plano para modelo:', modeloId);
        await carregarModeloEPlano(modeloId);
    } else {
        console.log('üìã Nenhum modelo especificado na URL');
        // Mostrar mensagem para selecionar modelo
        const tituloPlano = document.getElementById('titulo-plano');
        const infoPlano = document.getElementById('info-plano');
        const container = document.getElementById('container-itens-plano');

        if (tituloPlano) {
            tituloPlano.textContent = 'Selecione um modelo';
        }
        if (infoPlano) {
            infoPlano.innerHTML = 'Acesse a p√°gina de <a href="modelos.html" class="text-primary hover:underline">Modelos</a> e clique em "Ver Plano" para visualizar o plano de manuten√ß√£o.';
        }
        if (container) {
            container.innerHTML = `
                <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm p-8 border dark:border-slate-700 text-center">
                    <span class="material-symbols-outlined text-6xl text-gray-400 mb-4">info</span>
                    <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-2">Nenhum modelo selecionado</h3>
                    <p class="text-gray-600 dark:text-gray-400 mb-4">Para visualizar ou editar um plano de manuten√ß√£o, acesse a p√°gina de Modelos e clique no √≠cone de visualiza√ß√£o.</p>
                    <a href="modelos.html" class="inline-flex items-center gap-2 px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90">
                        <span class="material-symbols-outlined">directions_car</span>
                        Ir para Modelos
                    </a>
                </div>
            `;
        }
    }
});

// Carregar modelo espec√≠fico e seus planos
async function carregarModeloEPlano(modeloId) {
    try {
        // Carregar dados do modelo
        const modeloResponse = await fetch(`https://floripa.in9automacao.com.br/modelos.php?id=${modeloId}`);
        const modelo = await modeloResponse.json();

        // Carregar planos de manuten√ß√£o do modelo (buscar por nome do modelo)
        const modeloNome = `${modelo.marca} ${modelo.modelo}`;
        const planosResponse = await fetch(`https://floripa.in9automacao.com.br/planos-manutencao-api.php?modelo=${encodeURIComponent(modelo.modelo)}`);
        const result = await planosResponse.json();
        const planos = result.data || [];

        // Atualizar UI com informa√ß√µes do modelo
        const tituloPlano = document.getElementById('titulo-plano');
        const infoPlano = document.getElementById('info-plano');

        if (tituloPlano) {
            tituloPlano.innerHTML = `Plano de Manuten√ß√£o: <span class="text-primary">${modelo.marca} ${modelo.modelo}</span>`;
        }

        if (infoPlano) {
            if (planos.length > 0) {
                infoPlano.innerHTML = `<span class="text-green-600 dark:text-green-400 font-medium">${planos.length} itens cadastrados</span> - Ano: ${modelo.ano || 'N/A'} | Tipo: ${modelo.tipo || 'N/A'}`;
            } else {
                infoPlano.innerHTML = `<span class="text-yellow-600 dark:text-yellow-400 font-medium">Nenhum item cadastrado</span> - Ano: ${modelo.ano || 'N/A'} | Tipo: ${modelo.tipo || 'N/A'}`;
            }
        }

        console.log(`‚úÖ Plano carregado: ${modelo.marca} ${modelo.modelo} - ${planos.length} itens`);

        // Armazenar planos e modelo para uso nas fun√ß√µes de edi√ß√£o/exclus√£o
        planosCarregados = planos;
        modeloAtual = modelo;

        // Renderizar tabela de itens do plano
        renderizarItensPlano(modelo, planos);

    } catch (error) {
        console.error('‚ùå Erro ao carregar plano do modelo:', error);
        alert('Erro ao carregar plano de manuten√ß√£o');
    }
}

// Renderizar itens do plano de manuten√ß√£o
function renderizarItensPlano(modelo, planos) {
    const container = document.getElementById('container-itens-plano');
    if (!container) return;

    if (planos.length === 0) {
        container.innerHTML = '';
        return;
    }

    let html = `
        <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border dark:border-slate-700">
            <div class="p-6 border-b dark:border-slate-700">
                <div class="flex flex-wrap justify-between items-center gap-4">
                    <h2 class="text-xl font-bold text-gray-900 dark:text-white">
                        Itens do Plano: <span class="text-primary">${modelo.marca} ${modelo.modelo}</span>
                        <span class="text-base font-normal text-gray-500 dark:text-gray-400 ml-2">(${planos.length} itens)</span>
                    </h2>
                </div>
            </div>
    `;

    planos.forEach((item, index) => {
        const intervalo = formatarIntervalo(item);
        const custo = formatarMoeda(item.custo_estimado || item.custo_total || item.custo_mao_obra || 0);
        const criticidadeRaw = (item.criticidade || 'media').toLowerCase();
        const criticidade = criticidadeRaw === 'alta' ? 'Alta' : criticidadeRaw === 'baixa' ? 'Baixa' : 'M√©dia';
        const corCriticidade = criticidadeRaw === 'alta' ? 'bg-red-600 dark:bg-red-700' :
                              criticidadeRaw === 'baixa' ? 'bg-green-600 dark:bg-green-700' :
                              'bg-yellow-600 dark:bg-yellow-700';

        html += `
            <div class="border-b dark:border-slate-700 ${index % 2 === 1 ? 'bg-gray-50 dark:bg-slate-800/50' : ''}">
                <div class="grid grid-cols-[1fr_auto] items-center p-4">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-center">
                        <div class="font-semibold text-gray-900 dark:text-white">${item.descricao_titulo || item.nome || item.categoria || 'Item de Manuten√ß√£o'}</div>
                        <div class="text-gray-600 dark:text-gray-400">${intervalo}</div>
                        <div class="text-gray-600 dark:text-gray-400">${custo}</div>
                        <div><span class="px-2 py-1 text-xs font-medium text-white ${corCriticidade} rounded-full">${criticidade}</span></div>
                    </div>
                    <div class="flex items-center gap-2 pl-4">
                        <button class="text-green-600 hover:text-green-800 dark:text-green-400 dark:hover:text-green-300" onclick="gerenciarPecas('${item.id}')" title="Gerenciar Pe√ßas">
                            <span class="material-symbols-outlined">build</span>
                        </button>
                        <button class="text-gray-500 hover:text-gray-800 dark:text-gray-400 dark:hover:text-gray-200" onclick="editarItem('${item.id}')" title="Editar Item">
                            <span class="material-symbols-outlined">edit</span>
                        </button>
                        <button class="text-gray-500 hover:text-red-600 dark:text-gray-400 dark:hover:text-red-400" onclick="excluirItem('${item.id}')" title="Excluir Item">
                            <span class="material-symbols-outlined">delete</span>
                        </button>
                        <button class="text-primary hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300" onclick="toggleDetalhes('item-${item.id}')">
                            <span class="material-symbols-outlined" id="icon-item-${item.id}">expand_more</span>
                        </button>
                    </div>
                </div>
                <!-- Detalhes expand√≠veis -->
                <div id="detalhes-item-${item.id}" class="hidden p-6 bg-gray-50 dark:bg-slate-800/50">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                        <div><p class="text-sm text-gray-500 dark:text-gray-400">Tipo de Manuten√ß√£o</p><p class="font-medium">${item.tipo_manutencao || 'Preventiva'}</p></div>
                        <div><p class="text-sm text-gray-500 dark:text-gray-400">Categoria</p><p class="font-medium">${item.categoria || '-'}</p></div>
                        <div><p class="text-sm text-gray-500 dark:text-gray-400">Criticidade</p><p class="font-medium">${criticidade}</p></div>
                        <div class="md:col-span-3"><p class="text-sm text-gray-500 dark:text-gray-400">Descri√ß√£o</p><p class="font-medium">${item.descricao || '-'}</p></div>
                        <div><p class="text-sm text-gray-500 dark:text-gray-400">Intervalo por KM</p><p class="font-medium">${(item.km_recomendado || item.intervalo_km) ? parseInt(item.km_recomendado || item.intervalo_km).toLocaleString('pt-BR') + ' km' : 'N/A'}</p></div>
                        <div><p class="text-sm text-gray-500 dark:text-gray-400">Intervalo por Tempo</p><p class="font-medium">${(item.intervalo_tempo || item.intervalo_meses) ? parseInt(item.intervalo_tempo || item.intervalo_meses) + ' meses' : 'N/A'}</p></div>
                        <div><p class="text-sm text-gray-500 dark:text-gray-400">Crit√©rio de Ativa√ß√£o</p><p class="font-medium">${item.criterio || 'Qual vier primeiro'}</p></div>
                    </div>
                    ${renderizarTabelaPecas(item.pecas || [])}
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-6 mt-6 pt-6 border-t dark:border-slate-700">
                        <div><p class="text-sm text-gray-500 dark:text-gray-400">Tempo Estimado (minutos)</p><p class="font-medium">${item.tempo_estimado || '-'}</p></div>
                        <div><p class="text-sm text-gray-500 dark:text-gray-400">Custo Estimado</p><p class="font-medium">${formatarMoeda(item.custo_estimado || item.custo_mao_obra || 0)}</p></div>
                        <div><p class="text-sm text-gray-500 dark:text-gray-400">Custo Total</p><p class="font-bold text-lg text-primary">${custo}</p></div>
                    </div>
                </div>
            </div>
        `;
    });

    html += '</div>';
    container.innerHTML = html;
}

// Formatar intervalo para exibi√ß√£o
function formatarIntervalo(item) {
    const partes = [];
    const km = item.km_recomendado || item.intervalo_km;
    const tempo = item.intervalo_tempo || item.intervalo_meses;

    if (km) {
        partes.push(`${parseInt(km).toLocaleString('pt-BR')} KM`);
    }
    if (tempo) {
        const meses = parseInt(tempo);
        partes.push(`${meses} ${meses === 1 ? 'm√™s' : 'meses'}`);
    }
    if (partes.length === 0) return 'Sob demanda';
    if (partes.length === 1) return `A cada ${partes[0]}`;
    return `A cada ${partes[0]} ou ${partes[1]}`;
}

// Formatar valor em moeda
function formatarMoeda(valor) {
    const numero = parseFloat(valor) || 0;
    return new Intl.NumberFormat('pt-BR', {
        style: 'currency',
        currency: 'BRL'
    }).format(numero);
}

// Renderizar tabela de pe√ßas
function renderizarTabelaPecas(pecas) {
    if (!pecas || pecas.length === 0) {
        return '<p class="text-sm text-gray-500 dark:text-gray-400 italic">Nenhuma pe√ßa cadastrada</p>';
    }

    let totalPecas = 0;
    let html = `
        <h4 class="text-lg font-semibold text-gray-800 dark:text-white mb-3">Tabela de Pe√ßas</h4>
        <div class="overflow-x-auto border rounded-lg dark:border-slate-700">
            <table class="w-full text-sm text-left">
                <thead class="text-xs text-gray-700 dark:text-gray-300 uppercase bg-gray-100 dark:bg-slate-700">
                    <tr>
                        <th class="px-4 py-2">Nome da Pe√ßa</th>
                        <th class="px-4 py-2 text-right">Qtd.</th>
                        <th class="px-4 py-2">Unidade</th>
                        <th class="px-4 py-2 text-right">Custo Unit√°rio</th>
                        <th class="px-4 py-2 text-right">Total</th>
                    </tr>
                </thead>
                <tbody>
    `;

    pecas.forEach(peca => {
        const total = (peca.quantidade || 1) * (peca.custo_unitario || 0);
        totalPecas += total;
        html += `
            <tr class="border-b dark:border-slate-700">
                <td class="px-4 py-2">${peca.nome}</td>
                <td class="px-4 py-2 text-right">${peca.quantidade || 1}</td>
                <td class="px-4 py-2">${peca.unidade || 'un'}</td>
                <td class="px-4 py-2 text-right">${formatarMoeda(peca.custo_unitario || 0)}</td>
                <td class="px-4 py-2 text-right">${formatarMoeda(total)}</td>
            </tr>
        `;
    });

    html += `
                </tbody>
                <tfoot>
                    <tr class="font-semibold text-gray-800 dark:text-white">
                        <td class="px-4 py-2 text-right" colspan="4">Total Pe√ßas</td>
                        <td class="px-4 py-2 text-right">${formatarMoeda(totalPecas)}</td>
                    </tr>
                </tfoot>
            </table>
        </div>
    `;

    return html;
}

// Toggle para mostrar/ocultar detalhes
function toggleDetalhes(itemId) {
    const detalhes = document.getElementById(`detalhes-${itemId}`);
    const icon = document.getElementById(`icon-${itemId}`);

    if (detalhes) {
        detalhes.classList.toggle('hidden');
        if (icon) {
            icon.textContent = detalhes.classList.contains('hidden') ? 'expand_more' : 'expand_less';
        }
    }
}

// Configurar eventos do modal de edi√ß√£o
document.addEventListener('DOMContentLoaded', () => {
    const modalEditar = document.getElementById('modalEditarItem');
    const btnFechar = document.getElementById('btnFecharModalEditar');
    const btnCancelar = document.getElementById('btnCancelarModalEditar');
    const btnSalvar = document.getElementById('btnSalvarItemEditar');

    // Fechar modal
    if (btnFechar) {
        btnFechar.addEventListener('click', fecharModalEditar);
    }
    if (btnCancelar) {
        btnCancelar.addEventListener('click', fecharModalEditar);
    }

    // Fechar ao clicar fora
    if (modalEditar) {
        modalEditar.addEventListener('click', (e) => {
            if (e.target === modalEditar) fecharModalEditar();
        });
    }

    // Salvar altera√ß√µes
    if (btnSalvar) {
        btnSalvar.addEventListener('click', salvarEdicaoItem);
    }

    // Bot√£o de adicionar pe√ßa no modal de edi√ß√£o
    const btnAdicionarPecaEdicao = document.getElementById('btnAdicionarPecaEdicao');
    if (btnAdicionarPecaEdicao) {
        btnAdicionarPecaEdicao.addEventListener('click', adicionarPecaEdicao);
    }
});

// Abrir modal de edi√ß√£o
async function editarItem(itemId) {
    const item = planosCarregados.find(p => p.id == itemId);
    if (!item) {
        console.error('Item n√£o encontrado:', itemId);
        alert('Item n√£o encontrado');
        return;
    }

    console.log('Editando item:', item);

    // Preencher formul√°rio com os campos corretos da API
    document.getElementById('edit-item-id').value = item.id;
    document.getElementById('edit-nome').value = item.descricao_titulo || item.nome || '';
    document.getElementById('edit-descricao').value = item.descricao || '';
    document.getElementById('edit-intervalo-km').value = item.km_recomendado || item.intervalo_km || '';
    document.getElementById('edit-intervalo-meses').value = item.intervalo_tempo || item.intervalo_meses || '';
    document.getElementById('edit-custo').value = item.custo_estimado || 0;

    // Definir criticidade
    const criticidade = (item.criticidade || 'media').toLowerCase();
    document.getElementById('edit-criticidade').value = criticidade;

    // Carregar pe√ßas dispon√≠veis no select de edi√ß√£o
    await carregarPecasSelectEdicao();

    // Carregar pe√ßas do item
    await carregarPecasItemEdicao(itemId);

    // Abrir modal
    document.getElementById('modalEditarItem').classList.remove('hidden');
}

// Carregar pe√ßas no select do modal de edi√ß√£o
async function carregarPecasSelectEdicao() {
    const select = document.getElementById('edit-select-peca');
    if (!select) return;

    // Carregar pe√ßas se ainda n√£o carregou
    if (pecasDisponiveis.length === 0) {
        await carregarPecasDisponiveis();
    }

    select.innerHTML = '<option value="">Selecione uma pe√ßa para adicionar...</option>';

    // Agrupar por categoria
    const categorias = {};
    pecasDisponiveis.forEach(peca => {
        const cat = peca.categoria || 'Outros';
        if (!categorias[cat]) categorias[cat] = [];
        categorias[cat].push(peca);
    });

    // Criar optgroups por categoria
    Object.keys(categorias).sort().forEach(categoria => {
        const optgroup = document.createElement('optgroup');
        optgroup.label = categoria;

        categorias[categoria].forEach(peca => {
            const option = document.createElement('option');
            option.value = peca.id;
            option.textContent = `${peca.codigo ? peca.codigo + ' - ' : ''}${peca.nome} (${formatarMoeda(peca.custo_unitario)})`;
            optgroup.appendChild(option);
        });

        select.appendChild(optgroup);
    });
}

// Carregar pe√ßas de um item no modal de edi√ß√£o
async function carregarPecasItemEdicao(itemId) {
    const tbody = document.getElementById('edit-tbody-pecas');
    const totalElement = document.getElementById('edit-total-pecas');

    tbody.innerHTML = '<tr><td colspan="4" class="px-3 py-4 text-center text-gray-500 text-xs">Carregando...</td></tr>';

    try {
        const response = await fetch(`${API_PLANO_PECAS_URL}?plano_item_id=${itemId}`);
        const result = await response.json();

        const pecas = result.data || result;
        let custoTotal = 0;

        if (!pecas || pecas.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" class="px-3 py-4 text-center text-gray-500 italic text-xs">Nenhuma pe√ßa adicionada</td></tr>';
            totalElement.textContent = 'R$ 0,00';
            return;
        }

        tbody.innerHTML = '';
        pecas.forEach(peca => {
            const total = (peca.quantidade || 1) * (peca.custo_unitario || 0);
            custoTotal += total;

            const tr = document.createElement('tr');
            tr.className = 'border-b dark:border-slate-700';
            tr.innerHTML = `
                <td class="px-3 py-2 text-xs">${peca.nome}</td>
                <td class="px-3 py-2 text-center text-xs">${peca.quantidade || 1}</td>
                <td class="px-3 py-2 text-right text-xs">${formatarMoeda(total)}</td>
                <td class="px-3 py-2 text-center">
                    <button type="button" class="text-red-500 hover:text-red-700" onclick="removerPecaEdicao(${peca.id})" title="Remover">
                        <span class="material-symbols-outlined text-sm">close</span>
                    </button>
                </td>
            `;
            tbody.appendChild(tr);
        });

        totalElement.textContent = formatarMoeda(custoTotal);
    } catch (error) {
        console.error('Erro ao carregar pe√ßas do item:', error);
        tbody.innerHTML = '<tr><td colspan="4" class="px-3 py-4 text-center text-red-500 text-xs">Erro ao carregar</td></tr>';
    }
}

// Adicionar pe√ßa ao item (modal de edi√ß√£o)
async function adicionarPecaEdicao() {
    const itemId = document.getElementById('edit-item-id').value;
    const pecaId = document.getElementById('edit-select-peca').value;
    const quantidade = parseInt(document.getElementById('edit-quantidade-peca').value) || 1;

    if (!pecaId) {
        alert('Selecione uma pe√ßa');
        return;
    }

    try {
        const response = await fetch(`${API_PLANO_PECAS_URL}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                plano_item_id: itemId,
                peca_id: pecaId,
                quantidade: quantidade
            })
        });

        if (response.ok) {
            // Recarregar lista de pe√ßas
            await carregarPecasItemEdicao(itemId);

            // Limpar campos
            document.getElementById('edit-select-peca').value = '';
            document.getElementById('edit-quantidade-peca').value = '1';
        } else {
            const result = await response.json();
            alert('Erro ao adicionar pe√ßa: ' + (result.error || 'Erro desconhecido'));
        }
    } catch (error) {
        console.error('Erro ao adicionar pe√ßa:', error);
        alert('Erro ao adicionar pe√ßa');
    }
}

// Remover pe√ßa do item (modal de edi√ß√£o)
async function removerPecaEdicao(associacaoId) {
    if (!confirm('Remover esta pe√ßa?')) return;

    try {
        const response = await fetch(`${API_PLANO_PECAS_URL}?id=${associacaoId}`, {
            method: 'DELETE'
        });

        if (response.ok) {
            const itemId = document.getElementById('edit-item-id').value;
            await carregarPecasItemEdicao(itemId);
        } else {
            const result = await response.json();
            alert('Erro: ' + (result.error || 'Erro desconhecido'));
        }
    } catch (error) {
        console.error('Erro ao remover pe√ßa:', error);
        alert('Erro ao remover pe√ßa');
    }
}

// Fechar modal de edi√ß√£o
function fecharModalEditar() {
    document.getElementById('modalEditarItem').classList.add('hidden');
}

// Salvar edi√ß√£o do item
async function salvarEdicaoItem() {
    const itemId = document.getElementById('edit-item-id').value;
    const dados = {
        descricao_titulo: document.getElementById('edit-nome').value,
        descricao_observacao: document.getElementById('edit-descricao').value,
        km_recomendado: document.getElementById('edit-intervalo-km').value ? parseInt(document.getElementById('edit-intervalo-km').value) : null,
        intervalo_tempo: document.getElementById('edit-intervalo-meses').value ? parseInt(document.getElementById('edit-intervalo-meses').value) : null,
        custo_estimado: parseFloat(document.getElementById('edit-custo').value) || 0,
        criticidade: document.getElementById('edit-criticidade').value
    };

    if (!dados.descricao_titulo || !dados.custo_estimado) {
        alert('Preencha os campos obrigat√≥rios: Nome e Custo Estimado');
        return;
    }

    try {
        console.log('Salvando item:', itemId, dados);

        const response = await fetch(`https://floripa.in9automacao.com.br/planos-manutencao-api.php?id=${itemId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(dados)
        });

        const result = await response.json();

        if (result.success) {
            alert('Item atualizado com sucesso!');
            fecharModalEditar();

            // Recarregar planos
            const urlParams = new URLSearchParams(window.location.search);
            const modeloId = urlParams.get('modeloId');
            if (modeloId) {
                await carregarModeloEPlano(modeloId);
            }
        } else {
            alert('Erro ao atualizar: ' + (result.error || 'Erro desconhecido'));
        }
    } catch (error) {
        console.error('Erro ao salvar:', error);
        alert('Erro ao salvar altera√ß√µes');
    }
}

// Excluir item
async function excluirItem(itemId) {
    const item = planosCarregados.find(p => p.id == itemId);
    const nomeItem = item ? item.nome : 'este item';

    if (!confirm(`Deseja realmente excluir "${nomeItem}"?\n\nEsta a√ß√£o n√£o pode ser desfeita.`)) {
        return;
    }

    try {
        console.log('Excluindo item:', itemId);

        const response = await fetch(`https://floripa.in9automacao.com.br/planos-manutencao-api.php?id=${itemId}`, {
            method: 'DELETE'
        });

        const result = await response.json();

        if (result.success) {
            alert('Item exclu√≠do com sucesso!');

            // Recarregar planos
            const urlParams = new URLSearchParams(window.location.search);
            const modeloId = urlParams.get('modeloId');
            if (modeloId) {
                await carregarModeloEPlano(modeloId);
            }
        } else {
            const error = await response.json();
            alert('Erro ao excluir: ' + (error.error || 'Erro desconhecido'));
        }
    } catch (error) {
        console.error('Erro ao excluir:', error);
        alert('Erro ao excluir item');
    }
}

// ==================== GERENCIAMENTO DE PE√áAS ====================

// URL base da API de pe√ßas
const API_PECAS_URL = 'https://floripa.in9automacao.com.br/pecas-api.php';
const API_PLANO_PECAS_URL = 'https://floripa.in9automacao.com.br/plano-pecas-api.php';

let pecasDisponiveis = [];

// Carregar lista de pe√ßas dispon√≠veis
async function carregarPecasDisponiveis() {
    try {
        const response = await fetch(`${API_PECAS_URL}`);
        const result = await response.json();

        // Tratar resposta da API
        if (result.success !== false) {
            pecasDisponiveis = result.data || [];
        } else {
            pecasDisponiveis = [];
        }

        atualizarSelectPecas();
    } catch (error) {
        console.error('Erro ao carregar pe√ßas:', error);
        pecasDisponiveis = [];
    }
}

// Atualizar select de pe√ßas
function atualizarSelectPecas() {
    const select = document.getElementById('select-peca');
    if (!select) return;

    select.innerHTML = '<option value="">Selecione uma pe√ßa...</option>';

    // Agrupar por categoria
    const categorias = {};
    pecasDisponiveis.forEach(peca => {
        const cat = peca.categoria || 'Outros';
        if (!categorias[cat]) categorias[cat] = [];
        categorias[cat].push(peca);
    });

    // Criar optgroups por categoria
    Object.keys(categorias).sort().forEach(categoria => {
        const optgroup = document.createElement('optgroup');
        optgroup.label = categoria;

        categorias[categoria].forEach(peca => {
            const option = document.createElement('option');
            option.value = peca.id;
            option.textContent = `${peca.codigo ? peca.codigo + ' - ' : ''}${peca.nome} (${formatarMoeda(peca.custo_unitario)})`;
            option.dataset.custo = peca.custo_unitario;
            optgroup.appendChild(option);
        });

        select.appendChild(optgroup);
    });
}

// Abrir modal de gerenciamento de pe√ßas
async function gerenciarPecas(itemId) {
    const item = planosCarregados.find(p => p.id == itemId);
    if (!item) {
        alert('Item n√£o encontrado');
        return;
    }

    console.log('Gerenciando pe√ßas do item:', item);

    // Atualizar t√≠tulo do modal
    document.getElementById('modalPecasTitulo').textContent = `Pe√ßas: ${item.descricao_titulo || item.nome || 'Item de Manuten√ß√£o'}`;
    document.getElementById('pecas-item-id').value = itemId;

    // Carregar pe√ßas dispon√≠veis se ainda n√£o carregou
    if (pecasDisponiveis.length === 0) {
        await carregarPecasDisponiveis();
    }

    // Carregar pe√ßas do item
    await carregarPecasDoItem(itemId);

    // Abrir modal
    document.getElementById('modalPecas').classList.remove('hidden');
}

// Carregar pe√ßas de um item espec√≠fico
async function carregarPecasDoItem(itemId) {
    const tbody = document.getElementById('tbody-pecas-item');
    const totalElement = document.getElementById('total-pecas-item');

    tbody.innerHTML = '<tr><td colspan="7" class="px-4 py-8 text-center text-gray-500">Carregando...</td></tr>';

    try {
        const response = await fetch(`${API_PLANO_PECAS_URL}?plano_item_id=${itemId}`);
        const result = await response.json();

        const pecas = result.data || result;
        let custoTotal = 0;

        if (!pecas || pecas.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="px-4 py-8 text-center text-gray-500 italic">Nenhuma pe√ßa cadastrada para este item</td></tr>';
            totalElement.textContent = 'R$ 0,00';
            return;
        }

        tbody.innerHTML = '';
        pecas.forEach(peca => {
            const total = (peca.quantidade || 1) * (peca.custo_unitario || 0);
            custoTotal += total;

            const tr = document.createElement('tr');
            tr.className = 'border-b dark:border-slate-700 hover:bg-gray-50 dark:hover:bg-slate-700/50';
            tr.innerHTML = `
                <td class="px-4 py-3 text-gray-600 dark:text-gray-400">${peca.codigo || '-'}</td>
                <td class="px-4 py-3 font-medium">${peca.nome}</td>
                <td class="px-4 py-3 text-center">${peca.quantidade || 1}</td>
                <td class="px-4 py-3">${peca.unidade || 'un'}</td>
                <td class="px-4 py-3 text-right">${formatarMoeda(peca.custo_unitario || 0)}</td>
                <td class="px-4 py-3 text-right font-medium">${formatarMoeda(total)}</td>
                <td class="px-4 py-3 text-center">
                    <button class="text-red-500 hover:text-red-700" onclick="removerPecaDoItem(${peca.id})" title="Remover pe√ßa">
                        <span class="material-symbols-outlined text-base">delete</span>
                    </button>
                </td>
            `;
            tbody.appendChild(tr);
        });

        totalElement.textContent = formatarMoeda(custoTotal);
    } catch (error) {
        console.error('Erro ao carregar pe√ßas do item:', error);
        tbody.innerHTML = '<tr><td colspan="7" class="px-4 py-8 text-center text-red-500">Erro ao carregar pe√ßas</td></tr>';
    }
}

// Adicionar pe√ßa ao item
async function adicionarPecaAoItem() {
    const itemId = document.getElementById('pecas-item-id').value;
    const pecaId = document.getElementById('select-peca').value;
    const quantidade = parseInt(document.getElementById('input-quantidade-peca').value) || 1;

    if (!pecaId) {
        alert('Selecione uma pe√ßa');
        return;
    }

    try {
        const response = await fetch(`${API_PLANO_PECAS_URL}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                plano_item_id: itemId,
                peca_id: pecaId,
                quantidade: quantidade
            })
        });

        const result = await response.json();

        if (response.ok) {
            // Recarregar lista de pe√ßas
            await carregarPecasDoItem(itemId);

            // Limpar campos
            document.getElementById('select-peca').value = '';
            document.getElementById('input-quantidade-peca').value = '1';

            // Recarregar plano para atualizar a tabela de pe√ßas nos detalhes
            const urlParams = new URLSearchParams(window.location.search);
            const modeloId = urlParams.get('modeloId');
            if (modeloId) {
                await carregarModeloEPlano(modeloId);
            }
        } else {
            alert('Erro ao adicionar pe√ßa: ' + (result.error || 'Erro desconhecido'));
        }
    } catch (error) {
        console.error('Erro ao adicionar pe√ßa:', error);
        alert('Erro ao adicionar pe√ßa');
    }
}

// Remover pe√ßa do item
async function removerPecaDoItem(associacaoId) {
    if (!confirm('Deseja remover esta pe√ßa do item?')) {
        return;
    }

    try {
        const response = await fetch(`${API_PLANO_PECAS_URL}?id=${associacaoId}`, {
            method: 'DELETE'
        });

        if (response.ok) {
            // Recarregar lista de pe√ßas
            const itemId = document.getElementById('pecas-item-id').value;
            await carregarPecasDoItem(itemId);

            // Recarregar plano
            const urlParams = new URLSearchParams(window.location.search);
            const modeloId = urlParams.get('modeloId');
            if (modeloId) {
                await carregarModeloEPlano(modeloId);
            }
        } else {
            const result = await response.json();
            alert('Erro ao remover pe√ßa: ' + (result.error || 'Erro desconhecido'));
        }
    } catch (error) {
        console.error('Erro ao remover pe√ßa:', error);
        alert('Erro ao remover pe√ßa');
    }
}

// Fechar modal de pe√ßas
function fecharModalPecas() {
    document.getElementById('modalPecas').classList.add('hidden');
}

// Configurar eventos do modal de pe√ßas
document.addEventListener('DOMContentLoaded', () => {
    // Carregar pe√ßas dispon√≠veis
    carregarPecasDisponiveis();

    // Eventos do modal
    const btnFechar = document.getElementById('btnFecharModalPecas');
    const btnFechar2 = document.getElementById('btnFecharModalPecas2');
    const btnAdicionar = document.getElementById('btnAdicionarPeca');
    const modalPecas = document.getElementById('modalPecas');

    if (btnFechar) btnFechar.addEventListener('click', fecharModalPecas);
    if (btnFechar2) btnFechar2.addEventListener('click', fecharModalPecas);
    if (btnAdicionar) btnAdicionar.addEventListener('click', adicionarPecaAoItem);

    // Fechar ao clicar fora
    if (modalPecas) {
        modalPecas.addEventListener('click', (e) => {
            if (e.target === modalPecas) fecharModalPecas();
        });
    }
});
</script>

<!-- Carregar Sidebar Unificado -->
<script src="sidebar.js?v=20251211-fix-rotas"></script>

</body>
</html>
