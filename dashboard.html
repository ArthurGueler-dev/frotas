<!DOCTYPE html>

<html class="light" lang="en"><head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>FleetFlow - Dashboard</title>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&amp;display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
<script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#1E3A8A",
                        "background-light": "#F3F4F6",
                        "background-dark": "#1F2937",
                        "text-light": "#1F2937",
                        "text-dark": "#F3F4F6",
                        "success": "#10B981",
                        "warning": "#F59E0B",
                        "danger": "#EF4444",
                        "info": "#3B82F6",
                    },
                    fontFamily: {
                        "display": ["Inter", "sans-serif"]
                    },
                    borderRadius: {
                        "DEFAULT": "0.5rem",
                        "lg": "0.75rem",
                        "xl": "1rem",
                        "full": "9999px"
                    },
                },
            },
        }
    </script>
<style>
        .material-symbols-outlined {
            font-variation-settings:
            'FILL' 0,
            'wght' 400,
            'GRAD' 0,
            'opsz' 24
        }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark font-display text-[#333333] dark:text-white">
<div class="relative flex h-auto min-h-screen w-full flex-col">
<div class="flex h-full grow flex-row">
<!-- Sidebar Unificado -->
<div id="sidebar-container" data-page="dashboard"></div>
<main class="flex-1 p-6 lg:p-8 bg-background-light dark:bg-gray-900">
<div class="flex flex-wrap justify-between gap-4 items-center mb-6">
<div class="flex flex-col gap-1">
<h1 class="text-3xl font-black text-[#111418] dark:text-white tracking-[-0.03em]">Vis√£o Geral da Frota</h1>
<p class="text-gray-500 dark:text-gray-400 text-base font-normal">Filtro de data: √öltimos 30 dias</p>
</div>
<div class="flex items-center gap-2">
<select class="rounded-lg border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 focus:border-primary focus:ring-primary text-sm">
<option>√öltimos 30 dias</option>
<option>Este M√™s</option>
<option>√öltimos 90 dias</option>
</select>
<button class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center gap-2 overflow-hidden rounded-lg h-10 px-4 bg-primary text-white text-sm font-bold leading-normal tracking-[0.015em]">
<span class="material-symbols-outlined">download</span>
<span class="truncate">Exportar</span>
</button>
</div>
</div>
<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
<div class="flex flex-col gap-2 rounded-xl p-6 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700">
<p class="text-base font-medium text-[#111418] dark:text-gray-300">Total de Ve√≠culos</p>
<p class="text-3xl font-bold text-[#111418] dark:text-white">150</p>
<p class="text-[#28A745] text-sm font-medium">+2% vs m√™s anterior</p>
</div>
<div class="flex flex-col gap-2 rounded-xl p-6 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700">
<p class="text-base font-medium text-[#111418] dark:text-gray-300">Em Manuten√ß√£o</p>
<p class="text-3xl font-bold text-[#111418] dark:text-white">12</p>
<p class="text-[#FFC107] text-sm font-medium">+5% vs m√™s anterior</p>
</div>
<div class="flex flex-col gap-2 rounded-xl p-6 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700">
<p class="text-base font-medium text-[#111418] dark:text-gray-300">Motoristas Dispon√≠veis</p>
<p class="text-3xl font-bold text-[#111418] dark:text-white">45</p>
<p class="text-[#DC3545] text-sm font-medium">-3% vs m√™s anterior</p>
</div>
<div class="flex flex-col gap-2 rounded-xl p-6 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700">
<p class="text-base font-medium text-[#111418] dark:text-gray-300">Custo Total (M√™s)</p>
<p class="text-3xl font-bold text-[#111418] dark:text-white">R$ 120.000</p>
<p class="text-xs text-gray-500 dark:text-gray-400">Combust√≠vel + Manuten√ß√£o + Seguro</p>
</div>
</div>
<!-- Barra de Progresso de Sincroniza√ß√£o -->
<div id="sync-progress-bar" class="hidden mb-6 rounded-xl border border-gray-200 dark:border-gray-700 p-6 bg-white dark:bg-gray-800">
    <div class="flex justify-between items-center mb-3">
        <span class="text-base font-semibold text-[#1173d4] dark:text-blue-400">üîÑ Sincronizando Quilometragem...</span>
        <span id="sync-progress-text" class="text-sm font-bold text-[#111418] dark:text-gray-300">0%</span>
    </div>
    <div class="bg-gray-200 dark:bg-gray-700 rounded-full h-3 overflow-hidden">
        <div id="sync-progress-fill" class="bg-gradient-to-r from-[#1173d4] to-[#28A745] h-full transition-all duration-300" style="width: 0%"></div>
    </div>
    <div id="sync-status-text" class="mt-3 text-xs text-gray-500 dark:text-gray-400"></div>
</div>

<!-- Card de Sincroniza√ß√£o de Quilometragem -->
<div class="mb-6 rounded-xl border border-gray-200 dark:border-gray-700 p-6 bg-white dark:bg-gray-800">
    <div class="flex items-center justify-between mb-4">
        <div>
            <p class="text-lg font-semibold text-[#111418] dark:text-white">Sincroniza√ß√£o de Quilometragem</p>
            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Atualizar dados em tempo real dos ve√≠culos</p>
        </div>
    </div>
    <div class="flex gap-3">
        <button id="btn-sync-km" onclick="sincronizarKmManual()"
                class="flex-1 flex items-center justify-center gap-2 px-4 py-3 bg-[#1173d4] hover:bg-[#0d5fb5] text-white font-medium rounded-lg transition-colors">
            <span class="material-symbols-outlined">sync</span>
            <span>Sincronizar KM Agora</span>
        </button>
        <button onclick="limparCacheKm()"
                class="flex items-center justify-center gap-2 px-4 py-3 bg-gray-500 hover:bg-gray-600 dark:bg-gray-600 dark:hover:bg-gray-700 text-white font-medium rounded-lg transition-colors">
            <span class="material-symbols-outlined">delete</span>
            <span>Limpar Cache</span>
        </button>
    </div>
</div>

<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
<div class="flex flex-col gap-2 rounded-xl p-6 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700">
<p class="text-base font-medium text-[#111418] dark:text-gray-300">KM Rodados Hoje</p>
<p class="text-3xl font-bold text-[#111418] dark:text-white" id="stat-km-today">-</p>
<p class="text-xs text-gray-500 dark:text-gray-400">Atualizado em tempo real</p>
</div>
<div class="flex flex-col gap-2 rounded-xl p-6 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700">
<p class="text-base font-medium text-[#111418] dark:text-gray-300">KM Rodados Ontem</p>
<p class="text-3xl font-bold text-[#111418] dark:text-white" id="stat-km-yesterday">-</p>
<p class="text-xs text-gray-500 dark:text-gray-400" id="stat-variation-display">Compara√ß√£o com hoje</p>
</div>
<div class="flex flex-col gap-2 rounded-xl p-6 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700">
<p class="text-base font-medium text-[#111418] dark:text-gray-300">KM Rodados no M√™s</p>
<p class="text-3xl font-bold text-[#111418] dark:text-white" id="stat-km-month">-</p>
<p class="text-xs text-gray-500 dark:text-gray-400">Total acumulado do m√™s atual</p>
</div>
<div class="flex flex-col gap-2 rounded-xl p-6 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700">
<p class="text-base font-medium text-[#111418] dark:text-gray-300">Ve√≠culos em Movimento</p>
<p class="text-3xl font-bold text-[#111418] dark:text-white" id="stat-vehicles-moving">-</p>
<p class="text-xs text-gray-500 dark:text-gray-400">Ve√≠culos ativos no momento</p>
</div>
</div>
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
<div class="lg:col-span-2 flex flex-col gap-4 rounded-xl border border-gray-200 dark:border-gray-700 p-6 bg-white dark:bg-gray-800">
<p class="text-lg font-semibold text-[#111418] dark:text-white">An√°lise de Custos</p>
<div class="h-80">
<svg height="100%" preserveaspectratio="xMidYMid meet" viewbox="0 0 500 300" width="100%" xmlns="http://www.w3.org/2000/svg">
<line stroke="#dbe0e6" stroke-width="1" x1="50" x2="480" y1="250" y2="250"></line>
<line stroke="#dbe0e6" stroke-width="1" x1="50" x2="50" y1="50" y2="250"></line>
<text fill="#617589" font-family="Inter" font-size="12" x="20" y="255">0</text>
<text fill="#617589" font-family="Inter" font-size="12" x="20" y="155">5k</text>
<text fill="#617589" font-family="Inter" font-size="12" x="15" y="55">10k</text>
<g class="bar-group">
<rect fill="#1173d4" height="100" width="30" x="80" y="150"></rect>
<rect fill="#28A745" height="50" width="30" x="120" y="200"></rect>
<rect fill="#FFC107" height="70" width="30" x="160" y="180"></rect>
<text fill="#617589" font-family="Inter" font-size="12" text-anchor="middle" x="110" y="270">Sem 1</text>
</g>
<g class="bar-group">
<rect fill="#1173d4" height="150" width="30" x="220" y="100"></rect>
<rect fill="#28A745" height="80" width="30" x="260" y="170"></rect>
<rect fill="#FFC107" height="40" width="30" x="300" y="210"></rect>
<text fill="#617589" font-family="Inter" font-size="12" text-anchor="middle" x="270" y="270">Sem 2</text>
</g>
<g class="bar-group">
<rect fill="#1173d4" height="130" width="30" x="360" y="120"></rect>
<rect fill="#28A745" height="60" width="30" x="400" y="190"></rect>
<rect fill="#FFC107" height="90" width="30" x="440" y="160"></rect>
<text fill="#617589" font-family="Inter" font-size="12" text-anchor="middle" x="410" y="270">Sem 3</text>
</g>
<g transform="translate(480, 50)">
<rect fill="#1173d4" height="10" width="10" y="0"></rect><text fill="#617589" font-size="12" x="15" y="9">Combust√≠vel</text>
<rect fill="#28A745" height="10" width="10" y="20"></rect><text fill="#617589" font-size="12" x="15" y="29">Manuten√ß√£o</text>
<rect fill="#FFC107" height="10" width="10" y="40"></rect><text fill="#617589" font-size="12" x="15" y="49">Outros</text>
</g>
</svg>
</div>
</div>
<div class="flex flex-col gap-4 rounded-xl border border-gray-200 dark:border-gray-700 p-6 bg-white dark:bg-gray-800">
<p class="text-lg font-semibold text-[#111418] dark:text-white">Status dos Ve√≠culos</p>
<div class="h-80 flex items-center justify-center">
<svg height="100%" viewbox="0 0 200 200" width="100%" xmlns="http://www.w3.org/2000/svg">
<circle cx="100" cy="100" fill="transparent" r="80" stroke="#28A745" stroke-dasharray="calc(70 * 3.14159 * 1.6) 999" stroke-width="25"></circle>
<circle cx="100" cy="100" fill="transparent" r="80" stroke="#FFC107" stroke-dasharray="calc(20 * 3.14159 * 1.6) 999" stroke-width="25" transform="rotate(252, 100, 100)"></circle>
<circle cx="100" cy="100" fill="transparent" r="80" stroke="#DC3545" stroke-dasharray="calc(10 * 3.14159 * 1.6) 999" stroke-width="25" transform="rotate(324, 100, 100)"></circle>
<text class="dark:fill-white" fill="#111418" font-size="24" font-weight="bold" text-anchor="middle" x="100" y="105">150</text>
<text class="dark:fill-gray-400" fill="#617589" font-size="12" text-anchor="middle" x="100" y="125">Total</text>
</svg>
</div>
<div class="flex justify-center gap-4 text-sm">
<div class="flex items-center gap-2"><div class="size-3 rounded-full bg-[#28A745]"></div><span>Ativo (70%)</span></div>
<div class="flex items-center gap-2"><div class="size-3 rounded-full bg-[#FFC107]"></div><span>Manuten√ß√£o (20%)</span></div>
<div class="flex items-center gap-2"><div class="size-3 rounded-full bg-[#DC3545]"></div><span>Inativo (10%)</span></div>
</div>
</div>
</div>
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
<div class="flex flex-col gap-2 rounded-xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800">
<h3 class="text-lg font-semibold text-[#111418] dark:text-white p-4 pb-0">Alertas Importantes</h3>
<div class="divide-y divide-gray-200 dark:divide-gray-700">
<div id="alerts-container"></div>
</div>
</div>
<div class="flex flex-col gap-4 rounded-xl border border-gray-200 dark:border-gray-700 p-6 bg-white dark:bg-gray-800">
<h3 class="text-lg font-semibold text-[#111418] dark:text-white">Localiza√ß√£o da Frota</h3>
<div class="h-full min-h-[250px] rounded-lg bg-gray-200 dark:bg-gray-700 flex items-center justify-center">
<img class="w-full h-full object-cover rounded-lg" data-alt="Map showing vehicle locations" data-location="Brazil" src="https://lh3.googleusercontent.com/aida-public/AB6AXuCcXE9RfRodSCXZz-dLYgjVrmdYR3cUpg7VDGnNcaGSpWF1zdd4h34a3nK-WqEzpXeZmBrV4UZroDjjyDARsrvZawgukEhJcKm6BPBrOUhbis2BaeEe8LgtIQ5KoFpwJZUl62N-8Xnd1t5DRIRIjsjtECIx3vohvtIY9RjF95QgSOVl5lGPZQQe4HGTrAGegpVQI2pHZ5WSaGYq1YBCkD5LoDZQ4bYShQOGTzaiu4GJA68-K992Ps8-GikdIEVWRFMPAG4t1uoaiTg"/>
</div>
</div>
</div>
<div class="grid grid-cols-1 gap-6 mt-8">
<div class="flex flex-col gap-4 rounded-xl border border-gray-200 dark:border-gray-700 p-6 bg-white dark:bg-gray-800">
<h3 class="text-lg font-semibold text-[#111418] dark:text-white">Top 10 Ve√≠culos - KM Rodados Hoje</h3>
<div id="top-vehicles-container" class="overflow-x-auto">
<table class="w-full text-sm">
<thead class="border-b border-gray-200 dark:border-gray-700">
<tr>
<th class="text-left py-3 px-4 font-semibold text-[#111418] dark:text-white">Placa</th>
<th class="text-left py-3 px-4 font-semibold text-[#111418] dark:text-white">Modelo</th>
<th class="text-right py-3 px-4 font-semibold text-[#111418] dark:text-white">KM Hoje</th>
<th class="text-right py-3 px-4 font-semibold text-[#111418] dark:text-white">Status</th>
</tr>
</thead>
<tbody id="top-vehicles-list" class="divide-y divide-gray-200 dark:divide-gray-700">
<tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50">
<td colspan="4" class="text-center py-8 text-gray-500 dark:text-gray-400">Carregando dados...</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</main>
</div>
</div>
<script src="api-client.js"></script>
<script src="dashboard-real-data.js"></script>
<!-- dashboard-quilometragem-db.js DESATIVADO: Usa banco de dados -->
<!-- dashboard-stats.js FAZ C√ÅLCULO EM TEMPO REAL da API Ituran -->
<script>
// Sistema de gerenciamento de dados da frota
class FleetDataManager {
    constructor() {
        this.storageKey = 'fleetflow_data';
        this.initializeData();
    }

    initializeData() {
        if (!localStorage.getItem(this.storageKey)) {
            const defaultData = {
                vehicles: [
                    { plate: 'ABC-1234', model: 'Volkswagen Gol', year: 2022, mileage: 50000, status: 'Ativo', color: 'Branco' },
                    { plate: 'JKL-3456', model: 'Renault Kwid', year: 2023, mileage: 25000, status: 'Ativo', color: 'Prata' },
                    { plate: 'MNO-7890', model: 'Honda Civic', year: 2021, mileage: 70000, status: 'Ativo', color: 'Preto' },
                    { plate: 'DEF-5678', model: 'Fiat Strada', year: 2020, mileage: 85000, status: 'Manuten√ß√£o', color: 'Vermelho' },
                    { plate: 'QWE-1122', model: 'Ford Ka', year: 2022, mileage: 45000, status: 'Manuten√ß√£o', color: 'Azul' },
                    { plate: 'RST-3344', model: 'VW Saveiro', year: 2021, mileage: 60000, status: 'Manuten√ß√£o', color: 'Branco' },
                    { plate: 'UVW-5566', model: 'Hyundai HB20', year: 2023, mileage: 15000, status: 'Ativo', color: 'Cinza' },
                    { plate: 'GHI-9012', model: 'Chevrolet Onix', year: 2019, mileage: 120000, status: 'Arquivado', color: 'Prata' },
                    { plate: 'ZXY-6789', model: 'Mercedes Sprinter', year: 2018, mileage: 150000, status: 'Arquivado', color: 'Branco' }
                ],
                stats: {
                    totalVehicles: 150,
                    inMaintenance: 12,
                    availableDrivers: 45,
                    monthlyCost: 120000
                }
            };
            this.saveData(defaultData);
        }
    }

    getData() {
        return JSON.parse(localStorage.getItem(this.storageKey) || '{}');
    }

    saveData(data) {
        localStorage.setItem(this.storageKey, JSON.stringify(data));
    }

    getVehicles() {
        return this.getData().vehicles || [];
    }

    async getStats() {
        // Calcular estat√≠sticas REAIS baseadas em dados reais
        try {
            // 1. Total de Ve√≠culos - do vehicles-data.json
            const vehiclesResponse = await fetch('vehicles-data.json');
            const vehicles = await vehiclesResponse.json();
            const totalVehicles = vehicles.length;

            // 2. Em Manuten√ß√£o - baseado em OS abertas (n√£o finalizadas)
            const serviceOrders = JSON.parse(localStorage.getItem('serviceOrders') || '[]');

            // Pegar placas √∫nicas de OS n√£o finalizadas
            const vehiclesInMaintenance = new Set();
            serviceOrders.forEach(os => {
                if (os.status !== 'Finalizada') {
                    vehiclesInMaintenance.add(os.plate);
                }
            });
            const maintenanceVehicles = vehiclesInMaintenance.size;

            // 3. Custo Total do M√™s - somar OS finalizadas do m√™s atual
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();

            let monthlyCost = 0;
            serviceOrders.forEach(os => {
                const osDate = new Date(os.dateTime);
                if (osDate.getMonth() === currentMonth &&
                    osDate.getFullYear() === currentYear) {
                    monthlyCost += os.totalGeral || 0;
                }
            });

            // 4. Motoristas Dispon√≠veis - calcular baseado em motoristas cadastrados
            const drivers = JSON.parse(localStorage.getItem('drivers') || '[]');
            const availableDrivers = drivers.filter(d => d.status === 'Dispon√≠vel').length;

            // 5. Percentuais para o gr√°fico
            const activeVehicles = totalVehicles - maintenanceVehicles;
            const inactiveVehicles = 0; // Por enquanto zero

            const activePercent = totalVehicles > 0 ? Math.round((activeVehicles / totalVehicles) * 100) : 0;
            const maintenancePercent = totalVehicles > 0 ? Math.round((maintenanceVehicles / totalVehicles) * 100) : 0;
            const inactivePercent = 100 - activePercent - maintenancePercent;

            return {
                totalVehicles,
                maintenanceVehicles,
                availableDrivers: availableDrivers || 0, // Default 0 se n√£o houver motoristas
                monthlyCost,
                percentages: {
                    active: activePercent,
                    maintenance: maintenancePercent,
                    inactive: Math.max(0, inactivePercent)
                }
            };
        } catch (error) {
            console.error('‚ùå Erro ao calcular estat√≠sticas:', error);
            return {
                totalVehicles: 0,
                maintenanceVehicles: 0,
                availableDrivers: 0,
                monthlyCost: 0,
                percentages: { active: 100, maintenance: 0, inactive: 0 }
            };
        }
    }

    addVehicle(vehicle) {
        const data = this.getData();
        data.vehicles.push(vehicle);
        this.saveData(data);
        this.updateStats();
    }

    updateStats() {
        const data = this.getData();
        const vehicles = data.vehicles;
        data.stats.totalVehicles = vehicles.filter(v => v.status !== 'Arquivado').length;
        data.stats.inMaintenance = vehicles.filter(v => v.status === 'Manuten√ß√£o').length;
        this.saveData(data);
    }
}

// Inicializar gerenciador de dados
const fleetManager = new FleetDataManager();

// REMOVIDO: calculateKmStats() - Agora usa dados REAIS do dashboard-stats.js

// Atualizar estat√≠sticas do dashboard com dados da API
async function updateDashboard() {
    try {
        // Buscar estat√≠sticas da API
        const stats = await FleetAPI.getStats();
        const alerts = await FleetAPI.getAlerts();

        if (!stats) return;

        // Atualizar cards de estat√≠sticas
        const statCards = document.querySelectorAll('.grid.grid-cols-1.sm\\:grid-cols-2.lg\\:grid-cols-4 > div');
        if (statCards.length >= 4) {
            // Total de Ve√≠culos
            statCards[0].querySelector('.text-3xl').textContent = stats.totalVehicles;

            // Em Manuten√ß√£o
            statCards[1].querySelector('.text-3xl').textContent = stats.maintenanceVehicles;

            // Motoristas Dispon√≠veis
            statCards[2].querySelector('.text-3xl').textContent = stats.availableDrivers;

            // Custo Total
            statCards[3].querySelector('.text-3xl').textContent = `R$ ${stats.monthlyCost.toLocaleString('pt-BR')}`;
        }

        // KM Estat√≠sticas s√£o atualizadas pelo dashboard-stats.js
        // que usa dados REAIS do Ituran

        // Atualizar gr√°fico de pizza (percentuais)
        const activePercent = stats.percentages.active;
        const maintenancePercent = stats.percentages.maintenance;
        const inactivePercent = stats.percentages.inactive;

        // Atualizar texto do gr√°fico
        const chartLabels = document.querySelectorAll('.flex.justify-center.gap-4.text-sm span');
        if (chartLabels.length >= 3) {
            chartLabels[0].textContent = `Ativo (${activePercent}%)`;
            chartLabels[1].textContent = `Manuten√ß√£o (${maintenancePercent}%)`;
            chartLabels[2].textContent = `Inativo (${inactivePercent}%)`;
        }

        // Atualizar total no centro do gr√°fico
        const chartCenter = document.querySelector('svg text[font-size="24"]');
        if (chartCenter) {
            chartCenter.textContent = stats.totalVehicles;
        }

        // Gerar alertas din√¢micos da API
        const alertsContainer = document.getElementById('alerts-container');
        if (alertsContainer && alerts.length > 0) {
            let alertsHTML = '';

            alerts.forEach(alert => {
                alertsHTML += `
                    <div class="flex items-center gap-4 p-4 hover:bg-gray-50 dark:hover:bg-gray-700/50">
                        <div class="text-${alert.color}-500 flex items-center justify-center rounded-lg bg-${alert.color}-500/10 shrink-0 size-12">
                            <span class="material-symbols-outlined text-2xl">${alert.icon}</span>
                        </div>
                        <div class="flex flex-col justify-center flex-1">
                            <p class="text-[#111418] dark:text-white text-base font-medium leading-normal line-clamp-1">${alert.title}</p>
                            <p class="text-gray-500 dark:text-gray-400 text-sm font-normal leading-normal line-clamp-2">${alert.description}</p>
                        </div>
                        <div class="shrink-0"><p class="text-gray-500 dark:text-gray-400 text-sm font-normal leading-normal">${alert.time}</p></div>
                    </div>
                `;
            });

            alertsContainer.innerHTML = alertsHTML;
        }

        console.log('‚úÖ Dashboard atualizado com sucesso!');
    } catch (error) {
        console.error('‚ùå Erro ao atualizar dashboard:', error);
    }
}

// Inicializar dashboard quando a p√°gina carregar
document.addEventListener('DOMContentLoaded', async () => {
    // Atualizar com dados reais primeiro
    const realData = new DashboardRealData();
    await realData.updateDashboard();

    // Depois atualizar dados din√¢micos da API
    updateDashboard();

    // REMOVIDO: setInterval - Os dados de KM agora s√£o gerenciados pelo dashboard-stats.js
    // que usa cache di√°rio e dados REAIS do Ituran
});

/**
 * Sincroniza√ß√£o Manual de Quilometragem
 * For√ßa rec√°lculo dos dados de KM de todos os ve√≠culos
 */
async function sincronizarKmManual() {
    console.log('üîÑ SINCRONIZA√á√ÉO MANUAL iniciada pelo usu√°rio');

    const btnSync = document.getElementById('btn-sync-km');
    const progressBar = document.getElementById('sync-progress-bar');
    const progressFill = document.getElementById('sync-progress-fill');
    const progressText = document.getElementById('sync-progress-text');
    const statusText = document.getElementById('sync-status-text');

    try {
        // Desabilita bot√£o
        if (btnSync) {
            btnSync.disabled = true;
            btnSync.classList.add('opacity-50', 'cursor-not-allowed');
        }

        // Mostra barra de progresso
        if (progressBar) {
            progressBar.classList.remove('hidden');
        }

        // Limpa TODOS os caches para for√ßar rec√°lculo COMPLETO (incluindo KM mensal)
        console.log('üóëÔ∏è Limpando TODOS os caches para for√ßar rec√°lculo completo...');
        localStorage.removeItem('fleetflow_daily_km_data');
        localStorage.removeItem('fleetflow_dashboard_stats_cache_realtime');
        localStorage.removeItem('fleetflow_dashboard_stats_cache_month'); // IMPORTANTE: Limpa cache mensal!

        if (statusText) {
            statusText.textContent = 'Preparando sincroniza√ß√£o...';
        }

        // Aguarda 500ms para dar tempo da interface atualizar
        await new Promise(resolve => setTimeout(resolve, 500));

        // Chama a fun√ß√£o calculateInBackground que j√° existe no dashboard-stats.js
        // Ela j√° tem toda a l√≥gica de progresso e atualiza√ß√£o da interface
        if (typeof calculateInBackground === 'function') {
            console.log('‚úÖ Chamando calculateInBackground() do dashboard-stats.js');

            if (statusText) {
                statusText.textContent = 'Buscando lista de ve√≠culos...';
            }

            await calculateInBackground(0, null);

            console.log('‚úÖ Sincroniza√ß√£o conclu√≠da!');

            if (statusText) {
                statusText.textContent = 'Sincroniza√ß√£o conclu√≠da com sucesso!';
            }
            if (progressFill) {
                progressFill.style.width = '100%';
            }
            if (progressText) {
                progressText.textContent = '100%';
            }

            // Esconde barra ap√≥s 3 segundos
            setTimeout(() => {
                if (progressBar) {
                    progressBar.classList.add('hidden');
                }
            }, 3000);

        } else {
            throw new Error('Fun√ß√£o calculateInBackground n√£o encontrada. Verifique se dashboard-stats.js foi carregado.');
        }

    } catch (error) {
        console.error('‚ùå Erro na sincroniza√ß√£o:', error);

        if (statusText) {
            statusText.textContent = `Erro: ${error.message}`;
            statusText.classList.add('text-red-600', 'dark:text-red-400');
        }

        alert('Erro ao sincronizar quilometragem. Verifique o console (F12) para mais detalhes.');

    } finally {
        // Reabilita bot√£o
        if (btnSync) {
            btnSync.disabled = false;
            btnSync.classList.remove('opacity-50', 'cursor-not-allowed');
        }
    }
}

/**
 * Limpar Cache de Quilometragem
 * Remove todos os caches de KM armazenados
 */
function limparCacheKm() {
    if (!confirm('Tem certeza que deseja limpar TODOS os caches de quilometragem?\n\nIsso for√ßar√° o rec√°lculo de todos os dados na pr√≥xima atualiza√ß√£o.')) {
        return;
    }

    console.log('üóëÔ∏è Limpando TODOS os caches de KM...');

    try {
        // Remove todos os caches relacionados a quilometragem
        localStorage.removeItem('fleetflow_daily_km_data');
        localStorage.removeItem('fleetflow_dashboard_stats_cache_realtime');
        localStorage.removeItem('fleetflow_dashboard_stats_cache_month');
        localStorage.removeItem('fleetflow_km_cache_v2');
        localStorage.removeItem('fleetflow_odometer_snapshots');

        console.log('‚úÖ Todos os caches foram removidos!');
        alert('Cache limpo com sucesso!\n\nA p√°gina ser√° recarregada para recalcular os dados.');

        // Recarrega a p√°gina
        window.location.reload();

    } catch (error) {
        console.error('‚ùå Erro ao limpar cache:', error);
        alert('Erro ao limpar cache. Verifique o console (F12) para mais detalhes.');
    }
}

// Exp√µe fun√ß√µes globalmente
window.sincronizarKmManual = sincronizarKmManual;
window.limparCacheKm = limparCacheKm;
</script>
<script src="ituran-service.js"></script>
<script src="vehicles-data.js"></script>
<script src="dashboard-stats.js"></script>
<script src="sidebar.js"></script>
</body></html>