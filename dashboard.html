<!DOCTYPE html>
<html class="light" lang="en"><head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Fleet Management Dashboard</title>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&amp;display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Scripts do FleetFlow -->
<script src="auth.js" defer></script>
<script src="ituran-service.js?v=20251208-1420"></script>
<script src="dashboard-stats.js?v=20260102-1110"></script>
<script src="sidebar.js?v=20260113-FIX-ZINDEX"></script>
<script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#1173d4",
                        "background-light": "#f6f7f8",
                        "background-dark": "#101922",
                    },
                    fontFamily: {
                        "display": ["Inter", "sans-serif"]
                    },
                    borderRadius: {
                        "DEFAULT": "0.25rem",
                        "lg": "0.5rem",
                        "xl": "0.75rem",
                        "full": "9999px"
                    },
                },
            },
        }
    </script>
<style>
        .material-symbols-outlined {
            font-variation-settings:
            'FILL' 0,
            'wght' 400,
            'GRAD' 0,
            'opsz' 24
        }
    </style>
</head>
<body class="bg-background-light dark:bg-gray-900 font-display text-[#333333] dark:text-white">
<div class="relative flex h-auto min-h-screen w-full flex-col">
<div class="flex h-full grow flex-row">
<!-- Sidebar Unificado -->
<div id="sidebar-container" data-page="dashboard"></div>
<main class="flex-1 p-6 lg:p-8 bg-background-light dark:bg-gray-900">
<div class="flex flex-wrap justify-between gap-4 items-center mb-6">
<div class="flex flex-col gap-1">
<h1 class="text-3xl font-black text-[#111418] dark:text-white tracking-[-0.03em]">Dashboard da Frota</h1>
<p class="text-gray-500 dark:text-gray-400 text-base font-normal">Vis√£o geral da sua frota em tempo real.</p>
</div>
<div class="flex items-center gap-2 flex-wrap justify-end">
<button id="btn-sync-km" onclick="sincronizarKmManual()" class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center gap-2 overflow-hidden rounded-lg h-10 px-4 bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 border border-gray-300 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700 text-sm font-bold leading-normal tracking-[0.015em]">
<span class="material-symbols-outlined">sync</span>
<span class="truncate">Sincronizar KM</span>
</button>
<button onclick="limparCacheKm()" class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center gap-2 overflow-hidden rounded-lg h-10 px-4 bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 border border-gray-300 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700 text-sm font-bold leading-normal tracking-[0.015em]">
<span class="material-symbols-outlined">delete</span>
<span class="truncate">Limpar Cache</span>
</button>
<button class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center gap-2 overflow-hidden rounded-lg h-10 px-4 bg-primary text-white text-sm font-bold leading-normal tracking-[0.015em]">
<span class="material-symbols-outlined">download</span>
<span class="truncate">Exportar</span>
</button>
</div>
</div>
<div id="sync-progress-bar" class="mb-6 p-6 rounded-xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 hidden">
<div class="flex items-center justify-between mb-4">
<p class="text-base font-medium text-gray-700 dark:text-gray-300" id="sync-progress-text">Sincronizando KM (0%)</p>
<p class="text-sm text-gray-500 dark:text-gray-400" id="sync-status-text">Iniciando...</p>
</div>
<div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5 mb-4">
<div id="sync-progress-fill" class="bg-primary h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
</div>
<div class="flex flex-col">
<p class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Ve√≠culos analisados:</p>
<div id="syncPlatesContainer" class="flex flex-wrap gap-2 max-h-32 overflow-y-auto">
<!-- Placas ser√£o adicionadas dinamicamente aqui -->
</div>
</div>
</div>
<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-6 mb-6">
<div class="flex flex-col gap-2 rounded-xl p-6 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700">
<p class="text-base font-medium text-[#111418] dark:text-gray-300">KM Rodados Hoje</p>
<p id="stat-km-today" class="text-3xl font-bold text-[#111418] dark:text-white">0 km</p>
<p id="stat-km-today-meta" class="text-gray-500 dark:text-gray-400 text-sm font-medium">
    <span id="last-sync-time">Carregando...</span>
</p>
</div>
<div class="flex flex-col gap-2 rounded-xl p-6 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700">
<p class="text-base font-medium text-[#111418] dark:text-gray-300">KM Rodados Ontem</p>
<p id="stat-km-yesterday" class="text-3xl font-bold text-[#111418] dark:text-white">0 km</p>
<p class="text-gray-500 dark:text-gray-400 text-sm font-medium">
    <span id="last-sync-time-yesterday">Carregando...</span>
</p>
</div>
<div class="flex flex-col gap-2 rounded-xl p-6 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700">
<p class="text-base font-medium text-[#111418] dark:text-gray-300">Ve√≠culos em Movimento</p>
<p id="stat-vehicles-moving" class="text-3xl font-bold text-[#111418] dark:text-white">0</p>
<p class="text-gray-500 dark:text-gray-400 text-sm font-medium">Atualizado agora</p>
</div>
<div class="flex flex-col gap-2 rounded-xl p-6 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700">
<p class="text-base font-medium text-[#111418] dark:text-gray-300">KM do M√™s</p>
<p id="stat-km-month" class="text-3xl font-bold text-[#111418] dark:text-white">0 km</p>
<p class="text-gray-500 dark:text-gray-400 text-sm font-medium">
    <span id="last-sync-time-month">Carregando...</span>
</p>
</div>
<div class="flex flex-col gap-2 rounded-xl p-6 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700">
<p class="text-base font-medium text-[#111418] dark:text-gray-300">Total de Ve√≠culos</p>
<p id="stat-total-vehicles" class="text-3xl font-bold text-[#111418] dark:text-white">0</p>
<p class="text-gray-500 dark:text-gray-400 text-sm font-medium">Ativos na frota</p>
</div>
</div>

<!-- Quilometragem por Regi√£o -->
<div class="rounded-xl border border-gray-200 dark:border-gray-700 p-6 bg-white dark:bg-gray-800 mb-6">
    <div class="flex flex-wrap items-center justify-between gap-4 mb-4">
        <div class="flex flex-col">
            <h3 class="text-lg font-semibold text-[#111418] dark:text-white">üìä Quilometragem por Regi√£o</h3>
            <p class="text-sm text-gray-500 dark:text-gray-400">KM rodados hoje em cada √°rea</p>
        </div>
        <button onclick="loadKmByArea()" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 text-sm flex items-center gap-2">
            <span class="material-symbols-outlined text-sm">refresh</span>
            Atualizar
        </button>
    </div>

    <div id="km-by-area-container" class="overflow-x-auto">
        <div class="text-center py-8 text-gray-500">
            <span class="material-symbols-outlined text-4xl mb-2">location_on</span>
            <p>Carregando dados de quilometragem por regi√£o...</p>
        </div>
    </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
<div class="lg:col-span-2 flex flex-col gap-4 rounded-xl border border-gray-200 dark:border-gray-700 p-6 bg-white dark:bg-gray-800">
<div class="flex flex-wrap items-start justify-between gap-4">
<div class="flex flex-col">
<p class="text-lg font-semibold text-[#111418] dark:text-white">An√°lise de Custos</p>
<p class="text-sm text-gray-500 dark:text-gray-400">Detalhes de custos por categoria e ve√≠culo.</p>
</div>
<div class="flex flex-wrap justify-end gap-2">
<div class="relative">
<select id="cost-period-filter" onchange="loadCostAnalysis()" class="pl-8 pr-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-sm focus:outline-none focus:ring-2 focus:ring-primary w-36">
<option value="current_month" selected>M√™s Atual</option>
<option value="last_month">M√™s Anterior</option>
<option value="year">Ano Atual</option>
<option value="all">Todos</option>
</select>
<span class="material-symbols-outlined absolute left-2 top-1/2 -translate-y-1/2 text-gray-400">calendar_today</span>
</div>
<div class="relative">
<select id="cost-vehicle-filter" onchange="loadCostAnalysis()" class="pl-8 pr-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-sm focus:outline-none focus:ring-2 focus:ring-primary w-36">
<option value="" selected>Todos Ve√≠culos</option>
</select>
<span class="material-symbols-outlined absolute left-2 top-1/2 -translate-y-1/2 text-gray-400">local_shipping</span>
</div>
<div class="relative">
<select id="cost-area-filter" onchange="loadCostAnalysis()" class="pl-8 pr-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-sm focus:outline-none focus:ring-2 focus:ring-primary w-36">
<option value="" selected>Todas Regi√µes</option>
</select>
<span class="material-symbols-outlined absolute left-2 top-1/2 -translate-y-1/2 text-gray-400">corporate_fare</span>
</div>
<button onclick="exportCostData()" class="flex items-center gap-1 px-3 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm font-medium">
<span class="material-symbols-outlined text-base">download</span>
Excel
</button>
</div>
</div>
<!-- Cards de M√©tricas de Manuten√ß√£o -->
<div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
<div class="bg-blue-50 dark:bg-blue-900/30 rounded-lg p-3 text-center">
<p class="text-xs text-blue-600 dark:text-blue-400 uppercase font-medium">Custo Total Manuten√ß√£o</p>
<p id="cost-total-maintenance" class="text-xl font-bold text-blue-800 dark:text-blue-200">Carregando...</p>
</div>
<div class="bg-green-50 dark:bg-green-900/30 rounded-lg p-3 text-center">
<p class="text-xs text-green-600 dark:text-green-400 uppercase font-medium">Preventivas</p>
<p id="cost-preventive-count" class="text-xl font-bold text-green-800 dark:text-green-200">-</p>
</div>
<div class="bg-red-50 dark:bg-red-900/30 rounded-lg p-3 text-center">
<p class="text-xs text-red-600 dark:text-red-400 uppercase font-medium">Corretivas</p>
<p id="cost-corrective-count" class="text-xl font-bold text-red-800 dark:text-red-200">-</p>
</div>
<div class="bg-purple-50 dark:bg-purple-900/30 rounded-lg p-3 text-center">
<p class="text-xs text-purple-600 dark:text-purple-400 uppercase font-medium">Pe√ßas Trocadas</p>
<p id="cost-parts-count" class="text-xl font-bold text-purple-800 dark:text-purple-200">-</p>
</div>
</div>
<div class="h-80"><canvas id="costChart"></canvas></div>
</div>
<div class="flex flex-col gap-4 rounded-xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800">
<h3 class="text-lg font-semibold text-[#111418] dark:text-white p-6 pb-2">Top 10 Ve√≠culos - KM Rodados Hoje</h3>
<div id="top-vehicles-container" class="overflow-hidden">
<table class="w-full text-sm table-fixed">
<thead class="border-b border-gray-200 dark:border-gray-700">
<tr>
<th class="text-left py-3 px-4 font-semibold text-[#111418] dark:text-white">Placa</th>
<th class="text-left py-3 px-4 font-semibold text-[#111418] dark:text-white">Modelo</th>
<th class="text-right py-3 px-4 font-semibold text-[#111418] dark:text-white">KM Hoje</th>
<th class="text-right py-3 px-4 font-semibold text-[#111418] dark:text-white">Status</th>
</tr>
</thead>
<tbody id="top-vehicles-list" class="divide-y divide-gray-200 dark:divide-gray-700">
<tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50">
<td colspan="4" class="text-center py-8 text-gray-500 dark:text-gray-400">Carregando dados...</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="flex flex-col gap-6 rounded-xl border border-gray-200 dark:border-gray-700 p-6 bg-white dark:bg-gray-800">
<div class="flex flex-wrap items-start justify-between gap-4">
<div class="flex flex-col">
<h3 class="text-lg font-semibold text-[#111418] dark:text-white">Quilometragem Detalhada</h3>
<p class="text-sm text-gray-500 dark:text-gray-400">Explore a quilometragem com filtros avan√ßados.</p>
</div>
<div class="flex items-center gap-2 p-1 rounded-lg bg-gray-100 dark:bg-gray-700">
<button data-period="today" class="px-3 py-1 rounded text-sm font-medium bg-white dark:bg-gray-800 text-primary shadow-sm">Hoje</button>
<button data-period="week" class="px-3 py-1 rounded text-sm font-medium text-gray-600 dark:text-gray-300">7 Dias</button>
<button data-period="month" class="px-3 py-1 rounded text-sm font-medium text-gray-600 dark:text-gray-300">M√™s</button>
<button data-period="custom" class="px-3 py-1 rounded text-sm font-medium text-gray-600 dark:text-gray-300 flex items-center gap-1">
<span class="material-symbols-outlined text-base">calendar_month</span> Customizado
</button>
</div>
</div>
<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4">
<div class="relative">
<input data-filter="plate" class="w-full pl-8 pr-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-sm focus:outline-none focus:ring-2 focus:ring-primary" placeholder="Buscar Ve√≠culo..." type="text"/>
<span class="material-symbols-outlined absolute left-2 top-1/2 -translate-y-1/2 text-gray-400">search</span>
</div>
<div class="relative">
<input data-filter="driver" class="w-full pl-8 pr-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-sm focus:outline-none focus:ring-2 focus:ring-primary" placeholder="Buscar Motorista..." type="text"/>
<span class="material-symbols-outlined absolute left-2 top-1/2 -translate-y-1/2 text-gray-400">search</span>
</div>
<div class="relative">
<select id="vehicleTypeSelect" data-filter-select="vehicleType" class="w-full pl-8 pr-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-sm focus:outline-none focus:ring-2 focus:ring-primary">
<option selected="">Tipo de Ve√≠culo</option>
</select>
<span class="material-symbols-outlined absolute left-2 top-1/2 -translate-y-1/2 text-gray-400">local_shipping</span>
</div>
<div class="relative">
<select id="baseSelect" data-filter-select="base" class="w-full pl-8 pr-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-sm focus:outline-none focus:ring-2 focus:ring-primary">
<option selected="">Centro de Custo</option>
</select>
<span class="material-symbols-outlined absolute left-2 top-1/2 -translate-y-1/2 text-gray-400">corporate_fare</span>
</div>
<div class="relative">
<select id="statusSelect" data-filter-select="status" class="w-full pl-8 pr-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-sm focus:outline-none focus:ring-2 focus:ring-primary">
<option selected="">Status do Ve√≠culo</option>
</select>
<span class="material-symbols-outlined absolute left-2 top-1/2 -translate-y-1/2 text-gray-400">circle</span>
</div>
</div>
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
<div class="lg:col-span-2 overflow-x-auto max-h-[600px] overflow-y-auto border border-gray-200 dark:border-gray-700 rounded-lg">
<table class="w-full text-left text-sm">
<thead class="border-b border-gray-200 dark:border-gray-700 text-gray-500 dark:text-gray-400 sticky top-0 bg-white dark:bg-gray-800 z-10">
<tr>
<th class="p-4 font-medium">Ve√≠culo</th>
<th class="p-4 font-medium">Motorista</th>
<th class="p-4 font-medium">KM Rodado</th>
<th class="p-4 font-medium">Consumo (km/l)</th>
<th class="p-4 font-medium">Custo por KM</th>
</tr>
</thead>
<tbody id="detailedTableBody" class="divide-y divide-gray-200 dark:divide-gray-700">
<tr>
<td colspan="5" class="p-8 text-center text-gray-500 dark:text-gray-400">
Carregando dados...
</td>
</tr>
</tbody>
<tfoot id="detailedTableFooter" class="bg-gray-50 dark:bg-gray-700 border-t-2 border-gray-300 dark:border-gray-600">
<!-- Footer ser√° preenchido dinamicamente -->
</tfoot>
</table>
</div>
<div class="flex flex-col gap-4">
<p class="text-base font-semibold text-[#111418] dark:text-white">Evolu√ß√£o da Quilometragem</p>
<div class="h-64"><canvas id="mileageChart"></canvas></div>
</div>
</div>
</div>
</main>
</div>
</div>
<script>
    const isDarkMode = document.documentElement.classList.contains('dark');
    const gridColor = isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
    const textColor = isDarkMode ? '#f9fafb' : '#374151';
    // === SISTEMA DE AN√ÅLISE DE CUSTOS ===
    const COST_API = 'https://floripa.in9automacao.com.br/cost-analysis-api.php';
    let costChartInstance = null;

    // Inicializar filtros e carregar dados
    async function initCostAnalysis() {
        await loadCostFilters();
        await loadCostAnalysis();
    }

    // Carregar op√ß√µes dos filtros
    async function loadCostFilters() {
        try {
            // Carregar √°reas
            const areasRes = await fetch(`${COST_API}?action=areas_list`);
            const areasData = await areasRes.json();
            if (areasData.success && areasData.areas) {
                const areaSelect = document.getElementById('cost-area-filter');
                areasData.areas.forEach(a => {
                    const opt = document.createElement('option');
                    opt.value = a.id;
                    opt.textContent = a.name;
                    areaSelect.appendChild(opt);
                });
            }

            // Carregar ve√≠culos
            const veicRes = await fetch(`${COST_API}?action=vehicles_list`);
            const veicData = await veicRes.json();
            if (veicData.success && veicData.veiculos) {
                const veicSelect = document.getElementById('cost-vehicle-filter');
                veicData.veiculos.forEach(v => {
                    const opt = document.createElement('option');
                    opt.value = v.placa;
                    opt.textContent = `${v.placa} - ${v.modelo || ''}`;
                    veicSelect.appendChild(opt);
                });
            }
        } catch (error) {
            console.error('Erro ao carregar filtros:', error);
        }
    }

    // Carregar dados de custos
    async function loadCostAnalysis() {
        const period = document.getElementById('cost-period-filter').value;
        const plate = document.getElementById('cost-vehicle-filter').value;
        const areaId = document.getElementById('cost-area-filter').value;

        const now = new Date();
        let month = now.getMonth() + 1;
        let year = now.getFullYear();
        let isAll = period === 'all';

        if (period === 'last_month') {
            month = month === 1 ? 12 : month - 1;
            year = month === 12 ? year - 1 : year;
        }

        try {
            // Carregar resumo
            let summaryUrl = `${COST_API}?action=summary`;
            if (isAll) {
                summaryUrl += '&all=true';
            } else {
                summaryUrl += `&month=${month}&year=${year}`;
            }
            if (plate) summaryUrl += `&plate=${encodeURIComponent(plate)}`;
            if (areaId) summaryUrl += `&area_id=${areaId}`;

            const summaryRes = await fetch(summaryUrl);
            const summaryData = await summaryRes.json();

            if (summaryData.success && summaryData.resumo) {
                document.getElementById('cost-total-maintenance').textContent = summaryData.resumo.custo_formatado || 'R$ 0,00';
                document.getElementById('cost-preventive-count').textContent = summaryData.resumo.preventivas_count || 0;
                document.getElementById('cost-corrective-count').textContent = summaryData.resumo.corretivas_count || 0;
                document.getElementById('cost-parts-count').textContent = summaryData.resumo.pecas_trocadas || 0;
            }

            // Carregar dados do gr√°fico
            let chartUrl = `${COST_API}?action=monthly`;
            if (isAll) {
                chartUrl += '&all=true';
            } else {
                chartUrl += `&year=${year}`;
            }
            if (plate) chartUrl += `&plate=${encodeURIComponent(plate)}`;
            if (areaId) chartUrl += `&area_id=${areaId}`;

            const chartRes = await fetch(chartUrl);
            const chartData = await chartRes.json();

            if (chartData.success && chartData.chart_data) {
                updateCostChart(chartData.chart_data);
            }
        } catch (error) {
            console.error('Erro ao carregar custos:', error);
            document.getElementById('cost-total-maintenance').textContent = 'Erro';
        }
    }

    // Atualizar gr√°fico
    function updateCostChart(data) {
        const ctx = document.getElementById('costChart');
        if (!ctx) return;

        const datasets = data.datasets.map(ds => ({
            ...ds,
            borderRadius: 4
        }));

        if (costChartInstance) {
            costChartInstance.data.labels = data.labels;
            costChartInstance.data.datasets = datasets;
            costChartInstance.update();
        } else {
            costChartInstance = new Chart(ctx, {
                type: 'bar',
                data: { labels: data.labels, datasets: datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top', labels: { color: textColor } },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': R$ ' + (context.raw || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2 });
                                }
                            }
                        }
                    },
                    scales: {
                        x: { stacked: true, ticks: { color: textColor }, grid: { color: gridColor, drawOnChartArea: false } },
                        y: {
                            stacked: true,
                            ticks: { color: textColor, callback: v => 'R$ ' + v.toLocaleString('pt-BR') },
                            grid: { color: gridColor }
                        }
                    }
                }
            });
        }
    }

    // Exportar para Excel
    function exportCostData() {
        const period = document.getElementById('cost-period-filter').value;
        const plate = document.getElementById('cost-vehicle-filter').value;
        const areaId = document.getElementById('cost-area-filter').value;

        const now = new Date();
        let month = now.getMonth() + 1;
        let year = now.getFullYear();

        if (period === 'last_month') {
            month = month === 1 ? 12 : month - 1;
            year = month === 12 ? year - 1 : year;
        }

        let url = `${COST_API}?action=export&year=${year}`;
        if (period !== 'year') url += `&month=${month}`;
        if (plate) url += `&plate=${encodeURIComponent(plate)}`;
        if (areaId) url += `&area_id=${areaId}`;

        window.location.href = url;
    }

    // Inicializar ao carregar
    initCostAnalysis();

    // Mileage Chart - DADOS REAIS DOS √öLTIMOS 7 DIAS
    const mileageCtx = document.getElementById('mileageChart');
    if (mileageCtx) {
        // Fun√ß√£o para carregar dados reais
        async function loadRealMileageChart() {
            try {
                // Buscar dados dos √∫ltimos 7 dias
                const today = new Date();
                const daysData = [];
                const labels = [];

                for (let i = 6; i >= 0; i--) {
                    const date = new Date(today);
                    date.setDate(date.getDate() - i);
                    const dateStr = date.toISOString().split('T')[0];

                    // Buscar KM do dia
                    const response = await fetch(`https://floripa.in9automacao.com.br/daily-mileage-api.php?date_from=${dateStr}&date_to=${dateStr}&limit=1000`);
                    const data = await response.json();

                    // Calcular total KM do dia
                    const totalKm = data.success && data.records
                        ? data.records.reduce((sum, r) => sum + (parseFloat(r.km_driven) || 0), 0)
                        : 0;

                    daysData.push(Math.round(totalKm));

                    // Label: Dia da semana (ex: Seg, Ter, Qua)
                    const dayNames = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'];
                    labels.push(dayNames[date.getDay()]);
                }

                // Criar gr√°fico com dados reais
                new Chart(mileageCtx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'KM Total',
                            data: daysData,
                            borderColor: '#1173d4',
                            backgroundColor: 'rgba(17, 115, 212, 0.1)',
                            fill: true,
                            tension: 0.4,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return 'KM Rodados: ' + context.parsed.y.toLocaleString('pt-BR') + ' km';
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                ticks: { color: textColor },
                                grid: { color: gridColor, drawOnChartArea: false }
                            },
                            y: {
                                ticks: {
                                    color: textColor,
                                    callback: function(value) {
                                        return value.toLocaleString('pt-BR') + ' km';
                                    }
                                },
                                grid: { color: gridColor }
                            }
                        }
                    }
                });

                console.log('‚úÖ Gr√°fico de evolu√ß√£o carregado com dados reais dos √∫ltimos 7 dias');

            } catch (error) {
                console.error('‚ùå Erro ao carregar gr√°fico de evolu√ß√£o:', error);
                // Fallback: criar gr√°fico vazio
                new Chart(mileageCtx, {
                    type: 'line',
                    data: {
                        labels: ['Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b', 'Dom'],
                        datasets: [{
                            label: 'KM Total',
                            data: [0, 0, 0, 0, 0, 0, 0],
                            borderColor: '#1173d4',
                            backgroundColor: 'rgba(17, 115, 212, 0.1)',
                            fill: true,
                            tension: 0.4,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: {
                                ticks: { color: textColor },
                                grid: { color: gridColor, drawOnChartArea: false }
                            },
                            y: {
                                ticks: { color: textColor },
                                grid: { color: gridColor }
                            }
                        }
                    }
                });
            }
        }

        // Carregar gr√°fico
        loadRealMileageChart();
    }
</script>
<script src="api-client.js?v=20251125"></script>
<script src="dashboard-real-data.js"></script>
<script src="vehicles-data.js"></script>
<!-- DESATIVADO: Conflita com dashboard-stats.js -->
<!-- <script src="novo-dashboard.js?v=20251202-002"></script> -->
<script src="sidebar.js?v=20260113-FIX-ZINDEX"></script>
<script>
/**
 * Sincroniza√ß√£o Manual de Quilometragem
 * For√ßa rec√°lculo dos dados de KM de todos os ve√≠culos
 */
async function sincronizarKmManual() {
    console.log('üîÑ SINCRONIZA√á√ÉO MANUAL iniciada pelo usu√°rio');

    const btnSync = document.getElementById('btn-sync-km');
    const progressBar = document.getElementById('syncProgressBar');
    const progressFill = document.getElementById('syncProgressFill');
    const progressText = document.getElementById('syncProgressText');
    const statusText = document.getElementById('syncStatusText');

    try {
        // Desabilita bot√£o
        if (btnSync) {
            btnSync.disabled = true;
            btnSync.classList.add('opacity-50', 'cursor-not-allowed');
        }

        // Mostra barra de progresso
        if (progressBar) {
            progressBar.classList.remove('hidden');
        }

        // Verifica se j√° existe sincroniza√ß√£o em andamento
        const existingCache = localStorage.getItem('fleetflow_daily_km_data');
        let startFrom = 0;
        let initialData = null;
        let continuingSync = false;

        if (existingCache) {
            try {
                const cacheData = JSON.parse(existingCache);
                const today = new Date().toISOString().split('T')[0];

                // Se o cache √© de hoje E est√° incompleto, continua de onde parou
                if (cacheData.date === today && cacheData.isComplete === false) {
                    startFrom = cacheData.progress || 0;
                    initialData = {
                        todayTotal: cacheData.todayTotal || 0,
                        yesterdayTotal: cacheData.yesterdayTotal || 0,
                        monthTotal: cacheData.monthTotal || 0,
                        vehiclesData: cacheData.vehiclesData || [],
                        vehiclesMoving: cacheData.vehiclesData?.filter(v => v.kmToday > 0).length || 0
                    };
                    continuingSync = true;
                    console.log(`üîÑ CONTINUANDO sincroniza√ß√£o do ve√≠culo ${startFrom}...`);
                } else {
                    // Cache completo ou de outro dia - limpa tudo
                    console.log('üóëÔ∏è Limpando caches para nova sincroniza√ß√£o...');
                    localStorage.removeItem('fleetflow_daily_km_data');
                    localStorage.removeItem('fleetflow_dashboard_stats_cache_realtime');
                    localStorage.removeItem('fleetflow_dashboard_stats_cache_month');
                    localStorage.removeItem('fleetflow_km_cache_v2');
                    localStorage.removeItem('fleetflow_odometer_snapshots');
                }
            } catch (e) {
                console.warn('‚ö†Ô∏è Erro ao ler cache, limpando...', e);
                localStorage.removeItem('fleetflow_daily_km_data');
            }
        } else {
            // Sem cache - limpa tudo para garantir
            console.log('üóëÔ∏è Limpando TODOS os caches para sincroniza√ß√£o completa...');
            localStorage.removeItem('fleetflow_dashboard_stats_cache_realtime');
            localStorage.removeItem('fleetflow_dashboard_stats_cache_month');
            localStorage.removeItem('fleetflow_km_cache_v2');
            localStorage.removeItem('fleetflow_odometer_snapshots');
        }

        // Atualiza progresso
        const initialProgress = continuingSync ? Math.round((startFrom / (initialData?.vehiclesData?.length || 1)) * 100) : 0;
        if (progressText) progressText.textContent = continuingSync ? `Continuando sincroniza√ß√£o (${initialProgress}%)` : 'Sincronizando KM (0%)';
        if (statusText) statusText.textContent = continuingSync ? `Retomando do ve√≠culo ${startFrom}...` : 'Preparando...';

        // Verifica se dashboard-stats.js carregou
        if (typeof calculateInBackground === 'function') {
            console.log(continuingSync ? 'üîÑ Continuando c√°lculo em background...' : '‚úÖ Iniciando c√°lculo em background...');

            const platesContainer = document.getElementById('syncPlatesContainer');
            if (platesContainer && !continuingSync) {
                platesContainer.innerHTML = ''; // Limpa placas apenas se for nova sincroniza√ß√£o
            }

            // Chama fun√ß√£o de c√°lculo em background
            await calculateInBackground(startFrom, initialData, (progress, currentPlate) => {
                if (progressFill) {
                    progressFill.style.width = `${progress}%`;
                }
                if (progressText) {
                    progressText.textContent = `Sincronizando KM (${Math.round(progress)}%)`;
                }
                if (statusText) {
                    if (progress < 50) {
                        statusText.textContent = 'Calculando KM de hoje...';
                    } else if (progress < 100) {
                        statusText.textContent = 'Calculando KM do m√™s...';
                    } else {
                        statusText.textContent = 'Finalizado!';
                    }
                }

                // Adicionar placa processada
                if (currentPlate && platesContainer) {
                    const plateSpan = document.createElement('span');
                    plateSpan.className = 'px-2 py-1 bg-primary/10 text-primary text-xs font-mono rounded-md';
                    plateSpan.textContent = currentPlate;
                    platesContainer.appendChild(plateSpan);

                    // Auto-scroll para o final
                    platesContainer.scrollTop = platesContainer.scrollHeight;
                }
            });

            // Sucesso
            if (statusText) {
                statusText.textContent = '‚úÖ Sincroniza√ß√£o conclu√≠da com sucesso!';
                statusText.classList.remove('text-red-600', 'dark:text-red-400');
                statusText.classList.add('text-green-600', 'dark:text-green-400');
            }

            // Oculta barra ap√≥s 3s
            setTimeout(() => {
                if (progressBar) progressBar.classList.add('hidden');
            }, 3000);

        } else {
            throw new Error('Fun√ß√£o calculateInBackground n√£o encontrada. Verifique se dashboard-stats.js foi carregado.');
        }

    } catch (error) {
        console.error('‚ùå Erro na sincroniza√ß√£o:', error);

        if (statusText) {
            statusText.textContent = `Erro: ${error.message}`;
            statusText.classList.add('text-red-600', 'dark:text-red-400');
        }

        alert('Erro ao sincronizar quilometragem. Verifique o console (F12) para mais detalhes.');

    } finally {
        // Reabilita bot√£o
        if (btnSync) {
            btnSync.disabled = false;
            btnSync.classList.remove('opacity-50', 'cursor-not-allowed');
        }
    }
}

/**
 * Limpar Cache de Quilometragem
 */
function limparCacheKm() {
    if (!confirm('Tem certeza que deseja limpar TODOS os caches de quilometragem?\n\nIsso for√ßar√° o rec√°lculo de todos os dados na pr√≥xima atualiza√ß√£o.')) {
        return;
    }

    console.log('üóëÔ∏è Limpando TODOS os caches de KM...');

    try {
        localStorage.removeItem('fleetflow_daily_km_data');
        localStorage.removeItem('fleetflow_dashboard_stats_cache_realtime');
        localStorage.removeItem('fleetflow_dashboard_stats_cache_month');
        localStorage.removeItem('fleetflow_km_cache_v2');
        localStorage.removeItem('fleetflow_odometer_snapshots');

        console.log('‚úÖ Todos os caches foram removidos!');
        alert('Cache limpo com sucesso!\n\nA p√°gina ser√° recarregada para recalcular os dados.');

        window.location.reload();

    } catch (error) {
        console.error('‚ùå Erro ao limpar cache:', error);
        alert('Erro ao limpar cache. Verifique o console (F12) para mais detalhes.');
    }
}

// Exp√µe fun√ß√µes globalmente
window.sincronizarKmManual = sincronizarKmManual;
window.limparCacheKm = limparCacheKm;

// IMPORTANTE: Atualizar dashboard quando a p√°gina carregar
document.addEventListener('DOMContentLoaded', function() {
    console.log('üìä Dashboard carregado - iniciando atualiza√ß√£o autom√°tica...');

    // Aguardar um pouco para garantir que o dashboard-stats.js foi carregado
    setTimeout(() => {
        if (typeof updateDashboardStats === 'function') {
            updateDashboardStats();
        } else {
            console.error('‚ùå Fun√ß√£o updateDashboardStats n√£o encontrada!');
        }
    }, 500);
});
</script>

<!-- Modal de Filtro de Data Customizada -->
<div id="customDateModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-md w-full mx-4 overflow-hidden">
        <!-- Header -->
        <div class="bg-primary text-white px-6 py-4">
            <h3 class="text-lg font-semibold">Filtrar por Per√≠odo</h3>
        </div>

        <!-- Body -->
        <div class="p-6 space-y-4">
            <!-- Data Inicial -->
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    Data Inicial
                </label>
                <input type="date" id="modalDateFrom"
                    class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent">
            </div>

            <!-- Data Final -->
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    Data Final
                </label>
                <input type="date" id="modalDateTo"
                    class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent">
            </div>

            <!-- Preview do Total -->
            <div id="modalTotalPreview" class="hidden mt-4 p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-200 dark:border-blue-800">
                <div class="flex items-center justify-between">
                    <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Total do Per√≠odo:</span>
                    <span id="modalTotalKm" class="text-lg font-bold text-primary">0 km</span>
                </div>
                <div class="mt-2 text-xs text-gray-500 dark:text-gray-400">
                    <span id="modalVehicleCount">0 ve√≠culos</span> ‚Ä¢
                    <span id="modalDayCount">0 dias</span>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="bg-gray-50 dark:bg-gray-700 px-6 py-4 flex justify-end gap-3">
            <button onclick="closeCustomDateModal()"
                class="px-4 py-2 text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-600 border border-gray-300 dark:border-gray-500 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-500 transition">
                Cancelar
            </button>
            <button onclick="applyCustomDateFilter()"
                class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition">
                Aplicar Filtro
            </button>
        </div>
    </div>
</div>

</body></html>