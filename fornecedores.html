<!DOCTYPE html>
<html class="light" lang="pt-br">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Gest√£o de Fornecedores - i9 Engenharia</title>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
<script>
tailwind.config = {
darkMode: "class",
theme: {
extend: {
colors: {
"primary": "#1E3A8A",
"background-light": "#F3F4F6",
"background-dark": "#1F2937"
}
}
}
};
</script>
<style>
.material-symbols-outlined {
font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
}
</style>
</head>
<body class="bg-background-light dark:bg-background-dark font-display">
<div class="flex h-screen">
<div id="sidebar-container" data-page="fornecedores"></div>
<main class="flex-1 p-8 overflow-y-auto">
<div class="flex justify-between items-center mb-6">
<div>
<h1 class="text-3xl font-black text-gray-800 dark:text-white">Gest√£o de Fornecedores</h1>
<p class="text-gray-500 dark:text-gray-400 mt-1">Cadastro e gerenciamento de fornecedores de pe√ßas e servi√ßos</p>
</div>
<button onclick="showAddModal()" class="flex items-center gap-2 px-4 py-2 bg-primary text-white rounded-lg hover:bg-blue-700 transition">
<span class="material-symbols-outlined">add</span>
Novo Fornecedor
</button>
</div>

<div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6">
<div class="flex gap-3 mb-6">
<div class="relative flex-1">
<input type="text" id="search-input" placeholder="Buscar por nome, CNPJ ou cidade..." class="form-input w-full pl-10 pr-4 py-2 border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white"/>
<span class="material-symbols-outlined absolute left-3 top-2.5 text-gray-400">search</span>
</div>
<button onclick="loadFornecedores()" class="flex items-center gap-2 px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition">
<span class="material-symbols-outlined">refresh</span>
Atualizar
</button>
</div>

<div class="overflow-x-auto">
<table class="w-full">
<thead class="bg-gray-50 dark:bg-gray-900 text-xs uppercase text-gray-700 dark:text-gray-300">
<tr>
<th class="px-4 py-3 text-left">Nome</th>
<th class="px-4 py-3 text-left">CNPJ/CPF</th>
<th class="px-4 py-3 text-left">Telefone</th>
<th class="px-4 py-3 text-left">Cidade/UF</th>
<th class="px-4 py-3 text-center">A√ß√µes</th>
</tr>
</thead>
<tbody id="fornecedores-tbody" class="divide-y divide-gray-200 dark:divide-gray-700">
<tr>
<td colspan="5" class="px-4 py-8 text-center text-gray-500">
<div class="flex flex-col items-center">
<span class="material-symbols-outlined text-5xl text-gray-400 mb-2">hourglass_empty</span>
Carregando fornecedores...
</div>
</td>
</tr>
</tbody>
</table>
</div>

<div class="flex justify-between items-center mt-4 text-sm text-gray-600 dark:text-gray-400">
<span id="total-count">Total: 0 fornecedores</span>
</div>
</div>
</main>
</div>

<!-- Modal Adicionar/Editar -->
<div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
<div class="bg-white dark:bg-gray-800 rounded-lg w-full max-w-3xl max-h-[90vh] overflow-y-auto">
<div class="sticky top-0 bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 px-6 py-4 flex justify-between items-center">
<h2 id="modal-title" class="text-xl font-bold text-gray-900 dark:text-white"></h2>
<button onclick="closeModal()" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
<span class="material-symbols-outlined">close</span>
</button>
</div>

<form id="fornecedor-form" class="p-6">
<input type="hidden" id="fornecedor-id"/>

<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
<div class="col-span-2">
<label class="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">Nome do Fornecedor *</label>
<input type="text" id="nome" required class="form-input w-full dark:bg-gray-700 dark:text-white border-gray-300 dark:border-gray-600 rounded-lg"/>
</div>

<div>
<label class="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">Raz√£o Social</label>
<input type="text" id="razao_social" class="form-input w-full dark:bg-gray-700 dark:text-white border-gray-300 dark:border-gray-600 rounded-lg"/>
</div>

<div>
<label class="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">CNPJ/CPF</label>
<input type="text" id="cnpj" class="form-input w-full dark:bg-gray-700 dark:text-white border-gray-300 dark:border-gray-600 rounded-lg"/>
</div>

<div>
<label class="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">Telefone</label>
<input type="text" id="telefone" class="form-input w-full dark:bg-gray-700 dark:text-white border-gray-300 dark:border-gray-600 rounded-lg"/>
</div>

<div>
<label class="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">Celular</label>
<input type="text" id="celular" class="form-input w-full dark:bg-gray-700 dark:text-white border-gray-300 dark:border-gray-600 rounded-lg"/>
</div>

<div class="col-span-2">
<label class="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">E-mail</label>
<input type="email" id="email" class="form-input w-full dark:bg-gray-700 dark:text-white border-gray-300 dark:border-gray-600 rounded-lg"/>
</div>

<div class="col-span-2">
<label class="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">Endere√ßo</label>
<input type="text" id="endereco" class="form-input w-full dark:bg-gray-700 dark:text-white border-gray-300 dark:border-gray-600 rounded-lg"/>
</div>

<div>
<label class="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">Complemento</label>
<input type="text" id="complemento" class="form-input w-full dark:bg-gray-700 dark:text-white border-gray-300 dark:border-gray-600 rounded-lg"/>
</div>

<div>
<label class="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">Bairro</label>
<input type="text" id="bairro" class="form-input w-full dark:bg-gray-700 dark:text-white border-gray-300 dark:border-gray-600 rounded-lg"/>
</div>

<div>
<label class="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">CEP</label>
<input type="text" id="cep" class="form-input w-full dark:bg-gray-700 dark:text-white border-gray-300 dark:border-gray-600 rounded-lg" placeholder="00000-000"/>
</div>

<div>
<label class="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">Cidade</label>
<input type="text" id="cidade" class="form-input w-full dark:bg-gray-700 dark:text-white border-gray-300 dark:border-gray-600 rounded-lg"/>
</div>

<div>
<label class="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">Estado</label>
<input type="text" id="estado" maxlength="2" class="form-input w-full dark:bg-gray-700 dark:text-white border-gray-300 dark:border-gray-600 rounded-lg" placeholder="ES"/>
</div>
</div>

<div class="flex justify-end gap-3 mt-6">
<button type="button" onclick="closeModal()" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition">
Cancelar
</button>
<button type="submit" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-blue-700 transition">
<span id="submit-text">Salvar</span>
</button>
</div>
</form>
</div>
</div>

<script src="sidebar.js?v=20260113-FIX-ZINDEX"></script>
<script>
let fornecedores = [];
let filteredFornecedores = [];

async function loadFornecedores() {
try {
const response = await fetch('https://floripa.in9automacao.com.br/fornecedores-api.php');
const data = await response.json();

if (data.success) {
fornecedores = data.data || [];
filteredFornecedores = fornecedores;
renderTable();
document.getElementById('total-count').textContent = `Total: ${fornecedores.length} fornecedores`;
} else {
showError('Erro ao carregar fornecedores');
}
} catch (error) {
console.error('Erro:', error);
showError('Erro ao conectar com o servidor');
}
}

function renderTable() {
const tbody = document.getElementById('fornecedores-tbody');

if (filteredFornecedores.length === 0) {
tbody.innerHTML = `
<tr>
<td colspan="5" class="px-4 py-8 text-center text-gray-500">
<div class="flex flex-col items-center">
<span class="material-symbols-outlined text-5xl text-gray-400 mb-2">search_off</span>
Nenhum fornecedor encontrado
</div>
</td>
</tr>
`;
return;
}

tbody.innerHTML = filteredFornecedores.map(f => `
<tr class="hover:bg-gray-50 dark:hover:bg-gray-700 transition">
<td class="px-4 py-3">
<div class="font-medium text-gray-900 dark:text-white">${f.nome}</div>
${f.razao_social ? `<div class="text-xs text-gray-500 dark:text-gray-400">${f.razao_social}</div>` : ''}
</td>
<td class="px-4 py-3 text-sm text-gray-600 dark:text-gray-400">${f.cnpj || '-'}</td>
<td class="px-4 py-3 text-sm text-gray-600 dark:text-gray-400">
${f.telefone || f.celular || '-'}
${f.celular && f.telefone ? `<div class="text-xs">${f.celular}</div>` : ''}
</td>
<td class="px-4 py-3 text-sm text-gray-600 dark:text-gray-400">
${f.cidade || '-'}${f.estado ? ' / ' + f.estado : ''}
</td>
<td class="px-4 py-3 text-center">
<div class="flex items-center justify-center gap-2">
<button onclick="editFornecedor(${f.id})" class="text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 p-1" title="Editar">
<span class="material-symbols-outlined text-lg">edit</span>
</button>
<button onclick="deleteFornecedor(${f.id}, '${f.nome.replace(/'/g, "\\'")}'))" class="text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300 p-1" title="Excluir">
<span class="material-symbols-outlined text-lg">delete</span>
</button>
</div>
</td>
</tr>
`).join('');
}

function showAddModal() {
document.getElementById('modal-title').textContent = 'Novo Fornecedor';
document.getElementById('fornecedor-form').reset();
document.getElementById('fornecedor-id').value = '';
document.getElementById('submit-text').textContent = 'Salvar';
document.getElementById('modal').classList.remove('hidden');
}

function editFornecedor(id) {
console.log('üîß editFornecedor chamado com id:', id, '| Tipo:', typeof id);
console.log('üìã Fornecedores dispon√≠veis:', fornecedores.length);

// Garantir que o ID seja um n√∫mero
const numId = parseInt(id);
console.log('üî¢ ID convertido para n√∫mero:', numId);

// Tentar encontrar por ID num√©rico E por ID string (para garantir)
const fornecedor = fornecedores.find(f => f.id === numId || f.id == id);

if (!fornecedor) {
    console.error('‚ùå Fornecedor n√£o encontrado. ID:', id);
    console.log('IDs dispon√≠veis:', fornecedores.map(f => f.id));
    alert('Fornecedor n√£o encontrado. Por favor, recarregue a p√°gina.');
    return;
}

console.log('‚úÖ Fornecedor encontrado:', fornecedor);

try {
    document.getElementById('modal-title').textContent = 'Editar Fornecedor';
    document.getElementById('fornecedor-id').value = fornecedor.id;
    document.getElementById('nome').value = fornecedor.nome || '';
    document.getElementById('razao_social').value = fornecedor.razao_social || '';
    document.getElementById('cnpj').value = fornecedor.cnpj || '';
    document.getElementById('telefone').value = fornecedor.telefone || '';
    document.getElementById('celular').value = fornecedor.celular || '';
    document.getElementById('email').value = fornecedor.email || '';
    document.getElementById('endereco').value = fornecedor.endereco || '';
    document.getElementById('complemento').value = fornecedor.complemento || '';
    document.getElementById('bairro').value = fornecedor.bairro || '';
    document.getElementById('cep').value = fornecedor.cep || '';
    document.getElementById('cidade').value = fornecedor.cidade || '';
    document.getElementById('estado').value = fornecedor.estado || '';
    document.getElementById('submit-text').textContent = 'Atualizar';
    document.getElementById('modal').classList.remove('hidden');

    console.log('‚úÖ Modal aberto com sucesso');
} catch (error) {
    console.error('‚ùå Erro ao abrir modal:', error);
    alert('Erro ao abrir formul√°rio de edi√ß√£o: ' + error.message);
}
}

async function deleteFornecedor(id, nome) {
if (!confirm(`Deseja realmente excluir o fornecedor "${nome}"?\n\nEsta a√ß√£o n√£o pode ser desfeita.`)) return;

try {
const response = await fetch(`https://floripa.in9automacao.com.br/fornecedores-api.php?id=${id}`, {
method: 'DELETE'
});

const data = await response.json();

if (data.success) {
showSuccess('Fornecedor exclu√≠do com sucesso!');
loadFornecedores();
} else {
showError('Erro ao excluir fornecedor');
}
} catch (error) {
console.error('Erro:', error);
showError('Erro ao conectar com o servidor');
}
}

function closeModal() {
document.getElementById('modal').classList.add('hidden');
document.getElementById('fornecedor-form').reset();
}

document.getElementById('fornecedor-form').addEventListener('submit', async (e) => {
e.preventDefault();

const submitBtn = e.target.querySelector('button[type="submit"]');
const originalText = document.getElementById('submit-text').textContent;
document.getElementById('submit-text').textContent = 'Salvando...';
submitBtn.disabled = true;

const id = document.getElementById('fornecedor-id').value;
const data = {
nome: document.getElementById('nome').value,
razao_social: document.getElementById('razao_social').value,
cnpj: document.getElementById('cnpj').value,
telefone: document.getElementById('telefone').value,
celular: document.getElementById('celular').value,
email: document.getElementById('email').value,
endereco: document.getElementById('endereco').value,
complemento: document.getElementById('complemento').value,
bairro: document.getElementById('bairro').value,
cep: document.getElementById('cep').value,
cidade: document.getElementById('cidade').value,
estado: document.getElementById('estado').value
};

if (id) {
data.id = parseInt(id);
}

try {
const response = await fetch('https://floripa.in9automacao.com.br/fornecedores-api.php', {
method: id ? 'PUT' : 'POST',
headers: { 'Content-Type': 'application/json' },
body: JSON.stringify(data)
});

const result = await response.json();

if (result.success) {
showSuccess(id ? 'Fornecedor atualizado com sucesso!' : 'Fornecedor cadastrado com sucesso!');
closeModal();
loadFornecedores();
} else {
showError(result.error || 'Erro ao salvar fornecedor');
}
} catch (error) {
console.error('Erro:', error);
showError('Erro ao conectar com o servidor');
} finally {
document.getElementById('submit-text').textContent = originalText;
submitBtn.disabled = false;
}
});

document.getElementById('search-input').addEventListener('input', (e) => {
const query = e.target.value.toLowerCase().trim();

if (query === '') {
filteredFornecedores = fornecedores;
} else {
filteredFornecedores = fornecedores.filter(f =>
f.nome.toLowerCase().includes(query) ||
(f.cnpj || '').includes(query) ||
(f.cidade || '').toLowerCase().includes(query) ||
(f.razao_social || '').toLowerCase().includes(query)
);
}

renderTable();
});

function showSuccess(message) {
alert(message);
}

function showError(message) {
alert('Erro: ' + message);
}

loadFornecedores();
</script>
</body>
</html>
