<!DOCTYPE html>
<html class="light" lang="en"><head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Fleet Management Dashboard</title>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&amp;display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Scripts do FleetFlow -->
<script src="auth.js" defer></script>
<script src="ituran-service.js?v=20251208-1420"></script>
<script src="dashboard-stats.js?v=20251230-final"></script>
<script src="sidebar.js?v=20260113-FIX-ZINDEX"></script>
<script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#1173d4",
                        "background-light": "#f6f7f8",
                        "background-dark": "#101922",
                    },
                    fontFamily: {
                        "display": ["Inter", "sans-serif"]
                    },
                    borderRadius: {
                        "DEFAULT": "0.25rem",
                        "lg": "0.5rem",
                        "xl": "0.75rem",
                        "full": "9999px"
                    },
                },
            },
        }
    </script>
<style>
        .material-symbols-outlined {
            font-variation-settings:
            'FILL' 0,
            'wght' 400,
            'GRAD' 0,
            'opsz' 24
        }
    </style>
</head>
<body class="bg-background-light dark:bg-gray-900 font-display text-[#333333] dark:text-white">
<div class="relative flex h-auto min-h-screen w-full flex-col">
<div class="flex h-full grow flex-row">
<!-- Sidebar Unificado -->
<div id="sidebar-container" data-page="dashboard"></div>
<main class="flex-1 p-6 lg:p-8 bg-background-light dark:bg-gray-900">
<div class="flex flex-wrap justify-between gap-4 items-center mb-6">
<div class="flex flex-col gap-1">
<h1 class="text-3xl font-black text-[#111418] dark:text-white tracking-[-0.03em]">Dashboard da Frota</h1>
<p class="text-gray-500 dark:text-gray-400 text-base font-normal">Vis√£o geral da sua frota em tempo real.</p>
</div>
<div class="flex items-center gap-2 flex-wrap justify-end">
<button id="btn-sync-km" onclick="sincronizarKmManual()" class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center gap-2 overflow-hidden rounded-lg h-10 px-4 bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 border border-gray-300 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700 text-sm font-bold leading-normal tracking-[0.015em]">
<span class="material-symbols-outlined">sync</span>
<span class="truncate">Sincronizar KM</span>
</button>
<button onclick="limparCacheKm()" class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center gap-2 overflow-hidden rounded-lg h-10 px-4 bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 border border-gray-300 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700 text-sm font-bold leading-normal tracking-[0.015em]">
<span class="material-symbols-outlined">delete</span>
<span class="truncate">Limpar Cache</span>
</button>
<button class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center gap-2 overflow-hidden rounded-lg h-10 px-4 bg-primary text-white text-sm font-bold leading-normal tracking-[0.015em]">
<span class="material-symbols-outlined">download</span>
<span class="truncate">Exportar</span>
</button>
</div>
</div>
<div id="sync-progress-bar" class="mb-6 p-6 rounded-xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 hidden">
<div class="flex items-center justify-between mb-4">
<p class="text-base font-medium text-gray-700 dark:text-gray-300" id="sync-progress-text">Sincronizando KM (0%)</p>
<p class="text-sm text-gray-500 dark:text-gray-400" id="sync-status-text">Iniciando...</p>
</div>
<div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5 mb-4">
<div id="sync-progress-fill" class="bg-primary h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
</div>
<div class="flex flex-col">
<p class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Ve√≠culos analisados:</p>
<div id="syncPlatesContainer" class="flex flex-wrap gap-2 max-h-32 overflow-y-auto">
<!-- Placas ser√£o adicionadas dinamicamente aqui -->
</div>
</div>
</div>
<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-6 mb-6">
<div class="flex flex-col gap-2 rounded-xl p-6 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700">
<p class="text-base font-medium text-[#111418] dark:text-gray-300">KM Rodados Hoje</p>
<p id="stat-km-today" class="text-3xl font-bold text-[#111418] dark:text-white">0 km</p>
<p id="stat-km-today-meta" class="text-gray-500 dark:text-gray-400 text-sm font-medium">
    <span id="last-sync-time">Carregando...</span>
</p>
</div>
<div class="flex flex-col gap-2 rounded-xl p-6 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700">
<p class="text-base font-medium text-[#111418] dark:text-gray-300">KM Rodados Ontem</p>
<p id="stat-km-yesterday" class="text-3xl font-bold text-[#111418] dark:text-white">0 km</p>
<p class="text-gray-500 dark:text-gray-400 text-sm font-medium">Total do dia anterior</p>
</div>
<div class="flex flex-col gap-2 rounded-xl p-6 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700">
<p class="text-base font-medium text-[#111418] dark:text-gray-300">Ve√≠culos em Movimento</p>
<p id="stat-vehicles-moving" class="text-3xl font-bold text-[#111418] dark:text-white">0</p>
<p class="text-gray-500 dark:text-gray-400 text-sm font-medium">Atualizado agora</p>
</div>
<div class="flex flex-col gap-2 rounded-xl p-6 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700">
<p class="text-base font-medium text-[#111418] dark:text-gray-300">KM do M√™s</p>
<p id="stat-km-month" class="text-3xl font-bold text-[#111418] dark:text-white">0 km</p>
<p id="stat-km-month-meta" class="text-[#28A745] text-sm font-medium">Carregando...</p>
</div>
<div class="flex flex-col gap-2 rounded-xl p-6 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700">
<p class="text-base font-medium text-[#111418] dark:text-gray-300">Total de Ve√≠culos</p>
<p id="stat-total-vehicles" class="text-3xl font-bold text-[#111418] dark:text-white">0</p>
<p class="text-gray-500 dark:text-gray-400 text-sm font-medium">Ativos na frota</p>
</div>
</div>

<!-- Quilometragem por Regi√£o -->
<div class="rounded-xl border border-gray-200 dark:border-gray-700 p-6 bg-white dark:bg-gray-800 mb-6">
    <div class="flex flex-wrap items-center justify-between gap-4 mb-4">
        <div class="flex flex-col">
            <h3 class="text-lg font-semibold text-[#111418] dark:text-white">üìä Quilometragem por Regi√£o</h3>
            <p class="text-sm text-gray-500 dark:text-gray-400">KM rodados hoje em cada √°rea</p>
        </div>
        <button onclick="loadKmByArea()" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 text-sm flex items-center gap-2">
            <span class="material-symbols-outlined text-sm">refresh</span>
            Atualizar
        </button>
    </div>

    <div id="km-by-area-container" class="overflow-x-auto">
        <div class="text-center py-8 text-gray-500">
            <span class="material-symbols-outlined text-4xl mb-2">location_on</span>
            <p>Carregando dados de quilometragem por regi√£o...</p>
        </div>
    </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
<div class="lg:col-span-2 flex flex-col gap-4 rounded-xl border border-gray-200 dark:border-gray-700 p-6 bg-white dark:bg-gray-800">
<div class="flex flex-wrap items-start justify-between gap-4">
<div class="flex flex-col">
<p class="text-lg font-semibold text-[#111418] dark:text-white">An√°lise de Custos</p>
<p class="text-sm text-gray-500 dark:text-gray-400">Detalhes de custos por categoria e ve√≠culo.</p>
</div>
<div class="flex flex-wrap justify-end gap-2">
<div class="relative">
<select class="pl-8 pr-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-sm focus:outline-none focus:ring-2 focus:ring-primary w-40">
<option selected="">M√™s Atual</option>
<option>Hoje</option>
<option>√öltimos 7 Dias</option>
<option>Customizado</option>
</select>
<span class="material-symbols-outlined absolute left-2 top-1/2 -translate-y-1/2 text-gray-400">calendar_today</span>
</div>
<div class="relative">
<select class="pl-8 pr-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-sm focus:outline-none focus:ring-2 focus:ring-primary w-40">
<option selected="">Todos Ve√≠culos</option>
<option>ABC-1234</option>
<option>DEF-5678</option>
</select>
<span class="material-symbols-outlined absolute left-2 top-1/2 -translate-y-1/2 text-gray-400">local_shipping</span>
</div>
<div class="relative">
<select id="filter-area" onchange="filterByArea()" class="pl-8 pr-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-sm focus:outline-none focus:ring-2 focus:ring-primary w-40">
<option value="" selected>Todas as Regi√µes</option>
</select>
<span class="material-symbols-outlined absolute left-2 top-1/2 -translate-y-1/2 text-gray-400">corporate_fare</span>
</div>
</div>
</div>
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-2">
<button class="px-3 py-1.5 rounded-lg text-sm font-medium bg-primary/10 text-primary dark:bg-primary/20">Manuten√ß√£o</button>
<button class="px-3 py-1.5 rounded-lg text-sm font-medium bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600">Abastecimento</button>
<button class="px-3 py-1.5 rounded-lg text-sm font-medium bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600">Ped√°gio</button>
<button class="px-3 py-1.5 rounded-lg text-sm font-medium bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600">Rastreamento</button>
<button class="px-3 py-1.5 rounded-lg text-sm font-medium bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600">Deprecia√ß√£o</button>
<button class="px-3 py-1.5 rounded-lg text-sm font-medium bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600">Loca√ß√£o</button>
<button class="px-3 py-1.5 rounded-lg text-sm font-medium bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600">Higieniza√ß√£o</button>
<button class="px-3 py-1.5 rounded-lg text-sm font-medium bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600">Seguro</button>
</div>
<div class="h-80"><canvas id="costChart"></canvas></div>
</div>
<div class="flex flex-col gap-4 rounded-xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800">
<h3 class="text-lg font-semibold text-[#111418] dark:text-white p-6 pb-2">Top 10 Ve√≠culos - KM Rodados Hoje</h3>
<div id="top-vehicles-container" class="overflow-x-auto">
<table class="w-full text-sm">
<thead class="border-b border-gray-200 dark:border-gray-700">
<tr>
<th class="text-left py-3 px-4 font-semibold text-[#111418] dark:text-white">Placa</th>
<th class="text-left py-3 px-4 font-semibold text-[#111418] dark:text-white">Modelo</th>
<th class="text-right py-3 px-4 font-semibold text-[#111418] dark:text-white">KM Hoje</th>
<th class="text-right py-3 px-4 font-semibold text-[#111418] dark:text-white">Status</th>
</tr>
</thead>
<tbody id="top-vehicles-list" class="divide-y divide-gray-200 dark:divide-gray-700">
<tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50">
<td colspan="4" class="text-center py-8 text-gray-500 dark:text-gray-400">Carregando dados...</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="flex flex-col gap-6 rounded-xl border border-gray-200 dark:border-gray-700 p-6 bg-white dark:bg-gray-800">
<div class="flex flex-wrap items-start justify-between gap-4">
<div class="flex flex-col">
<h3 class="text-lg font-semibold text-[#111418] dark:text-white">Quilometragem Detalhada</h3>
<p class="text-sm text-gray-500 dark:text-gray-400">Explore a quilometragem com filtros avan√ßados.</p>
</div>
<div class="flex items-center gap-2 p-1 rounded-lg bg-gray-100 dark:bg-gray-700">
<button data-period="today" class="px-3 py-1 rounded text-sm font-medium bg-white dark:bg-gray-800 text-primary shadow-sm">Hoje</button>
<button data-period="week" class="px-3 py-1 rounded text-sm font-medium text-gray-600 dark:text-gray-300">7 Dias</button>
<button data-period="month" class="px-3 py-1 rounded text-sm font-medium text-gray-600 dark:text-gray-300">M√™s</button>
<button data-period="custom" class="px-3 py-1 rounded text-sm font-medium text-gray-600 dark:text-gray-300 flex items-center gap-1">
<span class="material-symbols-outlined text-base">calendar_month</span> Customizado
</button>
</div>
</div>
<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4">
<div class="relative">
<input data-filter="plate" class="w-full pl-8 pr-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-sm focus:outline-none focus:ring-2 focus:ring-primary" placeholder="Buscar Ve√≠culo..." type="text"/>
<span class="material-symbols-outlined absolute left-2 top-1/2 -translate-y-1/2 text-gray-400">search</span>
</div>
<div class="relative">
<input data-filter="driver" class="w-full pl-8 pr-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-sm focus:outline-none focus:ring-2 focus:ring-primary" placeholder="Buscar Motorista..." type="text"/>
<span class="material-symbols-outlined absolute left-2 top-1/2 -translate-y-1/2 text-gray-400">search</span>
</div>
<div class="relative">
<select id="vehicleTypeSelect" data-filter-select="vehicleType" class="w-full pl-8 pr-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-sm focus:outline-none focus:ring-2 focus:ring-primary">
<option selected="">Tipo de Ve√≠culo</option>
</select>
<span class="material-symbols-outlined absolute left-2 top-1/2 -translate-y-1/2 text-gray-400">local_shipping</span>
</div>
<div class="relative">
<select id="baseSelect" data-filter-select="base" class="w-full pl-8 pr-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-sm focus:outline-none focus:ring-2 focus:ring-primary">
<option selected="">Centro de Custo</option>
</select>
<span class="material-symbols-outlined absolute left-2 top-1/2 -translate-y-1/2 text-gray-400">corporate_fare</span>
</div>
<div class="relative">
<select id="statusSelect" data-filter-select="status" class="w-full pl-8 pr-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-sm focus:outline-none focus:ring-2 focus:ring-primary">
<option selected="">Status do Ve√≠culo</option>
</select>
<span class="material-symbols-outlined absolute left-2 top-1/2 -translate-y-1/2 text-gray-400">circle</span>
</div>
</div>
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
<div class="lg:col-span-2 overflow-x-auto">
<table class="w-full text-left text-sm">
<thead class="border-b border-gray-200 dark:border-gray-700 text-gray-500 dark:text-gray-400">
<tr>
<th class="p-4 font-medium">Ve√≠culo</th>
<th class="p-4 font-medium">Motorista</th>
<th class="p-4 font-medium">KM Rodado</th>
<th class="p-4 font-medium">Consumo (km/l)</th>
<th class="p-4 font-medium">Custo por KM</th>
</tr>
</thead>
<tbody id="detailedTableBody" class="divide-y divide-gray-200 dark:divide-gray-700">
<tr>
<td colspan="5" class="p-8 text-center text-gray-500 dark:text-gray-400">
Carregando dados...
</td>
</tr>
</tbody>
</table>
</div>
<div class="flex flex-col gap-4">
<p class="text-base font-semibold text-[#111418] dark:text-white">Evolu√ß√£o da Quilometragem</p>
<div class="h-64"><canvas id="mileageChart"></canvas></div>
</div>
</div>
</div>
</main>
</div>
</div>
<script>
    const isDarkMode = document.documentElement.classList.contains('dark');
    const gridColor = isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
    const textColor = isDarkMode ? '#f9fafb' : '#374151';
    // Cost Chart
    const costCtx = document.getElementById('costChart');
    if (costCtx) {
        new Chart(costCtx, {
            type: 'bar',
            data: {
                labels: ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun'],
                datasets: [{
                    label: 'Manuten√ß√£o',
                    data: [1200, 1900, 3000, 2500, 2200, 3000],
                    backgroundColor: '#1173d4',
                    borderRadius: 4,
                }, {
                    label: 'Abastecimento',
                    data: [8000, 8200, 7800, 9000, 8500, 9200],
                    backgroundColor: '#28A745',
                    borderRadius: 4,
                }, {
                    label: 'Ped√°gio',
                    data: [300, 320, 280, 400, 350, 420],
                    backgroundColor: '#FFC107',
                    borderRadius: 4,
                }, {
                    label: 'Rastreamento',
                    data: [150, 150, 150, 150, 150, 150],
                    backgroundColor: '#fd7e14',
                    borderRadius: 4,
                }, {
                    label: 'Deprecia√ß√£o',
                    data: [500, 500, 500, 500, 500, 500],
                    backgroundColor: '#6f42c1',
                    borderRadius: 4,
                }, {
                    label: 'Loca√ß√£o',
                    data: [0, 0, 0, 1200, 1200, 1200],
                    backgroundColor: '#dc3545',
                    borderRadius: 4,
                }, {
                    label: 'Higieniza√ß√£o',
                    data: [50, 0, 50, 0, 100, 50],
                    backgroundColor: '#20c997',
                    borderRadius: 4,
                }, {
                    label: 'Seguro',
                    data: [400, 400, 400, 400, 400, 400],
                    backgroundColor: '#0dcaf0',
                    borderRadius: 4,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                           color: textColor
                        }
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                    }
                },
                scales: {
                    x: {
                        stacked: true,
                        ticks: { color: textColor },
                        grid: { color: gridColor, drawOnChartArea: false }
                    },
                    y: {
                        stacked: true,
                        ticks: { color: textColor },
                        grid: { color: gridColor }
                    }
                },
                interaction: {
                    mode: 'index',
                    intersect: false
                }
            }
        });
    }
    // Mileage Chart
    const mileageCtx = document.getElementById('mileageChart');
    if (mileageCtx) {
        new Chart(mileageCtx, {
            type: 'line',
            data: {
                labels: ['Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b', 'Dom'],
                datasets: [{
                    label: 'KM Total',
                    data: [1200, 1900, 1500, 2100, 1800, 2300, 2000],
                    borderColor: '#1173d4',
                    backgroundColor: 'rgba(17, 115, 212, 0.1)',
                    fill: true,
                    tension: 0.4,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    x: {
                        ticks: { color: textColor },
                        grid: { color: gridColor, drawOnChartArea: false }
                    },
                    y: {
                        ticks: { color: textColor },
                        grid: { color: gridColor }
                    }
                }
            }
        });
    }
</script>
<script src="api-client.js?v=20251125"></script>
<script src="dashboard-real-data.js"></script>
<script src="vehicles-data.js"></script>
<script src="novo-dashboard.js?v=20251202-002"></script>
<script src="sidebar.js?v=20260113-FIX-ZINDEX"></script>
<script>
/**
 * Sincroniza√ß√£o Manual de Quilometragem
 * For√ßa rec√°lculo dos dados de KM de todos os ve√≠culos
 */
async function sincronizarKmManual() {
    console.log('üîÑ SINCRONIZA√á√ÉO MANUAL iniciada pelo usu√°rio');

    const btnSync = document.getElementById('btn-sync-km');
    const progressBar = document.getElementById('syncProgressBar');
    const progressFill = document.getElementById('syncProgressFill');
    const progressText = document.getElementById('syncProgressText');
    const statusText = document.getElementById('syncStatusText');

    try {
        // Desabilita bot√£o
        if (btnSync) {
            btnSync.disabled = true;
            btnSync.classList.add('opacity-50', 'cursor-not-allowed');
        }

        // Mostra barra de progresso
        if (progressBar) {
            progressBar.classList.remove('hidden');
        }

        // Verifica se j√° existe sincroniza√ß√£o em andamento
        const existingCache = localStorage.getItem('fleetflow_daily_km_data');
        let startFrom = 0;
        let initialData = null;
        let continuingSync = false;

        if (existingCache) {
            try {
                const cacheData = JSON.parse(existingCache);
                const today = new Date().toISOString().split('T')[0];

                // Se o cache √© de hoje E est√° incompleto, continua de onde parou
                if (cacheData.date === today && cacheData.isComplete === false) {
                    startFrom = cacheData.progress || 0;
                    initialData = {
                        todayTotal: cacheData.todayTotal || 0,
                        yesterdayTotal: cacheData.yesterdayTotal || 0,
                        monthTotal: cacheData.monthTotal || 0,
                        vehiclesData: cacheData.vehiclesData || [],
                        vehiclesMoving: cacheData.vehiclesData?.filter(v => v.kmToday > 0).length || 0
                    };
                    continuingSync = true;
                    console.log(`üîÑ CONTINUANDO sincroniza√ß√£o do ve√≠culo ${startFrom}...`);
                } else {
                    // Cache completo ou de outro dia - limpa tudo
                    console.log('üóëÔ∏è Limpando caches para nova sincroniza√ß√£o...');
                    localStorage.removeItem('fleetflow_daily_km_data');
                    localStorage.removeItem('fleetflow_dashboard_stats_cache_realtime');
                    localStorage.removeItem('fleetflow_dashboard_stats_cache_month');
                    localStorage.removeItem('fleetflow_km_cache_v2');
                    localStorage.removeItem('fleetflow_odometer_snapshots');
                }
            } catch (e) {
                console.warn('‚ö†Ô∏è Erro ao ler cache, limpando...', e);
                localStorage.removeItem('fleetflow_daily_km_data');
            }
        } else {
            // Sem cache - limpa tudo para garantir
            console.log('üóëÔ∏è Limpando TODOS os caches para sincroniza√ß√£o completa...');
            localStorage.removeItem('fleetflow_dashboard_stats_cache_realtime');
            localStorage.removeItem('fleetflow_dashboard_stats_cache_month');
            localStorage.removeItem('fleetflow_km_cache_v2');
            localStorage.removeItem('fleetflow_odometer_snapshots');
        }

        // Atualiza progresso
        const initialProgress = continuingSync ? Math.round((startFrom / (initialData?.vehiclesData?.length || 1)) * 100) : 0;
        if (progressText) progressText.textContent = continuingSync ? `Continuando sincroniza√ß√£o (${initialProgress}%)` : 'Sincronizando KM (0%)';
        if (statusText) statusText.textContent = continuingSync ? `Retomando do ve√≠culo ${startFrom}...` : 'Preparando...';

        // Verifica se dashboard-stats.js carregou
        if (typeof calculateInBackground === 'function') {
            console.log(continuingSync ? 'üîÑ Continuando c√°lculo em background...' : '‚úÖ Iniciando c√°lculo em background...');

            const platesContainer = document.getElementById('syncPlatesContainer');
            if (platesContainer && !continuingSync) {
                platesContainer.innerHTML = ''; // Limpa placas apenas se for nova sincroniza√ß√£o
            }

            // Chama fun√ß√£o de c√°lculo em background
            await calculateInBackground(startFrom, initialData, (progress, currentPlate) => {
                if (progressFill) {
                    progressFill.style.width = `${progress}%`;
                }
                if (progressText) {
                    progressText.textContent = `Sincronizando KM (${Math.round(progress)}%)`;
                }
                if (statusText) {
                    if (progress < 50) {
                        statusText.textContent = 'Calculando KM de hoje...';
                    } else if (progress < 100) {
                        statusText.textContent = 'Calculando KM do m√™s...';
                    } else {
                        statusText.textContent = 'Finalizado!';
                    }
                }

                // Adicionar placa processada
                if (currentPlate && platesContainer) {
                    const plateSpan = document.createElement('span');
                    plateSpan.className = 'px-2 py-1 bg-primary/10 text-primary text-xs font-mono rounded-md';
                    plateSpan.textContent = currentPlate;
                    platesContainer.appendChild(plateSpan);

                    // Auto-scroll para o final
                    platesContainer.scrollTop = platesContainer.scrollHeight;
                }
            });

            // Sucesso
            if (statusText) {
                statusText.textContent = '‚úÖ Sincroniza√ß√£o conclu√≠da com sucesso!';
                statusText.classList.remove('text-red-600', 'dark:text-red-400');
                statusText.classList.add('text-green-600', 'dark:text-green-400');
            }

            // Oculta barra ap√≥s 3s
            setTimeout(() => {
                if (progressBar) progressBar.classList.add('hidden');
            }, 3000);

        } else {
            throw new Error('Fun√ß√£o calculateInBackground n√£o encontrada. Verifique se dashboard-stats.js foi carregado.');
        }

    } catch (error) {
        console.error('‚ùå Erro na sincroniza√ß√£o:', error);

        if (statusText) {
            statusText.textContent = `Erro: ${error.message}`;
            statusText.classList.add('text-red-600', 'dark:text-red-400');
        }

        alert('Erro ao sincronizar quilometragem. Verifique o console (F12) para mais detalhes.');

    } finally {
        // Reabilita bot√£o
        if (btnSync) {
            btnSync.disabled = false;
            btnSync.classList.remove('opacity-50', 'cursor-not-allowed');
        }
    }
}

/**
 * Limpar Cache de Quilometragem
 */
function limparCacheKm() {
    if (!confirm('Tem certeza que deseja limpar TODOS os caches de quilometragem?\n\nIsso for√ßar√° o rec√°lculo de todos os dados na pr√≥xima atualiza√ß√£o.')) {
        return;
    }

    console.log('üóëÔ∏è Limpando TODOS os caches de KM...');

    try {
        localStorage.removeItem('fleetflow_daily_km_data');
        localStorage.removeItem('fleetflow_dashboard_stats_cache_realtime');
        localStorage.removeItem('fleetflow_dashboard_stats_cache_month');
        localStorage.removeItem('fleetflow_km_cache_v2');
        localStorage.removeItem('fleetflow_odometer_snapshots');

        console.log('‚úÖ Todos os caches foram removidos!');
        alert('Cache limpo com sucesso!\n\nA p√°gina ser√° recarregada para recalcular os dados.');

        window.location.reload();

    } catch (error) {
        console.error('‚ùå Erro ao limpar cache:', error);
        alert('Erro ao limpar cache. Verifique o console (F12) para mais detalhes.');
    }
}

// Exp√µe fun√ß√µes globalmente
window.sincronizarKmManual = sincronizarKmManual;
window.limparCacheKm = limparCacheKm;

// IMPORTANTE: Atualizar dashboard quando a p√°gina carregar
document.addEventListener('DOMContentLoaded', function() {
    console.log('üìä Dashboard carregado - iniciando atualiza√ß√£o autom√°tica...');

    // Aguardar um pouco para garantir que o dashboard-stats.js foi carregado
    setTimeout(() => {
        if (typeof updateDashboardStats === 'function') {
            updateDashboardStats();
        } else {
            console.error('‚ùå Fun√ß√£o updateDashboardStats n√£o encontrada!');
        }
    }, 500);
});
</script>
</body></html>