<!DOCTYPE html>
<html class="light" lang="pt-BR">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Planos de Manuten√ß√£o - FleetFlow</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#1E3A8A",
                        "background-light": "#F3F4F6",
                        "background-dark": "#1F2937",
                    },
                    fontFamily: {
                        "display": ["Inter", "sans-serif"]
                    },
                },
            },
        }
    </script>
    <style>
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }
        body {
            font-family: 'Inter', sans-serif;
        }
        .tab-button {
            transition: all 0.2s ease;
        }
        .tab-button.active {
            border-color: #1E3A8A;
        }
        .peca-card {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .peca-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark font-display text-gray-800 dark:text-gray-200">
<div class="flex h-screen">
    <!-- Sidebar Container -->
    <div id="sidebar-container" data-page="planos"></div>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto">
        <div class="w-full mx-auto px-4 sm:px-6 lg:px-8 py-8" style="max-width: 1400px;">
            <!-- PageHeading -->
            <div class="flex flex-wrap justify-between items-center gap-4 mb-8">
                <h1 class="text-gray-900 dark:text-white text-3xl md:text-4xl font-black tracking-tighter">Planos de Manuten√ß√£o</h1>
            </div>

            <!-- Selection Section -->
            <section class="bg-white dark:bg-gray-800/50 p-6 rounded-xl border border-gray-200 dark:border-gray-700">
                <h2 class="text-gray-900 dark:text-white text-xl font-bold tracking-tight mb-4">Sele√ß√£o de Modelo</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 items-end">
                    <div class="md:col-span-2">
                        <label class="flex flex-col w-full">
                            <p class="text-sm font-medium pb-2 text-gray-700 dark:text-gray-300">Selecione o modelo do ve√≠culo</p>
                            <select id="modelSelect" class="form-select flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-gray-900 dark:text-white focus:outline-0 focus:ring-2 focus:ring-primary/50 border-gray-300 dark:border-gray-600 bg-background-light dark:bg-gray-700 focus:border-primary dark:focus:border-primary h-12 placeholder:text-gray-400 dark:placeholder:text-gray-500 px-4 text-base font-normal">
                                <option value="">‚è≥ Carregando modelos...</option>
                            </select>
                        </label>
                    </div>
                    <div class="flex items-center gap-4 justify-start md:justify-end">
                        <span id="planStatus" class="hidden inline-flex items-center rounded-full px-3 py-1 text-sm font-semibold"></span>
                    </div>
                </div>
            </section>

            <!-- Tabs System -->
            <div id="modeloTabs" class="mt-8 hidden">
                <!-- Tabs Navigation -->
                <div class="border-b border-gray-200 dark:border-gray-700 mb-6">
                    <nav class="flex gap-4">
                        <button id="tabPlanos" onclick="switchTab('planos')"
                            class="tab-button active px-4 py-2 border-b-2 border-primary text-primary font-medium">
                            Plano de Manuten√ß√£o
                        </button>
                        <button id="tabPecas" onclick="switchTab('pecas')"
                            class="tab-button px-4 py-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700 dark:hover:text-gray-400 font-medium">
                            Pe√ßas Compat√≠veis
                        </button>
                    </nav>
                </div>

                <!-- Tab: Plano de Manuten√ß√£o -->
                <section id="contentPlanos" class="tab-content">
                    <!-- Section Header -->
                    <div class="flex flex-wrap justify-between items-center gap-4 mb-4">
                    <div>
                        <h2 id="planTitle" class="text-gray-900 dark:text-white text-2xl font-bold tracking-tight">Plano para...</h2>
                        <p id="planCount" class="text-gray-500 dark:text-gray-400">0 itens cadastrados</p>
                    </div>
                    <button onclick="adicionarItem()" class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-12 px-5 bg-primary text-white gap-2 text-sm font-bold tracking-wide hover:bg-primary/90">
                        <span class="material-symbols-outlined text-lg">add_circle</span>
                        <span class="truncate">Adicionar Item</span>
                    </button>
                </div>

                <!-- Item List -->
                <div id="itemsList" class="flex flex-col gap-3">
                    <!-- Items will be dynamically inserted here -->
                </div>

                <!-- Empty State -->
                <div id="emptyState" class="text-center bg-white dark:bg-gray-800/50 border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-xl p-12">
                    <span class="material-symbols-outlined text-5xl text-gray-400 dark:text-gray-500">assignment</span>
                    <h3 class="mt-4 text-xl font-bold text-gray-900 dark:text-white">Este plano ainda est√° vazio</h3>
                    <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Comece adicionando um item de manuten√ß√£o preventiva.</p>
                    <button onclick="adicionarItem()" class="mt-6 flex min-w-[84px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-4 bg-primary text-white gap-2 text-sm font-bold tracking-wide mx-auto">
                        <span class="material-symbols-outlined text-lg">add</span>
                        <span class="truncate">Come√ßar Agora</span>
                    </button>
                </div>
                </section>
                <!-- End Tab: Plano de Manuten√ß√£o -->

                <!-- Tab: Pe√ßas Compat√≠veis -->
                <section id="contentPecas" class="tab-content hidden">
                    <!-- Filtro de Ano -->
                    <div class="bg-white dark:bg-gray-800/50 rounded-lg shadow-sm p-4 mb-6">
                        <div class="flex items-center gap-4">
                            <label class="text-sm font-medium text-gray-700 dark:text-gray-300">Filtrar por ano:</label>
                            <select id="filtroAno" onchange="filtrarPecasPorAno()"
                                class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                <option value="">Todos os anos</option>
                                <!-- Populado dinamicamente -->
                            </select>
                        </div>
                    </div>

                    <!-- Container de Pe√ßas -->
                    <div id="pecasContainer">
                        <!-- Categorias ser√£o renderizadas aqui -->
                    </div>

                    <!-- Empty State -->
                    <div id="emptyPecas" class="hidden text-center py-12 text-gray-500 dark:text-gray-400">
                        <span class="material-symbols-outlined text-6xl mb-4">inbox</span>
                        <p>Nenhuma pe√ßa compat√≠vel cadastrada para este modelo/ano.</p>
                    </div>

                    <!-- Loading State -->
                    <div id="loadingPecas" class="hidden text-center py-12">
                        <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-primary"></div>
                        <p class="text-gray-500 dark:text-gray-400 mt-4">Carregando pe√ßas...</p>
                    </div>
                </section>
                <!-- End Tab: Pe√ßas Compat√≠veis -->
            </div>
            <!-- End Tabs System -->
        </div>
    </main>
</div>

<!-- Modal Adicionar/Editar Item -->
<div id="itemModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
        <div class="sticky top-0 bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 p-6 flex justify-between items-center">
            <h3 id="modalTitle" class="text-2xl font-bold text-gray-900 dark:text-white">Adicionar Item de Manuten√ß√£o</h3>
            <button onclick="fecharModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200">
                <span class="material-symbols-outlined text-3xl">close</span>
            </button>
        </div>

        <form id="itemForm" class="p-6 space-y-6">
            <input type="hidden" id="itemId"/>

            <!-- Basic Info -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="col-span-2">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        Nome do Item de Manuten√ß√£o <span class="text-red-500">*</span>
                    </label>
                    <input type="text" id="itemNome" required class="w-full rounded-lg border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white h-12 px-4"/>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        Intervalo KM
                    </label>
                    <input type="number" id="itemKm" placeholder="Ex: 10000" class="w-full rounded-lg border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white h-12 px-4"/>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        Intervalo Meses
                    </label>
                    <input type="number" id="itemMeses" placeholder="Ex: 6" class="w-full rounded-lg border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white h-12 px-4"/>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        Custo Estimado (R$) <span class="text-red-500">*</span>
                    </label>
                    <input type="number" id="itemCusto" required step="0.01" placeholder="Ex: 850.00" class="w-full rounded-lg border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white h-12 px-4"/>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        Criticidade <span class="text-red-500">*</span>
                    </label>
                    <select id="itemCriticidade" required class="w-full rounded-lg border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white h-12 px-4">
                        <option value="alta">Alta</option>
                        <option value="media">M√©dia</option>
                        <option value="baixa">Baixa</option>
                    </select>
                </div>

                <div class="col-span-2">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        Descri√ß√£o/Observa√ß√µes
                    </label>
                    <textarea id="itemDescricao" rows="3" placeholder="Detalhes sobre o servi√ßo de manuten√ß√£o..." class="w-full rounded-lg border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white px-4 py-2"></textarea>
                </div>
            </div>

            <!-- Se√ß√£o de Pe√ßas -->
            <div class="border-t border-gray-200 dark:border-gray-700 pt-6">
                <h4 class="text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
                    <span class="material-symbols-outlined">build</span>
                    Pe√ßas Necess√°rias
                </h4>

                <!-- Adicionar pe√ßa -->
                <div class="grid grid-cols-1 md:grid-cols-12 gap-3 mb-4">
                    <div class="md:col-span-6">
                        <select id="itemSelectPeca" class="w-full h-12 px-4 rounded-lg border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                            <option value="">Selecione uma pe√ßa para adicionar...</option>
                        </select>
                    </div>
                    <div class="md:col-span-3">
                        <input id="itemQuantidadePeca" type="number" min="1" value="1" placeholder="Qtd" class="w-full h-12 px-4 rounded-lg border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white" />
                    </div>
                    <div class="md:col-span-3">
                        <button type="button" id="btnAdicionarPecaItem" class="w-full h-12 px-4 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 flex items-center justify-center gap-2">
                            <span class="material-symbols-outlined">add</span>
                            Adicionar
                        </button>
                    </div>
                </div>

                <!-- Lista de pe√ßas -->
                <div id="itemListaPecas" class="border rounded-lg border-gray-200 dark:border-gray-700 overflow-hidden">
                    <table class="w-full text-sm text-left">
                        <thead class="text-xs text-gray-700 dark:text-gray-300 uppercase bg-gray-100 dark:bg-gray-700">
                            <tr>
                                <th class="px-4 py-3">Pe√ßa</th>
                                <th class="px-4 py-3 text-center">Qtd</th>
                                <th class="px-4 py-3 text-right">Custo Unit.</th>
                                <th class="px-4 py-3 text-right">Total</th>
                                <th class="px-4 py-3 text-center w-12"></th>
                            </tr>
                        </thead>
                        <tbody id="itemTbodyPecas">
                            <tr><td colspan="5" class="px-4 py-6 text-center text-gray-500 italic">Nenhuma pe√ßa adicionada</td></tr>
                        </tbody>
                    </table>
                </div>
                <div class="flex justify-between items-center mt-3">
                    <span class="text-sm text-gray-500 dark:text-gray-400">Total em pe√ßas:</span>
                    <span id="itemTotalPecas" class="text-lg font-bold text-primary">R$ 0,00</span>
                </div>
            </div>

            <div class="flex justify-end gap-3 pt-4 border-t border-gray-200 dark:border-gray-700">
                <button type="button" onclick="fecharModal()" class="px-6 py-2 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-lg font-medium hover:bg-gray-300 dark:hover:bg-gray-600">
                    Cancelar
                </button>
                <button type="submit" class="px-6 py-2 bg-primary text-white rounded-lg font-medium hover:bg-primary/90">
                    Salvar Item
                </button>
            </div>
        </form>
    </div>
</div>

<script>
const API_URL = 'https://floripa.in9automacao.com.br';
const API_PLANOS_URL = 'https://floripa.in9automacao.com.br/planos-manutencao-api.php';
let currentModelId = null;
let currentModeloNome = null;
let planItems = [];
let expandedItems = new Set();

// Carregar modelos ao iniciar
document.addEventListener('DOMContentLoaded', async () => {
    await carregarModelos();
});

// Carregar modelos
async function carregarModelos() {
    try {
        const response = await fetch(`${API_URL}/modelos.php`);
        const modelos = await response.json();

        const select = document.getElementById('modelSelect');
        select.innerHTML = '<option value="" disabled selected>Selecione um modelo...</option>';

        modelos.forEach(modelo => {
            const option = document.createElement('option');
            option.value = modelo.id;
            const tipoIcon = {
                'Passeio': 'üöó',
                'Utilit√°rio': 'üöê',
                'Caminhonete': 'üõª',
                'Caminh√£o': 'üöö',
                'SUV': 'üöô'
            }[modelo.tipo] || 'üöó';
            option.textContent = `${tipoIcon} ${modelo.marca} ${modelo.modelo} (${modelo.ano}) - ${modelo.tipo}`;
            option.dataset.marca = modelo.marca;
            option.dataset.modelo = modelo.modelo;
            option.dataset.ano = modelo.ano;
            select.appendChild(option);
        });

        select.addEventListener('change', (e) => {
            const modeloId = e.target.value;
            if (modeloId) {
                currentModelId = modeloId;
                const selectedOption = e.target.options[e.target.selectedIndex];
                const marca = selectedOption.dataset.marca;
                const modelo = selectedOption.dataset.modelo;
                const ano = selectedOption.dataset.ano;
                // Buscar apenas pelo nome do modelo (sem marca e ano)
                carregarPlano(modeloId, modelo, `${marca} ${modelo} (${ano})`);
            }
        });
    } catch (error) {
        console.error('Erro ao carregar modelos:', error);
        alert('Erro ao carregar modelos');
    }
}

// Carregar plano do modelo
async function carregarPlano(modeloId, modeloNome, modeloCompleto) {
    try {
        currentModeloNome = modeloCompleto || modeloNome;

        // Buscar da API PHP usando apenas o nome do modelo
        console.log('üîç Buscando planos para:', modeloNome);
        const response = await fetch(`${API_PLANOS_URL}?modelo=${encodeURIComponent(modeloNome)}`);
        const result = await response.json();
        console.log('üì¶ Resposta da API:', result);
        planItems = result.data || [];
        console.log('üìã Planos encontrados:', planItems.length);
        expandedItems.clear();

        // Mostrar sistema de abas ao inv√©s de apenas planSection
        document.getElementById('modeloTabs').classList.remove('hidden');
        document.getElementById('planTitle').textContent = `Plano para ${currentModeloNome}`;
        document.getElementById('planCount').textContent = `${planItems.length} ${planItems.length === 1 ? 'item cadastrado' : 'itens cadastrados'}`;

        const statusBadge = document.getElementById('planStatus');
        if (planItems.length > 0) {
            statusBadge.className = 'inline-flex items-center rounded-full bg-green-100 dark:bg-green-900/50 px-3 py-1 text-sm font-semibold text-green-800 dark:text-green-300';
            statusBadge.textContent = 'Com Plano';
            statusBadge.classList.remove('hidden');
        } else {
            statusBadge.className = 'inline-flex items-center rounded-full bg-gray-100 dark:bg-gray-700 px-3 py-1 text-sm font-semibold text-gray-600 dark:text-gray-300';
            statusBadge.textContent = 'Sem Plano';
            statusBadge.classList.remove('hidden');
        }

        renderizarItens();

        // Pr√©-carregar pe√ßas compat√≠veis
        carregarPecasCompativeis(modeloNome);

        // Popular automaticamente as pe√ßas nos itens (em background)
        if (planItems.length > 0) {
            popularPecasAutomaticamente(modeloNome);
        }
    } catch (error) {
        console.error('Erro ao carregar plano:', error);
        alert('Erro ao carregar plano de manuten√ß√£o');
    }
}

// Popular automaticamente as pe√ßas em todos os itens do plano
async function popularPecasAutomaticamente(modeloNome) {
    console.log('ü§ñ Iniciando popula√ß√£o autom√°tica de pe√ßas...');

    // Carregar pe√ßas compat√≠veis do modelo
    await carregarPecasDisponiveis(modeloNome);

    if (pecasDisponiveis.length === 0) {
        console.log('‚ö†Ô∏è Nenhuma pe√ßa compat√≠vel encontrada para o modelo');
        return;
    }

    console.log(`‚úÖ ${pecasDisponiveis.length} pe√ßas dispon√≠veis para sugest√£o`);

    // Para cada item do plano, verificar se precisa sugerir pe√ßas
    for (const item of planItems) {
        try {
            // Verificar se o item j√° tem pe√ßas cadastradas
            const response = await fetch(`${API_URL}/plano-pecas-api.php?plano_item_id=${item.id}`);
            const result = await response.json();
            const pecasExistentes = result.data || [];

            // Se j√° tem pe√ßas, pular este item
            if (pecasExistentes.length > 0) {
                console.log(`‚è≠Ô∏è Item "${item.descricao_titulo}" j√° tem ${pecasExistentes.length} pe√ßa(s)`);
                continue;
            }

            // Sugerir pe√ßas automaticamente
            console.log(`ü§ñ Sugerindo pe√ßas para: ${item.descricao_titulo}`);
            await sugerirPecasAutomaticas(item.id, item.descricao_titulo);

        } catch (error) {
            console.error(`Erro ao processar item ${item.id}:`, error);
        }
    }

    console.log('‚úÖ Popula√ß√£o autom√°tica conclu√≠da!');
}

// Toggle expand item
function toggleExpand(itemId) {
    if (expandedItems.has(itemId)) {
        expandedItems.delete(itemId);
    } else {
        expandedItems.add(itemId);
    }
    renderizarItens();

    // Se est√° expandindo, carregar as pe√ßas ap√≥s renderizar
    if (expandedItems.has(itemId)) {
        setTimeout(() => carregarPecasExpandido(itemId), 0);
    }
}

// Carregar e renderizar pe√ßas na view expandida
async function carregarPecasExpandido(itemId) {
    const container = document.getElementById(`pecas-item-${itemId}`);
    if (!container) return;

    try {
        const response = await fetch(`${API_URL}/plano-pecas-api.php?plano_item_id=${itemId}`);
        const result = await response.json();

        const pecas = result.data || result;

        if (!pecas || pecas.length === 0) {
            container.innerHTML = '<p class="text-gray-500 dark:text-gray-400 italic">Nenhuma pe√ßa cadastrada para este item</p>';
            return;
        }

        let custoTotal = 0;
        let html = '<div class="grid gap-3">';

        pecas.forEach(peca => {
            const total = (peca.quantidade || 1) * (peca.custo_unitario || 0);
            custoTotal += total;

            html += `
                <div class="flex items-center justify-between p-3 bg-white dark:bg-gray-700/50 rounded-lg border border-gray-100 dark:border-gray-600">
                    <div class="flex-1">
                        <p class="font-medium text-gray-800 dark:text-gray-200">${peca.nome}</p>
                        <p class="text-xs text-gray-500 dark:text-gray-400">
                            ${peca.codigo ? `C√≥digo: ${peca.codigo} ‚Ä¢ ` : ''}
                            Qtd: ${peca.quantidade || 1} ${peca.unidade || 'un'}
                            ${peca.vida_util_km ? ` ‚Ä¢ Vida √∫til: ${Number(peca.vida_util_km).toLocaleString('pt-BR')} km` : ''}
                            ${peca.vida_util_meses ? ` ‚Ä¢ ${peca.vida_util_meses} meses` : ''}
                        </p>
                    </div>
                    <div class="text-right">
                        <p class="font-semibold text-gray-800 dark:text-gray-200">${formatarMoeda(total)}</p>
                        <p class="text-xs text-gray-500 dark:text-gray-400">${formatarMoeda(peca.custo_unitario || 0)}/un</p>
                    </div>
                </div>
            `;
        });

        html += '</div>';
        html += `
            <div class="mt-3 pt-3 border-t border-gray-200 dark:border-gray-600 flex justify-between items-center">
                <span class="text-sm font-medium text-gray-600 dark:text-gray-400">Total em Pe√ßas:</span>
                <span class="text-lg font-bold text-primary">${formatarMoeda(custoTotal)}</span>
            </div>
        `;

        container.innerHTML = html;
    } catch (error) {
        console.error('Erro ao carregar pe√ßas expandidas:', error);
        container.innerHTML = '<p class="text-red-500 italic">Erro ao carregar pe√ßas</p>';
    }
}

// Renderizar itens
// Extrair informa√ß√µes estruturadas do campo descricao_observacao
function parseDescricaoObservacao(descricao) {
    if (!descricao) return { categoria: '-', tempo: '-', descricao: '-', pecas: [] };

    // Extrair [CATEGORIA: X]
    const categoriaMatch = descricao.match(/\[CATEGORIA:\s*([^\]]+)\]/);
    const categoria = categoriaMatch ? categoriaMatch[1].trim() : '-';

    // Extrair [TEMPO: X]
    const tempoMatch = descricao.match(/\[TEMPO:\s*([^\]]+)\]/);
    const tempo = tempoMatch ? tempoMatch[1].trim() : '-';

    // Extrair pe√ßas ANTES de limpar (precisa do bloco original)
    const pecas = extrairPecasDescricao(descricao);

    // Remover tags e bloco de pe√ßas da descri√ß√£o limpa
    let descricaoLimpa = descricao
        .replace(/\[CATEGORIA:[^\]]+\]/g, '')
        .replace(/\[TEMPO:[^\]]+\]/g, '')
        .replace(/\[PECAS\][\s\S]*?\[\/PECAS\]/gi, '') // Remove bloco de pe√ßas
        .replace(/\n{3,}/g, '\n\n') // Remove linhas em branco extras
        .trim();

    return { categoria, tempo, descricao: descricaoLimpa, pecas };
}

// Extrair informa√ß√µes de pe√ßas da descri√ß√£o do Perplexity
function extrairPecasDescricao(descricao) {
    if (!descricao) return [];

    const pecas = [];

    // ============================================
    // PADR√ÉO PRINCIPAL: Bloco estruturado [PECAS]...[/PECAS]
    // ============================================
    const blocoPecas = descricao.match(/\[PECAS\]([\s\S]*?)\[\/PECAS\]/i);
    if (blocoPecas) {
        const conteudo = blocoPecas[1].trim();

        // Usar regex para extrair pe√ßas ORIGINAIS
        // Formato: ORIGINAL|CODIGO|NOME|QTD|PRECO
        const regexOriginal = /ORIGINAL\|([^|]+)\|([^|]+)\|([^|]+)\|([0-9.,]+)/gi;
        let matchOrig;
        while ((matchOrig = regexOriginal.exec(conteudo)) !== null) {
            const codigo = matchOrig[1].trim();
            const nome = matchOrig[2].trim();
            const qtdStr = matchOrig[3].trim();
            const precoStr = matchOrig[4].trim();

            pecas.push({
                codigo: codigo,
                nome: nome,
                quantidade: qtdStr,
                preco: precoStr,
                custo_unitario: parseFloat(precoStr.replace(',', '.')) || 0,
                tipo: 'Original'
            });
        }

        // Usar regex para extrair pe√ßas SIMILARES
        // Formato: SIMILAR|CODIGO|MARCA|NOME|QTD|PRECO
        const regexSimilar = /SIMILAR\|([^|]+)\|([^|]+)\|([^|]+)\|([^|]+)\|([0-9.,]+)/gi;
        let matchSim;
        while ((matchSim = regexSimilar.exec(conteudo)) !== null) {
            const codigo = matchSim[1].trim();
            const marca = matchSim[2].trim();
            const nome = matchSim[3].trim();
            const qtdStr = matchSim[4].trim();
            const precoStr = matchSim[5].trim();

            pecas.push({
                codigo: codigo,
                nome: `${nome} (${marca})`,
                quantidade: qtdStr,
                preco: precoStr,
                custo_unitario: parseFloat(precoStr.replace(',', '.')) || 0,
                tipo: 'Similar'
            });
        }

        console.log('üîß Pe√ßas extra√≠das do bloco [PECAS]:', pecas.length, pecas);

        // Se encontrou pe√ßas no formato estruturado, retornar
        if (pecas.length > 0) return pecas;
    }

    // ============================================
    // PADR√ïES LEGADO (mantidos para compatibilidade)
    // ============================================

    // PADR√ÉO 1: "C√≥digo filtro: 90915-YZZJ2" ou "C√≥digo pe√ßa: XXX"
    const padraoCodigo1 = /c√≥digo\s+(filtro|pe√ßa|original)?:?\s*([A-Z0-9][\w-]{2,})/gi;
    let match;
    while ((match = padraoCodigo1.exec(descricao)) !== null) {
        const tipoPeca = match[1] || '';
        const codigo = match[2];

        // Extrair contexto ao redor (30 chars antes e depois)
        const inicio = Math.max(0, match.index - 30);
        const fim = Math.min(descricao.length, match.index + match[0].length + 30);
        const contexto = descricao.substring(inicio, fim);

        pecas.push({
            codigo: codigo,
            nome: identificarNomePeca(tipoPeca, contexto, descricao),
            quantidade: extrairQuantidade(contexto, descricao),
            tipo: 'Original'
        });
    }

    // PADR√ÉO 2: "equivalente Wega JFO0211" ou "similar Tecfil PSL127"
    const padraoEquivalente = /(equivalente|similar)\s+([A-Za-z]+)\s+([A-Z0-9][\w-]{2,})/gi;
    while ((match = padraoEquivalente.exec(descricao)) !== null) {
        const marca = match[2];
        const codigo = match[3];

        const inicio = Math.max(0, match.index - 30);
        const fim = Math.min(descricao.length, match.index + match[0].length + 30);
        const contexto = descricao.substring(inicio, fim);

        pecas.push({
            codigo: codigo,
            nome: identificarNomePeca('', contexto, descricao) + ` ${marca}`,
            quantidade: extrairQuantidade(contexto, descricao),
            tipo: 'Similar'
        });
    }

    // PADR√ÉO 3: Quantidades de fluidos sem c√≥digo espec√≠fico (8L √≥leo, 1,5L fluido freio)
    const padraoFluido = /(\d+(?:[.,]\d+)?)\s*L\s+(√≥leo|oleo|fluido)\s+([^\.,]{5,40})/gi;
    while ((match = padraoFluido.exec(descricao)) !== null) {
        const quantidade = match[1] + 'L';
        const tipoFluido = match[2];
        const especificacao = match[3].trim();

        // S√≥ adicionar se n√£o encontrou c√≥digo para este fluido
        const jaTemCodigo = pecas.some(p => p.nome.toLowerCase().includes(tipoFluido));
        if (!jaTemCodigo) {
            let nome = 'Fluido';
            if (/5W-?30/i.test(especificacao)) nome = '√ìleo Motor 5W-30';
            else if (/10W-?40/i.test(especificacao)) nome = '√ìleo Motor 10W-40';
            else if (/sint√©tico/i.test(especificacao)) nome = '√ìleo Sint√©tico';
            else if (/freio|DOT/i.test(especificacao)) nome = 'Fluido de Freio';
            else if (/arrefecimento/i.test(especificacao)) nome = 'Fluido de Arrefecimento';
            else nome = `${tipoFluido} ${especificacao.substring(0, 20)}`;

            pecas.push({
                codigo: '-',
                nome: nome,
                quantidade: quantidade,
                tipo: 'Necess√°rio'
            });
        }
    }

    return pecas;
}

// Identificar nome da pe√ßa baseado no contexto
function identificarNomePeca(tipoPecaExplicito, contexto, descricaoCompleta) {
    if (tipoPecaExplicito) {
        // Se j√° veio "filtro" ou "pe√ßa", usar isso
        if (/filtro/i.test(tipoPecaExplicito)) {
            // Tentar identificar tipo de filtro
            if (/√≥leo|oleo/i.test(contexto) || /√≥leo|oleo/i.test(descricaoCompleta)) return 'Filtro de √ìleo';
            if (/ar\s+motor/i.test(contexto)) return 'Filtro de Ar Motor';
            if (/combust√≠vel|combustivel|diesel/i.test(contexto)) return 'Filtro de Combust√≠vel';
            if (/cabine|ar condicionado/i.test(contexto)) return 'Filtro de Cabine';
            return 'Filtro';
        }
    }

    // An√°lise de contexto
    const ctx = contexto.toLowerCase();

    if (/filtro.*√≥leo|√≥leo.*filtro/i.test(contexto)) return 'Filtro de √ìleo';
    if (/filtro.*ar|ar.*filtro/i.test(contexto)) return 'Filtro de Ar';
    if (/filtro.*combust√≠vel|combust√≠vel.*filtro|filtro.*diesel/i.test(contexto)) return 'Filtro de Combust√≠vel';
    if (/filtro.*cabine|cabine.*filtro/i.test(contexto)) return 'Filtro de Cabine';

    if (/pastilha.*freio|freio.*pastilha/i.test(contexto)) {
        if (/dianteira/i.test(contexto)) return 'Pastilha Freio Dianteira';
        if (/traseira/i.test(contexto)) return 'Pastilha Freio Traseira';
        return 'Pastilha de Freio';
    }

    if (/vela.*aquecimento/i.test(contexto)) return 'Vela de Aquecimento';
    if (/corrente.*distribui√ß√£o|distribui√ß√£o.*corrente/i.test(contexto)) return 'Corrente de Distribui√ß√£o';
    if (/correia/i.test(contexto)) return 'Correia';
    if (/amortecedor/i.test(contexto)) return 'Amortecedor';
    if (/disco.*freio/i.test(contexto)) return 'Disco de Freio';

    // Fallback: procurar substantivo antes do c√≥digo
    const palavrasAntes = contexto.substring(0, 30).trim().split(/\s+/);
    const ultimaPalavra = palavrasAntes[palavrasAntes.length - 1];
    if (ultimaPalavra && ultimaPalavra.length > 3) {
        return ultimaPalavra.charAt(0).toUpperCase() + ultimaPalavra.slice(1);
    }

    return 'Componente';
}

// Extrair quantidade do contexto
function extrairQuantidade(contexto, descricaoCompleta) {
    // Procurar padr√µes de quantidade
    const padroes = [
        /(\d+(?:[.,]\d+)?)\s*L(?:itros?)?/i,
        /(\d+)\s*unidades?/i,
        /(\d+)\s*pe√ßas?/i,
        /(\d+)\s*und/i
    ];

    for (const padrao of padroes) {
        const match = contexto.match(padrao) || descricaoCompleta.match(padrao);
        if (match) {
            return match[0];
        }
    }

    return '1 unidade';
}

function renderizarItens() {
    const container = document.getElementById('itemsList');
    const emptyState = document.getElementById('emptyState');

    if (planItems.length === 0) {
        container.classList.add('hidden');
        emptyState.classList.remove('hidden');
        return;
    }

    container.classList.remove('hidden');
    emptyState.classList.add('hidden');

    container.innerHTML = planItems.map(item => {
        const isExpanded = expandedItems.has(item.id);

        const criticidade = (item.criticidade || '').toLowerCase();
        const criticidadeClass = {
            'alta': 'bg-red-100 dark:bg-red-900/50 text-red-800 dark:text-red-300',
            'm√©dia': 'bg-orange-100 dark:bg-orange-900/50 text-orange-800 dark:text-orange-300',
            'media': 'bg-orange-100 dark:bg-orange-900/50 text-orange-800 dark:text-orange-300',
            'baixa': 'bg-green-100 dark:bg-green-900/50 text-green-800 dark:text-green-300',
            'cr√≠tica': 'bg-red-100 dark:bg-red-900/50 text-red-800 dark:text-red-300',
            'critica': 'bg-red-100 dark:bg-red-900/50 text-red-800 dark:text-red-300'
        }[criticidade] || 'bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-300';

        const criticidadeLabel = item.criticidade || 'Sem Criticidade';

        const borderClass = isExpanded ? 'border-primary/50 dark:border-primary/50 ring-2 ring-primary/20' : 'border-gray-200 dark:border-gray-700';
        const expandIcon = isExpanded ? 'expand_less' : 'expand_more';
        const expandBtnClass = isExpanded ? 'bg-primary/10 text-primary' : 'bg-gray-100 dark:bg-gray-700/50 text-gray-600 dark:text-gray-300';

        return `
            <div class="bg-white dark:bg-gray-800/50 border ${borderClass} rounded-xl overflow-hidden">
                <div class="p-4 flex flex-col md:flex-row items-start md:items-center gap-4 ${isExpanded ? 'border-b border-gray-200 dark:border-gray-700' : ''}">
                    <div class="flex-1">
                        <p class="font-bold text-lg text-gray-900 dark:text-white">${item.descricao_titulo || item.nome || 'Sem t√≠tulo'}</p>
                        <div class="flex flex-wrap items-center gap-x-6 gap-y-2 mt-2 text-sm text-gray-600 dark:text-gray-300">
                            ${item.km_recomendado ? `<div class="flex items-center gap-2"><span class="material-symbols-outlined text-base">speed</span> <span>${Number(item.km_recomendado).toLocaleString('pt-BR')} KM</span></div>` : ''}
                            ${item.intervalo_tempo ? `<div class="flex items-center gap-2"><span class="material-symbols-outlined text-base">calendar_month</span> <span>${item.intervalo_tempo}</span></div>` : ''}
                            <div class="flex items-center gap-2"><span class="material-symbols-outlined text-base">payments</span> <span>Custo: R$ ${Number(item.custo_estimado || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span></div>
                        </div>
                    </div>
                    <div class="flex items-center gap-3 w-full md:w-auto justify-end">
                        <span class="inline-flex items-center rounded-full ${criticidadeClass} px-3 py-1 text-sm font-semibold">${criticidadeLabel}</span>
                        <button onclick="editarItem(${item.id})" class="flex h-10 w-10 cursor-pointer items-center justify-center rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-500 dark:text-gray-400">
                            <span class="material-symbols-outlined">edit</span>
                        </button>
                        <button onclick="excluirItem(${item.id})" class="flex h-10 w-10 cursor-pointer items-center justify-center rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-500 dark:text-gray-400">
                            <span class="material-symbols-outlined">delete</span>
                        </button>
                        <button onclick="toggleExpand(${item.id})" class="flex h-10 w-10 cursor-pointer items-center justify-center rounded-lg ${expandBtnClass}">
                            <span class="material-symbols-outlined">${expandIcon}</span>
                        </button>
                    </div>
                </div>
                ${isExpanded ? `
                <div class="p-6 bg-background-light dark:bg-gray-800">
                    ${(() => {
                        const detalhes = parseDescricaoObservacao(item.descricao_observacao || item.descricao || '');
                        // Calcular custo das pe√ßas originais
                        const custoPecasOriginais = detalhes.pecas
                            .filter(p => p.tipo === 'Original')
                            .reduce((sum, p) => sum + (p.custo_unitario || parseFloat(p.preco) || 0), 0);
                        const custoMaoObra = Number(item.custo_estimado) || 0;
                        const custoTotal = custoMaoObra + custoPecasOriginais;

                        return `
                        <!-- Informa√ß√µes Principais -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                            <div class="bg-white dark:bg-slate-700 p-4 rounded-lg border border-gray-200 dark:border-slate-600">
                                <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">Categoria</p>
                                <p class="font-bold text-gray-900 dark:text-white">${detalhes.categoria}</p>
                            </div>
                            <div class="bg-white dark:bg-slate-700 p-4 rounded-lg border border-gray-200 dark:border-slate-600">
                                <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">Tempo Estimado</p>
                                <p class="font-bold text-gray-900 dark:text-white">${detalhes.tempo}</p>
                            </div>
                            <div class="bg-white dark:bg-slate-700 p-4 rounded-lg border border-gray-200 dark:border-slate-600">
                                <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">Criticidade</p>
                                <p class="font-bold text-gray-900 dark:text-white">${criticidadeLabel}</p>
                            </div>
                        </div>

                        <!-- Custos Detalhados -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                            <div class="bg-white dark:bg-slate-700 p-4 rounded-lg border border-gray-200 dark:border-slate-600">
                                <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">M√£o de Obra</p>
                                <p class="font-bold text-gray-900 dark:text-white text-lg">R$ ${custoMaoObra.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p>
                            </div>
                            <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg border border-blue-200 dark:border-blue-800">
                                <p class="text-xs text-blue-600 dark:text-blue-400 mb-1">Pe√ßas Originais</p>
                                <p class="font-bold text-blue-900 dark:text-blue-300 text-lg">R$ ${custoPecasOriginais.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p>
                            </div>
                            <div class="bg-green-50 dark:bg-green-900/20 p-4 rounded-lg border border-green-200 dark:border-green-800">
                                <p class="text-xs text-green-600 dark:text-green-400 mb-1">Custo Total Estimado</p>
                                <p class="font-bold text-green-900 dark:text-green-300 text-xl">R$ ${custoTotal.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p>
                            </div>
                        </div>

                        <!-- Intervalos -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                            <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg border border-blue-200 dark:border-blue-800">
                                <p class="text-xs text-blue-600 dark:text-blue-400 mb-1">Intervalo por KM</p>
                                <p class="font-bold text-blue-900 dark:text-blue-300 text-lg">${(item.km_recomendado || item.intervalo_km) ? Number(item.km_recomendado || item.intervalo_km).toLocaleString('pt-BR') + ' km' : 'N/A'}</p>
                            </div>
                            <div class="bg-purple-50 dark:bg-purple-900/20 p-4 rounded-lg border border-purple-200 dark:border-purple-800">
                                <p class="text-xs text-purple-600 dark:text-purple-400 mb-1">Intervalo por Tempo</p>
                                <p class="font-bold text-purple-900 dark:text-purple-300 text-lg">${(item.intervalo_tempo || item.intervalo_meses) ? Number(item.intervalo_tempo || item.intervalo_meses) + ' meses' : 'N/A'}</p>
                            </div>
                            <div class="bg-green-50 dark:bg-green-900/20 p-4 rounded-lg border border-green-200 dark:border-green-800">
                                <p class="text-xs text-green-600 dark:text-green-400 mb-1">Crit√©rio de Ativa√ß√£o</p>
                                <p class="font-bold text-green-900 dark:text-green-300">Qual vier primeiro</p>
                            </div>
                        </div>

                        <!-- Descri√ß√£o Completa -->
                        <div class="bg-white dark:bg-slate-700 p-6 rounded-lg border border-gray-200 dark:border-slate-600 mb-6">
                            <h4 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-3 flex items-center gap-2">
                                <span class="material-symbols-outlined text-lg">description</span>
                                Descri√ß√£o T√©cnica Detalhada
                            </h4>
                            <div class="text-sm text-gray-700 dark:text-gray-300 leading-relaxed whitespace-pre-wrap">${detalhes.descricao}</div>
                        </div>
                        `;
                    })()}

                    <!-- Se√ß√£o de Pe√ßas do Item -->
                    <div class="mt-6 pt-6 border-t border-gray-200 dark:border-gray-700">
                        <h4 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-3 flex items-center gap-2">
                            <span class="material-symbols-outlined text-base">build</span>
                            Pe√ßas Necess√°rias (Perplexity AI)
                        </h4>
                        ${(() => {
                            const detalhesInterno = parseDescricaoObservacao(item.descricao_observacao || item.descricao || '');
                            const pecas = detalhesInterno.pecas;

                            if (!pecas || pecas.length === 0) {
                                return '<p class="text-gray-500 italic text-sm">Nenhuma pe√ßa espec√≠fica mencionada na descri√ß√£o</p>';
                            }

                            // Calcular totais
                            const totalOriginal = pecas.filter(p => p.tipo === 'Original').reduce((sum, p) => sum + (p.custo_unitario || parseFloat(p.preco) || 0), 0);
                            const totalSimilar = pecas.filter(p => p.tipo === 'Similar').reduce((sum, p) => sum + (p.custo_unitario || parseFloat(p.preco) || 0), 0);
                            const economia = totalOriginal > 0 && totalSimilar > 0 ? ((1 - totalSimilar/totalOriginal) * 100).toFixed(0) : 0;

                            return `
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                                        <thead class="bg-gray-50 dark:bg-gray-800">
                                            <tr>
                                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">C√≥digo</th>
                                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Nome da Pe√ßa</th>
                                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Qtd</th>
                                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Pre√ßo Est.</th>
                                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Tipo</th>
                                            </tr>
                                        </thead>
                                        <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                            ${pecas.map(peca => `
                                                <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50">
                                                    <td class="px-4 py-3 text-sm font-mono text-gray-900 dark:text-white">${peca.codigo}</td>
                                                    <td class="px-4 py-3 text-sm text-gray-700 dark:text-gray-300">${peca.nome}</td>
                                                    <td class="px-4 py-3 text-sm text-gray-700 dark:text-gray-300">${peca.quantidade}</td>
                                                    <td class="px-4 py-3 text-sm font-semibold ${peca.tipo === 'Similar' ? 'text-green-600 dark:text-green-400' : 'text-gray-700 dark:text-gray-300'}">
                                                        ${(peca.custo_unitario || peca.preco) ? 'R$ ' + Number(peca.custo_unitario || peca.preco).toLocaleString('pt-BR', {minimumFractionDigits: 2}) : '-'}
                                                    </td>
                                                    <td class="px-4 py-3">
                                                        <span class="inline-flex items-center rounded-full px-2 py-1 text-xs font-semibold
                                                            ${peca.tipo === 'Original' ? 'bg-blue-100 dark:bg-blue-900/50 text-blue-800 dark:text-blue-300' :
                                                              peca.tipo === 'Similar' ? 'bg-green-100 dark:bg-green-900/50 text-green-800 dark:text-green-300' :
                                                              'bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-300'}">
                                                            ${peca.tipo}
                                                        </span>
                                                    </td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                                ${totalOriginal > 0 || totalSimilar > 0 ? `
                                <div class="mt-4 p-4 bg-gray-50 dark:bg-gray-800 rounded-lg">
                                    <div class="flex flex-wrap gap-4 text-sm">
                                        ${totalOriginal > 0 ? `<div><span class="text-gray-500">Pe√ßas Originais:</span> <span class="font-bold text-blue-600">R$ ${totalOriginal.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</span></div>` : ''}
                                        ${totalSimilar > 0 ? `<div><span class="text-gray-500">Pe√ßas Similares:</span> <span class="font-bold text-green-600">R$ ${totalSimilar.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</span></div>` : ''}
                                        ${economia > 0 ? `<div class="bg-green-100 dark:bg-green-900/30 px-3 py-1 rounded-full"><span class="text-green-700 dark:text-green-300 font-semibold">üí∞ Economia com similares: ${economia}%</span></div>` : ''}
                                    </div>
                                </div>
                                ` : ''}
                                <p class="text-xs text-gray-500 dark:text-gray-400 mt-3 italic">
                                    <span class="material-symbols-outlined text-xs">info</span>
                                    Informa√ß√µes extra√≠das automaticamente da descri√ß√£o t√©cnica do Perplexity AI
                                </p>
                            `;
                        })()}
                    </div>
                </div>
                ` : ''}
            </div>
        `;
    }).join('');
}

// Adicionar item
async function adicionarItem() {
    if (!currentModelId) {
        alert('Por favor, selecione um modelo primeiro');
        return;
    }

    document.getElementById('modalTitle').textContent = 'Adicionar Item de Manuten√ß√£o';
    document.getElementById('itemForm').reset();
    document.getElementById('itemId').value = '';

    // Limpar lista de pe√ßas (novo item ainda n√£o tem pe√ßas)
    const tbody = document.getElementById('itemTbodyPecas');
    const totalElement = document.getElementById('itemTotalPecas');
    if (tbody) {
        tbody.innerHTML = '<tr><td colspan="5" class="px-4 py-6 text-center text-gray-500 italic">Salve o item primeiro para adicionar pe√ßas</td></tr>';
    }
    if (totalElement) {
        totalElement.textContent = 'R$ 0,00';
    }

    // Carregar pe√ßas compat√≠veis com o modelo selecionado
    await carregarPecasDisponiveis(currentModeloNome);

    document.getElementById('itemModal').classList.remove('hidden');
}

// Editar item
async function editarItem(itemId) {
    const item = planItems.find(i => i.id === itemId);
    if (!item) return;

    document.getElementById('modalTitle').textContent = 'Editar Item de Manuten√ß√£o';
    document.getElementById('itemId').value = item.id;
    document.getElementById('itemNome').value = item.descricao_titulo || item.nome || '';
    document.getElementById('itemKm').value = item.km_recomendado || item.intervalo_km || '';
    document.getElementById('itemMeses').value = item.intervalo_tempo || item.intervalo_meses || '';
    document.getElementById('itemCusto').value = item.custo_estimado;
    document.getElementById('itemCriticidade').value = item.criticidade;
    document.getElementById('itemDescricao').value = item.descricao || '';

    // Carregar pe√ßas compat√≠veis com o modelo selecionado
    await carregarPecasDisponiveis(currentModeloNome);

    // Carregar pe√ßas do item
    await carregarPecasItem(itemId);

    document.getElementById('itemModal').classList.remove('hidden');
}

// Fechar modal
function fecharModal() {
    document.getElementById('itemModal').classList.add('hidden');
}

// Sugerir pe√ßas automaticamente baseado no nome do item
async function sugerirPecasAutomaticas(itemId, nomeItem) {
    if (!itemId || !nomeItem) return;

    const nomeLower = nomeItem.toLowerCase();

    // Mapeamento de palavras-chave para categorias
    const mapeamento = {
        '√≥leo': ['√ìleos', '√ìleos e Fluidos', 'Filtros'],
        'oleo': ['√ìleos', '√ìleos e Fluidos', 'Filtros'],
        'filtro': ['Filtros'],
        'freio': ['Freios'],
        'pastilha': ['Freios'],
        'disco': ['Freios'],
        'suspens√£o': ['Suspens√£o', 'Suspens√£o e Dire√ß√£o'],
        'suspensao': ['Suspens√£o', 'Suspens√£o e Dire√ß√£o'],
        'amortecedor': ['Suspens√£o', 'Suspens√£o e Dire√ß√£o'],
        'correia': ['Transmiss√£o', 'Correias e Transmiss√£o'],
        'motor': ['Motor'],
        'vela': ['Motor', 'Sistema El√©trico'],
        'bateria': ['El√©trica', 'Sistema El√©trico'],
        'ar condicionado': ['Outros'],
        'alinhamento': [], // Sem pe√ßas (apenas servi√ßo)
        'balanceamento': [] // Sem pe√ßas (apenas servi√ßo)
    };

    // Detectar categorias relevantes
    const categoriasRelevantes = new Set();
    for (const [palavra, categorias] of Object.entries(mapeamento)) {
        if (nomeLower.includes(palavra)) {
            categorias.forEach(cat => categoriasRelevantes.add(cat));
        }
    }

    if (categoriasRelevantes.size === 0) {
        console.log('‚ÑπÔ∏è Nenhuma categoria detectada para sugest√£o autom√°tica');
        return;
    }

    console.log('ü§ñ Categorias detectadas:', Array.from(categoriasRelevantes));

    // Filtrar pe√ßas dispon√≠veis por categoria
    const pecasSugeridas = pecasDisponiveis.filter(peca => {
        const categoriaPeca = (peca.categoria || '').toLowerCase();
        return Array.from(categoriasRelevantes).some(cat =>
            categoriaPeca.includes(cat.toLowerCase())
        );
    });

    console.log('üí° Pe√ßas sugeridas:', pecasSugeridas.length);

    if (pecasSugeridas.length === 0) {
        console.log('‚ö†Ô∏è Nenhuma pe√ßa encontrada para as categorias detectadas');
        return;
    }

    // Adicionar pe√ßas automaticamente
    let pecasAdicionadas = 0;
    for (const peca of pecasSugeridas) {
        try {
            const response = await fetch(`${API_URL}/plano-pecas-api.php`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    plano_item_id: itemId,
                    peca_id: peca.id,
                    quantidade: 1
                })
            });

            const result = await response.json();
            if (result.success) {
                pecasAdicionadas++;
            }
        } catch (error) {
            console.error('Erro ao adicionar pe√ßa:', error);
        }
    }

    if (pecasAdicionadas > 0) {
        console.log(`‚úÖ ${pecasAdicionadas} pe√ßa(s) adicionada(s) automaticamente`);
        // Recarregar lista de pe√ßas
        await carregarPecasItem(itemId);
    }
}

// Salvar item (form submit)
document.getElementById('itemForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const itemId = document.getElementById('itemId').value;
    const nomeItem = document.getElementById('itemNome').value;
    const data = {
        descricao_titulo: nomeItem,
        km_recomendado: document.getElementById('itemKm').value || null,
        intervalo_tempo: document.getElementById('itemMeses').value || null,
        custo_estimado: parseFloat(document.getElementById('itemCusto').value),
        criticidade: document.getElementById('itemCriticidade').value,
        descricao_observacao: document.getElementById('itemDescricao').value || null
    };

    // Adicionar modelo_carro apenas para POST (criar novo)
    if (!itemId) {
        data.modelo_carro = currentModelName;
    }

    try {
        const url = itemId ? `${API_PLANOS_URL}?id=${itemId}` : API_PLANOS_URL;
        const method = itemId ? 'PUT' : 'POST';

        const response = await fetch(url, {
            method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });

        if (response.ok) {
            const result = await response.json();
            const novoItemId = result.id || itemId;

            // Se for novo item, sugerir pe√ßas automaticamente
            if (!itemId && novoItemId) {
                console.log('ü§ñ Sugerindo pe√ßas automaticamente para:', nomeItem);
                await sugerirPecasAutomaticas(novoItemId, nomeItem);
            }

            alert(`Item ${itemId ? 'atualizado' : 'adicionado'} com sucesso!`);
            fecharModal();
            const modelSelect = document.getElementById('modelSelect');
            const selectedOption = modelSelect.options[modelSelect.selectedIndex];
            const marca = selectedOption.dataset.marca;
            const modelo = selectedOption.dataset.modelo;
            const ano = selectedOption.dataset.ano;
            await carregarPlano(currentModelId, modelo, `${marca} ${modelo} (${ano})`);
        } else {
            throw new Error('Erro ao salvar item');
        }
    } catch (error) {
        console.error('Erro ao salvar item:', error);
        alert('Erro ao salvar item de manuten√ß√£o');
    }
});

// Excluir item
async function excluirItem(itemId) {
    if (!confirm('Deseja realmente excluir este item?')) return;

    try {
        const response = await fetch(`${API_PLANOS_URL}?id=${itemId}`, {
            method: 'DELETE'
        });

        if (response.ok) {
            alert('Item exclu√≠do com sucesso!');
            const modelSelect = document.getElementById('modelSelect');
            const selectedOption = modelSelect.options[modelSelect.selectedIndex];
            const marca = selectedOption.dataset.marca;
            const modelo = selectedOption.dataset.modelo;
            const ano = selectedOption.dataset.ano;
            await carregarPlano(currentModelId, modelo, `${marca} ${modelo} (${ano})`);
        } else {
            throw new Error('Erro ao excluir item');
        }
    } catch (error) {
        console.error('Erro ao excluir item:', error);
        alert('Erro ao excluir item');
    }
}

// ==================== GERENCIAMENTO DE PE√áAS ====================

let pecasDisponiveis = [];

// Formatar moeda
function formatarMoeda(valor) {
    const numero = parseFloat(valor) || 0;
    return new Intl.NumberFormat('pt-BR', {
        style: 'currency',
        currency: 'BRL'
    }).format(numero);
}

// Carregar pe√ßas dispon√≠veis
async function carregarPecasDisponiveis(modeloNome = null) {
    try {
        // Se n√£o passar modelo, usar o modelo global atual
        let modelo = modeloNome || currentModeloNome;

        console.log('üîç Carregando pe√ßas para modelo:', modelo);
        console.log('üìå currentModeloNome:', currentModeloNome);
        console.log('üìå modeloNome passado:', modeloNome);

        if (!modelo) {
            console.warn('‚ö†Ô∏è Nenhum modelo selecionado');
            pecasDisponiveis = [];
            popularSelectPecas();
            return;
        }

        // Extrair apenas o nome do modelo (remover marca e ano)
        // Exemplo: "Chevrolet CELTA (11/12)" -> "CELTA"
        // Exemplo: "Toyota HILUX CD" -> "HILUX CD"
        let modeloLimpo = modelo;

        // Remover ano entre par√™nteses: (11/12), (2020), etc
        modeloLimpo = modeloLimpo.replace(/\s*\([^)]*\)\s*$/g, '').trim();

        // Remover marca (primeira palavra antes do espa√ßo)
        const partes = modeloLimpo.split(' ');
        if (partes.length > 1) {
            // Remove a primeira palavra (marca) e junta o resto (modelo)
            modeloLimpo = partes.slice(1).join(' ');
        }

        console.log('üîß Modelo limpo:', modeloLimpo);

        // Buscar pe√ßas compat√≠veis com o modelo (da API de compatibilidade)
        const url = `${API_URL}/pecas-compatibilidade-api.php?modelo=${encodeURIComponent(modeloLimpo)}`;
        console.log('üåê URL da API:', url);

        const response = await fetch(url);
        const result = await response.json();

        console.log('üì¶ Resposta da API:', result);

        if (result.success && result.data && result.data.length > 0) {
            // Extrair todas as pe√ßas (originais + similares) das compatibilidades
            const pecasMap = new Map();

            result.data.forEach(comp => {
                // Adicionar pe√ßa original
                if (comp.peca_original && comp.peca_original.id) {
                    const peca = comp.peca_original;
                    if (!pecasMap.has(peca.id)) {
                        pecasMap.set(peca.id, {
                            id: peca.id,
                            codigo: peca.codigo,
                            nome: peca.nome,
                            descricao: peca.descricao,
                            categoria: comp.categoria_aplicacao || peca.categoria,
                            custo_unitario: peca.custo_unitario,
                            tipo: 'Original'
                        });
                    }
                }

                // Adicionar pe√ßas similares
                if (comp.pecas_similares && Array.isArray(comp.pecas_similares)) {
                    comp.pecas_similares.forEach(similar => {
                        if (similar.id && !pecasMap.has(similar.id)) {
                            pecasMap.set(similar.id, {
                                id: similar.id,
                                codigo: similar.codigo,
                                nome: similar.nome,
                                descricao: similar.descricao,
                                categoria: comp.categoria_aplicacao || similar.categoria,
                                custo_unitario: similar.custo_unitario,
                                tipo: 'Similar'
                            });
                        }
                    });
                }
            });

            pecasDisponiveis = Array.from(pecasMap.values());
            console.log('‚úÖ Total de pe√ßas carregadas:', pecasDisponiveis.length);
            console.log('üìã Pe√ßas:', pecasDisponiveis);
        } else {
            console.warn('‚ö†Ô∏è Nenhuma compatibilidade encontrada ou resposta vazia');
            pecasDisponiveis = [];
        }

        popularSelectPecas();
        console.log('‚úÖ Select populado com', pecasDisponiveis.length, 'pe√ßas');
    } catch (error) {
        console.error('‚ùå Erro ao carregar pe√ßas:', error);
        pecasDisponiveis = [];
        popularSelectPecas();
    }
}

// Popular select de pe√ßas
function popularSelectPecas() {
    const select = document.getElementById('itemSelectPeca');
    if (!select) return;

    select.innerHTML = '<option value="">Selecione uma pe√ßa para adicionar...</option>';

    // Agrupar por categoria
    const categorias = {};
    pecasDisponiveis.forEach(peca => {
        const cat = peca.categoria || 'Outros';
        if (!categorias[cat]) categorias[cat] = [];
        categorias[cat].push(peca);
    });

    // Criar optgroups por categoria
    Object.keys(categorias).sort().forEach(categoria => {
        const optgroup = document.createElement('optgroup');
        optgroup.label = categoria;

        categorias[categoria].forEach(peca => {
            const option = document.createElement('option');
            option.value = peca.id;
            option.textContent = `${peca.codigo ? peca.codigo + ' - ' : ''}${peca.nome} (${formatarMoeda(peca.custo_unitario)})`;
            optgroup.appendChild(option);
        });

        select.appendChild(optgroup);
    });
}

// Carregar pe√ßas do item
async function carregarPecasItem(itemId) {
    const tbody = document.getElementById('itemTbodyPecas');
    const totalElement = document.getElementById('itemTotalPecas');

    if (!itemId) {
        tbody.innerHTML = '<tr><td colspan="5" class="px-4 py-6 text-center text-gray-500 italic">Salve o item primeiro para adicionar pe√ßas</td></tr>';
        totalElement.textContent = 'R$ 0,00';
        return;
    }

    tbody.innerHTML = '<tr><td colspan="5" class="px-4 py-6 text-center text-gray-500">Carregando...</td></tr>';

    try {
        const response = await fetch(`${API_URL}/plano-pecas-api.php?plano_item_id=${itemId}`);
        const result = await response.json();

        const pecas = result.data || result;
        let custoTotal = 0;

        if (!pecas || pecas.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="px-4 py-6 text-center text-gray-500 italic">Nenhuma pe√ßa adicionada</td></tr>';
            totalElement.textContent = 'R$ 0,00';
            return;
        }

        tbody.innerHTML = '';
        pecas.forEach(peca => {
            const total = (peca.quantidade || 1) * (peca.custo_unitario || 0);
            custoTotal += total;

            const tr = document.createElement('tr');
            tr.className = 'border-b border-gray-200 dark:border-gray-700';
            tr.innerHTML = `
                <td class="px-4 py-3">${peca.nome}</td>
                <td class="px-4 py-3 text-center">${peca.quantidade || 1}</td>
                <td class="px-4 py-3 text-right">${formatarMoeda(peca.custo_unitario || 0)}</td>
                <td class="px-4 py-3 text-right font-medium">${formatarMoeda(total)}</td>
                <td class="px-4 py-3 text-center">
                    <button type="button" class="text-red-500 hover:text-red-700" onclick="removerPecaItem(${peca.id})" title="Remover">
                        <span class="material-symbols-outlined">delete</span>
                    </button>
                </td>
            `;
            tbody.appendChild(tr);
        });

        totalElement.textContent = formatarMoeda(custoTotal);
    } catch (error) {
        console.error('Erro ao carregar pe√ßas do item:', error);
        tbody.innerHTML = '<tr><td colspan="5" class="px-4 py-6 text-center text-red-500">Erro ao carregar pe√ßas</td></tr>';
    }
}

// Adicionar pe√ßa ao item
async function adicionarPecaItem() {
    const itemId = document.getElementById('itemId').value;
    const pecaId = document.getElementById('itemSelectPeca').value;
    const quantidade = parseInt(document.getElementById('itemQuantidadePeca').value) || 1;

    if (!itemId) {
        alert('Salve o item primeiro antes de adicionar pe√ßas');
        return;
    }

    if (!pecaId) {
        alert('Selecione uma pe√ßa');
        return;
    }

    try {
        const response = await fetch(`${API_URL}/plano-pecas-api.php`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                plano_item_id: itemId,
                peca_id: pecaId,
                quantidade: quantidade
            })
        });

        if (response.ok) {
            await carregarPecasItem(itemId);
            document.getElementById('itemSelectPeca').value = '';
            document.getElementById('itemQuantidadePeca').value = '1';
        } else {
            const result = await response.json();
            alert('Erro ao adicionar pe√ßa: ' + (result.error || 'Erro desconhecido'));
        }
    } catch (error) {
        console.error('Erro ao adicionar pe√ßa:', error);
        alert('Erro ao adicionar pe√ßa');
    }
}

// Remover pe√ßa do item
async function removerPecaItem(associacaoId) {
    if (!confirm('Remover esta pe√ßa?')) return;

    try {
        const response = await fetch(`${API_URL}/plano-pecas-api.php?id=${associacaoId}`, {
            method: 'DELETE'
        });

        if (response.ok) {
            const itemId = document.getElementById('itemId').value;
            await carregarPecasItem(itemId);
        } else {
            const result = await response.json();
            alert('Erro: ' + (result.error || 'Erro desconhecido'));
        }
    } catch (error) {
        console.error('Erro ao remover pe√ßa:', error);
        alert('Erro ao remover pe√ßa');
    }
}

// Inicializar eventos ao carregar p√°gina
document.addEventListener('DOMContentLoaded', async () => {
    // Evento do bot√£o de adicionar pe√ßa
    const btnAdicionarPeca = document.getElementById('btnAdicionarPecaItem');
    if (btnAdicionarPeca) {
        btnAdicionarPeca.addEventListener('click', adicionarPecaItem);
    }

    // As pe√ßas ser√£o carregadas dinamicamente ao abrir o modal (filtradas por modelo)
});

// ========== FUN√á√ïES DO SISTEMA DE ABAS E PE√áAS COMPAT√çVEIS ==========

// Vari√°veis globais para pe√ßas compat√≠veis
let modeloAtual = '';
let anoSelecionado = '';

// Alternar entre abas
function switchTab(tabName) {
    // Atualizar bot√µes
    const buttons = document.querySelectorAll('.tab-button');
    buttons.forEach(btn => {
        btn.classList.remove('active', 'border-primary', 'text-primary');
        btn.classList.add('border-transparent', 'text-gray-500');
    });

    const activeBtn = document.getElementById('tab' + tabName.charAt(0).toUpperCase() + tabName.slice(1));
    if (activeBtn) {
        activeBtn.classList.add('active', 'border-primary', 'text-primary');
        activeBtn.classList.remove('border-transparent', 'text-gray-500');
    }

    // Mostrar/esconder conte√∫do
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.add('hidden');
    });
    const contentEl = document.getElementById('content' + tabName.charAt(0).toUpperCase() + tabName.slice(1));
    if (contentEl) {
        contentEl.classList.remove('hidden');
    }

    // Carregar dados da aba se necess√°rio
    if (tabName === 'pecas' && modeloAtual) {
        const selectModelo = document.getElementById('modelSelect');
        const selectedOption = selectModelo.options[selectModelo.selectedIndex];
        if (selectedOption) {
            const modelo = selectedOption.dataset.modelo;
            carregarPecasCompativeis(modelo, anoSelecionado);
        }
    }
}

// Carregar pe√ßas compat√≠veis do modelo
async function carregarPecasCompativeis(modelo, ano = '') {
    if (!modelo) return;

    modeloAtual = modelo;

    document.getElementById('loadingPecas').classList.remove('hidden');
    document.getElementById('pecasContainer').classList.add('hidden');
    document.getElementById('emptyPecas').classList.add('hidden');

    try {
        let url = `https://floripa.in9automacao.com.br/pecas-compatibilidade-api.php?modelo=${encodeURIComponent(modelo)}`;
        if (ano) {
            url += `&ano=${ano}`;
        }

        const response = await fetch(url);
        const data = await response.json();

        document.getElementById('loadingPecas').classList.add('hidden');

        if (data.success && data.data && data.data.length > 0) {
            renderizarPecasCompativeis(data.data);
            popularFiltroAnos(data.data);
        } else {
            mostrarMensagemVazia();
        }
    } catch (error) {
        console.error('Erro ao carregar pe√ßas:', error);
        document.getElementById('loadingPecas').classList.add('hidden');
        mostrarMensagemVazia();
    }
}

// Renderizar pe√ßas agrupadas por categoria
function renderizarPecasCompativeis(pecas) {
    // Agrupar por categoria
    const porCategoria = {};
    pecas.forEach(item => {
        const cat = item.categoria_aplicacao || 'Outros';
        if (!porCategoria[cat]) {
            porCategoria[cat] = [];
        }
        porCategoria[cat].push(item);
    });

    const container = document.getElementById('pecasContainer');
    container.innerHTML = '';

    // Renderizar cada categoria
    Object.keys(porCategoria).sort().forEach(categoria => {
        const categoriaHTML = renderizarCategoria(categoria, porCategoria[categoria]);
        container.innerHTML += categoriaHTML;
    });

    document.getElementById('emptyPecas').classList.add('hidden');
    container.classList.remove('hidden');
}

// Renderizar uma categoria de pe√ßas
function renderizarCategoria(categoria, items) {
    const icones = {
        'Filtros': 'filter_alt',
        '√ìleos': 'oil_barrel',
        'Freios': 'local_parking',
        'Motor': 'settings',
        'Suspens√£o': 'tune',
        'Transmiss√£o': 'settings_applications',
        'El√©trica': 'electrical_services',
        'Outros': 'build'
    };

    let html = `
        <div class="categoria-section mb-6">
            <h3 class="text-lg font-bold mb-4 flex items-center gap-2 text-gray-900 dark:text-white">
                <span class="material-symbols-outlined text-primary">${icones[categoria] || 'build'}</span>
                ${categoria}
            </h3>
    `;

    items.forEach(item => {
        html += renderizarPecaCard(item);
    });

    html += `</div>`;
    return html;
}

// Renderizar card de pe√ßa individual
function renderizarPecaCard(item) {
    const original = item.peca_original;
    const similares = item.pecas_similares || [];

    let html = `
        <div class="peca-card bg-white dark:bg-gray-800/50 rounded-lg shadow-sm p-4 mb-4 border border-gray-200 dark:border-gray-700">
            <div class="grid grid-cols-12 gap-4">
                <!-- Pe√ßa Original -->
                <div class="col-span-12 md:col-span-5 border-r border-gray-200 dark:border-gray-700 pr-4">
                    <div class="flex items-start gap-3">
                        <span class="material-symbols-outlined text-blue-600 text-2xl">verified</span>
                        <div class="flex-1">
                            <p class="font-semibold text-sm text-gray-600 dark:text-gray-400">ORIGINAL</p>
                            <p class="text-xs text-gray-500 dark:text-gray-400">C√≥digo: ${original.codigo}</p>
                            <p class="font-medium text-gray-900 dark:text-white">${original.nome}</p>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Anos: ${item.ano_inicial}${item.ano_final ? '-' + item.ano_final : '+'}</p>
                            <p class="text-lg font-bold text-primary mt-2">
                                R$ ${parseFloat(original.custo_unitario).toFixed(2).replace('.', ',')}
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Pe√ßas Similares -->
                <div class="col-span-12 md:col-span-7">
                    <p class="font-semibold mb-3 flex items-center gap-2 text-gray-900 dark:text-white">
                        <span class="material-symbols-outlined text-green-600">check_circle</span>
                        SIMILARES / COMPAT√çVEIS
                    </p>
    `;

    if (similares.length > 0) {
        html += `<div class="space-y-2">`;
        similares.forEach(similar => {
            const economia = parseFloat(original.custo_unitario) - parseFloat(similar.custo_unitario);
            html += `
                <div class="flex items-center justify-between bg-gray-50 dark:bg-gray-700 rounded p-3">
                    <div class="flex-1">
                        <p class="text-sm text-gray-600 dark:text-gray-400">C√≥digo: ${similar.codigo}</p>
                        <p class="font-medium text-sm text-gray-900 dark:text-white">${similar.nome}</p>
                    </div>
                    <div class="text-right ml-4">
                        <p class="font-bold text-green-600">R$ ${parseFloat(similar.custo_unitario).toFixed(2).replace('.', ',')}</p>
                        ${economia > 0 ? `
                            <span class="text-xs bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300 px-2 py-1 rounded">
                                Economia: R$ ${economia.toFixed(2).replace('.', ',')}
                            </span>
                        ` : ''}
                    </div>
                </div>
            `;
        });
        html += `</div>`;
    } else {
        html += `
            <p class="text-sm text-gray-500 dark:text-gray-400 italic">
                Nenhuma pe√ßa similar cadastrada
            </p>
        `;
    }

    html += `</div></div>`;

    // Observa√ß√µes
    if (item.observacoes) {
        html += `
            <div class="mt-3 pt-3 border-t border-gray-200 dark:border-gray-700">
                <p class="text-sm text-gray-600 dark:text-gray-400">
                    <span class="font-medium">Observa√ß√µes:</span>
                    ${item.observacoes}
                </p>
            </div>
        `;
    }

    html += `</div>`;
    return html;
}

// Popular filtro de anos
function popularFiltroAnos(pecas) {
    const anos = new Set();
    pecas.forEach(item => {
        const anoFinal = item.ano_final || new Date().getFullYear();
        for (let ano = item.ano_inicial; ano <= anoFinal; ano++) {
            anos.add(ano);
        }
    });

    const select = document.getElementById('filtroAno');
    if (!select) return;

    select.innerHTML = '<option value="">Todos os anos</option>';

    Array.from(anos).sort().reverse().forEach(ano => {
        const option = document.createElement('option');
        option.value = ano;
        option.textContent = ano;
        select.appendChild(option);
    });
}

// Filtrar por ano
function filtrarPecasPorAno() {
    const ano = document.getElementById('filtroAno').value;
    anoSelecionado = ano;
    carregarPecasCompativeis(modeloAtual, ano);
}

// Mensagem vazia
function mostrarMensagemVazia() {
    document.getElementById('pecasContainer').classList.add('hidden');
    document.getElementById('emptyPecas').classList.remove('hidden');
}
</script>

<!-- Carregar Sidebar Unificado -->
<script src="auth.js" defer></script>
<script src="sidebar.js?v=20260113-FIX-ZINDEX"></script>

</body>
</html>
