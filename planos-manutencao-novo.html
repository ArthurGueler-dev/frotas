<!DOCTYPE html>
<html class="light" lang="pt-BR">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Planos de Manuten√ß√£o - FleetFlow</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#1E3A8A",
                        "background-light": "#F3F4F6",
                        "background-dark": "#1F2937",
                    },
                    fontFamily: {
                        "display": ["Inter", "sans-serif"]
                    },
                },
            },
        }
    </script>
    <style>
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark font-display text-gray-800 dark:text-gray-200">
<div class="flex h-screen">
    <!-- Sidebar Container -->
    <div id="sidebar-container" data-page="planos"></div>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto">
        <div class="w-full mx-auto px-4 sm:px-6 lg:px-8 py-8" style="max-width: 1400px;">
            <!-- PageHeading -->
            <div class="flex flex-wrap justify-between items-center gap-4 mb-8">
                <h1 class="text-gray-900 dark:text-white text-3xl md:text-4xl font-black tracking-tighter">Planos de Manuten√ß√£o</h1>
            </div>

            <!-- Selection Section -->
            <section class="bg-white dark:bg-gray-800/50 p-6 rounded-xl border border-gray-200 dark:border-gray-700">
                <h2 class="text-gray-900 dark:text-white text-xl font-bold tracking-tight mb-4">Sele√ß√£o de Modelo</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 items-end">
                    <div class="md:col-span-2">
                        <label class="flex flex-col w-full">
                            <p class="text-sm font-medium pb-2 text-gray-700 dark:text-gray-300">Selecione o modelo do ve√≠culo</p>
                            <select id="modelSelect" class="form-select flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-gray-900 dark:text-white focus:outline-0 focus:ring-2 focus:ring-primary/50 border-gray-300 dark:border-gray-600 bg-background-light dark:bg-gray-700 focus:border-primary dark:focus:border-primary h-12 placeholder:text-gray-400 dark:placeholder:text-gray-500 px-4 text-base font-normal">
                                <option value="">‚è≥ Carregando modelos...</option>
                            </select>
                        </label>
                    </div>
                    <div class="flex items-center gap-4 justify-start md:justify-end">
                        <span id="planStatus" class="hidden inline-flex items-center rounded-full px-3 py-1 text-sm font-semibold"></span>
                    </div>
                </div>
            </section>

            <!-- Plan Area -->
            <section id="planSection" class="mt-8 hidden">
                <!-- Section Header -->
                <div class="flex flex-wrap justify-between items-center gap-4 mb-4">
                    <div>
                        <h2 id="planTitle" class="text-gray-900 dark:text-white text-2xl font-bold tracking-tight">Plano para...</h2>
                        <p id="planCount" class="text-gray-500 dark:text-gray-400">0 itens cadastrados</p>
                    </div>
                    <button onclick="adicionarItem()" class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-12 px-5 bg-primary text-white gap-2 text-sm font-bold tracking-wide hover:bg-primary/90">
                        <span class="material-symbols-outlined text-lg">add_circle</span>
                        <span class="truncate">Adicionar Item</span>
                    </button>
                </div>

                <!-- Item List -->
                <div id="itemsList" class="flex flex-col gap-3">
                    <!-- Items will be dynamically inserted here -->
                </div>

                <!-- Empty State -->
                <div id="emptyState" class="text-center bg-white dark:bg-gray-800/50 border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-xl p-12">
                    <span class="material-symbols-outlined text-5xl text-gray-400 dark:text-gray-500">assignment</span>
                    <h3 class="mt-4 text-xl font-bold text-gray-900 dark:text-white">Este plano ainda est√° vazio</h3>
                    <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Comece adicionando um item de manuten√ß√£o preventiva.</p>
                    <button onclick="adicionarItem()" class="mt-6 flex min-w-[84px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-4 bg-primary text-white gap-2 text-sm font-bold tracking-wide mx-auto">
                        <span class="material-symbols-outlined text-lg">add</span>
                        <span class="truncate">Come√ßar Agora</span>
                    </button>
                </div>
            </section>
        </div>
    </main>
</div>

<!-- Modal Adicionar/Editar Item -->
<div id="itemModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
        <div class="sticky top-0 bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 p-6 flex justify-between items-center">
            <h3 id="modalTitle" class="text-2xl font-bold text-gray-900 dark:text-white">Adicionar Item de Manuten√ß√£o</h3>
            <button onclick="fecharModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200">
                <span class="material-symbols-outlined text-3xl">close</span>
            </button>
        </div>

        <form id="itemForm" class="p-6 space-y-6">
            <input type="hidden" id="itemId"/>

            <!-- Basic Info -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="col-span-2">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        Nome do Item de Manuten√ß√£o <span class="text-red-500">*</span>
                    </label>
                    <input type="text" id="itemNome" required class="w-full rounded-lg border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white h-12 px-4"/>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        Intervalo KM
                    </label>
                    <input type="number" id="itemKm" placeholder="Ex: 10000" class="w-full rounded-lg border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white h-12 px-4"/>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        Intervalo Meses
                    </label>
                    <input type="number" id="itemMeses" placeholder="Ex: 6" class="w-full rounded-lg border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white h-12 px-4"/>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        Custo Estimado (R$) <span class="text-red-500">*</span>
                    </label>
                    <input type="number" id="itemCusto" required step="0.01" placeholder="Ex: 850.00" class="w-full rounded-lg border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white h-12 px-4"/>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        Criticidade <span class="text-red-500">*</span>
                    </label>
                    <select id="itemCriticidade" required class="w-full rounded-lg border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white h-12 px-4">
                        <option value="alta">Alta</option>
                        <option value="media">M√©dia</option>
                        <option value="baixa">Baixa</option>
                    </select>
                </div>

                <div class="col-span-2">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        Descri√ß√£o/Observa√ß√µes
                    </label>
                    <textarea id="itemDescricao" rows="3" placeholder="Detalhes sobre o servi√ßo de manuten√ß√£o..." class="w-full rounded-lg border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white px-4 py-2"></textarea>
                </div>
            </div>

            <!-- Se√ß√£o de Pe√ßas -->
            <div class="border-t border-gray-200 dark:border-gray-700 pt-6">
                <h4 class="text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
                    <span class="material-symbols-outlined">build</span>
                    Pe√ßas Necess√°rias
                </h4>

                <!-- Adicionar pe√ßa -->
                <div class="grid grid-cols-1 md:grid-cols-12 gap-3 mb-4">
                    <div class="md:col-span-6">
                        <select id="itemSelectPeca" class="w-full h-12 px-4 rounded-lg border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                            <option value="">Selecione uma pe√ßa para adicionar...</option>
                        </select>
                    </div>
                    <div class="md:col-span-3">
                        <input id="itemQuantidadePeca" type="number" min="1" value="1" placeholder="Qtd" class="w-full h-12 px-4 rounded-lg border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white" />
                    </div>
                    <div class="md:col-span-3">
                        <button type="button" id="btnAdicionarPecaItem" class="w-full h-12 px-4 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 flex items-center justify-center gap-2">
                            <span class="material-symbols-outlined">add</span>
                            Adicionar
                        </button>
                    </div>
                </div>

                <!-- Lista de pe√ßas -->
                <div id="itemListaPecas" class="border rounded-lg border-gray-200 dark:border-gray-700 overflow-hidden">
                    <table class="w-full text-sm text-left">
                        <thead class="text-xs text-gray-700 dark:text-gray-300 uppercase bg-gray-100 dark:bg-gray-700">
                            <tr>
                                <th class="px-4 py-3">Pe√ßa</th>
                                <th class="px-4 py-3 text-center">Qtd</th>
                                <th class="px-4 py-3 text-right">Custo Unit.</th>
                                <th class="px-4 py-3 text-right">Total</th>
                                <th class="px-4 py-3 text-center w-12"></th>
                            </tr>
                        </thead>
                        <tbody id="itemTbodyPecas">
                            <tr><td colspan="5" class="px-4 py-6 text-center text-gray-500 italic">Nenhuma pe√ßa adicionada</td></tr>
                        </tbody>
                    </table>
                </div>
                <div class="flex justify-between items-center mt-3">
                    <span class="text-sm text-gray-500 dark:text-gray-400">Total em pe√ßas:</span>
                    <span id="itemTotalPecas" class="text-lg font-bold text-primary">R$ 0,00</span>
                </div>
            </div>

            <div class="flex justify-end gap-3 pt-4 border-t border-gray-200 dark:border-gray-700">
                <button type="button" onclick="fecharModal()" class="px-6 py-2 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-lg font-medium hover:bg-gray-300 dark:hover:bg-gray-600">
                    Cancelar
                </button>
                <button type="submit" class="px-6 py-2 bg-primary text-white rounded-lg font-medium hover:bg-primary/90">
                    Salvar Item
                </button>
            </div>
        </form>
    </div>
</div>

<script>
const API_URL = '/api';
const API_PLANOS_URL = 'https://floripa.in9automacao.com.br/planos-manutencao-api.php';
let currentModelId = null;
let currentModeloNome = null;
let planItems = [];
let expandedItems = new Set();

// Carregar modelos ao iniciar
document.addEventListener('DOMContentLoaded', async () => {
    await carregarModelos();
});

// Carregar modelos
async function carregarModelos() {
    try {
        const response = await fetch(`${API_URL}/modelos`);
        const modelos = await response.json();

        const select = document.getElementById('modelSelect');
        select.innerHTML = '<option value="" disabled selected>Selecione um modelo...</option>';

        modelos.forEach(modelo => {
            const option = document.createElement('option');
            option.value = modelo.id;
            const tipoIcon = {
                'Passeio': 'üöó',
                'Utilit√°rio': 'üöê',
                'Caminhonete': 'üõª',
                'Caminh√£o': 'üöö',
                'SUV': 'üöô'
            }[modelo.tipo] || 'üöó';
            option.textContent = `${tipoIcon} ${modelo.marca} ${modelo.modelo} (${modelo.ano}) - ${modelo.tipo}`;
            option.dataset.marca = modelo.marca;
            option.dataset.modelo = modelo.modelo;
            option.dataset.ano = modelo.ano;
            select.appendChild(option);
        });

        select.addEventListener('change', (e) => {
            const modeloId = e.target.value;
            if (modeloId) {
                currentModelId = modeloId;
                const selectedOption = e.target.options[e.target.selectedIndex];
                const marca = selectedOption.dataset.marca;
                const modelo = selectedOption.dataset.modelo;
                const ano = selectedOption.dataset.ano;
                carregarPlano(modeloId, `${marca} ${modelo} (${ano})`);
            }
        });
    } catch (error) {
        console.error('Erro ao carregar modelos:', error);
        alert('Erro ao carregar modelos');
    }
}

// Carregar plano do modelo
async function carregarPlano(modeloId, modeloNome) {
    try {
        currentModeloNome = modeloNome;

        // Buscar da API local primeiro
        const response = await fetch(`${API_URL}/maintenance-plan-items?modelo_id=${modeloId}`);
        planItems = await response.json();
        expandedItems.clear();

        document.getElementById('planSection').classList.remove('hidden');
        document.getElementById('planTitle').textContent = `Plano para ${modeloNome}`;
        document.getElementById('planCount').textContent = `${planItems.length} ${planItems.length === 1 ? 'item cadastrado' : 'itens cadastrados'}`;

        const statusBadge = document.getElementById('planStatus');
        if (planItems.length > 0) {
            statusBadge.className = 'inline-flex items-center rounded-full bg-green-100 dark:bg-green-900/50 px-3 py-1 text-sm font-semibold text-green-800 dark:text-green-300';
            statusBadge.textContent = 'Com Plano';
            statusBadge.classList.remove('hidden');
        } else {
            statusBadge.className = 'inline-flex items-center rounded-full bg-gray-100 dark:bg-gray-700 px-3 py-1 text-sm font-semibold text-gray-600 dark:text-gray-300';
            statusBadge.textContent = 'Sem Plano';
            statusBadge.classList.remove('hidden');
        }

        renderizarItens();
    } catch (error) {
        console.error('Erro ao carregar plano:', error);
        alert('Erro ao carregar plano de manuten√ß√£o');
    }
}

// Toggle expand item
function toggleExpand(itemId) {
    if (expandedItems.has(itemId)) {
        expandedItems.delete(itemId);
    } else {
        expandedItems.add(itemId);
    }
    renderizarItens();

    // Se est√° expandindo, carregar as pe√ßas ap√≥s renderizar
    if (expandedItems.has(itemId)) {
        setTimeout(() => carregarPecasExpandido(itemId), 0);
    }
}

// Carregar e renderizar pe√ßas na view expandida
async function carregarPecasExpandido(itemId) {
    const container = document.getElementById(`pecas-item-${itemId}`);
    if (!container) return;

    try {
        const response = await fetch(`${API_URL}/plano-pecas/${itemId}`);
        const result = await response.json();

        const pecas = result.data || result;

        if (!pecas || pecas.length === 0) {
            container.innerHTML = '<p class="text-gray-500 dark:text-gray-400 italic">Nenhuma pe√ßa cadastrada para este item</p>';
            return;
        }

        let custoTotal = 0;
        let html = '<div class="grid gap-3">';

        pecas.forEach(peca => {
            const total = (peca.quantidade || 1) * (peca.custo_unitario || 0);
            custoTotal += total;

            html += `
                <div class="flex items-center justify-between p-3 bg-white dark:bg-gray-700/50 rounded-lg border border-gray-100 dark:border-gray-600">
                    <div class="flex-1">
                        <p class="font-medium text-gray-800 dark:text-gray-200">${peca.nome}</p>
                        <p class="text-xs text-gray-500 dark:text-gray-400">
                            ${peca.codigo ? `C√≥digo: ${peca.codigo} ‚Ä¢ ` : ''}
                            Qtd: ${peca.quantidade || 1} ${peca.unidade || 'un'}
                            ${peca.vida_util_km ? ` ‚Ä¢ Vida √∫til: ${Number(peca.vida_util_km).toLocaleString('pt-BR')} km` : ''}
                            ${peca.vida_util_meses ? ` ‚Ä¢ ${peca.vida_util_meses} meses` : ''}
                        </p>
                    </div>
                    <div class="text-right">
                        <p class="font-semibold text-gray-800 dark:text-gray-200">${formatarMoeda(total)}</p>
                        <p class="text-xs text-gray-500 dark:text-gray-400">${formatarMoeda(peca.custo_unitario || 0)}/un</p>
                    </div>
                </div>
            `;
        });

        html += '</div>';
        html += `
            <div class="mt-3 pt-3 border-t border-gray-200 dark:border-gray-600 flex justify-between items-center">
                <span class="text-sm font-medium text-gray-600 dark:text-gray-400">Total em Pe√ßas:</span>
                <span class="text-lg font-bold text-primary">${formatarMoeda(custoTotal)}</span>
            </div>
        `;

        container.innerHTML = html;
    } catch (error) {
        console.error('Erro ao carregar pe√ßas expandidas:', error);
        container.innerHTML = '<p class="text-red-500 italic">Erro ao carregar pe√ßas</p>';
    }
}

// Renderizar itens
function renderizarItens() {
    const container = document.getElementById('itemsList');
    const emptyState = document.getElementById('emptyState');

    if (planItems.length === 0) {
        container.classList.add('hidden');
        emptyState.classList.remove('hidden');
        return;
    }

    container.classList.remove('hidden');
    emptyState.classList.add('hidden');

    container.innerHTML = planItems.map(item => {
        const isExpanded = expandedItems.has(item.id);

        const criticidadeClass = {
            'alta': 'bg-red-100 dark:bg-red-900/50 text-red-800 dark:text-red-300',
            'media': 'bg-orange-100 dark:bg-orange-900/50 text-orange-800 dark:text-orange-300',
            'baixa': 'bg-green-100 dark:bg-green-900/50 text-green-800 dark:text-green-300'
        }[item.criticidade] || 'bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-300';

        const criticidadeLabel = {
            'alta': 'Alta Criticidade',
            'media': 'M√©dia Criticidade',
            'baixa': 'Baixa Criticidade'
        }[item.criticidade] || 'Criticidade';

        const borderClass = isExpanded ? 'border-primary/50 dark:border-primary/50 ring-2 ring-primary/20' : 'border-gray-200 dark:border-gray-700';
        const expandIcon = isExpanded ? 'expand_less' : 'expand_more';
        const expandBtnClass = isExpanded ? 'bg-primary/10 text-primary' : 'bg-gray-100 dark:bg-gray-700/50 text-gray-600 dark:text-gray-300';

        return `
            <div class="bg-white dark:bg-gray-800/50 border ${borderClass} rounded-xl overflow-hidden">
                <div class="p-4 flex flex-col md:flex-row items-start md:items-center gap-4 ${isExpanded ? 'border-b border-gray-200 dark:border-gray-700' : ''}">
                    <div class="flex-1">
                        <p class="font-bold text-lg text-gray-900 dark:text-white">${item.nome}</p>
                        <div class="flex flex-wrap items-center gap-x-6 gap-y-2 mt-2 text-sm text-gray-600 dark:text-gray-300">
                            ${item.intervalo_km ? `<div class="flex items-center gap-2"><span class="material-symbols-outlined text-base">speed</span> <span>${Number(item.intervalo_km).toLocaleString('pt-BR')} KM</span></div>` : ''}
                            ${item.intervalo_meses ? `<div class="flex items-center gap-2"><span class="material-symbols-outlined text-base">calendar_month</span> <span>${item.intervalo_meses} ${item.intervalo_meses === 1 ? 'M√™s' : 'Meses'}</span></div>` : ''}
                            <div class="flex items-center gap-2"><span class="material-symbols-outlined text-base">payments</span> <span>Custo: R$ ${Number(item.custo_estimado).toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span></div>
                        </div>
                    </div>
                    <div class="flex items-center gap-3 w-full md:w-auto justify-end">
                        <span class="inline-flex items-center rounded-full ${criticidadeClass} px-3 py-1 text-sm font-semibold">${criticidadeLabel}</span>
                        <button onclick="editarItem(${item.id})" class="flex h-10 w-10 cursor-pointer items-center justify-center rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-500 dark:text-gray-400">
                            <span class="material-symbols-outlined">edit</span>
                        </button>
                        <button onclick="excluirItem(${item.id})" class="flex h-10 w-10 cursor-pointer items-center justify-center rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-500 dark:text-gray-400">
                            <span class="material-symbols-outlined">delete</span>
                        </button>
                        <button onclick="toggleExpand(${item.id})" class="flex h-10 w-10 cursor-pointer items-center justify-center rounded-lg ${expandBtnClass}">
                            <span class="material-symbols-outlined">${expandIcon}</span>
                        </button>
                    </div>
                </div>
                ${isExpanded ? `
                <div class="p-6 bg-background-light dark:bg-gray-800">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 text-sm">
                        ${item.intervalo_km ? `<div><p class="font-medium text-gray-500 dark:text-gray-400">Intervalo KM</p><p class="font-semibold text-gray-800 dark:text-gray-200">${Number(item.intervalo_km).toLocaleString('pt-BR')} KM</p></div>` : ''}
                        ${item.intervalo_meses ? `<div><p class="font-medium text-gray-500 dark:text-gray-400">Intervalo Tempo</p><p class="font-semibold text-gray-800 dark:text-gray-200">${item.intervalo_meses} ${item.intervalo_meses === 1 ? 'M√™s' : 'Meses'}</p></div>` : ''}
                        <div><p class="font-medium text-gray-500 dark:text-gray-400">Custo Estimado</p><p class="font-semibold text-gray-800 dark:text-gray-200">R$ ${Number(item.custo_estimado).toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p></div>
                        <div><p class="font-medium text-gray-500 dark:text-gray-400">Criticidade</p><p class="font-semibold text-gray-800 dark:text-gray-200">${criticidadeLabel}</p></div>
                        ${item.descricao ? `<div class="col-span-1 md:col-span-2 lg:col-span-4"><p class="font-medium text-gray-500 dark:text-gray-400">Descri√ß√£o</p><p class="text-gray-800 dark:text-gray-200">${item.descricao}</p></div>` : ''}
                    </div>

                    <!-- Se√ß√£o de Pe√ßas do Item -->
                    <div class="mt-6 pt-6 border-t border-gray-200 dark:border-gray-700">
                        <h4 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-3 flex items-center gap-2">
                            <span class="material-symbols-outlined text-base">build</span>
                            Pe√ßas Necess√°rias
                        </h4>
                        <div id="pecas-item-${item.id}" class="text-sm">
                            <p class="text-gray-500 italic">Carregando pe√ßas...</p>
                        </div>
                    </div>
                </div>
                ` : ''}
            </div>
        `;
    }).join('');
}

// Adicionar item
function adicionarItem() {
    if (!currentModelId) {
        alert('Por favor, selecione um modelo primeiro');
        return;
    }

    document.getElementById('modalTitle').textContent = 'Adicionar Item de Manuten√ß√£o';
    document.getElementById('itemForm').reset();
    document.getElementById('itemId').value = '';

    // Limpar lista de pe√ßas (novo item ainda n√£o tem pe√ßas)
    const tbody = document.getElementById('itemTbodyPecas');
    const totalElement = document.getElementById('itemTotalPecas');
    if (tbody) {
        tbody.innerHTML = '<tr><td colspan="5" class="px-4 py-6 text-center text-gray-500 italic">Salve o item primeiro para adicionar pe√ßas</td></tr>';
    }
    if (totalElement) {
        totalElement.textContent = 'R$ 0,00';
    }

    document.getElementById('itemModal').classList.remove('hidden');
}

// Editar item
async function editarItem(itemId) {
    const item = planItems.find(i => i.id === itemId);
    if (!item) return;

    document.getElementById('modalTitle').textContent = 'Editar Item de Manuten√ß√£o';
    document.getElementById('itemId').value = item.id;
    document.getElementById('itemNome').value = item.nome;
    document.getElementById('itemKm').value = item.intervalo_km || '';
    document.getElementById('itemMeses').value = item.intervalo_meses || '';
    document.getElementById('itemCusto').value = item.custo_estimado;
    document.getElementById('itemCriticidade').value = item.criticidade;
    document.getElementById('itemDescricao').value = item.descricao || '';

    // Carregar pe√ßas do item
    await carregarPecasItem(itemId);

    document.getElementById('itemModal').classList.remove('hidden');
}

// Fechar modal
function fecharModal() {
    document.getElementById('itemModal').classList.add('hidden');
}

// Salvar item (form submit)
document.getElementById('itemForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const itemId = document.getElementById('itemId').value;
    const data = {
        modelo_id: currentModelId,
        nome: document.getElementById('itemNome').value,
        intervalo_km: document.getElementById('itemKm').value || null,
        intervalo_meses: document.getElementById('itemMeses').value || null,
        custo_estimado: parseFloat(document.getElementById('itemCusto').value),
        criticidade: document.getElementById('itemCriticidade').value,
        descricao: document.getElementById('itemDescricao').value || null
    };

    try {
        const url = itemId ? `${API_URL}/maintenance-plan-items/${itemId}` : `${API_URL}/maintenance-plan-items`;
        const method = itemId ? 'PUT' : 'POST';

        const response = await fetch(url, {
            method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });

        if (response.ok) {
            alert(`Item ${itemId ? 'atualizado' : 'adicionado'} com sucesso!`);
            fecharModal();
            const modelSelect = document.getElementById('modelSelect');
            const selectedOption = modelSelect.options[modelSelect.selectedIndex];
            const marca = selectedOption.dataset.marca;
            const modelo = selectedOption.dataset.modelo;
            const ano = selectedOption.dataset.ano;
            await carregarPlano(currentModelId, `${marca} ${modelo} (${ano})`);
        } else {
            throw new Error('Erro ao salvar item');
        }
    } catch (error) {
        console.error('Erro ao salvar item:', error);
        alert('Erro ao salvar item de manuten√ß√£o');
    }
});

// Excluir item
async function excluirItem(itemId) {
    if (!confirm('Deseja realmente excluir este item?')) return;

    try {
        const response = await fetch(`${API_URL}/maintenance-plan-items/${itemId}`, {
            method: 'DELETE'
        });

        if (response.ok) {
            alert('Item exclu√≠do com sucesso!');
            const modelSelect = document.getElementById('modelSelect');
            const selectedOption = modelSelect.options[modelSelect.selectedIndex];
            const marca = selectedOption.dataset.marca;
            const modelo = selectedOption.dataset.modelo;
            const ano = selectedOption.dataset.ano;
            await carregarPlano(currentModelId, `${marca} ${modelo} (${ano})`);
        } else {
            throw new Error('Erro ao excluir item');
        }
    } catch (error) {
        console.error('Erro ao excluir item:', error);
        alert('Erro ao excluir item');
    }
}

// ==================== GERENCIAMENTO DE PE√áAS ====================

let pecasDisponiveis = [];

// Formatar moeda
function formatarMoeda(valor) {
    const numero = parseFloat(valor) || 0;
    return new Intl.NumberFormat('pt-BR', {
        style: 'currency',
        currency: 'BRL'
    }).format(numero);
}

// Carregar pe√ßas dispon√≠veis
async function carregarPecasDisponiveis() {
    try {
        const response = await fetch(`${API_URL}/pecas`);
        const result = await response.json();
        pecasDisponiveis = Array.isArray(result) ? result : (result.data || []);
        popularSelectPecas();
    } catch (error) {
        console.error('Erro ao carregar pe√ßas:', error);
    }
}

// Popular select de pe√ßas
function popularSelectPecas() {
    const select = document.getElementById('itemSelectPeca');
    if (!select) return;

    select.innerHTML = '<option value="">Selecione uma pe√ßa para adicionar...</option>';

    // Agrupar por categoria
    const categorias = {};
    pecasDisponiveis.forEach(peca => {
        const cat = peca.categoria || 'Outros';
        if (!categorias[cat]) categorias[cat] = [];
        categorias[cat].push(peca);
    });

    // Criar optgroups por categoria
    Object.keys(categorias).sort().forEach(categoria => {
        const optgroup = document.createElement('optgroup');
        optgroup.label = categoria;

        categorias[categoria].forEach(peca => {
            const option = document.createElement('option');
            option.value = peca.id;
            option.textContent = `${peca.codigo ? peca.codigo + ' - ' : ''}${peca.nome} (${formatarMoeda(peca.custo_unitario)})`;
            optgroup.appendChild(option);
        });

        select.appendChild(optgroup);
    });
}

// Carregar pe√ßas do item
async function carregarPecasItem(itemId) {
    const tbody = document.getElementById('itemTbodyPecas');
    const totalElement = document.getElementById('itemTotalPecas');

    if (!itemId) {
        tbody.innerHTML = '<tr><td colspan="5" class="px-4 py-6 text-center text-gray-500 italic">Salve o item primeiro para adicionar pe√ßas</td></tr>';
        totalElement.textContent = 'R$ 0,00';
        return;
    }

    tbody.innerHTML = '<tr><td colspan="5" class="px-4 py-6 text-center text-gray-500">Carregando...</td></tr>';

    try {
        const response = await fetch(`${API_URL}/plano-pecas/${itemId}`);
        const result = await response.json();

        const pecas = result.data || result;
        let custoTotal = 0;

        if (!pecas || pecas.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="px-4 py-6 text-center text-gray-500 italic">Nenhuma pe√ßa adicionada</td></tr>';
            totalElement.textContent = 'R$ 0,00';
            return;
        }

        tbody.innerHTML = '';
        pecas.forEach(peca => {
            const total = (peca.quantidade || 1) * (peca.custo_unitario || 0);
            custoTotal += total;

            const tr = document.createElement('tr');
            tr.className = 'border-b border-gray-200 dark:border-gray-700';
            tr.innerHTML = `
                <td class="px-4 py-3">${peca.nome}</td>
                <td class="px-4 py-3 text-center">${peca.quantidade || 1}</td>
                <td class="px-4 py-3 text-right">${formatarMoeda(peca.custo_unitario || 0)}</td>
                <td class="px-4 py-3 text-right font-medium">${formatarMoeda(total)}</td>
                <td class="px-4 py-3 text-center">
                    <button type="button" class="text-red-500 hover:text-red-700" onclick="removerPecaItem(${peca.id})" title="Remover">
                        <span class="material-symbols-outlined">delete</span>
                    </button>
                </td>
            `;
            tbody.appendChild(tr);
        });

        totalElement.textContent = formatarMoeda(custoTotal);
    } catch (error) {
        console.error('Erro ao carregar pe√ßas do item:', error);
        tbody.innerHTML = '<tr><td colspan="5" class="px-4 py-6 text-center text-red-500">Erro ao carregar pe√ßas</td></tr>';
    }
}

// Adicionar pe√ßa ao item
async function adicionarPecaItem() {
    const itemId = document.getElementById('itemId').value;
    const pecaId = document.getElementById('itemSelectPeca').value;
    const quantidade = parseInt(document.getElementById('itemQuantidadePeca').value) || 1;

    if (!itemId) {
        alert('Salve o item primeiro antes de adicionar pe√ßas');
        return;
    }

    if (!pecaId) {
        alert('Selecione uma pe√ßa');
        return;
    }

    try {
        const response = await fetch(`${API_URL}/plano-pecas`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                plano_item_id: itemId,
                peca_id: pecaId,
                quantidade: quantidade
            })
        });

        if (response.ok) {
            await carregarPecasItem(itemId);
            document.getElementById('itemSelectPeca').value = '';
            document.getElementById('itemQuantidadePeca').value = '1';
        } else {
            const result = await response.json();
            alert('Erro ao adicionar pe√ßa: ' + (result.error || 'Erro desconhecido'));
        }
    } catch (error) {
        console.error('Erro ao adicionar pe√ßa:', error);
        alert('Erro ao adicionar pe√ßa');
    }
}

// Remover pe√ßa do item
async function removerPecaItem(associacaoId) {
    if (!confirm('Remover esta pe√ßa?')) return;

    try {
        const response = await fetch(`${API_URL}/plano-pecas/${associacaoId}`, {
            method: 'DELETE'
        });

        if (response.ok) {
            const itemId = document.getElementById('itemId').value;
            await carregarPecasItem(itemId);
        } else {
            const result = await response.json();
            alert('Erro: ' + (result.error || 'Erro desconhecido'));
        }
    } catch (error) {
        console.error('Erro ao remover pe√ßa:', error);
        alert('Erro ao remover pe√ßa');
    }
}

// Inicializar pe√ßas ao carregar p√°gina
document.addEventListener('DOMContentLoaded', async () => {
    await carregarPecasDisponiveis();

    // Evento do bot√£o de adicionar pe√ßa
    const btnAdicionarPeca = document.getElementById('btnAdicionarPecaItem');
    if (btnAdicionarPeca) {
        btnAdicionarPeca.addEventListener('click', adicionarPecaItem);
    }
});
</script>

<!-- Carregar Sidebar Unificado -->
<script src="sidebar.js"></script>

</body>
</html>
