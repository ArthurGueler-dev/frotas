<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Central de Manutenção Preventiva</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" rel="stylesheet"/>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#1173d4",
                        "background-light": "#f6f7f8",
                        "background-dark": "#101922",
                    },
                    fontFamily: {
                        "display": ["Inter"]
                    }
                },
            },
        }
    </script>
    <style>
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }
        .loading-spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .tab-active { border-bottom: 3px solid #1173d4; color: #1173d4; font-weight: 600; }
        .tab-inactive { border-bottom: 3px solid transparent; color: #6b7280; }
        .tab-inactive:hover { color: #1173d4; background: #f3f4f6; }
        .urgency-critical { animation: pulse-critical 2s infinite; }
        @keyframes pulse-critical {
            0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
            50% { box-shadow: 0 0 0 8px rgba(239, 68, 68, 0); }
        }
        .filter-section { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
        .filter-section.open { max-height: 500px; }
        .card-stat:hover { transform: translateY(-2px); }
        .progress-bar { transition: width 0.5s ease-in-out; }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark font-display text-[#333333] dark:text-white">
<div class="relative flex h-auto min-h-screen w-full flex-col">
<div class="flex h-full grow flex-row">

<!-- Sidebar Container -->
<div id="sidebar-container" data-page="alertas"></div>

<main class="flex-1 p-4 lg:p-6 overflow-y-auto bg-background-light dark:bg-gray-900 ml-64">
<div class="max-w-[1600px] mx-auto">

    <!-- Page Header -->
    <div class="flex flex-wrap justify-between gap-4 mb-6 items-center">
        <div class="flex flex-col gap-1">
            <div class="flex items-center gap-3">
                <div class="p-2 bg-primary/10 rounded-lg">
                    <span class="material-symbols-outlined text-primary text-3xl">engineering</span>
                </div>
                <div>
                    <h1 class="text-[#18181B] dark:text-white text-2xl lg:text-3xl font-bold">
                        Central de Manutenção Preventiva
                    </h1>
                    <p id="data-atual" class="text-[#617589] dark:text-gray-400 text-sm"></p>
                </div>
            </div>
        </div>
        <div class="flex gap-2 flex-wrap">
            <button onclick="toggleFiltros()" id="btn-toggle-filtros"
                    class="flex items-center gap-2 px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                <span class="material-symbols-outlined text-xl">filter_list</span>
                <span class="hidden sm:inline">Filtros</span>
                <span id="filtros-badge" class="hidden bg-primary text-white text-xs px-1.5 py-0.5 rounded-full">0</span>
            </button>
            <button onclick="gerarAlertas()" id="btn-gerar-alertas"
                    class="flex items-center gap-2 px-4 py-2 rounded-lg bg-green-600 hover:bg-green-700 text-white transition-colors">
                <span class="material-symbols-outlined text-xl">autorenew</span>
                <span class="hidden sm:inline">Gerar Alertas</span>
            </button>
            <button onclick="exportarDados()"
                    class="flex items-center gap-2 px-4 py-2 rounded-lg bg-gray-600 hover:bg-gray-700 text-white transition-colors">
                <span class="material-symbols-outlined text-xl">download</span>
                <span class="hidden sm:inline">Exportar</span>
            </button>
        </div>
    </div>

    <!-- Tabs Navigation -->
    <div class="bg-white dark:bg-slate-800 rounded-t-xl border-b dark:border-slate-700 mb-0">
        <nav class="flex overflow-x-auto" aria-label="Tabs">
            <button onclick="mudarAba('todos')" id="tab-todos"
                    class="tab-active flex items-center gap-2 px-6 py-4 text-sm font-medium whitespace-nowrap transition-colors">
                <span class="material-symbols-outlined text-xl">list_alt</span>
                Todos os Alertas
                <span id="count-todos" class="bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-200 text-xs px-2 py-0.5 rounded-full">0</span>
            </button>
            <button onclick="mudarAba('vencidos')" id="tab-vencidos"
                    class="tab-inactive flex items-center gap-2 px-6 py-4 text-sm font-medium whitespace-nowrap transition-colors">
                <span class="material-symbols-outlined text-xl text-red-500">error</span>
                Vencidos
                <span id="count-vencidos" class="bg-red-100 text-red-700 dark:bg-red-900 dark:text-red-200 text-xs px-2 py-0.5 rounded-full">0</span>
            </button>
            <button onclick="mudarAba('urgentes')" id="tab-urgentes"
                    class="tab-inactive flex items-center gap-2 px-6 py-4 text-sm font-medium whitespace-nowrap transition-colors">
                <span class="material-symbols-outlined text-xl text-orange-500">warning</span>
                Urgentes
                <span id="count-urgentes" class="bg-orange-100 text-orange-700 dark:bg-orange-900 dark:text-orange-200 text-xs px-2 py-0.5 rounded-full">0</span>
            </button>
            <button onclick="mudarAba('proximos')" id="tab-proximos"
                    class="tab-inactive flex items-center gap-2 px-6 py-4 text-sm font-medium whitespace-nowrap transition-colors">
                <span class="material-symbols-outlined text-xl text-blue-500">schedule</span>
                Próximos 30 dias
                <span id="count-proximos" class="bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-200 text-xs px-2 py-0.5 rounded-full">0</span>
            </button>
            <button onclick="mudarAba('emdia')" id="tab-emdia"
                    class="tab-inactive flex items-center gap-2 px-6 py-4 text-sm font-medium whitespace-nowrap transition-colors">
                <span class="material-symbols-outlined text-xl text-green-500">check_circle</span>
                Em Dia
                <span id="count-emdia" class="bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-200 text-xs px-2 py-0.5 rounded-full">0</span>
            </button>
            <button onclick="mudarAba('concluidos')" id="tab-concluidos"
                    class="tab-inactive flex items-center gap-2 px-6 py-4 text-sm font-medium whitespace-nowrap transition-colors">
                <span class="material-symbols-outlined text-xl text-gray-500">task_alt</span>
                Concluídos
                <span id="count-concluidos" class="bg-gray-200 text-gray-700 dark:bg-gray-600 dark:text-gray-200 text-xs px-2 py-0.5 rounded-full">0</span>
            </button>
            <button onclick="mudarAba('veiculos')" id="tab-veiculos"
                    class="tab-inactive flex items-center gap-2 px-6 py-4 text-sm font-medium whitespace-nowrap transition-colors">
                <span class="material-symbols-outlined text-xl text-primary">directions_car</span>
                Por Veículo
            </button>
        </nav>
    </div>

    <!-- Stats Cards -->
    <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-3 p-4 bg-white dark:bg-slate-800 border-x dark:border-slate-700">
        <!-- Vencidas -->
        <div class="card-stat flex flex-col gap-1 rounded-lg p-4 bg-gradient-to-br from-red-50 to-red-100 dark:from-red-900/30 dark:to-red-800/30 border border-red-200 dark:border-red-800 cursor-pointer transition-all"
             onclick="mudarAba('vencidos')">
            <div class="flex items-center justify-between">
                <span class="material-symbols-outlined text-red-500 text-2xl">error</span>
                <span id="stat-vencidas" class="text-2xl font-bold text-red-600 dark:text-red-400">0</span>
            </div>
            <p class="text-red-700 dark:text-red-300 text-xs font-medium">Vencidas</p>
        </div>
        <!-- Urgentes -->
        <div class="card-stat flex flex-col gap-1 rounded-lg p-4 bg-gradient-to-br from-orange-50 to-orange-100 dark:from-orange-900/30 dark:to-orange-800/30 border border-orange-200 dark:border-orange-800 cursor-pointer transition-all"
             onclick="mudarAba('urgentes')">
            <div class="flex items-center justify-between">
                <span class="material-symbols-outlined text-orange-500 text-2xl">warning</span>
                <span id="stat-urgentes" class="text-2xl font-bold text-orange-600 dark:text-orange-400">0</span>
            </div>
            <p class="text-orange-700 dark:text-orange-300 text-xs font-medium">Urgentes</p>
        </div>
        <!-- Próximas -->
        <div class="card-stat flex flex-col gap-1 rounded-lg p-4 bg-gradient-to-br from-blue-50 to-blue-100 dark:from-blue-900/30 dark:to-blue-800/30 border border-blue-200 dark:border-blue-800 cursor-pointer transition-all"
             onclick="mudarAba('proximos')">
            <div class="flex items-center justify-between">
                <span class="material-symbols-outlined text-blue-500 text-2xl">schedule</span>
                <span id="stat-proximas" class="text-2xl font-bold text-blue-600 dark:text-blue-400">0</span>
            </div>
            <p class="text-blue-700 dark:text-blue-300 text-xs font-medium">Próx. 30 dias</p>
        </div>
        <!-- Em Dia -->
        <div class="card-stat flex flex-col gap-1 rounded-lg p-4 bg-gradient-to-br from-green-50 to-green-100 dark:from-green-900/30 dark:to-green-800/30 border border-green-200 dark:border-green-800 cursor-pointer transition-all"
             onclick="mudarAba('emdia')">
            <div class="flex items-center justify-between">
                <span class="material-symbols-outlined text-green-500 text-2xl">check_circle</span>
                <span id="stat-emdia" class="text-2xl font-bold text-green-600 dark:text-green-400">0</span>
            </div>
            <p class="text-green-700 dark:text-green-300 text-xs font-medium">Em Dia</p>
        </div>
        <!-- Total Veículos -->
        <div class="card-stat flex flex-col gap-1 rounded-lg p-4 bg-gradient-to-br from-purple-50 to-purple-100 dark:from-purple-900/30 dark:to-purple-800/30 border border-purple-200 dark:border-purple-800 cursor-pointer transition-all"
             onclick="mudarAba('veiculos')">
            <div class="flex items-center justify-between">
                <span class="material-symbols-outlined text-purple-500 text-2xl">directions_car</span>
                <span id="stat-veiculos" class="text-2xl font-bold text-purple-600 dark:text-purple-400">0</span>
            </div>
            <p class="text-purple-700 dark:text-purple-300 text-xs font-medium">Veículos</p>
        </div>
        <!-- Custo Estimado -->
        <div class="card-stat flex flex-col gap-1 rounded-lg p-4 bg-gradient-to-br from-slate-50 to-slate-100 dark:from-slate-700/30 dark:to-slate-600/30 border border-slate-200 dark:border-slate-600">
            <div class="flex items-center justify-between">
                <span class="material-symbols-outlined text-slate-500 text-2xl">payments</span>
                <span id="stat-custo" class="text-lg font-bold text-slate-600 dark:text-slate-300">R$ 0</span>
            </div>
            <p class="text-slate-600 dark:text-slate-400 text-xs font-medium">Custo Est. 30d</p>
        </div>
    </div>

    <!-- Filtros Avançados (Colapsável) -->
    <div id="filtros-section" class="filter-section bg-white dark:bg-slate-800 border-x dark:border-slate-700">
        <div class="p-4 border-t dark:border-slate-700">
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4">
                <!-- Busca por Placa -->
                <div>
                    <label class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">Buscar Placa</label>
                    <div class="relative">
                        <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-xl">search</span>
                        <input id="filtro-busca" type="text" onkeyup="debounceSearch()"
                               class="w-full pl-10 pr-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-slate-700 text-sm"
                               placeholder="Ex: ABC1234"/>
                    </div>
                </div>
                <!-- Modelo -->
                <div>
                    <label class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">Modelo</label>
                    <select id="filtro-modelo" onchange="aplicarFiltros()"
                            class="w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-slate-700 text-sm">
                        <option value="">Todos os modelos</option>
                    </select>
                </div>
                <!-- Categoria -->
                <div>
                    <label class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">Categoria</label>
                    <select id="filtro-categoria" onchange="aplicarFiltros()"
                            class="w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-slate-700 text-sm">
                        <option value="">Todas categorias</option>
                        <option value="Motor">Motor</option>
                        <option value="Freios">Freios</option>
                        <option value="Suspensão">Suspensão</option>
                        <option value="Transmissão">Transmissão</option>
                        <option value="Elétrico">Elétrico</option>
                        <option value="Arrefecimento">Arrefecimento</option>
                        <option value="Pneus">Pneus</option>
                        <option value="Geral">Geral</option>
                    </select>
                </div>
                <!-- Período -->
                <div>
                    <label class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">Período</label>
                    <select id="filtro-periodo" onchange="aplicarFiltros()"
                            class="w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-slate-700 text-sm">
                        <option value="">Qualquer período</option>
                        <option value="7">Últimos 7 dias</option>
                        <option value="30">Últimos 30 dias</option>
                        <option value="90">Últimos 90 dias</option>
                    </select>
                </div>
                <!-- Ações -->
                <div class="flex items-end gap-2">
                    <button onclick="limparFiltros()"
                            class="flex-1 px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 text-gray-600 dark:text-gray-300 text-sm hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                        Limpar
                    </button>
                    <button onclick="aplicarFiltros()"
                            class="flex-1 px-4 py-2 rounded-lg bg-primary text-white text-sm hover:bg-blue-700 transition-colors">
                        Aplicar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Conteúdo Principal -->
    <div id="conteudo-principal" class="bg-white dark:bg-slate-800 rounded-b-xl border-x border-b dark:border-slate-700 shadow-sm">
        <!-- Tabela de Alertas -->
        <div id="view-tabela">
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left">
                    <thead class="text-xs text-gray-600 dark:text-gray-300 uppercase bg-gray-50 dark:bg-slate-700/50">
                        <tr>
                            <th class="px-4 py-3 font-semibold">Status</th>
                            <th class="px-4 py-3 font-semibold">Veículo</th>
                            <th class="px-4 py-3 font-semibold">Manutenção</th>
                            <th class="px-4 py-3 font-semibold text-right">KM Restante</th>
                            <th class="px-4 py-3 font-semibold text-right">Tempo</th>
                            <th class="px-4 py-3 font-semibold">Prioridade</th>
                            <th class="px-4 py-3 font-semibold text-right">Custo Est.</th>
                            <th class="px-4 py-3 font-semibold text-center">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="tabela-alertas">
                        <tr>
                            <td colspan="8" class="text-center py-12">
                                <span class="material-symbols-outlined loading-spin text-4xl text-primary">sync</span>
                                <p class="mt-2 text-gray-500">Carregando alertas...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Paginação -->
            <div class="flex flex-wrap items-center justify-between gap-4 p-4 border-t dark:border-slate-700">
                <div class="flex items-center gap-2">
                    <span class="text-sm text-gray-500 dark:text-gray-400">Exibir:</span>
                    <select id="items-por-pagina" onchange="mudarItensPorPagina()"
                            class="px-2 py-1 rounded border border-gray-300 dark:border-gray-600 bg-white dark:bg-slate-700 text-sm">
                        <option value="15">15</option>
                        <option value="30">30</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                    </select>
                    <span id="pagination-info" class="text-sm text-gray-500 dark:text-gray-400 ml-2">0 de 0</span>
                </div>
                <div class="flex items-center gap-1">
                    <button id="btn-first" onclick="irParaPagina(1)" disabled
                            class="p-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700 disabled:opacity-40 disabled:cursor-not-allowed">
                        <span class="material-symbols-outlined text-xl">first_page</span>
                    </button>
                    <button id="btn-prev" onclick="paginaAnterior()" disabled
                            class="p-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700 disabled:opacity-40 disabled:cursor-not-allowed">
                        <span class="material-symbols-outlined text-xl">chevron_left</span>
                    </button>
                    <span id="pagination-pages" class="px-4 py-1 text-sm font-medium">1 / 1</span>
                    <button id="btn-next" onclick="proximaPagina()" disabled
                            class="p-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700 disabled:opacity-40 disabled:cursor-not-allowed">
                        <span class="material-symbols-outlined text-xl">chevron_right</span>
                    </button>
                    <button id="btn-last" onclick="irParaUltimaPagina()" disabled
                            class="p-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700 disabled:opacity-40 disabled:cursor-not-allowed">
                        <span class="material-symbols-outlined text-xl">last_page</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- View Por Veículo -->
        <div id="view-veiculos" class="hidden p-4">
            <div id="lista-veiculos" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
                <!-- Preenchido via JS -->
            </div>
        </div>
    </div>

</div>
</main>
</div>
</div>

<!-- Modal Ver Plano -->
<div id="modal-plano" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
    <div class="bg-white dark:bg-gray-800 rounded-xl p-6 max-w-2xl w-full mx-4 max-h-[85vh] overflow-y-auto shadow-2xl">
        <div class="flex justify-between items-center mb-4 pb-4 border-b dark:border-gray-700">
            <h3 class="text-xl font-bold text-gray-900 dark:text-white flex items-center gap-2">
                <span class="material-symbols-outlined text-primary">description</span>
                Detalhes do Plano
            </h3>
            <button onclick="fecharModal('modal-plano')" class="p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>
        <div id="conteudo-modal-plano"></div>
    </div>
</div>

<!-- Modal Histórico -->
<div id="modal-historico" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
    <div class="bg-white dark:bg-gray-800 rounded-xl p-6 max-w-3xl w-full mx-4 max-h-[85vh] overflow-y-auto shadow-2xl">
        <div class="flex justify-between items-center mb-4 pb-4 border-b dark:border-gray-700">
            <h3 class="text-xl font-bold text-gray-900 dark:text-white flex items-center gap-2">
                <span class="material-symbols-outlined text-primary">history</span>
                Histórico de Manutenções
            </h3>
            <button onclick="fecharModal('modal-historico')" class="p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>
        <div id="conteudo-modal-historico"></div>
    </div>
</div>

<!-- Modal Resolver -->
<div id="modal-resolver" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
    <div class="bg-white dark:bg-gray-800 rounded-xl p-6 max-w-md w-full mx-4 shadow-2xl">
        <div class="flex justify-between items-center mb-4 pb-4 border-b dark:border-gray-700">
            <h3 class="text-xl font-bold text-gray-900 dark:text-white flex items-center gap-2">
                <span class="material-symbols-outlined text-green-500">check_circle</span>
                Resolver Alerta
            </h3>
            <button onclick="fecharModal('modal-resolver')" class="p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>
        <p class="text-gray-600 dark:text-gray-400 mb-2">Marcar este alerta como resolvido?</p>
        <p id="resolver-descricao" class="text-gray-800 dark:text-white font-medium mb-4 p-3 bg-gray-100 dark:bg-gray-700 rounded-lg"></p>
        <div class="mb-4">
            <label class="block mb-2 text-gray-700 dark:text-gray-300 text-sm font-medium">Observações</label>
            <textarea id="resolver-observacoes"
                      class="w-full rounded-lg border border-gray-300 dark:border-gray-600 p-3 bg-white dark:bg-gray-700 text-sm"
                      rows="2" placeholder="Adicione observações..."></textarea>
        </div>
        <div class="flex gap-3 justify-end">
            <button onclick="fecharModal('modal-resolver')"
                    class="px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                Cancelar
            </button>
            <button onclick="confirmarResolucao()"
                    class="px-4 py-2 rounded-lg bg-green-600 hover:bg-green-700 text-white font-medium">
                Confirmar
            </button>
        </div>
    </div>
</div>

<script>
// ==================== ESTADO ====================
let state = {
    abaAtual: 'todos',
    page: 1,
    limit: 15,
    totalPages: 1,
    total: 0,
    filtros: {
        status: '',
        nivel_alerta: '',
        busca: '',
        modelo: '',
        categoria: '',
        periodo: ''
    },
    stats: {},
    modelos: [],
    alertaParaResolver: null
};

let searchTimeout = null;

// ==================== INICIALIZAÇÃO ====================
document.addEventListener('DOMContentLoaded', () => {
    atualizarDataAtual();
    carregarModelos();
    carregarAlertas();
    setInterval(carregarAlertas, 5 * 60 * 1000);
});

function atualizarDataAtual() {
    const el = document.getElementById('data-atual');
    if (el) {
        const hoje = new Date();
        el.textContent = hoje.toLocaleDateString('pt-BR', {
            weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
        });
    }
}

// ==================== CARREGAR DADOS ====================
async function carregarAlertas() {
    const tbody = document.getElementById('tabela-alertas');
    if (!tbody) return;

    tbody.innerHTML = `
        <tr><td colspan="8" class="text-center py-12">
            <span class="material-symbols-outlined loading-spin text-4xl text-primary">sync</span>
            <p class="mt-2 text-gray-500">Carregando...</p>
        </td></tr>
    `;

    try {
        const params = new URLSearchParams();

        // Aplicar filtro baseado na aba atual
        if (state.abaAtual === 'vencidos') {
            params.append('status', 'Vencido');
        } else if (state.abaAtual === 'urgentes') {
            params.append('nivel_alerta', 'Critico');
        } else if (state.abaAtual === 'proximos') {
            params.append('nivel_alerta', 'Medio');
        } else if (state.abaAtual === 'emdia') {
            params.append('nivel_alerta', 'Baixo');
        } else if (state.abaAtual === 'concluidos') {
            params.append('status', 'Concluido');
        } else {
            // Aba "todos" - aplicar filtros manuais
            if (state.filtros.status) params.append('status', state.filtros.status);
            if (state.filtros.nivel_alerta) params.append('nivel_alerta', state.filtros.nivel_alerta);
        }

        if (state.filtros.busca) params.append('busca', state.filtros.busca);
        params.append('page', state.page);
        params.append('limit', state.limit);

        const response = await fetch(`https://floripa.in9automacao.com.br/avisos-manutencao-api.php?${params}`);
        const result = await response.json();

        if (!result.success) throw new Error(result.error);

        state.stats = result.data.stats || {};
        state.total = result.data.pagination?.total || 0;
        state.totalPages = result.data.pagination?.totalPages || 1;

        atualizarStats();
        atualizarContadoresAbas();

        if (state.abaAtual === 'veiculos') {
            renderizarPorVeiculo(result.data.alertas);
        } else {
            renderizarTabela(result.data.alertas);
        }

        atualizarPaginacao();

    } catch (error) {
        console.error('Erro:', error);
        tbody.innerHTML = `
            <tr><td colspan="8" class="text-center py-12 text-red-500">
                <span class="material-symbols-outlined text-4xl">error</span>
                <p class="mt-2">Erro ao carregar. <button onclick="carregarAlertas()" class="text-primary underline">Tentar novamente</button></p>
            </td></tr>
        `;
    }
}

async function carregarModelos() {
    try {
        const response = await fetch('https://floripa.in9automacao.com.br/modelos.php');
        const modelos = await response.json();

        const select = document.getElementById('filtro-modelo');
        if (select && Array.isArray(modelos)) {
            modelos.forEach(m => {
                const opt = document.createElement('option');
                opt.value = m.modelo || m.model;
                opt.textContent = `${m.marca || m.brand} ${m.modelo || m.model}`;
                select.appendChild(opt);
            });
        }
    } catch (e) {
        console.error('Erro ao carregar modelos:', e);
    }
}

// ==================== RENDERIZAÇÃO ====================
function atualizarStats() {
    document.getElementById('stat-vencidas').textContent = state.stats.vencidas || 0;
    document.getElementById('stat-urgentes').textContent = state.stats.urgentes || 0;
    document.getElementById('stat-proximas').textContent = state.stats.proximas || 0;
    document.getElementById('stat-emdia').textContent = state.stats.emDia || 0;

    // Calcular veículos únicos e custo
    document.getElementById('stat-veiculos').textContent = state.stats.veiculos || '-';
    document.getElementById('stat-custo').textContent = formatarMoeda(state.stats.custoEstimado30Dias || 0);
}

function atualizarContadoresAbas() {
    const total = (state.stats.vencidas || 0) + (state.stats.urgentes || 0) +
                  (state.stats.proximas || 0) + (state.stats.emDia || 0);

    document.getElementById('count-todos').textContent = total;
    document.getElementById('count-vencidos').textContent = state.stats.vencidas || 0;
    document.getElementById('count-urgentes').textContent = state.stats.urgentes || 0;
    document.getElementById('count-proximos').textContent = state.stats.proximas || 0;
    document.getElementById('count-emdia').textContent = state.stats.emDia || 0;
    document.getElementById('count-concluidos').textContent = state.stats.concluidos || 0;
}

function renderizarTabela(alertas) {
    const tbody = document.getElementById('tabela-alertas');
    document.getElementById('view-tabela').classList.remove('hidden');
    document.getElementById('view-veiculos').classList.add('hidden');

    if (!alertas || alertas.length === 0) {
        tbody.innerHTML = `
            <tr><td colspan="8" class="px-6 py-12 text-center">
                <span class="material-symbols-outlined text-5xl text-gray-300 mb-2">inbox</span>
                <p class="text-gray-500">Nenhum alerta encontrado</p>
            </td></tr>
        `;
        return;
    }

    tbody.innerHTML = alertas.map(a => {
        const statusConfig = {
            'Vencido': { bg: 'bg-red-100 dark:bg-red-900/50', text: 'text-red-700 dark:text-red-300', icon: 'error', iconColor: 'text-red-500' },
            'Pendente': { bg: 'bg-orange-100 dark:bg-orange-900/50', text: 'text-orange-700 dark:text-orange-300', icon: 'warning', iconColor: 'text-orange-500' },
            'EmDia': { bg: 'bg-green-100 dark:bg-green-900/50', text: 'text-green-700 dark:text-green-300', icon: 'check_circle', iconColor: 'text-green-500' },
            'Concluido': { bg: 'bg-blue-100 dark:bg-blue-900/50', text: 'text-blue-700 dark:text-blue-300', icon: 'task_alt', iconColor: 'text-blue-500' }
        }[a.status] || { bg: 'bg-gray-100', text: 'text-gray-700', icon: 'help', iconColor: 'text-gray-500' };

        const prioridadeConfig = {
            'Critico': { bg: 'bg-red-600', text: 'text-white' },
            'Alto': { bg: 'bg-orange-500', text: 'text-white' },
            'Medio': { bg: 'bg-yellow-500', text: 'text-gray-900' },
            'Baixo': { bg: 'bg-green-500', text: 'text-white' }
        }[a.prioridade] || { bg: 'bg-gray-500', text: 'text-white' };

        const kmRestantes = a.km_restantes || 0;
        const diasRestantes = a.dias_restantes;
        const kmClass = kmRestantes <= 0 ? 'text-red-600 dark:text-red-400 font-semibold' : 'text-gray-700 dark:text-gray-300';
        const diasClass = diasRestantes !== null && diasRestantes <= 0 ? 'text-red-600 dark:text-red-400 font-semibold' : 'text-gray-700 dark:text-gray-300';

        const urgencyClass = a.status === 'Vencido' ? 'urgency-critical' : '';

        return `
            <tr class="border-b dark:border-slate-700 hover:bg-gray-50 dark:hover:bg-slate-700/30 ${urgencyClass}">
                <td class="px-4 py-3">
                    <div class="flex items-center gap-2 ${statusConfig.bg} ${statusConfig.text} px-2 py-1 rounded-lg w-fit">
                        <span class="material-symbols-outlined text-lg ${statusConfig.iconColor}">${statusConfig.icon}</span>
                        <span class="text-xs font-medium">${a.status === 'EmDia' ? 'Em Dia' : a.status}</span>
                    </div>
                </td>
                <td class="px-4 py-3">
                    <div class="font-semibold text-gray-900 dark:text-white">${a.placa || 'N/A'}</div>
                    <div class="text-xs text-gray-500 dark:text-gray-400">${a.modelo || ''}</div>
                </td>
                <td class="px-4 py-3">
                    <div class="max-w-[200px] truncate font-medium" title="${a.plano_nome || ''}">${a.plano_nome || 'N/A'}</div>
                    <div class="text-xs text-gray-500">KM Atual: ${(a.km_atual || 0).toLocaleString('pt-BR')}</div>
                </td>
                <td class="px-4 py-3 text-right ${kmClass}">
                    ${kmRestantes <= 0 ? `<span class="text-red-600">-${Math.abs(kmRestantes).toLocaleString('pt-BR')}</span>` : kmRestantes.toLocaleString('pt-BR')} km
                </td>
                <td class="px-4 py-3 text-right ${diasClass}">
                    ${diasRestantes !== null ? (diasRestantes <= 0 ? `<span class="text-red-600">-${Math.abs(diasRestantes)}</span>` : diasRestantes) + ' dias' : '-'}
                </td>
                <td class="px-4 py-3">
                    <span class="px-2 py-1 rounded text-xs font-medium ${prioridadeConfig.bg} ${prioridadeConfig.text}">
                        ${a.prioridade || 'N/A'}
                    </span>
                </td>
                <td class="px-4 py-3 text-right font-medium">${formatarMoeda(a.custo_estimado)}</td>
                <td class="px-4 py-3">
                    <div class="flex items-center justify-center gap-1">
                        ${a.status !== 'Concluido' ? `
                            <button onclick="resolverAlerta(${a.id}, '${(a.plano_nome || '').replace(/'/g, "\\'")}')" title="Resolver"
                                    class="p-1.5 text-green-600 hover:bg-green-100 dark:hover:bg-green-900/30 rounded-lg">
                                <span class="material-symbols-outlined text-xl">check_circle</span>
                            </button>
                        ` : ''}
                        <button onclick="abrirOS('${a.placa}')" title="Abrir OS"
                                class="p-1.5 text-primary hover:bg-blue-100 dark:hover:bg-blue-900/30 rounded-lg">
                            <span class="material-symbols-outlined text-xl">add_box</span>
                        </button>
                        <button onclick="verPlano(${a.plano_id})" title="Ver Plano"
                                class="p-1.5 text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">
                            <span class="material-symbols-outlined text-xl">description</span>
                        </button>
                        <button onclick="verHistorico('${a.placa}')" title="Histórico"
                                class="p-1.5 text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">
                            <span class="material-symbols-outlined text-xl">history</span>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
}

function renderizarPorVeiculo(alertas) {
    document.getElementById('view-tabela').classList.add('hidden');
    document.getElementById('view-veiculos').classList.remove('hidden');

    const container = document.getElementById('lista-veiculos');

    // Agrupar por veículo
    const grupos = {};
    alertas.forEach(a => {
        const placa = a.placa || 'UNKNOWN';
        if (!grupos[placa]) {
            grupos[placa] = { modelo: a.modelo, alertas: [] };
        }
        grupos[placa].alertas.push(a);
    });

    if (Object.keys(grupos).length === 0) {
        container.innerHTML = `
            <div class="col-span-full text-center py-12">
                <span class="material-symbols-outlined text-5xl text-gray-300">directions_car</span>
                <p class="mt-2 text-gray-500">Nenhum veículo com alertas</p>
            </div>
        `;
        return;
    }

    container.innerHTML = Object.entries(grupos).map(([placa, data]) => {
        const vencidos = data.alertas.filter(a => a.status === 'Vencido').length;
        const urgentes = data.alertas.filter(a => a.prioridade === 'Critico' || a.prioridade === 'Alto').length;
        const total = data.alertas.length;

        const statusColor = vencidos > 0 ? 'border-red-500 bg-red-50 dark:bg-red-900/20' :
                           urgentes > 0 ? 'border-orange-500 bg-orange-50 dark:bg-orange-900/20' :
                           'border-green-500 bg-green-50 dark:bg-green-900/20';

        return `
            <div class="rounded-xl border-2 ${statusColor} p-4 hover:shadow-lg transition-shadow cursor-pointer"
                 onclick="filtrarPorPlaca('${placa}')">
                <div class="flex items-center justify-between mb-3">
                    <div>
                        <h3 class="font-bold text-lg text-gray-900 dark:text-white">${placa}</h3>
                        <p class="text-sm text-gray-500">${data.modelo || 'Modelo não informado'}</p>
                    </div>
                    <div class="text-right">
                        <div class="text-2xl font-bold ${vencidos > 0 ? 'text-red-600' : 'text-gray-700 dark:text-gray-300'}">${total}</div>
                        <div class="text-xs text-gray-500">alertas</div>
                    </div>
                </div>
                <div class="flex gap-2 flex-wrap">
                    ${vencidos > 0 ? `<span class="px-2 py-1 bg-red-100 text-red-700 text-xs rounded-full">${vencidos} vencidos</span>` : ''}
                    ${urgentes > 0 ? `<span class="px-2 py-1 bg-orange-100 text-orange-700 text-xs rounded-full">${urgentes} urgentes</span>` : ''}
                </div>
            </div>
        `;
    }).join('');
}

function atualizarPaginacao() {
    const inicio = Math.min((state.page - 1) * state.limit + 1, state.total);
    const fim = Math.min(state.page * state.limit, state.total);

    document.getElementById('pagination-info').textContent = `${inicio}-${fim} de ${state.total}`;
    document.getElementById('pagination-pages').textContent = `${state.page} / ${state.totalPages || 1}`;

    document.getElementById('btn-first').disabled = state.page <= 1;
    document.getElementById('btn-prev').disabled = state.page <= 1;
    document.getElementById('btn-next').disabled = state.page >= state.totalPages;
    document.getElementById('btn-last').disabled = state.page >= state.totalPages;
}

// ==================== NAVEGAÇÃO ====================
function mudarAba(aba) {
    state.abaAtual = aba;
    state.page = 1;

    // Atualizar visual das abas
    document.querySelectorAll('[id^="tab-"]').forEach(tab => {
        tab.classList.remove('tab-active');
        tab.classList.add('tab-inactive');
    });
    document.getElementById(`tab-${aba}`).classList.remove('tab-inactive');
    document.getElementById(`tab-${aba}`).classList.add('tab-active');

    carregarAlertas();
}

function toggleFiltros() {
    const section = document.getElementById('filtros-section');
    section.classList.toggle('open');
}

// ==================== FILTROS ====================
function aplicarFiltros() {
    state.filtros.busca = document.getElementById('filtro-busca').value;
    state.filtros.modelo = document.getElementById('filtro-modelo').value;
    state.filtros.categoria = document.getElementById('filtro-categoria').value;
    state.filtros.periodo = document.getElementById('filtro-periodo').value;
    state.page = 1;

    // Contar filtros ativos
    const ativos = Object.values(state.filtros).filter(v => v).length;
    const badge = document.getElementById('filtros-badge');
    if (ativos > 0) {
        badge.textContent = ativos;
        badge.classList.remove('hidden');
    } else {
        badge.classList.add('hidden');
    }

    carregarAlertas();
}

function limparFiltros() {
    document.getElementById('filtro-busca').value = '';
    document.getElementById('filtro-modelo').value = '';
    document.getElementById('filtro-categoria').value = '';
    document.getElementById('filtro-periodo').value = '';
    state.filtros = { status: '', nivel_alerta: '', busca: '', modelo: '', categoria: '', periodo: '' };
    document.getElementById('filtros-badge').classList.add('hidden');
    carregarAlertas();
}

function debounceSearch() {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(aplicarFiltros, 500);
}

function filtrarPorPlaca(placa) {
    document.getElementById('filtro-busca').value = placa;
    mudarAba('todos');
    aplicarFiltros();
    toggleFiltros();
}

// ==================== PAGINAÇÃO ====================
function paginaAnterior() { if (state.page > 1) { state.page--; carregarAlertas(); } }
function proximaPagina() { if (state.page < state.totalPages) { state.page++; carregarAlertas(); } }
function irParaPagina(p) { state.page = p; carregarAlertas(); }
function irParaUltimaPagina() { state.page = state.totalPages; carregarAlertas(); }
function mudarItensPorPagina() {
    state.limit = parseInt(document.getElementById('items-por-pagina').value);
    state.page = 1;
    carregarAlertas();
}

// ==================== AÇÕES ====================
async function gerarAlertas() {
    const btn = document.getElementById('btn-gerar-alertas');
    const original = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = `<span class="material-symbols-outlined loading-spin text-xl">autorenew</span><span class="hidden sm:inline">Gerando...</span>`;

    try {
        const response = await fetch('https://floripa.in9automacao.com.br/gerar-alertas-manutencao.php', {
            method: 'POST', headers: { 'Content-Type': 'application/json' }
        });
        const result = await response.json();

        if (result.success) {
            const d = result.data;
            alert(`Alertas gerados!\n\nVeículos: ${d.total_veiculos}\nNovos: ${d.alertas_gerados}\nAtualizados: ${d.alertas_atualizados}\nTempo: ${d.tempo_execucao}`);
            carregarAlertas();
        } else {
            throw new Error(result.error);
        }
    } catch (e) {
        alert('Erro: ' + e.message);
    } finally {
        btn.disabled = false;
        btn.innerHTML = original;
    }
}

function abrirOS(placa) {
    window.location.href = `lancar-os.html?placa=${encodeURIComponent(placa)}&ocorrencia=Preventiva`;
}

function resolverAlerta(id, descricao) {
    state.alertaParaResolver = id;
    document.getElementById('resolver-descricao').textContent = descricao;
    document.getElementById('resolver-observacoes').value = '';
    document.getElementById('modal-resolver').classList.remove('hidden');
}

async function confirmarResolucao() {
    if (!state.alertaParaResolver) return;
    try {
        const obs = document.getElementById('resolver-observacoes').value;
        const response = await fetch(`https://floripa.in9automacao.com.br/avisos-manutencao-api.php?action=resolve&id=${state.alertaParaResolver}`, {
            method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ observacoes: obs })
        });
        const result = await response.json();
        if (result.success) {
            fecharModal('modal-resolver');
            carregarAlertas();
        } else throw new Error(result.error);
    } catch (e) {
        alert('Erro: ' + e.message);
    }
}

async function verPlano(planoId) {
    if (!planoId) { alert('Plano não encontrado'); return; }
    try {
        const response = await fetch(`https://floripa.in9automacao.com.br/planos-manutencao-api.php?id=${planoId}`);
        const result = await response.json();
        if (!result.success || !result.data) throw new Error('Plano não encontrado');

        const p = result.data;
        document.getElementById('conteudo-modal-plano').innerHTML = `
            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div class="p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                        <p class="text-xs text-gray-500 mb-1">Modelo</p>
                        <p class="font-semibold">${p.modelo_carro || 'N/A'}</p>
                    </div>
                    <div class="p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                        <p class="text-xs text-gray-500 mb-1">Criticidade</p>
                        <p class="font-semibold">${p.criticidade || 'N/A'}</p>
                    </div>
                </div>
                <div class="p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                    <p class="text-xs text-gray-500 mb-1">Descrição</p>
                    <p class="font-semibold">${p.descricao_titulo || 'N/A'}</p>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="p-3 bg-blue-50 dark:bg-blue-900/30 rounded-lg">
                        <p class="text-xs text-blue-600 mb-1">Intervalo KM</p>
                        <p class="font-bold text-blue-700">${p.km_recomendado ? p.km_recomendado.toLocaleString('pt-BR') + ' km' : 'N/A'}</p>
                    </div>
                    <div class="p-3 bg-purple-50 dark:bg-purple-900/30 rounded-lg">
                        <p class="text-xs text-purple-600 mb-1">Intervalo Tempo</p>
                        <p class="font-bold text-purple-700">${p.intervalo_tempo || 'N/A'}</p>
                    </div>
                </div>
                <div class="p-3 bg-green-50 dark:bg-green-900/30 rounded-lg">
                    <p class="text-xs text-green-600 mb-1">Custo Estimado</p>
                    <p class="font-bold text-green-700 text-xl">${formatarMoeda(p.custo_estimado)}</p>
                </div>
                ${p.descricao_observacao ? `
                    <div class="p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                        <p class="text-xs text-gray-500 mb-1">Observações Técnicas</p>
                        <p class="text-sm whitespace-pre-wrap">${p.descricao_observacao}</p>
                    </div>
                ` : ''}
            </div>
        `;
        document.getElementById('modal-plano').classList.remove('hidden');
    } catch (e) {
        alert('Erro: ' + e.message);
    }
}

async function verHistorico(placa) {
    try {
        const response = await fetch(`https://floripa.in9automacao.com.br/avisos-manutencao-api.php?action=history&placa=${encodeURIComponent(placa)}`);
        const result = await response.json();
        const historico = result.success ? result.data : [];

        const container = document.getElementById('conteudo-modal-historico');

        if (historico.length === 0) {
            container.innerHTML = `
                <div class="text-center py-8 text-gray-500">
                    <span class="material-symbols-outlined text-5xl mb-2">history</span>
                    <p>Nenhum histórico para ${placa}</p>
                </div>
            `;
        } else {
            container.innerHTML = `
                <div class="mb-4 p-3 bg-gray-100 dark:bg-gray-700 rounded-lg">
                    <span class="font-bold">${placa}</span> - ${historico.length} registro(s)
                </div>
                <div class="space-y-3 max-h-[400px] overflow-y-auto">
                    ${historico.map(h => {
                        const statusClass = {
                            'Concluido': 'border-l-green-500 bg-green-50 dark:bg-green-900/20',
                            'Vencido': 'border-l-red-500 bg-red-50 dark:bg-red-900/20',
                            'Pendente': 'border-l-yellow-500 bg-yellow-50 dark:bg-yellow-900/20'
                        }[h.status] || 'border-l-gray-500 bg-gray-50';

                        return `
                            <div class="border-l-4 ${statusClass} p-3 rounded-r-lg">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <h4 class="font-semibold">${h.plano_nome || 'Manutenção'}</h4>
                                        <p class="text-sm text-gray-600 dark:text-gray-400">${h.mensagem || ''}</p>
                                    </div>
                                    <span class="text-xs text-gray-500">${h.criado_em ? new Date(h.criado_em).toLocaleDateString('pt-BR') : ''}</span>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }
        document.getElementById('modal-historico').classList.remove('hidden');
    } catch (e) {
        alert('Erro: ' + e.message);
    }
}

function exportarDados() {
    alert('Funcionalidade de exportação em desenvolvimento');
}

function fecharModal(id) {
    document.getElementById(id).classList.add('hidden');
}

// ==================== UTILITÁRIOS ====================
function formatarMoeda(valor) {
    return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(valor || 0);
}

// Fechar modais ao clicar fora
document.addEventListener('click', (e) => {
    if (e.target.classList.contains('fixed')) {
        e.target.classList.add('hidden');
    }
});
</script>

<script src="sidebar.js?v=20260121-v2"></script>
</body>
</html>
