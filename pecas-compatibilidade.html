<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Peças Compatíveis - FleetFlow</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#1E3A8A",
                        "background-light": "#F3F4F6",
                        "background-dark": "#1F2937"
                    }
                }
            }
        }
    </script>

    <!-- Google Material Symbols -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />

    <style>
        .material-symbols-outlined {
            font-variation-settings:
            'FILL' 0,
            'wght' 400,
            'GRAD' 0,
            'opsz' 24
        }

        :root {
            --color-primary: #1E3A8A;
        }

        .text-primary {
            color: var(--color-primary) !important;
        }

        .bg-primary {
            background-color: var(--color-primary) !important;
        }

        .border-primary {
            border-color: var(--color-primary) !important;
        }

        .hover\:bg-primary:hover {
            background-color: #1e40af !important;
        }

        .hover\:bg-green-600:hover {
            background-color: #1e40af !important;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .similar-part-item {
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 0.5rem;
            background: #f9fafb;
        }

        .search-results {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
            border-radius: 0.375rem;
            margin-top: 0.5rem;
        }

        .search-result-item {
            padding: 0.75rem;
            cursor: pointer;
            border-bottom: 1px solid #e5e7eb;
        }

        .search-result-item:hover {
            background-color: #f3f4f6;
        }

        .search-result-item:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Sidebar -->
    <div id="sidebar-container" data-page="pecas-compatibilidade"></div>

    <!-- Main Content -->
    <main class="ml-64 p-8">
        <!-- Header -->
        <div class="mb-8">
            <div class="flex items-center gap-3 mb-2">
                <span class="material-symbols-outlined text-primary text-4xl">settings</span>
                <h1 class="text-3xl font-bold text-gray-800">Peças Compatíveis</h1>
            </div>
            <p class="text-gray-600">Gerencie peças originais e similares por modelo e ano de veículo</p>
        </div>

        <!-- Filtros e Ações -->
        <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Modelo de Veículo</label>
                    <select id="filtroModelo" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                        <option value="">Todos os modelos</option>
                        <!-- Populado dinamicamente -->
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Ano Inicial</label>
                    <input type="number" id="filtroAnoInicial" placeholder="Ex: 2020" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Ano Final</label>
                    <input type="number" id="filtroAnoFinal" placeholder="Ex: 2024" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                </div>

                <div class="flex items-end">
                    <button onclick="buscarCompatibilidades()" class="w-full bg-primary text-white px-6 py-2 rounded-lg hover:bg-green-600 transition-colors flex items-center justify-center gap-2">
                        <span class="material-symbols-outlined">search</span>
                        <span>Buscar</span>
                    </button>
                </div>
            </div>

            <div class="mt-4 flex justify-end">
                <button onclick="abrirModal()" class="bg-primary text-white px-6 py-2 rounded-lg hover:bg-green-600 transition-colors flex items-center gap-2">
                    <span class="material-symbols-outlined">add</span>
                    <span>Nova Compatibilidade</span>
                </button>
            </div>
        </div>

        <!-- Tabela de Compatibilidades -->
        <div class="bg-white rounded-lg shadow-sm overflow-hidden">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Modelo</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ano</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Categoria</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Peça Original</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Similares</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="tabelaCompatibilidades" class="bg-white divide-y divide-gray-200">
                        <!-- Populado dinamicamente -->
                    </tbody>
                </table>
            </div>

            <!-- Empty State -->
            <div id="emptyState" class="hidden text-center py-12">
                <span class="material-symbols-outlined text-gray-400 text-6xl mb-4">inbox</span>
                <p class="text-gray-500 text-lg">Nenhuma compatibilidade encontrada</p>
                <p class="text-gray-400 text-sm mt-2">Clique em "Nova Compatibilidade" para adicionar</p>
            </div>

            <!-- Loading State -->
            <div id="loadingState" class="text-center py-12">
                <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-primary"></div>
                <p class="text-gray-500 mt-4">Carregando...</p>
            </div>
        </div>
    </main>

    <!-- Modal de Cadastro/Edição -->
    <div id="modalCompatibilidade" class="modal">
        <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <h2 class="text-2xl font-bold text-gray-800" id="modalTitulo">Nova Compatibilidade</h2>
                    <button onclick="fecharModal()" class="text-gray-400 hover:text-gray-600">
                        <span class="material-symbols-outlined">close</span>
                    </button>
                </div>
            </div>

            <div class="p-6">
                <form id="formCompatibilidade" onsubmit="salvarCompatibilidade(event)">
                    <input type="hidden" id="editandoId" value="">

                    <!-- Informações Básicas -->
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Informações Básicas</h3>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Modelo de Veículo <span class="text-red-500">*</span>
                                </label>
                                <select id="inputModelo" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                                    <option value="">Selecione o modelo</option>
                                    <!-- Populado dinamicamente -->
                                </select>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Categoria <span class="text-red-500">*</span>
                                </label>
                                <select id="inputCategoria" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                                    <option value="">Selecione a categoria</option>
                                    <option value="Filtros">Filtros</option>
                                    <option value="Óleos">Óleos</option>
                                    <option value="Freios">Freios</option>
                                    <option value="Motor">Motor</option>
                                    <option value="Suspensão">Suspensão</option>
                                    <option value="Transmissão">Transmissão</option>
                                    <option value="Elétrica">Elétrica</option>
                                    <option value="Outros">Outros</option>
                                </select>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Ano Inicial <span class="text-red-500">*</span>
                                </label>
                                <input type="number" id="inputAnoInicial" required min="1900" max="2100" placeholder="Ex: 2020" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Ano Final <span class="text-gray-400">(Opcional)</span>
                                </label>
                                <input type="number" id="inputAnoFinal" min="1900" max="2100" placeholder="Ex: 2024 (vazio = todos anos seguintes)" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                            </div>
                        </div>
                    </div>

                    <!-- Peça Original -->
                    <div class="mb-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                            <span class="material-symbols-outlined text-blue-600">verified</span>
                            Peça Original <span class="text-red-500">*</span>
                        </h3>

                        <div class="mb-3">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Buscar Peça Existente</label>
                            <input type="text" id="buscaPecaOriginal" placeholder="Digite código ou nome da peça..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" oninput="buscarPecas('original', this.value)">
                            <div id="resultadosBuscaOriginal" class="search-results hidden"></div>
                        </div>

                        <div class="text-center my-2">
                            <button type="button" onclick="toggleFormNovaPecaOriginal()" class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                                <span class="material-symbols-outlined text-sm align-middle">add_circle</span>
                                Ou cadastrar nova peça
                            </button>
                        </div>

                        <!-- Formulário de Nova Peça Original -->
                        <div id="formNovaPecaOriginal" class="hidden mt-3 p-3 bg-white border border-blue-300 rounded-lg">
                            <h4 class="font-semibold text-sm text-gray-700 mb-3">Cadastrar Nova Peça</h4>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">Código *</label>
                                    <input type="text" id="novaPecaOriginalCodigo" placeholder="Ex: FLT-001" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">Categoria *</label>
                                    <select id="novaPecaOriginalCategoria" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg">
                                        <option value="">Selecione...</option>
                                        <option value="Filtros">Filtros</option>
                                        <option value="Óleos">Óleos</option>
                                        <option value="Freios">Freios</option>
                                        <option value="Motor">Motor</option>
                                        <option value="Suspensão">Suspensão</option>
                                        <option value="Transmissão">Transmissão</option>
                                        <option value="Elétrica">Elétrica</option>
                                        <option value="Outros">Outros</option>
                                    </select>
                                </div>
                                <div class="col-span-2">
                                    <label class="block text-xs font-medium text-gray-600 mb-1">Nome da Peça *</label>
                                    <input type="text" id="novaPecaOriginalNome" placeholder="Ex: Filtro de Óleo" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">Custo Unitário (R$) *</label>
                                    <input type="number" id="novaPecaOriginalCusto" step="0.01" placeholder="0.00" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">Estoque Mínimo</label>
                                    <input type="number" id="novaPecaOriginalEstoqueMin" placeholder="0" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg">
                                </div>
                            </div>
                            <div class="flex gap-2 mt-3">
                                <button type="button" onclick="salvarNovaPecaOriginal()" class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-blue-700">
                                    Salvar e Selecionar
                                </button>
                                <button type="button" onclick="toggleFormNovaPecaOriginal()" class="px-4 py-2 border border-gray-300 rounded-lg text-sm hover:bg-gray-50">
                                    Cancelar
                                </button>
                            </div>
                        </div>

                        <div id="pecaOriginalSelecionada" class="hidden p-4 bg-white border border-blue-300 rounded-lg mt-3">
                            <div class="flex items-center justify-between">
                                <div class="flex-1">
                                    <p class="font-semibold text-gray-800" id="pecaOriginalNome"></p>
                                    <p class="text-sm text-gray-600" id="pecaOriginalCodigo"></p>
                                    <p class="text-sm text-gray-600" id="pecaOriginalCategoria"></p>
                                    <p class="text-lg font-bold text-primary mt-2" id="pecaOriginalCusto"></p>
                                </div>
                                <button type="button" onclick="removerPecaOriginal()" class="text-red-500 hover:text-red-700">
                                    <span class="material-symbols-outlined">close</span>
                                </button>
                            </div>
                        </div>

                        <input type="hidden" id="pecaOriginalId" required>
                    </div>

                    <!-- Peças Similares -->
                    <div class="mb-6 p-4 bg-green-50 rounded-lg border border-green-200">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                            <span class="material-symbols-outlined text-green-600">check_circle</span>
                            Peças Similares / Compatíveis
                        </h3>

                        <div class="mb-3">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Buscar Peça Similar</label>
                            <input type="text" id="buscaPecaSimilar" placeholder="Digite código ou nome da peça..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" oninput="buscarPecas('similar', this.value)">
                            <div id="resultadosBuscaSimilar" class="search-results hidden"></div>
                        </div>

                        <div class="text-center my-2">
                            <button type="button" onclick="toggleFormNovaPecaSimilar()" class="text-green-600 hover:text-green-800 text-sm font-medium">
                                <span class="material-symbols-outlined text-sm align-middle">add_circle</span>
                                Ou cadastrar nova peça similar
                            </button>
                        </div>

                        <!-- Formulário de Nova Peça Similar -->
                        <div id="formNovaPecaSimilar" class="hidden mt-3 p-3 bg-white border border-green-300 rounded-lg">
                            <h4 class="font-semibold text-sm text-gray-700 mb-3">Cadastrar Nova Peça Similar</h4>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">Código *</label>
                                    <input type="text" id="novaPecaSimilarCodigo" placeholder="Ex: FLT-001-SIM" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">Categoria *</label>
                                    <select id="novaPecaSimilarCategoria" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg">
                                        <option value="">Selecione...</option>
                                        <option value="Filtros">Filtros</option>
                                        <option value="Óleos">Óleos</option>
                                        <option value="Freios">Freios</option>
                                        <option value="Motor">Motor</option>
                                        <option value="Suspensão">Suspensão</option>
                                        <option value="Transmissão">Transmissão</option>
                                        <option value="Elétrica">Elétrica</option>
                                        <option value="Outros">Outros</option>
                                    </select>
                                </div>
                                <div class="col-span-2">
                                    <label class="block text-xs font-medium text-gray-600 mb-1">Nome da Peça *</label>
                                    <input type="text" id="novaPecaSimilarNome" placeholder="Ex: Filtro de Óleo Compatível" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">Custo Unitário (R$) *</label>
                                    <input type="number" id="novaPecaSimilarCusto" step="0.01" placeholder="0.00" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">Estoque Mínimo</label>
                                    <input type="number" id="novaPecaSimilarEstoqueMin" placeholder="0" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg">
                                </div>
                            </div>
                            <div class="flex gap-2 mt-3">
                                <button type="button" onclick="salvarNovaPecaSimilar()" class="flex-1 bg-green-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-green-700">
                                    Salvar e Adicionar
                                </button>
                                <button type="button" onclick="toggleFormNovaPecaSimilar()" class="px-4 py-2 border border-gray-300 rounded-lg text-sm hover:bg-gray-50">
                                    Cancelar
                                </button>
                            </div>
                        </div>

                        <div id="listaPecasSimilares" class="space-y-2">
                            <!-- Peças similares adicionadas aparecerão aqui -->
                        </div>

                        <p class="text-sm text-gray-500 mt-2">
                            <span class="material-symbols-outlined text-sm align-middle">info</span>
                            Adicione quantas peças similares desejar. Elas aparecerão como alternativas à peça original.
                        </p>
                    </div>

                    <!-- Observações -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Observações</label>
                        <textarea id="inputObservacoes" rows="3" placeholder="Ex: Compatível com motores 2.8 diesel" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"></textarea>
                    </div>

                    <!-- Botões de Ação -->
                    <div class="flex items-center justify-end gap-3 pt-4 border-t border-gray-200">
                        <button type="button" onclick="fecharModal()" class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors">
                            Cancelar
                        </button>
                        <button type="submit" class="bg-primary text-white px-6 py-2 rounded-lg hover:bg-green-600 transition-colors flex items-center gap-2">
                            <span class="material-symbols-outlined">save</span>
                            <span>Salvar</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="sidebar.js?v=20260113-FIX-ZINDEX"></script>

    <script>
        // Constantes
        const API_URL = 'https://floripa.in9automacao.com.br/pecas-compatibilidade-api.php';
        const API_PECAS = 'https://floripa.in9automacao.com.br/pecas-api.php';
        const API_MODELOS = 'https://floripa.in9automacao.com.br/modelos.php';

        // Estado global
        let compatibilidades = [];
        let modelos = [];
        let pecasSimilaresSelecionadas = [];
        let timeoutBusca = null;

        // Inicialização
        document.addEventListener('DOMContentLoaded', () => {
            carregarModelos();
            buscarCompatibilidades();
        });

        // Carregar modelos de veículos
        async function carregarModelos() {
            try {
                const response = await fetch(API_MODELOS);
                modelos = await response.json();
                popularSelectModelos();
            } catch (error) {
                console.error('Erro ao carregar modelos:', error);
            }
        }

        // Popular selects de modelo
        function popularSelectModelos() {
            const selectFiltro = document.getElementById('filtroModelo');
            const selectInput = document.getElementById('inputModelo');

            // Agrupar modelos únicos (pode haver várias entradas por modelo com anos diferentes)
            const modelosUnicos = [...new Set(modelos.map(m => m.modelo))].sort();

            const opcoes = modelosUnicos.map(modelo => `<option value="${modelo}">${modelo}</option>`).join('');

            selectFiltro.innerHTML = '<option value="">Todos os modelos</option>' + opcoes;
            selectInput.innerHTML = '<option value="">Selecione o modelo</option>' + opcoes;
        }

        // Buscar compatibilidades
        async function buscarCompatibilidades() {
            const modelo = document.getElementById('filtroModelo').value;
            const anoInicial = document.getElementById('filtroAnoInicial').value;
            const anoFinal = document.getElementById('filtroAnoFinal').value;

            document.getElementById('loadingState').classList.remove('hidden');
            document.getElementById('emptyState').classList.add('hidden');

            try {
                let url = API_URL;
                const params = new URLSearchParams();

                if (modelo) params.append('modelo', modelo);
                if (anoInicial) params.append('ano', anoInicial);

                if (params.toString()) {
                    url += '?' + params.toString();
                }

                const response = await fetch(url);
                const data = await response.json();

                document.getElementById('loadingState').classList.add('hidden');

                if (data.success && data.data.length > 0) {
                    compatibilidades = data.data;
                    renderizarTabela();
                } else {
                    mostrarEmptyState();
                }
            } catch (error) {
                console.error('Erro ao buscar compatibilidades:', error);
                document.getElementById('loadingState').classList.add('hidden');
                mostrarErro('Erro ao carregar compatibilidades');
            }
        }

        // Renderizar tabela
        function renderizarTabela() {
            const tbody = document.getElementById('tabelaCompatibilidades');
            tbody.innerHTML = '';

            compatibilidades.forEach(comp => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50';

                const anoTexto = comp.ano_final
                    ? `${comp.ano_inicial} - ${comp.ano_final}`
                    : `${comp.ano_inicial}+`;

                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">${comp.modelo_veiculo}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">${anoTexto}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">
                            ${comp.categoria_aplicacao || 'N/A'}
                        </span>
                    </td>
                    <td class="px-6 py-4">
                        <div class="text-sm font-medium text-gray-900">${comp.peca_original.nome}</div>
                        <div class="text-sm text-gray-500">Código: ${comp.peca_original.codigo}</div>
                        <div class="text-sm font-semibold text-primary">R$ ${comp.peca_original.custo_unitario.toFixed(2)}</div>
                    </td>
                    <td class="px-6 py-4">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                            ${comp.pecas_similares.length} similar(es)
                        </span>
                        ${comp.pecas_similares.length > 0 ? `
                            <button onclick="mostrarSimilares(${comp.id})" class="text-xs text-blue-600 hover:text-blue-800 ml-2">
                                Ver detalhes
                            </button>
                        ` : ''}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="excluirCompatibilidade(${comp.id})" class="text-red-600 hover:text-red-900 mr-3">
                            <span class="material-symbols-outlined">delete</span>
                        </button>
                    </td>
                `;

                tbody.appendChild(tr);
            });
        }

        // Mostrar empty state
        function mostrarEmptyState() {
            document.getElementById('tabelaCompatibilidades').innerHTML = '';
            document.getElementById('emptyState').classList.remove('hidden');
        }

        // Mostrar detalhes de similares
        function mostrarSimilares(id) {
            const comp = compatibilidades.find(c => c.id === id);
            if (!comp) return;

            const similares = comp.pecas_similares.map(s => {
                const economia = comp.peca_original.custo_unitario - s.custo_unitario;
                return `
                    <div class="border-b pb-2 mb-2">
                        <p class="font-medium">${s.nome}</p>
                        <p class="text-sm text-gray-600">Código: ${s.codigo}</p>
                        <p class="text-sm font-semibold text-green-600">R$ ${s.custo_unitario.toFixed(2)}</p>
                        ${economia > 0 ? `<p class="text-xs text-green-700">Economia: R$ ${economia.toFixed(2)}</p>` : ''}
                    </div>
                `;
            }).join('');

            alert(`Peças similares a ${comp.peca_original.nome}:\n\n${similares}`);
        }

        // Abrir modal
        function abrirModal(id = null) {
            document.getElementById('modalCompatibilidade').classList.add('active');
            document.getElementById('formCompatibilidade').reset();
            document.getElementById('editandoId').value = '';
            document.getElementById('pecaOriginalId').value = '';
            pecasSimilaresSelecionadas = [];
            document.getElementById('listaPecasSimilares').innerHTML = '';
            document.getElementById('pecaOriginalSelecionada').classList.add('hidden');
            document.getElementById('modalTitulo').textContent = 'Nova Compatibilidade';
        }

        // Fechar modal
        function fecharModal() {
            document.getElementById('modalCompatibilidade').classList.remove('active');
        }

        // Buscar peças
        async function buscarPecas(tipo, termo) {
            if (timeoutBusca) clearTimeout(timeoutBusca);

            if (!termo || termo.length < 2) {
                document.getElementById(`resultadosBusca${tipo === 'original' ? 'Original' : 'Similar'}`).classList.add('hidden');
                return;
            }

            timeoutBusca = setTimeout(async () => {
                try {
                    const response = await fetch(`${API_PECAS}?busca=${encodeURIComponent(termo)}&limit=10`);
                    const data = await response.json();

                    if (data.success && data.data.length > 0) {
                        mostrarResultadosBusca(tipo, data.data);
                    }
                } catch (error) {
                    console.error('Erro ao buscar peças:', error);
                }
            }, 300);
        }

        // Mostrar resultados da busca
        function mostrarResultadosBusca(tipo, pecas) {
            const container = document.getElementById(`resultadosBusca${tipo === 'original' ? 'Original' : 'Similar'}`);
            container.innerHTML = '';

            pecas.forEach(peca => {
                const div = document.createElement('div');
                div.className = 'search-result-item';
                div.innerHTML = `
                    <p class="font-medium text-sm">${peca.nome}</p>
                    <p class="text-xs text-gray-600">Código: ${peca.codigo} | Categoria: ${peca.categoria}</p>
                    <p class="text-sm font-semibold text-primary">R$ ${parseFloat(peca.custo_unitario).toFixed(2)}</p>
                `;
                div.onclick = () => tipo === 'original' ? selecionarPecaOriginal(peca) : adicionarPecaSimilar(peca);
                container.appendChild(div);
            });

            container.classList.remove('hidden');
        }

        // Selecionar peça original
        function selecionarPecaOriginal(peca) {
            document.getElementById('pecaOriginalId').value = peca.id;
            document.getElementById('pecaOriginalNome').textContent = peca.nome;
            document.getElementById('pecaOriginalCodigo').textContent = `Código: ${peca.codigo}`;
            document.getElementById('pecaOriginalCategoria').textContent = `Categoria: ${peca.categoria}`;
            document.getElementById('pecaOriginalCusto').textContent = `R$ ${parseFloat(peca.custo_unitario).toFixed(2)}`;
            document.getElementById('pecaOriginalSelecionada').classList.remove('hidden');
            document.getElementById('buscaPecaOriginal').value = '';
            document.getElementById('resultadosBuscaOriginal').classList.add('hidden');
        }

        // Remover peça original
        function removerPecaOriginal() {
            document.getElementById('pecaOriginalId').value = '';
            document.getElementById('pecaOriginalSelecionada').classList.add('hidden');
        }

        // Adicionar peça similar
        function adicionarPecaSimilar(peca) {
            // Verificar se já foi adicionada
            if (pecasSimilaresSelecionadas.find(p => p.id === peca.id)) {
                alert('Esta peça já foi adicionada');
                return;
            }

            pecasSimilaresSelecionadas.push(peca);
            renderizarPecasSimilares();
            document.getElementById('buscaPecaSimilar').value = '';
            document.getElementById('resultadosBuscaSimilar').classList.add('hidden');
        }

        // Renderizar peças similares
        function renderizarPecasSimilares() {
            const container = document.getElementById('listaPecasSimilares');
            container.innerHTML = '';

            pecasSimilaresSelecionadas.forEach((peca, index) => {
                const div = document.createElement('div');
                div.className = 'similar-part-item';
                div.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex-1">
                            <p class="font-medium text-sm">${peca.nome}</p>
                            <p class="text-xs text-gray-600">Código: ${peca.codigo}</p>
                            <p class="text-sm font-semibold text-green-600">R$ ${parseFloat(peca.custo_unitario).toFixed(2)}</p>
                        </div>
                        <button type="button" onclick="removerPecaSimilar(${index})" class="text-red-500 hover:text-red-700">
                            <span class="material-symbols-outlined">delete</span>
                        </button>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        // Remover peça similar
        function removerPecaSimilar(index) {
            pecasSimilaresSelecionadas.splice(index, 1);
            renderizarPecasSimilares();
        }

        // Salvar compatibilidade
        async function salvarCompatibilidade(event) {
            event.preventDefault();

            const modelo = document.getElementById('inputModelo').value;
            const anoInicial = parseInt(document.getElementById('inputAnoInicial').value);
            const anoFinal = document.getElementById('inputAnoFinal').value ? parseInt(document.getElementById('inputAnoFinal').value) : null;
            const categoria = document.getElementById('inputCategoria').value;
            const pecaOriginalId = parseInt(document.getElementById('pecaOriginalId').value);
            const observacoes = document.getElementById('inputObservacoes').value;

            if (!pecaOriginalId) {
                alert('Selecione uma peça original');
                return;
            }

            if (anoFinal && anoFinal < anoInicial) {
                alert('Ano final deve ser maior ou igual ao ano inicial');
                return;
            }

            try {
                // Salvar peça original (com peca_similar_id = null)
                const originalData = {
                    modelo_veiculo: modelo,
                    ano_inicial: anoInicial,
                    ano_final: anoFinal,
                    peca_original_id: pecaOriginalId,
                    peca_similar_id: null,
                    categoria_aplicacao: categoria,
                    observacoes: observacoes
                };

                const responseOriginal = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(originalData)
                });

                const dataOriginal = await responseOriginal.json();

                if (!dataOriginal.success) {
                    throw new Error(dataOriginal.error || 'Erro ao salvar peça original');
                }

                // Salvar peças similares
                for (const similar of pecasSimilaresSelecionadas) {
                    const similarData = {
                        modelo_veiculo: modelo,
                        ano_inicial: anoInicial,
                        ano_final: anoFinal,
                        peca_original_id: pecaOriginalId,
                        peca_similar_id: similar.id,
                        categoria_aplicacao: categoria,
                        observacoes: observacoes
                    };

                    const responseSimilar = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(similarData)
                    });

                    const dataSimilar = await responseSimilar.json();
                    if (!dataSimilar.success) {
                        console.error('Erro ao salvar similar:', dataSimilar.error);
                    }
                }

                alert('Compatibilidade salva com sucesso!');
                fecharModal();
                buscarCompatibilidades();

            } catch (error) {
                console.error('Erro ao salvar:', error);
                alert('Erro ao salvar compatibilidade: ' + error.message);
            }
        }

        // Excluir compatibilidade
        async function excluirCompatibilidade(id) {
            if (!confirm('Tem certeza que deseja excluir esta compatibilidade?')) {
                return;
            }

            try {
                const response = await fetch(`${API_URL}?id=${id}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    alert('Compatibilidade excluída com sucesso!');
                    buscarCompatibilidades();
                } else {
                    throw new Error(data.error || 'Erro ao excluir');
                }
            } catch (error) {
                console.error('Erro ao excluir:', error);
                alert('Erro ao excluir compatibilidade: ' + error.message);
            }
        }

        // Mostrar erro
        function mostrarErro(mensagem) {
            alert(mensagem);
        }

        // Toggle formulário de nova peça original
        function toggleFormNovaPecaOriginal() {
            const form = document.getElementById('formNovaPecaOriginal');
            form.classList.toggle('hidden');

            // Limpar campos
            if (!form.classList.contains('hidden')) {
                document.getElementById('novaPecaOriginalCodigo').value = '';
                document.getElementById('novaPecaOriginalNome').value = '';
                document.getElementById('novaPecaOriginalCategoria').value = '';
                document.getElementById('novaPecaOriginalCusto').value = '';
                document.getElementById('novaPecaOriginalEstoqueMin').value = '';
            }
        }

        // Salvar nova peça original
        async function salvarNovaPecaOriginal() {
            const codigo = document.getElementById('novaPecaOriginalCodigo').value.trim();
            const nome = document.getElementById('novaPecaOriginalNome').value.trim();
            const categoria = document.getElementById('novaPecaOriginalCategoria').value;
            const custo = parseFloat(document.getElementById('novaPecaOriginalCusto').value);
            const estoqueMin = document.getElementById('novaPecaOriginalEstoqueMin').value
                ? parseInt(document.getElementById('novaPecaOriginalEstoqueMin').value)
                : 0;

            // Validar campos obrigatórios
            if (!codigo || !nome || !categoria || isNaN(custo)) {
                alert('Preencha todos os campos obrigatórios (Código, Nome, Categoria e Custo)');
                return;
            }

            try {
                const novaPeca = {
                    codigo: codigo,
                    nome: nome,
                    categoria: categoria,
                    custo_unitario: custo,
                    estoque_minimo: estoqueMin,
                    tipo: 'Original'
                };

                const response = await fetch(API_PECAS, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(novaPeca)
                });

                const data = await response.json();

                if (data.success) {
                    // Selecionar a peça recém-criada
                    const pecaCriada = {
                        id: data.id,
                        codigo: codigo,
                        nome: nome,
                        categoria: categoria,
                        custo_unitario: custo
                    };

                    selecionarPecaOriginal(pecaCriada);
                    toggleFormNovaPecaOriginal();
                    alert('Peça criada e selecionada com sucesso!');
                } else {
                    throw new Error(data.error || 'Erro ao criar peça');
                }
            } catch (error) {
                console.error('Erro ao salvar peça:', error);
                alert('Erro ao salvar peça: ' + error.message);
            }
        }

        // Toggle formulário de nova peça similar
        function toggleFormNovaPecaSimilar() {
            const form = document.getElementById('formNovaPecaSimilar');
            form.classList.toggle('hidden');

            // Limpar campos
            if (!form.classList.contains('hidden')) {
                document.getElementById('novaPecaSimilarCodigo').value = '';
                document.getElementById('novaPecaSimilarNome').value = '';
                document.getElementById('novaPecaSimilarCategoria').value = '';
                document.getElementById('novaPecaSimilarCusto').value = '';
                document.getElementById('novaPecaSimilarEstoqueMin').value = '';
            }
        }

        // Salvar nova peça similar
        async function salvarNovaPecaSimilar() {
            const codigo = document.getElementById('novaPecaSimilarCodigo').value.trim();
            const nome = document.getElementById('novaPecaSimilarNome').value.trim();
            const categoria = document.getElementById('novaPecaSimilarCategoria').value;
            const custo = parseFloat(document.getElementById('novaPecaSimilarCusto').value);
            const estoqueMin = document.getElementById('novaPecaSimilarEstoqueMin').value
                ? parseInt(document.getElementById('novaPecaSimilarEstoqueMin').value)
                : 0;

            // Validar campos obrigatórios
            if (!codigo || !nome || !categoria || isNaN(custo)) {
                alert('Preencha todos os campos obrigatórios (Código, Nome, Categoria e Custo)');
                return;
            }

            try {
                const novaPeca = {
                    codigo: codigo,
                    nome: nome,
                    categoria: categoria,
                    custo_unitario: custo,
                    estoque_minimo: estoqueMin,
                    tipo: 'Similar'
                };

                const response = await fetch(API_PECAS, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(novaPeca)
                });

                const data = await response.json();

                if (data.success) {
                    // Adicionar a peça recém-criada à lista de similares
                    const pecaCriada = {
                        id: data.id,
                        codigo: codigo,
                        nome: nome,
                        categoria: categoria,
                        custo_unitario: custo
                    };

                    adicionarPecaSimilar(pecaCriada);
                    toggleFormNovaPecaSimilar();
                    alert('Peça similar criada e adicionada com sucesso!');
                } else {
                    throw new Error(data.error || 'Erro ao criar peça');
                }
            } catch (error) {
                console.error('Erro ao salvar peça:', error);
                alert('Erro ao salvar peça: ' + error.message);
            }
        }
    </script>
</body>
</html>
